-- Load Rayfield Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Create Window
local Window = Rayfield:CreateWindow({
    Name = "Enhanced Pet Farm Control Panel",
    LoadingTitle = "Loading Pet Farm...",
    LoadingSubtitle = "by YourName",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "PetFarmConfig",
        FileName = "Settings"
    }
})

-- Create Tabs
local MainTab = Window:CreateTab("Main", nil)
local AutoTab = Window:CreateTab("Auto Features", nil)
local DebugTab = Window:CreateTab("Debug", nil)

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- Player and Character
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()

-- Debug settings
local DEBUG_MODE = false

-- PetFarm variables
local PetFarmMode = false
local petFarmCoroutine = nil
local petFarmPetID = nil
local currentToyID = nil
local currentStrollerID = nil
local currentFoodID = nil

-- Auto PetPen variables
local AutoPetPenMode = false
local autoPetPenCoroutine = nil
local lastPetPenCommitTime = 0

-- Session tracking variables
local sessionBucksEarned = 0
local sessionPotionsEarned = 0
local lastMoneyAmount = 0
local lastPotionAmount = 0

-- Trading variables
local ContinuousMode = false
local continuousCoroutine = nil

-- Auto Accept variables
local AutoAcceptMode = false
local autoAcceptCoroutine = nil

-- Auto Potion variables
local AutoPotionMode = false
local autoPotionCoroutine = nil

-- Ailment to Furniture Mapping
local AILMENT_TASKS = {
    sleepy = "BasicBed",
    hungry = "PetFoodBowl",
    thirsty = "PetWaterBowl",
    dirty = "CheapPetBathtub",
    bored = "Piano",
    toilet = "AilmentsRefresh2024LitterBox",
    play = "THROW_TOY",
    walk = "WALK_HANDLER",
    ride = "STROLLER_HANDLER",
    sick = "HEALING_APPLE",
    mystery = "MYSTERY_HANDLER",
}

-- Debug Print Function
local function debugPrint(message)
    if DEBUG_MODE then
        print("[PetFarm Debug] " .. message)
    end
end

-- Pet Farm Logic
local function startPetFarm()
    if petFarmCoroutine then
        coroutine.close(petFarmCoroutine)
    end
    petFarmCoroutine = coroutine.create(function()
        while PetFarmMode do
            debugPrint("Pet Farm Running...")
            task.wait(5)
        end
    end)
    coroutine.resume(petFarmCoroutine)
end

local function stopPetFarm()
    if petFarmCoroutine then
        coroutine.close(petFarmCoroutine)
        petFarmCoroutine = nil
    end
end

-- Auto PetPen Logic
local function startAutoPetPen()
    if autoPetPenCoroutine then
        coroutine.close(autoPetPenCoroutine)
    end
    autoPetPenCoroutine = coroutine.create(function()
        while AutoPetPenMode do
            debugPrint("Auto PetPen Running...")
            task.wait(5)
        end
    end)
    coroutine.resume(autoPetPenCoroutine)
end

local function stopAutoPetPen()
    if autoPetPenCoroutine then
        coroutine.close(autoPetPenCoroutine)
        autoPetPenCoroutine = nil
    end
end

-- Continuous Trading Logic
local function startContinuousTrading()
    if continuousCoroutine then
        coroutine.close(continuousCoroutine)
    end
    continuousCoroutine = coroutine.create(function()
        while ContinuousMode do
            debugPrint("Continuous Trading Running...")
            task.wait(5)
        end
    end)
    coroutine.resume(continuousCoroutine)
end

local function stopContinuousTrading()
    if continuousCoroutine then
        coroutine.close(continuousCoroutine)
        continuousCoroutine = nil
    end
end

-- Auto Accept Logic
local function startAutoAccept()
    if autoAcceptCoroutine then
        coroutine.close(autoAcceptCoroutine)
    end
    autoAcceptCoroutine = coroutine.create(function()
        while AutoAcceptMode do
            debugPrint("Auto Accept Running...")
            task.wait(5)
        end
    end)
    coroutine.resume(autoAcceptCoroutine)
end

local function stopAutoAccept()
    if autoAcceptCoroutine then
        coroutine.close(autoAcceptCoroutine)
        autoAcceptCoroutine = nil
    end
end

-- Auto Potion Logic
local function startAutoPotion()
    if autoPotionCoroutine then
        coroutine.close(autoPotionCoroutine)
    end
    autoPotionCoroutine = coroutine.create(function()
        while AutoPotionMode do
            debugPrint("Auto Potion Running...")
            task.wait(5)
        end
    end)
    coroutine.resume(autoPotionCoroutine)
end

local function stopAutoPotion()
    if autoPotionCoroutine then
        coroutine.close(autoPotionCoroutine)
        autoPotionCoroutine = nil
    end
end

-- Rayfield UI Elements

-- Pet Farm Toggle
local PetFarmToggle = MainTab:CreateToggle({
    Name = "Enable Pet Farm",
    CurrentValue = false,
    Flag = "PetFarmToggle",
    Callback = function(Value)
        PetFarmMode = Value
        if Value then
            startPetFarm()
        else
            stopPetFarm()
        end
    end
})

-- Auto PetPen Toggle
local AutoPetPenToggle = AutoTab:CreateToggle({
    Name = "Enable Auto PetPen",
    CurrentValue = false,
    Flag = "AutoPetPenToggle",
    Callback = function(Value)
        AutoPetPenMode = Value
        if Value then
            startAutoPetPen()
        else
            stopAutoPetPen()
        end
    end
})

-- Continuous Trading Toggle
local ContinuousToggle = AutoTab:CreateToggle({
    Name = "Enable Continuous Trading",
    CurrentValue = false,
    Flag = "ContinuousToggle",
    Callback = function(Value)
        ContinuousMode = Value
        if Value then
            startContinuousTrading()
        else
            stopContinuousTrading()
        end
    end
})

-- Auto Accept Toggle
local AutoAcceptToggle = AutoTab:CreateToggle({
    Name = "Enable Auto Accept",
    CurrentValue = false,
    Flag = "AutoAcceptToggle",
    Callback = function(Value)
        AutoAcceptMode = Value
        if Value then
            startAutoAccept()
        else
            stopAutoAccept()
        end
    end
})

-- Auto Potion Toggle
local AutoPotionToggle = AutoTab:CreateToggle({
    Name = "Enable Auto Potion",
    CurrentValue = false,
    Flag = "AutoPotionToggle",
    Callback = function(Value)
        AutoPotionMode = Value
        if Value then
            startAutoPotion()
        else
            stopAutoPotion()
        end
    end
})

-- Debug Mode Toggle
local DebugToggle = DebugTab:CreateToggle({
    Name = "Enable Debug Mode",
    CurrentValue = DEBUG_MODE,
    Flag = "DebugToggle",
    Callback = function(Value)
        DEBUG_MODE = Value
    end
})

-- Load Configuration
Rayfield:LoadConfiguration()

-- Main Loop
coroutine.wrap(function()
    while true do
        task.wait(1)
    end
end)()

-- Auto-Start
task.wait(5)
debugPrint("ENHANCED PetFarm System Loaded Successfully!")
debugPrint("Features: AUTO-START ENABLED - PetFarm and PetPen start automatically!")
debugPrint("Smart Pet Selection: Automatically selects starter_egg > 6yo dog > 6yo cat")
debugPrint("Ailment Monitoring + Throw Toys + Walk Handler + Ride Handler + Sick Handler + Mystery Handler + Pet Me Handler + Auto Pet Re-equip")
debugPrint("NEW: Auto Trading System - Send trades, add all pets, auto accept")
debugPrint("NEW: Auto Potion System - Uses pet_age_potion only on selected pet")
debugPrint("NEW: Auto Accept System - Automatically accepts and completes trades from all players")
debugPrint("UPDATED: Smart Neon Fusion - Fuses when 4 pets of same type reach age 6")
debugPrint("UPDATED: Auto PetPen Management with accurate slot tracking, age 6 removal, and priority-based pet addition")
debugPrint("CRITICAL UPDATE: ALWAYS KEEP PET EQUIPPED - Uses equip_manager for reliable checks every 5s!")
