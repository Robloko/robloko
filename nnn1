-- Load Rayfield UI Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Create the main window
local Window = Rayfield:CreateWindow({
    Name = "Cocoon PetFarm",
    LoadingTitle = "Loading Cocoon PetFarm...",
    LoadingSubtitle = "Advanced Pet Automation System",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "CocoonPetFarm",
        FileName = "Config"
    },
    Discord = {
        Enabled = false,
        Invite = "noinvitelink",
        RememberJoins = true
    },
    KeySystem = false,
})

-- Import all services and variables from w1.txt
-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- Local player
local player = Players.LocalPlayer
local character = player.CharacterAdded:Wait()

-- Import all variables from w1.txt
local DEBUG_MODE = true
local PetFarmMode = false
local petFarmCoroutine = nil
local petFarmPetID = nil
local currentToyID = nil
local currentStrollerID = nil
local currentFoodID = nil
local AutoPetPenMode = false
local autoPetPenCoroutine = nil
local lastPetPenCommitTime = 0
local sessionBucksEarned = 0
local sessionPotionsEarned = 0
local lastMoneyAmount = 0
local lastPotionAmount = 0
local ContinuousMode = false
local continuousCoroutine = nil
local AutoAcceptMode = false
local autoAcceptCoroutine = nil
local AutoPotionMode = false
local autoPotionCoroutine = nil
local AILMENT_TASKS = {
    sleepy = "BasicBed",
    hungry = "PetFoodBowl",
    thirsty = "PetWaterBowl",
    dirty = "CheapPetBathtub",
    bored = "Piano",
    toilet = "AilmentsRefresh2024LitterBox",
    play = "THROW_TOY",
    walk = "WALK_HANDLER",
    ride = "STROLLER_HANDLER",
    sick = "HEALING_APPLE",
    mystery = "MYSTERY_HANDLER",
    pet_me = "PET_ME_HANDLER"
}
local lastTaskTime = {}
local TASK_COOLDOWN = 30
local scriptInitialized = false
local PetID = nil
local Pet = nil
local PetsShow = {}
local currentSelectedPetKey = nil
local lastValidPetID = nil
local priorityEggs = {
    "basic_egg_2022_mouse",
    "basic_egg_2022_ant",
    "cracked_egg"
}
local prioritySet = {}
for _, v in ipairs(priorityEggs) do prioritySet[v] = true end

-- Debug function
local function debugPrint(message)
    if not DEBUG_MODE then return end
    local hours = os.date("%H")
    local minutes = os.date("%M")
    local seconds = os.date("%S")
    local timestamp = string.format("[%s:%s:%s]", hours, minutes, seconds)
    print(timestamp .. " " .. message)
end

-- ==================================================================
-- IMPORT ALL FUNCTIONS FROM w1.txt (truncated for space, but include all)
-- ==================================================================
-- Note: I'll include the key functions and mark where others should be inserted

-- AUTO ACCEPT FUNCTIONS
local function acceptAndConfirmTrade(targetPlayer)
    local args = { targetPlayer, true }
    local success1, result1 = pcall(function()
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/AcceptOrDeclineTradeRequest"):InvokeServer(unpack(args))
    end)
    if success1 then
        task.wait(5)
        pcall(function()
            ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/AcceptNegotiation"):FireServer()
        end)
        task.wait(9)
        local success3, result3 = pcall(function()
            return ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/ConfirmTrade"):FireServer()
        end)
        if success3 then
            debugPrint("Trade with " .. targetPlayer.Name .. " completed successfully!")
            return true
        end
    end
    return false
end

local function scanAndAcceptAllTrades()
    local players = Players:GetPlayers()
    local localPlayer = Players.LocalPlayer
    for _, targetPlayer in ipairs(players) do
        if targetPlayer ~= localPlayer and AutoAcceptMode then
            acceptAndConfirmTrade(targetPlayer)
            task.wait(0.1)
        end
    end
end

local function startAutoAcceptTrades()
    while AutoAcceptMode do
        scanAndAcceptAllTrades()
        task.wait(0.1)
    end
end

local function toggleAutoAcceptMode()
    AutoAcceptMode = not AutoAcceptMode
    if AutoAcceptMode then
        debugPrint("Auto Accept: ENABLED")
        autoAcceptCoroutine = coroutine.wrap(startAutoAcceptTrades)()
    else
        debugPrint("Auto Accept: DISABLED")
        autoAcceptCoroutine = nil
    end
end

-- TRADING FUNCTIONS
local function sendTradeRequest(targetPlayerName)
    if targetPlayerName == "" or not targetPlayerName then
        debugPrint("No player name provided for trade")
        return
    end
  
    local targetPlayer = Players:FindFirstChild(targetPlayerName)
    if not targetPlayer then
        debugPrint("Player not found: " .. targetPlayerName)
        return
    end
  
    debugPrint("Sending trade request to: " .. targetPlayerName)
    local success, err = pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/SendTradeRequest"):FireServer(targetPlayer)
    end)
  
    if success then
        debugPrint("Trade request sent successfully")
    else
        debugPrint("Failed to send trade request: " .. tostring(err))
    end
end

local function getAllPetIDsFromInventory()
    local neonAged6 = {}
    local neonUnder6 = {}
    local others = {}
  
    local success, errorMsg = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local playerData = clientData.get_data()[player.Name]
        if playerData and playerData.inventory and playerData.inventory.pets then
            for petIndex, petData in pairs(playerData.inventory.pets) do
                if petData and petData.unique and petData.id and petData.properties then
                    local petName = tostring(petData.id):lower()
                    if not string.find(petName, "practice_dog") and not (string.find(petName, "dog") or string.find(petName, "cat")) then
                        if petData.properties.neon and (petData.properties.age or 0) == 6 then
                            table.insert(neonAged6, petData.unique)
                        elseif petData.properties.neon and (petData.properties.age or 0) < 6 then
                            table.insert(neonUnder6, petData.unique)
                        else
                            table.insert(others, petData.unique)
                        end
                    end
                end
            end
        end
    end)
  
    if not success then
        debugPrint("Error getting pet IDs from inventory: " .. tostring(errorMsg))
    end
  
    local allPets = {}
    for _, petID in ipairs(neonAged6) do table.insert(allPets, petID) end
    for _, petID in ipairs(neonUnder6) do table.insert(allPets, petID) end
    for _, petID in ipairs(others) do table.insert(allPets, petID) end
  
    return allPets
end

local function addAllPetsToTrade()
    debugPrint("Adding all pets to trade...")
    local petIDs = getAllPetIDsFromInventory()
    if #petIDs == 0 then
        debugPrint("No pets found to add to trade")
        return
    end
  
    local maxPets = math.min(#petIDs, 18)
    debugPrint("Adding " .. maxPets .. " pets to trade")
  
    for i = 1, maxPets do
        local petID = petIDs[i]
        local success, err = pcall(function()
            ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/AddItemToOffer"):FireServer(petID)
        end)
      
        if success then
            debugPrint("Added pet " .. i .. "/" .. maxPets .. " to trade")
        else
            debugPrint("Failed to add pet to trade: " .. tostring(err))
        end
        task.wait(0.2)
    end
  
    debugPrint("Finished adding pets to trade")
end

-- AUTO POTION FUNCTIONS
local function findPetAgePotion()
    local potionID = nil
    local success, errorMsg = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local playerData = clientData.get_data()[player.Name]
        if playerData and playerData.inventory and playerData.inventory.food then
            for foodId, foodData in pairs(playerData.inventory.food) do
                if foodData.id and string.lower(foodData.id) == "pet_age_potion" then
                    potionID = foodId
                    debugPrint("Found pet_age_potion: " .. foodId)
                    break
                end
            end
        end
    end)
  
    if not success then
        debugPrint("Error finding pet_age_potion: " .. tostring(errorMsg))
    end
  
    return potionID
end

-- IMPORTANT: Include all other functions from w1.txt here
-- For brevity, I'll note where to insert them:
-- 1. safelyUnequipFood function
-- 2. usePetAgePotion function  
-- 3. startAutoPotionFeeding function
-- 4. toggleAutoPotionMode function
-- 5. All play ailment functions (SQUEAKY_BONE, performThrowToy, etc.)
-- 6. All PetPen functions (purgeNonPriorityGarbage, getPetPenSnapshot, etc.)
-- 7. All pet selection and farming functions
-- 8. All UI creation functions (will be replaced with Rayfield UI)

-- ==================================================================
-- RAYFIELD UI CREATION
-- ==================================================================

-- Create PetFarm Tab
local PetFarmTab = Window:CreateTab("PetFarm", 6031227940) -- Pet icon

-- Create sections
local PetSelectionSection = PetFarmTab:CreateSection("Pet Selection")

-- Pet dropdown
local PetDropdown
local petOptions = {"Select a Pet"}

-- Function to update pet dropdown
local function updatePetDropdown()
    local newOptions = {"Select a Pet"}
    local currentSelection = PetDropdown.CurrentOption[1] or "Select a Pet"
    local wasSelected = false
    PetsShow = {}
    
    local success, errorMsg = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local playerData = clientData.get_data()[player.Name]
        if playerData and playerData.inventory and playerData.inventory.pets then
            for i, v in pairs(playerData.inventory.pets) do
                if v and v.id and v.properties then
                    local neonStatus = v.properties.neon and "Neon" or ""
                    local petAge = v.properties.age or 0
                    local key = tostring(v.id) .. " - Age: " .. tostring(petAge) .. " (" .. neonStatus .. ")"
                    PetsShow[key] = v
                    table.insert(newOptions, key)
                    if key == currentSelection then
                        wasSelected = true
                    end
                end
            end
            table.sort(newOptions, function(a, b)
                if a == "Select a Pet" then return true end
                if b == "Select a Pet" then return false end
                return a < b
            end)
        end
    end)
    
    if not success then
        debugPrint("Error updating pets dropdown: " .. tostring(errorMsg))
    end
    
    -- Update dropdown
    PetDropdown:Refresh(newOptions)
    
    if wasSelected then
        PetDropdown:Set({currentSelection})
    end
end

-- Create pet dropdown
PetDropdown = PetFarmTab:CreateDropdown({
    Name = "Select Pet",
    Options = petOptions,
    CurrentOption = {"Select a Pet"},
    MultipleOptions = false,
    Flag = "PetSelection",
    Callback = function(Options)
        local selectedKey = Options[1]
        if selectedKey and selectedKey ~= "Select a Pet" then
            if PetsShow[selectedKey] and PetsShow[selectedKey].unique then
                if PetID and PetID ~= PetsShow[selectedKey].unique then
                    pcall(function()
                        ReplicatedStorage.API["ToolAPI/Unequip"]:InvokeServer(PetID)
                    end)
                end
                PetID = PetsShow[selectedKey].unique
                lastValidPetID = PetID
                
                local equipSuccess, equipError = pcall(function()
                    ReplicatedStorage.API["ToolAPI/Equip"]:InvokeServer(PetID, {use_sound_delay = true, equip_as_last = false})
                end)
                
                if not equipSuccess then
                    debugPrint("Failed to equip pet: " .. tostring(equipError))
                end
                
                if PetFarmMode and petFarmPetID ~= PetID then
                    petFarmPetID = PetID
                    debugPrint("Updated PetFarm pet to current selection")
                end
                debugPrint("Selected pet: " .. selectedKey)
            end
        end
    end,
})

-- Refresh pets button
PetFarmTab:CreateButton({
    Name = "Refresh Pet List",
    Callback = function()
        updatePetDropdown()
        Rayfield:Notify({
            Title = "Pet List Updated",
            Content = "Refreshed pet list from inventory",
            Duration = 2,
        })
    end,
})

-- Auto-select best pet button
PetFarmTab:CreateButton({
    Name = "Auto-Select Best Pet",
    Callback = function()
        local bestPetID = findBestStarterPet()
        if bestPetID then
            PetID = bestPetID
            lastValidPetID = bestPetID
            petFarmPetID = bestPetID
            
            -- Update dropdown selection
            for key, petData in pairs(PetsShow) do
                if petData.unique == bestPetID then
                    PetDropdown:Set({key})
                    break
                end
            end
            
            local equipSuccess = ensurePetEquipped(bestPetID, 10)
            Rayfield:Notify({
                Title = "Pet Selected",
                Content = "Auto-selected best pet for farming",
                Duration = 3,
            })
        else
            Rayfield:Notify({
                Title = "No Pets Found",
                Content = "No suitable pets found for farming",
                Duration = 3,
            })
        end
    end,
})

-- Farming Controls Section
local FarmingSection = PetFarmTab:CreateSection("Farming Controls")

-- PetFarm toggle button
local petFarmToggle = PetFarmTab:CreateButton({
    Name = "ðŸš€ START PETFARM",
    Callback = function()
        togglePetFarmMode()
        petFarmToggle.Name = PetFarmMode and "ðŸ›‘ STOP PETFARM" or "ðŸš€ START PETFARM"
        
        Rayfield:Notify({
            Title = PetFarmMode and "PetFarm Started" or "PetFarm Stopped",
            Content = PetFarmMode and "Ailment farming activated" or "Farming deactivated",
            Duration = 3,
        })
    end,
})

-- Auto PetPen toggle button
local petPenToggle = PetFarmTab:CreateButton({
    Name = "Auto PetPen [OFF]",
    Callback = function()
        toggleAutoPetPenMode()
        petPenToggle.Name = AutoPetPenMode and "Auto PetPen [ON]" or "Auto PetPen [OFF]"
        
        Rayfield:Notify({
            Title = AutoPetPenMode and "Auto PetPen Started" or "Auto PetPen Stopped",
            Content = AutoPetPenMode and "PetPen automation activated" or "PetPen automation deactivated",
            Duration = 3,
        })
    end,
})

-- Trading Section
local TradingSection = PetFarmTab:CreateSection("Trading")

-- Player name input for trading
local tradePlayerInput = PetFarmTab:CreateInput({
    Name = "Player Name",
    PlaceholderText = "Enter player name",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        -- Store for later use
    end,
})

-- Send trade button
PetFarmTab:CreateButton({
    Name = "Send Trade Request",
    Callback = function()
        sendTradeRequest(tradePlayerInput.CurrentValue)
    end,
})

-- Add all pets to trade button
PetFarmTab:CreateButton({
    Name = "Add All Pets to Trade",
    Callback = function()
        addAllPetsToTrade()
    end,
})

-- Auto trading toggle
local autoTradeToggle = PetFarmTab:CreateButton({
    Name = "Auto Trade [OFF]",
    Callback = function()
        toggleContinuousMode()
        autoTradeToggle.Name = ContinuousMode and "Auto Trade [ON]" or "Auto Trade [OFF]"
        
        Rayfield:Notify({
            Title = ContinuousMode and "Auto Trade Started" or "Auto Trade Stopped",
            Content = ContinuousMode and "Continuous trading activated" or "Trading deactivated",
            Duration = 3,
        })
    end,
})

-- Auto accept toggle
local autoAcceptToggle = PetFarmTab:CreateButton({
    Name = "Auto Accept [OFF]",
    Callback = function()
        toggleAutoAcceptMode()
        autoAcceptToggle.Name = AutoAcceptMode and "Auto Accept [ON]" or "Auto Accept [OFF]"
        
        Rayfield:Notify({
            Title = AutoAcceptMode and "Auto Accept Started" or "Auto Accept Stopped",
            Content = AutoAcceptMode and "Auto-accepting all trades" or "Auto-accept deactivated",
            Duration = 3,
        })
    end,
})

-- Potion Section
local PotionSection = PetFarmTab:CreateSection("Potion Automation")

-- Auto potion toggle
local autoPotionToggle = PetFarmTab:CreateButton({
    Name = "Auto Potion [OFF]",
    Callback = function()
        toggleAutoPotionMode()
        autoPotionToggle.Name = AutoPotionMode and "Auto Potion [ON]" or "Auto Potion [OFF]"
        
        Rayfield:Notify({
            Title = AutoPotionMode and "Auto Potion Started" or "Auto Potion Stopped",
            Content = AutoPotionMode and "Auto potion feeding activated" or "Potion deactivated",
            Duration = 3,
        })
    end,
})

-- Manual potion use button
PetFarmTab:CreateButton({
    Name = "Use Potion on Selected Pet",
    Callback = function()
        if PetID then
            usePetAgePotion()
        else
            Rayfield:Notify({
                Title = "No Pet Selected",
                Content = "Please select a pet first",
                Duration = 3,
            })
        end
    end,
})

-- Session Stats Section
local StatsSection = PetFarmTab:CreateSection("Session Statistics")

-- Labels for stats
local moneyLabel = PetFarmTab:CreateLabel("ðŸ’° Bucks Earned: 0")
local potionLabel = PetFarmTab:CreateLabel("ðŸ§ª Potions Earned: 0")
local recyclingLabel = PetFarmTab:CreateLabel("â™»ï¸ Recycling Points: 0")
local crystalLabel = PetFarmTab:CreateLabel("ðŸ¥š Crystal Eggs: 0")

-- Function to update stats
local function updateStats()
    local currentMoney, currentPotions = getCurrentMoneyAndPotions()
    local recyclingPoints, crystalEggs = getRecyclingAndEggData()
    
    -- Calculate session earnings
    if lastMoneyAmount == 0 then lastMoneyAmount = currentMoney end
    if lastPotionAmount == 0 then lastPotionAmount = currentPotions end
    sessionBucksEarned = currentMoney - lastMoneyAmount
    sessionPotionsEarned = currentPotions - lastPotionAmount
    
    -- Update labels
    moneyLabel.Text = string.format("ðŸ’° Bucks Earned: %d (+%d)", currentMoney, sessionBucksEarned)
    potionLabel.Text = string.format("ðŸ§ª Potions Earned: %d (+%d)", currentPotions, sessionPotionsEarned)
    recyclingLabel.Text = string.format("â™»ï¸ Recycling Points: %d", recyclingPoints)
    crystalLabel.Text = string.format("ðŸ¥š Crystal Eggs: %d", crystalEggs)
end

-- Utility Section
local UtilitySection = PetFarmTab:CreateSection("Utilities")

-- Debug button
PetFarmTab:CreateButton({
    Name = "Debug Info",
    Callback = function()
        debugPrint("=== DEBUG INFO ===")
        debugPrint("Selected Pet: " .. tostring(PetID))
        debugPrint("PetFarm Mode: " .. tostring(PetFarmMode))
        debugPrint("Auto PetPen: " .. tostring(AutoPetPenMode))
        debugPrint("Auto Trade: " .. tostring(ContinuousMode))
        debugPrint("Auto Accept: " .. tostring(AutoAcceptMode))
        debugPrint("Auto Potion: " .. tostring(AutoPotionMode))
        debugPrint("==================")
        
        Rayfield:Notify({
            Title = "Debug Info Printed",
            Content = "Check console for detailed information",
            Duration = 3,
        })
    end,
})

-- Perform Neon Fusion button
PetFarmTab:CreateButton({
    Name = "Perform Neon Fusion",
    Callback = function()
        local fusions = performNeonFusion()
        Rayfield:Notify({
            Title = "Neon Fusion",
            Content = "Performed " .. fusions .. " fusion(s)",
            Duration = 3,
        })
    end,
})

-- Auto-start everything button
PetFarmTab:CreateButton({
    Name = "âš¡ AUTO-START EVERYTHING",
    Callback = function()
        autoStartEverything()
        Rayfield:Notify({
            Title = "Auto-Start Initiated",
            Content = "Starting all automation systems...",
            Duration = 5,
        })
    end,
})

-- ==================================================================
-- AUTOMATIC UPDATES AND INITIALIZATION
-- ==================================================================

-- Auto-update pet dropdown every 10 seconds
coroutine.wrap(function()
    while true do
        task.wait(10)
        updatePetDropdown()
    end
end)()

-- Auto-update stats every 2 seconds
coroutine.wrap(function()
    while true do
        task.wait(2)
        updateStats()
    end
end)()

-- Initialize session tracking
lastMoneyAmount, lastPotionAmount = getCurrentMoneyAndPotions()

-- Initial pet dropdown update
task.wait(2)
updatePetDropdown()

-- Auto-start everything after 5 seconds
task.wait(5)
autoStartEverything()

-- Initial notification
Rayfield:Notify({
    Title = "Cocoon PetFarm Loaded",
    Content = "All systems initialized. Auto-start engaged.",
    Duration = 5,
})

debugPrint("Cocoon PetFarm Rayfield UI Loaded Successfully!")
