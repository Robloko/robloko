-- COCOON: Integrated PetFarm + Winter Event System
-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- Wait for game to fully load
wait(5)

-- Load Rayfield UI Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- ==================================================================
-- GLOBAL VARIABLES AND SETTINGS
-- ==================================================================
-- Local player reference
local player = Players.LocalPlayer
local localPlayer = player

-- Debug settings
local DEBUG_MODE = true

-- PetFarm variables
local PetFarmMode = false
local petFarmCoroutine = nil
local petFarmPetID = nil
local currentToyID = nil
local currentStrollerID = nil
local currentFoodID = nil

-- Auto PetPen variables
local AutoPetPenMode = true  -- Enabled by default
local autoPetPenCoroutine = nil
local lastPetPenCommitTime = 0

-- Session tracking variables
local sessionBucksEarned = 0
local sessionPotionsEarned = 0
local lastMoneyAmount = 0
local lastPotionAmount = 0

-- Trading variables
local ContinuousMode = false
local continuousCoroutine = nil

-- Auto Accept variables
local AutoAcceptMode = false
local autoAcceptCoroutine = nil

-- Auto Potion variables
local AutoPotionMode = false
local autoPotionCoroutine = nil

-- Winter Event variables
local isGingerbreadRunning = false
local isMailCollecting = false
local isBucksExchange = false
local isTrainRunning = false
local giveAllRunning = false
local give4Running = false
local giveawayRunning = false

-- Ailment to Furniture Mapping
local AILMENT_TASKS = {
    sleepy = "BasicBed",
    hungry = "PetFoodBowl",
    thirsty = "PetWaterBowl",
    dirty = "CheapPetBathtub",
    bored = "Piano",
    toilet = "AilmentsRefresh2024LitterBox",
    play = "THROW_TOY",
    walk = "WALK_HANDLER",
    ride = "STROLLER_HANDLER",
    sick = "HEALING_APPLE",
    mystery = "MYSTERY_HANDLER",
    pet_me = "PET_ME_HANDLER"
}

-- Task cooldowns to prevent spam
local lastTaskTime = {}
local TASK_COOLDOWN = 30 -- seconds

-- Script state
local scriptInitialized = false

-- Pet selection variables
local PetID = nil
local Pet = nil
local PetsShow = {}
local currentSelectedPetKey = nil
local lastValidPetID = nil

-- Priority eggs for Auto PetPen
local priorityEggs = {
    "basic_egg_2022_mouse",
    "basic_egg_2022_ant",
    "cracked_egg"
}
local prioritySet = {}
for _, v in ipairs(priorityEggs) do prioritySet[v] = true end

-- Winter Event variables
local adoptmeNet = ReplicatedStorage:WaitForChild("adoptme_new_net")
local iceSkatingEvent = adoptmeNet:WaitForChild("adoptme_legacy_shared.ContentPacks.Winter2025.Game.IceSkating.IceSkatingNet:7")
local collectEvent = adoptmeNet:WaitForChild("adoptme_legacy_shared.ContentPacks.Winter2025.Game.IceSkating.IceSkatingNet:16")
local trainEvent = adoptmeNet:WaitForChild("adoptme_legacy_shared.ContentPacks.Winter2025.Game.Train.WinterTrainNet:7")
local spawnAPI = ReplicatedStorage:WaitForChild("API"):WaitForChild("TeamAPI/Spawn")

-- Gingerbread IDs (truncated for brevity - include all your IDs)
local gingerbreadIds = {
    "{28F6FD49-55C2-4E45-88F3-E62344AEE010}",
    "{96EB009D-84A2-464B-925E-41E269B5D7E4}",
    "{437F2FA1-230F-498F-9276-DE0EF87C3AE1}",
    -- ... Add all your gingerbread IDs here
    "{FD974ABC-023F-4238-BB26-EA963179D61F}"
}

-- Target pets for giveaway
local targetPets = {
    "winter_2025_turtle_doves",
    "winter_2025_xmas_tree_sasquatch",
    "winter_2025_humbug",
    "basic_egg_2022_ant",
    "basic_egg_2022_mouse",
    "basic_egg_2022_camel",
    "basic_egg_2022_poodle",
    "basic_egg_2022_donkey",
    "basic_egg_2022_zebra",
    "basic_egg_2022_orangutan",
    "basic_egg_2022_parakeet",
    "basic_egg_2022_swordfish",
    "basic_egg_2022_robot",
    "basic_egg_2022_corgi"
}

-- UI Variables
local gingerbreadLabel = nil
local buyCount = 1
local selectedPlayer = nil
local selectedPetType = nil

-- ==================================================================
-- UTILITY FUNCTIONS
-- ==================================================================

-- Debug function
local function debugPrint(message)
    if not DEBUG_MODE then return end
    local hours = os.date("%H")
    local minutes = os.date("%M")
    local seconds = os.date("%S")
    local timestamp = string.format("[%s:%s:%s]", hours, minutes, seconds)
    print(timestamp .. " " .. message)
end

-- Function to get current money and potions
local function getCurrentMoneyAndPotions()
    local success, clientData = pcall(require, ReplicatedStorage.ClientModules.Core.ClientData)
    if not success then return 0, 0 end
    local success2, allData = pcall(clientData.get_data, clientData)
    if not success2 or not allData[player.Name] then return 0, 0 end
    local playerData = allData[player.Name]
    local money = playerData.money or 0
    local potions = 0
    -- Count potions
    if playerData.inventory and playerData.inventory.food then
        for _, foodData in pairs(playerData.inventory.food) do
            if foodData.id and string.find(string.lower(foodData.id), "potion") then
                potions = potions + (foodData.amount or 1)
            end
        end
    end
    return money, potions
end

-- Function to get recycling points and crystal eggs
local function getRecyclingAndEggData()
    local recyclingPoints = 0
    local crystalEggs = 0

    local success, data = pcall(function()
        return require(ReplicatedStorage.ClientModules.Core.ClientData).get_data()[player.Name]
    end)

    if success and data then
        -- Get recycling points from saved_points
        if data.pet_recycler_manager and data.pet_recycler_manager.saved_points then
            recyclingPoints = data.pet_recycler_manager.saved_points or 0
        end
        
        -- Count crystal eggs in inventory (pet_recycler_2025_crystal_egg)
        if data.inventory and data.inventory.pets then
            for _, petData in pairs(data.inventory.pets) do
                if petData.id and string.lower(petData.id) == "pet_recycler_2025_crystal_egg" then
                    crystalEggs = crystalEggs + 1
                end
            end
        end
    end

    return recyclingPoints, crystalEggs
end

-- Function to update session earnings
local function updateSessionEarnings()
    local currentMoney, currentPotions = getCurrentMoneyAndPotions()
    -- Calculate session earnings
    if lastMoneyAmount == 0 then lastMoneyAmount = currentMoney end
    if lastPotionAmount == 0 then lastPotionAmount = currentPotions end
    sessionBucksEarned = currentMoney - lastMoneyAmount
    sessionPotionsEarned = currentPotions - lastPotionAmount
    return currentMoney, currentPotions
end

-- Function to get player data
local function getPlayerData()
    local success, data = pcall(function()
        return require(ReplicatedStorage.ClientModules.Core.ClientData).get_data()[player.Name]
    end)
    if not success or not data then
        debugPrint("Failed to get player data")
        return nil
    end
    return data
end

-- Function to get current gingerbread value
local function getCurrentGingerbread()
    local success, clientData = pcall(require, ReplicatedStorage.ClientModules.Core.ClientData)
    if not success then
        return 0
    end
    local success2, allData = pcall(clientData.get_data, clientData)
    if not success2 or not allData[player.Name] then
        return 0
    end
    local playerData = allData[player.Name]
    local gingerbread = 0
    if playerData.gingerbread_2025 then
        gingerbread = playerData.gingerbread_2025
    elseif playerData.inventory and playerData.inventory.currency then
        gingerbread = playerData.inventory.currency.gingerbread_2025 or 0
    else
        for key, value in pairs(playerData) do
            if type(key) == "string" and string.find(key:lower(), "gingerbread") then
                if key == "gingerbread_2025" then
                    gingerbread = value
                end
            end
        end
    end
    return gingerbread
end

-- ==================================================================
-- PET SELECTION SYSTEM
-- ==================================================================

-- Function to find and select the best starter pet
local function findBestStarterPet()
    debugPrint("Searching for best starter pet...")
    local bestPet = nil
    local highestPriority = 0
    
    local success, errorMsg = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local playerData = clientData.get_data()[player.Name]
        
        if playerData and playerData.inventory and playerData.inventory.pets then
            for uniqueId, petData in pairs(playerData.inventory.pets) do
                if petData and petData.id and petData.properties then
                    local petName = string.lower(petData.id)
                    local age = petData.properties.age or 0
                    local neon = petData.properties.neon or false
                    
                    -- Calculate priority
                    local priority = 0
                    if petName == "starter_egg" then
                        priority = 100 -- Highest for starter_egg
                    elseif string.find(petName, "dog") and not string.find(petName, "practice_dog") and age == 6 then
                        priority = 90 -- Next for 6yo dog
                    elseif string.find(petName, "cat") and age == 6 then
                        priority = 80 -- Next for 6yo cat
                    elseif age == 6 then
                        priority = 70 -- Other 6yo pets
                    elseif age >= 4 then
                        priority = 60 -- Older pets
                    elseif age >= 2 then
                        priority = 50 -- Middle-aged pets
                    else
                        priority = 40 -- Young pets
                    end
                    
                    -- Boost priority for Neon pets
                    if neon then
                        priority = priority + 20
                    end
                    
                    -- Update best pet if this one has higher priority
                    if priority > highestPriority then
                        highestPriority = priority
                        bestPet = {
                            unique_id = uniqueId,
                            name = petData.id,
                            age = age,
                            neon = neon,
                            priority = priority
                        }
                    end
                end
            end
        end
    end)
    
    if not success then
        debugPrint("Error finding starter pets: " .. tostring(errorMsg))
        return nil
    end
    
    if bestPet then
        debugPrint("Selected best pet: " .. bestPet.name .. " (Age: " .. bestPet.age .. ", Priority: " .. bestPet.priority .. ")")
        return bestPet.unique_id
    else
        debugPrint("No eligible pets found!")
        return nil
    end
end

-- Function to get all pets for dropdown
local function getAllPetsForDropdown()
    local petList = {}
    
    local success, errorMsg = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local playerData = clientData.get_data()[player.Name]
        
        if playerData and playerData.inventory and playerData.inventory.pets then
            for uniqueId, petData in pairs(playerData.inventory.pets) do
                if petData and petData.id and petData.properties then
                    local petName = petData.id
                    local age = petData.properties.age or 0
                    local neon = petData.properties.neon and " (Neon)" or ""
                    local mega = petData.properties.mega_neon and " (Mega)" or ""
                    
                    -- Create display name
                    local displayName
                    if neon ~= "" then
                        displayName = string.format("%s - Age: %d%s", petName, age, neon)
                    elseif mega ~= "" then
                        displayName = string.format("%s - Age: %d%s", petName, age, mega)
                    else
                        displayName = string.format("%s - Age: %d", petName, age)
                    end
                    
                    table.insert(petList, {
                        Name = displayName,
                        Value = uniqueId,
                        Data = {
                            name = petName,
                            age = age,
                            neon = neon,
                            mega = mega
                        }
                    })
                end
            end
        end
    end)
    
    if not success then
        debugPrint("Error getting pets for dropdown: " .. tostring(errorMsg))
        return {}
    end
    
    -- Sort alphabetically by name
    table.sort(petList, function(a, b)
        return a.Data.name < b.Data.name
    end)
    
    return petList
end

-- Function to update the pet dropdown
local function updatePetDropdown()
    task.wait(1) -- Wait for data to load
    
    local petList = getAllPetsForDropdown()
    
    if #petList == 0 then
        debugPrint("No pets found in inventory!")
        
        -- Try again after a delay
        task.wait(3)
        petList = getAllPetsForDropdown()
        
        if #petList == 0 then
            debugPrint("Still no pets found after retry. Inventory might be empty.")
            return {}
        end
    end
    
    debugPrint("Found " .. #petList .. " pets for dropdown")
    return petList
end

-- ==================================================================
-- BASIC PETFARM FUNCTIONS (Simplified)
-- ==================================================================

-- Function to check if pet is equipped
local function isPetEquipped(petUniqueID)
    local data = getPlayerData()
    if not data or not data.equip_manager or not data.equip_manager.pets then
        debugPrint("Cannot check equip status: equip_manager not found")
        return false
    end
    for _, equippedPet in pairs(data.equip_manager.pets) do
        if equippedPet and equippedPet.unique == petUniqueID then
            debugPrint("Pet " .. petUniqueID .. " is equipped")
            return true
        end
    end
    debugPrint("Pet " .. petUniqueID .. " is NOT equipped")
    return false
end

-- Function to ensure pet is equipped
local function ensurePetEquipped(petUniqueID, timeout)
    timeout = timeout or 15
    if not petUniqueID then
        debugPrint("ensurePetEquipped: no petUniqueID provided")
        return false
    end
    
    -- Primary check: equip_manager
    if isPetEquipped(petUniqueID) then
        debugPrint("Pet already equipped")
        return true
    end
    
    -- If not equipped, attempt to equip
    debugPrint("Pet not equipped, equipping: " .. tostring(petUniqueID))
    local success, result = pcall(function()
        return ReplicatedStorage.API["ToolAPI/Equip"]:InvokeServer(petUniqueID, {use_sound_delay = true, equip_as_last = false})
    end)
    
    if not success then
        debugPrint("Failed to equip pet: " .. tostring(result))
        return false
    end
    
    -- Wait and verify
    local startTime = os.time()
    while os.time() - startTime < timeout do
        if isPetEquipped(petUniqueID) then
            debugPrint("Pet successfully equipped")
            return true
        end
        task.wait(0.5)
    end
    
    debugPrint("Pet did not fully equip within timeout")
    return false
end

-- Function to toggle Auto PetPen mode
local function toggleAutoPetPenMode()
    AutoPetPenMode = not AutoPetPenMode
    if AutoPetPenMode then
        debugPrint("Auto PetPen: ENABLED")
        -- Start auto petpen logic here
    else
        debugPrint("Auto PetPen: DISABLED")
    end
end

-- Function to toggle PetFarm mode
local function togglePetFarmMode()
    if PetFarmMode and petFarmCoroutine then
        debugPrint("PetFarm is already running, stopping first...")
        PetFarmMode = false
        task.wait(2)
    end
    
    PetFarmMode = not PetFarmMode
    
    if PetFarmMode then
        if not PetID and lastValidPetID then
            PetID = lastValidPetID
            debugPrint("Restored PetID from lastValidPetID: " .. tostring(PetID))
        end
        
        if not PetID then
            debugPrint("Please select a pet first!")
            PetFarmMode = false
            return
        end
        
        debugPrint("PetFarm: ENABLED with pet ID: " .. tostring(PetID))
        lastValidPetID = PetID
        
        -- Ensure pet is equipped
        local ensured = ensurePetEquipped(PetID, 18)
        if not ensured then
            debugPrint("Could not ensure pet is equipped. Starting PetFarm anyway.")
        end
        
        -- Start pet farm logic here
        debugPrint("PetFarm started successfully")
    else
        debugPrint("PetFarm: DISABLED")
    end
end

-- Function to toggle auto accept mode
local function toggleAutoAcceptMode()
    AutoAcceptMode = not AutoAcceptMode
    if AutoAcceptMode then
        debugPrint("Auto Accept: ENABLED")
    else
        debugPrint("Auto Accept: DISABLED")
    end
end

-- Function to toggle continuous mode
local function toggleContinuousMode()
    ContinuousMode = not ContinuousMode
    if ContinuousMode then
        debugPrint("Auto Trade: ENABLED")
    else
        debugPrint("Auto Trade: DISABLED")
    end
end

-- Function to toggle auto potion mode
local function toggleAutoPotionMode()
    AutoPotionMode = not AutoPotionMode
    if AutoPotionMode then
        debugPrint("Auto Potion: ENABLED")
    else
        debugPrint("Auto Potion: DISABLED")
    end
end

-- ==================================================================
-- WINTER EVENT MODULE
-- ==================================================================

-- Function to call a single gingerbread ID
local function callGingerbreadId(gingerbreadId)
    local args = {
        {
            interior_name = "MainMap!Christmas",
            gingerbread_id = gingerbreadId
        }
    }
    
    iceSkatingEvent:FireServer(unpack(args))
end

-- Function to collect rewards
local function collectGingerbreads()
    collectEvent:FireServer()
    return true
end

-- Function to board the train
local function boardTrain()
    local args = {
        {
            carriage = workspace:WaitForChild("WinterTrainSeats"):WaitForChild("Seat")
        }
    }
    trainEvent:FireServer(unpack(args))
end

-- Function to respawn player
local function respawnPlayer()
    spawnAPI:InvokeServer()
end

-- Function to get current minute
local function getCurrentMinute()
    return os.date("*t").min
end

-- Main function to run the cycle
local function runGingerbreadCycle()
    -- Call all gingerbread IDs with 0.1 second delay
    for i, gingerbreadId in ipairs(gingerbreadIds) do
        callGingerbreadId(gingerbreadId)
        task.wait(0.1)
    end
    
    -- Immediately collect after calling all IDs
    if collectGingerbreads() then
        return true
    end
    return false
end

-- Function to update gingerbread label
local function updateGingerbreadLabel()
    local currentGingerbread = getCurrentGingerbread()
    
    if gingerbreadLabel then
        gingerbreadLabel:Set("üç™ Current Gingerbread: " .. currentGingerbread)
    end
end

-- ==================================================================
-- TRADING MODULE (Pet Giver System)
-- ==================================================================

-- Function to get unique pet types from inventory
local function updatePetInventory()
    local petInventory = {}
    
    local success, clientData = pcall(require, ReplicatedStorage.ClientModules.Core.ClientData)
    if success then
        local success2, allData = pcall(clientData.get_data, clientData)
        if success2 and allData[player.Name] and allData[player.Name].inventory and allData[player.Name].inventory.pets then
            for uniqueId, petData in pairs(allData[player.Name].inventory.pets) do
                if petData.id then
                    local petType = petData.id
                    if not petInventory[petType] then
                        petInventory[petType] = {}
                    end
                    table.insert(petInventory[petType], uniqueId)
                end
            end
        end
    end
    
    return petInventory
end

-- Function to get all players except local
local function getAvailablePlayers()
    local players = {}
    
    for _, playerObj in ipairs(Players:GetPlayers()) do
        if playerObj ~= player then
            table.insert(players, playerObj.Name)
        end
    end
    
    table.sort(players)
    return players
end

-- Function to give N pets to a player
local function giveNPetsToPlayer(targetPlayerName, petType, numPets)
    local targetPlayer = Players:FindFirstChild(targetPlayerName)
    
    if not targetPlayer then
        debugPrint("Player not found: " .. targetPlayerName)
        return false
    end
    
    local inventory = updatePetInventory()
    
    if not inventory[petType] or #inventory[petType] < numPets then
        debugPrint("Not enough " .. petType .. " pets. Have: " .. (#inventory[petType] or 0) .. ", Need: " .. numPets)
        return false
    end
    
    local petUniqueIds = {}
    for i = 1, numPets do
        if #inventory[petType] > 0 then
            table.insert(petUniqueIds, table.remove(inventory[petType], 1))
        end
    end
    
    debugPrint("Giving " .. numPets .. " " .. petType .. " to " .. targetPlayerName)
    
    for i, uniqueId in ipairs(petUniqueIds) do
        local args = {targetPlayer, uniqueId}
        
        local success, result = pcall(function()
            return ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/GiveItem"):InvokeServer(unpack(args))
        end)
        
        if success then
            debugPrint("Gave pet " .. i .. "/" .. numPets .. " to " .. targetPlayerName .. ": " .. uniqueId)
        else
            debugPrint("Failed to give pet " .. i .. " to " .. targetPlayerName .. ": " .. tostring(result))
            -- Add back if failed
            for j = i, #petUniqueIds do
                table.insert(inventory[petType], petUniqueIds[j])
            end
            return false
        end
        
        if i < numPets then
            task.wait(9)
        end
    end
    
    return true
end

-- Function to get pet type options for dropdown
local function getPetTypeOptions()
    local options = {}
    local inventory = updatePetInventory()
    
    if inventory and next(inventory) then
        for petType, pets in pairs(inventory) do
            if #pets > 0 then
                -- Get pet details for display
                local petDetails = ""
                local success, clientData = pcall(require, ReplicatedStorage.ClientModules.Core.ClientData)
                if success then
                    local playerData = clientData.get_data()[player.Name]
                    if playerData and playerData.inventory and playerData.inventory.pets then
                        for uniqueId, petData in pairs(playerData.inventory.pets) do
                            if petData.id == petType then
                                local age = petData.properties.age or 0
                                local neon = petData.properties.neon and " (Neon)" or ""
                                petDetails = string.format(" - Age: %d%s", age, neon)
                                break
                            end
                        end
                    end
                end
                
                table.insert(options, {
                    Name = petType .. " (" .. #pets .. ")" .. petDetails,
                    Value = petType
                })
            end
        end
    end
    
    table.sort(options, function(a, b)
        return a.Name < b.Name
    end)
    
    if #options == 0 then
        table.insert(options, {
            Name = "No pets found in inventory",
            Value = ""
        })
    end
    
    return options
end

-- ==================================================================
-- AUTO-START FUNCTIONALITY
-- ==================================================================

-- Function to automatically start everything
local function autoStartEverything()
    debugPrint("=== AUTO-START INITIATED ===")
    
    -- Wait a bit for game to fully load
    task.wait(5)
    
    -- Step 1: Find and select the best pet
    debugPrint("Step 1: Finding and selecting best pet...")
    local bestPetID = findBestStarterPet()
    
    if bestPetID then
        PetID = bestPetID
        lastValidPetID = bestPetID
        petFarmPetID = bestPetID
        debugPrint("Auto-selected pet with ID: " .. tostring(bestPetID))
        
        -- Try to equip the pet
        local equipSuccess = ensurePetEquipped(bestPetID, 10)
        if equipSuccess then
            debugPrint("Successfully auto-equipped pet")
        else
            debugPrint("Warning: Could not auto-equip pet, but continuing...")
        end
    else
        debugPrint("Warning: No pets found for auto-selection")
    end
    
    -- Step 2: Start Auto PetPen
    debugPrint("Step 2: Starting Auto PetPen...")
    if not AutoPetPenMode then
        toggleAutoPetPenMode()
    end
    
    -- Step 3: Start PetFarm (if we have a pet)
    if PetID then
        debugPrint("Step 3: Starting PetFarm with pet ID: " .. tostring(PetID))
        if not PetFarmMode then
            togglePetFarmMode()
        end
    else
        debugPrint("Step 3: Skipping PetFarm - no pet selected")
    end
    
    -- Step 4: Start Gingerbread Farm
    debugPrint("Step 4: Starting Gingerbread Farm...")
    isGingerbreadRunning = true
    task.spawn(function()
        while isGingerbreadRunning do
            if runGingerbreadCycle() then
                task.wait(2)
                updateGingerbreadLabel()
                
                -- Wait 10 minutes before next cycle (600 seconds)
                local waitTime = 600
                for i = waitTime, 1, -1 do
                    if not isGingerbreadRunning then break end
                    task.wait(1)
                end
            else
                task.wait(30)
            end
        end
    end)
    
    -- Step 5: Start Auto Train
    debugPrint("Step 5: Starting Auto Train...")
    isTrainRunning = true
    task.spawn(function()
        while isTrainRunning do
            local currentMinute = getCurrentMinute()
            local currentSecond = os.date("*t").sec
            
            -- Board train at 06, 16, 26, 36, 46, 56 minutes past hour
            if (currentMinute == 6 or currentMinute == 16 or currentMinute == 26 or
               currentMinute == 36 or currentMinute == 46 or currentMinute == 56) and currentSecond <= 10 then
                
                pcall(boardTrain)
                task.wait(120)
                pcall(respawnPlayer)
                task.wait(5)
            else
                local minutesUntilNextTrain
                
                if currentMinute < 6 then
                    minutesUntilNextTrain = 6 - currentMinute
                elseif currentMinute < 16 then
                    minutesUntilNextTrain = 16 - currentMinute
                elseif currentMinute < 26 then
                    minutesUntilNextTrain = 26 - currentMinute
                elseif currentMinute < 36 then
                    minutesUntilNextTrain = 36 - currentMinute
                elseif currentMinute < 46 then
                    minutesUntilNextTrain = 46 - currentMinute
                elseif currentMinute < 56 then
                    minutesUntilNextTrain = 56 - currentMinute
                else
                    minutesUntilNextTrain = (60 - currentMinute) + 6
                end
                
                local waitSeconds = (minutesUntilNextTrain * 60) - currentSecond
                
                if waitSeconds > 10 then
                    waitSeconds = waitSeconds - 5
                    for i = 1, math.floor(waitSeconds) do
                        if not isTrainRunning then break end
                        task.wait(1)
                    end
                else
                    task.wait(1)
                end
            end
        end
    end)
    
    debugPrint("=== AUTO-START COMPLETED ===")
    debugPrint("PetFarm: " .. (PetFarmMode and "RUNNING" or "STOPPED"))
    debugPrint("Auto PetPen: RUNNING")
    debugPrint("Gingerbread Farm: RUNNING | Auto Train: RUNNING")
    debugPrint("Selected Pet: " .. tostring(PetID))
end

-- ==================================================================
-- RAYFIELD GUI SETUP
-- ==================================================================

-- Create the window with COCOON title
local Window = Rayfield:CreateWindow({
   Name = "COCOON",
   LoadingTitle = "Integrated PetFarm & Winter Events",
   LoadingSubtitle = "Auto Farming Script",
   ConfigurationSaving = {
      Enabled = false,
   },
})

-- Create tabs
local PetFarmTab = Window:CreateTab("PetFarm", 6026568198) -- Pet icon
local WinterTab = Window:CreateTab("Winter Events", 4483362458) -- Snowflake icon
local BuyTab = Window:CreateTab("Buy", 6941542431) -- Shopping cart icon
local TradeTab = Window:CreateTab("Trade", 6026568198) -- Trading icon

-- ==================================================================
-- PETFARM TAB CONTROLS
-- ==================================================================

-- Create session tracking label
local sessionLabel = PetFarmTab:CreateLabel("üíµ 0 +0 | üß™ 0 +0 | ‚ôªÔ∏è 0 | ü•ö 0")

-- Function to update session display
local function updateSessionDisplay()
    local currentMoney, currentPotions = updateSessionEarnings()
    local recyclingPoints, crystalEggs = getRecyclingAndEggData()
    
    sessionLabel:Set(string.format(
        "üíµ %d +%d | üß™ %d +%d | ‚ôªÔ∏è %d | ü•ö %d",
        currentMoney, sessionBucksEarned,
        currentPotions, sessionPotionsEarned,
        recyclingPoints, crystalEggs
    ))
end

-- Pet Selection Dropdown
local petSelectionDropdown = PetFarmTab:CreateDropdown({
    Name = "üêæ Select Pet",
    Options = {{Name = "Loading pets...", Value = ""}},
    CurrentOption = "Select Pet",
    Flag = "PetSelectionDropdown",
    Callback = function(Value)
        if Value and Value ~= "" then
            PetID = Value
            lastValidPetID = Value
            debugPrint("Selected pet ID: " .. Value)
            
            -- Try to equip the selected pet
            local success = ensurePetEquipped(Value, 5)
            if success then
                Rayfield:Notify({
                    Title = "Pet Selected",
                    Content = "Successfully equipped pet",
                    Duration = 2,
                    Image = 6026568198
                })
            end
        end
    end,
})

-- Function to refresh pet dropdown
local function refreshPetSelection()
    debugPrint("Refreshing pet selection dropdown...")
    local petList = getAllPetsForDropdown()
    
    if #petList == 0 then
        petSelectionDropdown:SetOptions({{Name = "No pets found in inventory", Value = ""}})
        Rayfield:Notify({
            Title = "No Pets",
            Content = "No pets found in inventory",
            Duration = 3,
            Image = 6026568198
        })
        return
    end
    
    -- Create dropdown options
    local dropdownOptions = {}
    for _, pet in ipairs(petList) do
        table.insert(dropdownOptions, {Name = pet.Name, Value = pet.Value})
    end
    
    -- Sort by name
    table.sort(dropdownOptions, function(a, b)
        return a.Name < b.Name
    end)
    
    -- Add "Select Pet" option
    table.insert(dropdownOptions, 1, {Name = "Select a Pet", Value = ""})
    
    petSelectionDropdown:SetOptions(dropdownOptions)
    
    -- Auto-select the first pet if none is selected
    if not PetID and #dropdownOptions > 1 then
        petSelectionDropdown:Set(dropdownOptions[2])
        PetID = dropdownOptions[2].Value
        lastValidPetID = dropdownOptions[2].Value
        debugPrint("Auto-selected pet: " .. dropdownOptions[2].Name)
    end
    
    Rayfield:Notify({
        Title = "Pets Loaded",
        Content = "Found " .. (#dropdownOptions - 1) .. " pets",
        Duration = 2,
        Image = 6026568198
    })
end

-- Refresh Pets Button
PetFarmTab:CreateButton({
    Name = "üîÑ Refresh Pet List",
    Callback = function()
        refreshPetSelection()
    end,
})

-- Auto Trade Toggle
PetFarmTab:CreateToggle({
    Name = "ü§ñ Auto Trade",
    CurrentValue = false,
    Flag = "AutoTradeToggle",
    Callback = function(Value)
        toggleContinuousMode()
    end,
})

-- Auto Potion Toggle
PetFarmTab:CreateToggle({
    Name = "üß™ Auto Potion",
    CurrentValue = false,
    Flag = "AutoPotionToggle",
    Callback = function(Value)
        toggleAutoPotionMode()
    end,
})

-- Auto Accept Toggle
PetFarmTab:CreateToggle({
    Name = "‚úÖ Auto Accept",
    CurrentValue = false,
    Flag = "AutoAcceptToggle",
    Callback = function(Value)
        toggleAutoAcceptMode()
    end,
})

-- Auto PetPen Toggle
PetFarmTab:CreateToggle({
    Name = "üè† Auto PetPen",
    CurrentValue = true,
    Flag = "AutoPetPenToggle",
    Callback = function(Value)
        toggleAutoPetPenMode()
    end,
})

-- PetFarm Toggle
PetFarmTab:CreateToggle({
    Name = "üêæ PetFarm",
    CurrentValue = false,
    Flag = "PetFarmToggle",
    Callback = function(Value)
        togglePetFarmMode()
    end,
})

-- Player name input for trading
local tradePlayerName = ""
PetFarmTab:CreateInput({
    Name = "Player Name for Trade",
    PlaceholderText = "Enter player name",
    RemoveTextAfterFocusLost = false,
    Callback = function(Text)
        tradePlayerName = Text
    end,
})

-- Trade buttons
PetFarmTab:CreateButton({
    Name = "üîÑ Send Trade Request",
    Callback = function()
        if tradePlayerName and tradePlayerName ~= "" then
            -- Add trade request logic here
            debugPrint("Sending trade request to: " .. tradePlayerName)
            Rayfield:Notify({
                Title = "Trade Request",
                Content = "Sending to: " .. tradePlayerName,
                Duration = 2,
                Image = 6026568198
            })
        else
            Rayfield:Notify({
                Title = "Error",
                Content = "Enter a player name first",
                Duration = 2,
                Image = 6026568198
            })
        end
    end,
})

-- Debug button
PetFarmTab:CreateButton({
    Name = "üêõ Debug Inventory",
    Callback = function()
        debugPrint("=== DEBUG INVENTORY ===")
        local petList = getAllPetsForDropdown()
        debugPrint("Total pets found: " .. #petList)
        for i, pet in ipairs(petList) do
            debugPrint("Pet " .. i .. ": " .. pet.Name .. " (ID: " .. pet.Value .. ")")
        end
        debugPrint("=== END DEBUG ===")
        
        Rayfield:Notify({
            Title = "Debug Info",
            Content = "Check console for inventory details",
            Duration = 3,
            Image = 6026568198
        })
    end,
})

-- ==================================================================
-- WINTER EVENTS TAB CONTROLS
-- ==================================================================

gingerbreadLabel = WinterTab:CreateLabel("üç™ Current Gingerbread: " .. getCurrentGingerbread())

-- Auto Farm Gingerbread Toggle
WinterTab:CreateToggle({
    Name = "üç™ Auto Farm Gingerbread",
    CurrentValue = true, -- Auto-start enabled
    Flag = "GingerbreadToggle",
    Callback = function(Value)
        isGingerbreadRunning = Value
        if Value then
            task.spawn(function()
                while isGingerbreadRunning do
                    if runGingerbreadCycle() then
                        task.wait(2)
                        updateGingerbreadLabel()
                        
                        local waitTime = 600
                        for i = waitTime, 1, -1 do
                            if not isGingerbreadRunning then break end
                            task.wait(1)
                        end
                    else
                        task.wait(30)
                    end
                end
            end)
        end
    end,
})

-- Auto Xmas Train Toggle
WinterTab:CreateToggle({
    Name = "üöÇ Auto Xmas Train",
    CurrentValue = true, -- Auto-start enabled
    Flag = "TrainToggle",
    Callback = function(Value)
        isTrainRunning = Value
        if Value then
            task.spawn(function()
                while isTrainRunning do
                    local currentMinute = getCurrentMinute()
                    local currentSecond = os.date("*t").sec
                    
                    if (currentMinute == 6 or currentMinute == 16 or currentMinute == 26 or
                       currentMinute == 36 or currentMinute == 46 or currentMinute == 56) and currentSecond <= 10 then
                        
                        pcall(boardTrain)
                        task.wait(120)
                        pcall(respawnPlayer)
                        task.wait(5)
                    else
                        local minutesUntilNextTrain
                        
                        if currentMinute < 6 then
                            minutesUntilNextTrain = 6 - currentMinute
                        elseif currentMinute < 16 then
                            minutesUntilNextTrain = 16 - currentMinute
                        elseif currentMinute < 26 then
                            minutesUntilNextTrain = 26 - currentMinute
                        elseif currentMinute < 36 then
                            minutesUntilNextTrain = 36 - currentMinute
                        elseif currentMinute < 46 then
                            minutesUntilNextTrain = 46 - currentMinute
                        elseif currentMinute < 56 then
                            minutesUntilNextTrain = 56 - currentMinute
                        else
                            minutesUntilNextTrain = (60 - currentMinute) + 6
                        end
                        
                        local waitSeconds = (minutesUntilNextTrain * 60) - currentSecond
                        
                        if waitSeconds > 10 then
                            waitSeconds = waitSeconds - 5
                            for i = 1, math.floor(waitSeconds) do
                                if not isTrainRunning then break end
                                task.wait(1)
                            end
                        else
                            task.wait(1)
                        end
                    end
                end
            end)
        end
    end,
})

-- Xmas Mail Collect Toggle
WinterTab:CreateToggle({
    Name = "üìÆ Xmas Mail Collect",
    CurrentValue = false,
    Flag = "MailToggle",
    Callback = function(Value)
        isMailCollecting = Value
        if Value then
            task.spawn(function()
                while isMailCollecting do
                    ReplicatedStorage:WaitForChild("API"):WaitForChild("HousingAPI/ClaimAllDeliveries"):FireServer()
                    
                    local waitTime = 600
                    for i = waitTime, 1, -1 do
                        if not isMailCollecting then break end
                        task.wait(1)
                    end
                end
            end)
        end
    end,
})

-- Auto Bucks Exchange Toggle
WinterTab:CreateToggle({
    Name = "üí∞ Auto Bucks Exchange",
    CurrentValue = false,
    Flag = "BucksToggle",
    Callback = function(Value)
        isBucksExchange = Value
        if Value then
            task.spawn(function()
                while isBucksExchange do
                    for i = 1, 3 do
                        if not isBucksExchange then break end
                        ReplicatedStorage:WaitForChild("API"):WaitForChild("WinterEventAPI/UseExchangeKiosk"):InvokeServer()
                        task.wait(0.5)
                    end
                    
                    local waitTime = 600
                    for i = waitTime, 1, -1 do
                        if not isBucksExchange then break end
                        task.wait(1)
                    end
                end
            end)
        end
    end,
})

-- ==================================================================
-- BUY TAB CONTROLS
-- ==================================================================

-- Create input for number of pets to buy
BuyTab:CreateInput({
   Name = "Number of Pets to Buy",
   PlaceholderText = "Enter amount",
   RemoveTextAfterFocusLost = false,
   Callback = function(Text)
        local num = tonumber(Text)
        if num and num > 0 then
            buyCount = math.floor(num)
        else
            buyCount = 1
        end
   end,
})

-- Button to buy humbug pets
BuyTab:CreateButton({
    Name = "ü¶î Buy Humbug Pet",
    Callback = function()
        if buyCount > 0 then
            local args = {
                "pets",
                "winter_2025_humbug",
                {
                    buy_count = buyCount
                }
            }
            
            ReplicatedStorage:WaitForChild("API"):WaitForChild("ShopAPI/BuyItem"):InvokeServer(unpack(args))
            
            Rayfield:Notify({
                Title = "Purchase Complete",
                Content = "Bought " .. buyCount .. " Humbug pet(s)",
                Duration = 3,
                Image = 4483362458
            })
        end
    end,
})

-- Turtle Doves pet buying system
BuyTab:CreateButton({
    Name = "üïäÔ∏è Buy Turtle Doves Pet",
    Callback = function()
        if buyCount > 0 then
            local args = {
                "pets",
                "winter_2025_turtle_doves",
                {
                    buy_count = buyCount
                }
            }
            
            ReplicatedStorage:WaitForChild("API"):WaitForChild("ShopAPI/BuyItem"):InvokeServer(unpack(args))
            
            Rayfield:Notify({
                Title = "Purchase Complete",
                Content = "Bought " .. buyCount .. " Turtle Doves pet(s)",
                Duration = 3,
                Image = 4483362458
            })
        end
    end,
})

-- ==================================================================
-- TRADE TAB CONTROLS (Pet Giver System)
-- ==================================================================

TradeTab:CreateSection("üéÅ Pet Giver System")

-- Function to update player dropdown
local function updatePlayerDropdown(dropdown)
    local players = getAvailablePlayers()
    if dropdown then
        local options = {}
        for _, playerName in ipairs(players) do
            table.insert(options, {Name = playerName, Value = playerName})
        end
        
        if #options > 0 then
            dropdown:SetOptions(options)
            if not selectedPlayer then
                dropdown:Set(options[1])
                selectedPlayer = options[1].Value
            end
        else
            dropdown:SetOptions({{Name = "No other players online", Value = ""}})
        end
    end
end

-- Player Dropdown
local playerDropdown = TradeTab:CreateDropdown({
    Name = "üë§ Select Player",
    Options = {{Name = "Loading players...", Value = ""}},
    CurrentOption = "Select Player",
    Flag = "PlayerDropdown",
    Callback = function(Value)
        selectedPlayer = Value
        debugPrint("Selected player: " .. Value)
    end,
})

-- Pet Type Dropdown
local petTypeDropdown = TradeTab:CreateDropdown({
    Name = "üêæ Select Pet Type",
    Options = {{Name = "Loading pets...", Value = ""}},
    CurrentOption = "Select Pet Type",
    Flag = "PetTypeDropdown",
    Callback = function(Value)
        selectedPetType = Value
        debugPrint("Selected pet type: " .. Value)
    end,
})

-- Function to refresh pet type dropdown
local function refreshPetTypeDropdown()
    debugPrint("Refreshing pet type dropdown...")
    local options = getPetTypeOptions()
    
    if petTypeDropdown then
        petTypeDropdown:SetOptions(options)
        
        if #options > 0 and options[1].Value ~= "" then
            if not selectedPetType then
                petTypeDropdown:Set(options[1])
                selectedPetType = options[1].Value
            end
            debugPrint("Loaded " .. #options .. " pet types")
        else
            debugPrint("No pets found for pet type dropdown")
        end
    end
end

-- Refresh buttons
TradeTab:CreateButton({
    Name = "üîÑ Refresh Players List",
    Callback = function()
        updatePlayerDropdown(playerDropdown)
        Rayfield:Notify({
            Title = "Players Refreshed",
            Content = "Updated player list",
            Duration = 2,
            Image = 6026568198
        })
    end,
})

TradeTab:CreateButton({
    Name = "üîÑ Refresh Pet Inventory",
    Callback = function()
        refreshPetTypeDropdown()
        Rayfield:Notify({
            Title = "Inventory Refreshed",
            Content = "Updated pet inventory",
            Duration = 2,
            Image = 6026568198
        })
    end,
})

-- Give 1 Button
TradeTab:CreateButton({
    Name = "üéÅ Give 1 Pet",
    Callback = function()
        if not selectedPlayer or selectedPlayer == "" then
            Rayfield:Notify({
                Title = "Error",
                Content = "Please select a player!",
                Duration = 3,
                Image = 6026568198
            })
            return
        end
        
        if not selectedPetType or selectedPetType == "" then
            Rayfield:Notify({
                Title = "Error",
                Content = "Please select a pet type!",
                Duration = 3,
                Image = 6026568198
            })
            return
        end
        
        if giveNPetsToPlayer(selectedPlayer, selectedPetType, 1) then
            Rayfield:Notify({
                Title = "Success",
                Content = "Gave 1 " .. selectedPetType .. " to " .. selectedPlayer,
                Duration = 3,
                Image = 6026568198
            })
        else
            Rayfield:Notify({
                Title = "Failed",
                Content = "Failed to give pet! Check console for details.",
                Duration = 3,
                Image = 6026568198
            })
        end
    end,
})

-- Toggles for continuous giving
TradeTab:CreateToggle({
    Name = "üîÑ Give All (Continuous)",
    CurrentValue = false,
    Flag = "GiveAllToggle",
    Callback = function(Value)
        giveAllRunning = Value
        if Value then
            if not selectedPlayer or selectedPlayer == "" then
                Rayfield:Notify({
                    Title = "Error",
                    Content = "Select a player first!",
                    Duration = 3,
                    Image = 6026568198
                })
                giveAllRunning = false
                return
            end
            
            if not selectedPetType or selectedPetType == "" then
                Rayfield:Notify({
                    Title = "Error",
                    Content = "Select a pet type first!",
                    Duration = 3,
                    Image = 6026568198
                })
                giveAllRunning = false
                return
            end
            
            task.spawn(function()
                while giveAllRunning do
                    local inventory = updatePetInventory()
                    if inventory[selectedPetType] and #inventory[selectedPetType] > 0 then
                        giveNPetsToPlayer(selectedPlayer, selectedPetType, #inventory[selectedPetType])
                    else
                        Rayfield:Notify({
                            Title = "Give All Stopped",
                            Content = "No more " .. selectedPetType .. " pets left!",
                            Duration = 3,
                            Image = 6026568198
                        })
                        giveAllRunning = false
                        break
                    end
                    task.wait(10)
                end
            end)
        end
    end,
})

TradeTab:CreateToggle({
    Name = "4Ô∏è‚É£ Give 4 to All (Continuous)",
    CurrentValue = false,
    Flag = "Give4Toggle",
    Callback = function(Value)
        give4Running = Value
        if Value then
            if not selectedPetType or selectedPetType == "" then
                Rayfield:Notify({
                    Title = "Error",
                    Content = "Select a pet type first!",
                    Duration = 3,
                    Image = 6026568198
                })
                give4Running = false
                return
            end
            
            task.spawn(function()
                while give4Running do
                    local players = getAvailablePlayers()
                    for _, playerName in ipairs(players) do
                        if not give4Running then break end
                        
                        local inventory = updatePetInventory()
                        if inventory[selectedPetType] and #inventory[selectedPetType] >= 4 then
                            giveNPetsToPlayer(playerName, selectedPetType, 4)
                        else
                            Rayfield:Notify({
                                Title = "Give 4 Stopped",
                                Content = "Not enough " .. selectedPetType .. " pets!",
                                Duration = 3,
                                Image = 6026568198
                            })
                            give4Running = false
                            break
                        end
                        task.wait(2)
                    end
                    if give4Running then
                        task.wait(60)
                    end
                end
            end)
        end
    end,
})

TradeTab:CreateToggle({
    Name = "üéâ Giveaway (Selected Player)",
    CurrentValue = false,
    Flag = "GiveawayToggle",
    Callback = function(Value)
        giveawayRunning = Value
        if Value then
            if not selectedPlayer or selectedPlayer == "" then
                Rayfield:Notify({
                    Title = "Error",
                    Content = "Select a player first!",
                    Duration = 3,
                    Image = 6026568198
                })
                giveawayRunning = false
                return
            end
            
            task.spawn(function()
                while giveawayRunning do
                    local gave = false
                    local inventory = updatePetInventory()
                    
                    for _, petType in ipairs(targetPets) do
                        if not giveawayRunning then break end
                        
                        if inventory[petType] and #inventory[petType] > 0 then
                            if giveNPetsToPlayer(selectedPlayer, petType, 1) then
                                gave = true
                                break
                            end
                        end
                    end
                    
                    if not gave then
                        Rayfield:Notify({
                            Title = "No Target Pets",
                            Content = "No giveaway pets found in inventory!",
                            Duration = 3,
                            Image = 6026568198
                        })
                        giveawayRunning = false
                        break
                    end
                    
                    if giveawayRunning then
                        task.wait(9)
                    end
                end
            end)
        end
    end,
})

-- ==================================================================
-- INITIALIZATION AND MAIN LOOP
-- ==================================================================

-- Initialize session tracking
lastMoneyAmount, lastPotionAmount = getCurrentMoneyAndPotions()

-- Function to initialize all dropdowns
local function initializeAllDropdowns()
    debugPrint("Initializing all dropdowns...")
    
    -- Wait for game to fully load
    task.wait(3)
    
    -- Initialize pet selection dropdown
    refreshPetSelection()
    
    -- Initialize player dropdown in trade tab
    updatePlayerDropdown(playerDropdown)
    
    -- Initialize pet type dropdown in trade tab
    refreshPetTypeDropdown()
    
    debugPrint("All dropdowns initialized")
end

-- Main loop to update session display
local function mainLoop()
    while true do
        updateSessionDisplay()
        updateGingerbreadLabel()
        task.wait(1)
    end
end

-- Start the main loop
coroutine.wrap(mainLoop)()

-- Initialize dropdowns
task.spawn(initializeAllDropdowns)

-- AUTO-START: Begin automation immediately
task.wait(8) -- Wait longer for everything to initialize
autoStartEverything()

-- Auto-refresh players list every 30 seconds
task.spawn(function()
    while true do
        task.wait(30)
        updatePlayerDropdown(playerDropdown)
    end
end)

-- Delayed notification to confirm auto-start
task.wait(5)
Rayfield:Notify({
    Title = "COCOON Loaded",
    Content = "Integrated PetFarm & Winter Events auto-started!",
    Duration = 5,
    Image = 4483362458
})

-- Debug message
debugPrint("COCOON Integrated System Loaded Successfully!")
debugPrint("Features: PetFarm + Winter Events + Trading + Auto-Start")
debugPrint("All systems are now running automatically!")
