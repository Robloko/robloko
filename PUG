-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Player
local player = Players.LocalPlayer

-- Wait for player to load
if not player then
    repeat task.wait() until Players.LocalPlayer
    player = Players.LocalPlayer
end

-- Updated bait name (common internal ID pattern from similar events)
local baitName = "yarn_beanie"  -- Try "Yarn Beanie" if case-sensitive, or check inventory print

-- Taming settings
local tamesNeeded = 20  -- Number of tames required
local delayBetweenTames = 10  -- Seconds between taming attempts

-- Safe debug print
local function safePrint(...)
    local args = {...}
    local message = ""
    for i, v in ipairs(args) do
        message = message .. tostring(v) .. " "
    end
    print("[Winter Tamer] " .. message)
end

-- Safe require function
local function safeRequire(path)
    local success, result = pcall(function()
        return require(path)
    end)
    if success then
        return result
    else
        safePrint("Warning: Could not require", path, "-", result)
        return nil
    end
end

-- Safe find API function
local function safeFindAPI(apiPath)
    local current = ReplicatedStorage
    local parts = string.split(apiPath, "/")
    
    for i, part in ipairs(parts) do
        if current:FindFirstChild(part) then
            current = current[part]
        else
            return nil
        end
    end
    
    return current
end

-- Function to scan food inventory safely
local function scanFoodInventory()
    safePrint("=== SCANNING FOOD INVENTORY ===")
    
    local foods = {}
    local foundBaitId = nil
    local baitCount = 0
    
    -- Try different module paths
    local clientData = nil
    
    -- Try multiple possible paths
    local modulePaths = {
        "ClientModules.Core.ClientData",
        "ClientModules.ClientData",
        "Modules.ClientData",
        "CoreModules.ClientData"
    }
    
    for _, path in ipairs(modulePaths) do
        local module = ReplicatedStorage:FindFirstChild(path, true)
        if module then
            safePrint("Found module at:", path)
            clientData = safeRequire(module)
            if clientData then break end
        end
    end
    
    if not clientData then
        safePrint("ERROR: Could not load client data module")
        return nil, 0
    end
    
    -- Try different data access patterns
    local playerData = nil
    local success, errorMsg = pcall(function()
        -- Try different access methods
        if type(clientData) == "table" then
            if clientData.get then
                playerData = clientData.get(player.Name)
            elseif clientData.GetData then
                playerData = clientData.GetData(player.Name)
            elseif clientData.get_data then
                playerData = clientData.get_data()[player.Name]
            elseif clientData.getPlayerData then
                playerData = clientData.getPlayerData(player)
            end
        elseif type(clientData) == "function" then
            playerData = clientData()[player.Name]
        end
    end)
    
    if not success or not playerData then
        safePrint("ERROR: Could not get player data -", errorMsg or "Unknown error")
        
        -- Alternative: Try to print debug info
        safePrint("Debug: ClientData type:", type(clientData))
        if type(clientData) == "table" then
            for k, v in pairs(clientData) do
                safePrint("  Method:", k, "Type:", type(v))
            end
        end
        return nil, 0
    end
    
    if playerData and playerData.inventory and playerData.inventory.food then
        safePrint("Found food inventory with", #playerData.inventory.food, "items")
        
        for foodId, foodData in pairs(playerData.inventory.food) do
            if foodData and foodData.id then
                local foodName = tostring(foodData.id)
                local foodAmount = foodData.amount or 1
                
                local foodInfo = {
                    id = foodId,
                    name = foodName,
                    amount = foodAmount
                }
                
                table.insert(foods, foodInfo)
                
                -- Updated bait check: Look for yarn beanie with flexible matching
                local lowerName = foodName:lower()
                if lowerName == baitName:lower() or 
                   lowerName:find("yarn") and lowerName:find("beanie") or
                   lowerName:find("winter") and lowerName:find("bait") then
                    
                    foundBaitId = foodId
                    baitCount = baitCount + foodAmount
                    safePrint("‚úÖ FOUND BAIT:", foodName, "(ID:", foodId, "- Amount:", foodAmount, ")")
                end
            end
        end
    else
        safePrint("No food inventory found or empty")
    end

    -- Print all foods
    safePrint("=== FOOD INVENTORY ===")
    safePrint("Total unique food items:", #foods)
    
    -- Sort by name
    table.sort(foods, function(a, b)
        return a.name:lower() < b.name:lower()
    end)
    
    for i, food in ipairs(foods) do
        local isBait = food.name:lower():find("yarn") and food.name:lower():find("beanie")
        local prefix = isBait and "üéØ " or "   "
        safePrint(string.format("%s%d. %s - Amount: %d", 
            prefix, i, food.name, food.amount))
    end
    
    safePrint("===================================")
    safePrint("üéØ Total bait found:", baitCount)
    safePrint("===================================")
    
    return foundBaitId, baitCount
end

-- Safe API call function
local function safeAPICall(apiPath, isInvoke, ...)
    local api = safeFindAPI(apiPath)
    if not api then
        return false, "API not found: " .. apiPath
    end
    
    local args = {...}
    local success, result = pcall(function()
        if isInvoke then
            return api:InvokeServer(unpack(args))
        else
            return api:FireServer(unpack(args))
        end
    end)
    
    if not success then
        safePrint("API call failed:", apiPath, "-", result)
        return false, result
    end
    
    return true, result
end

-- Find the snowball pug with multiple search methods
local function findSnowballPug()
    safePrint("üîç Searching for Snowball Pug...")
    
    -- Try multiple locations and names
    local searchPaths = {
        workspace,  -- Direct in workspace
        workspace:FindFirstChild("Pets"),
        workspace:FindFirstChild("SnowglobeSummit"),
        workspace:FindFirstChild("WinterEvent"),
        workspace:FindFirstChild("Event"),
        workspace:FindFirstChild("Workspace")  -- Sometimes nested
    }
    
    local petNames = {
        "Snowball Pug",
        "SnowballPug", 
        "Snowball_Pug",
        "Snow Pug",
        "Winter Pug",
        "Pug"  -- Generic fallback
    }
    
    for _, location in ipairs(searchPaths) do
        if location then
            for _, petName in ipairs(petNames) do
                local pet = location:FindFirstChild(petName)
                if pet then
                    safePrint("‚úÖ Found pet:", petName, "at", location.Name)
                    return pet
                end
            end
            
            -- Also try FindFirstDescendant for deeper search
            for _, petName in ipairs(petNames) do
                local pet = location:FindFirstDescendant(petName)
                if pet then
                    safePrint("‚úÖ Found pet (descendant):", petName, "in", location.Name)
                    return pet
                end
            end
        end
    end
    
    -- Last resort: Search all of workspace
    for _, petName in ipairs(petNames) do
        local pet = workspace:FindFirstChild(petName, true)
        if pet then
            safePrint("‚úÖ Found pet (deep search):", petName)
            return pet
        end
    end
    
    safePrint("‚ùå Could not find Snowball Pug")
    return nil
end

-- Main function to auto-tame (single use)
local function autoTameWithBait()
    safePrint("üöÄ Starting taming sequence...")
    
    -- Step 1: Scan for bait
    local baitId, baitCount = scanFoodInventory()
    
    if not baitId then
        safePrint("‚ùå ERROR: Winter bait not found!")
        return false
    end
    
    if baitCount <= 0 then
        safePrint("‚ùå ERROR: No bait remaining!")
        return false
    end
    
    safePrint("üéØ Using bait ID:", baitId)
    safePrint("üéØ Bait remaining:", baitCount)
    
    -- Step 2: Equip the bait
    safePrint("üõ†Ô∏è Equipping bait...")
    local success1, result1 = safeAPICall("API/ToolAPI/Equip", true, baitId, {
        use_sound_delay = false,
        equip_as_last = false
    })
    
    if not success1 then
        safePrint("‚ö†Ô∏è Could not equip bait, trying without options...")
        success1, result1 = safeAPICall("API/ToolAPI/Equip", true, baitId)
    end
    
    if not success1 then
        safePrint("‚ùå Failed to equip bait")
        return false
    end
    
    task.wait(1)
    
    -- Step 3: Find and focus on snowball pug
    local pug = findSnowballPug()
    
    if pug then
        safePrint("üéØ Focusing on pet...")
        -- Try multiple focus APIs
        local focusAPIs = {
            "API/AdoptAPI/FocusPet",
            "API/PetAPI/FocusPet", 
            "API/EventAPI/FocusPet",
            "API/MinigameAPI/FocusTarget"
        }
        
        local focused = false
        for _, apiPath in ipairs(focusAPIs) do
            local success2, _ = safeAPICall(apiPath, false, pug)
            if success2 then
                safePrint("‚úÖ Pet focused via", apiPath)
                focused = true
                break
            end
        end
        
        if not focused then
            safePrint("‚ö†Ô∏è Could not focus pet (may not be needed)")
        end
    else
        safePrint("‚ö†Ô∏è No pet found, continuing anyway...")
    end
    
    task.wait(1.5)
    
    -- Step 4: Start using tool
    safePrint("üéØ Using bait on pet...")
    local success3, result3 = safeAPICall("API/ToolAPI/ServerUseTool", false, baitId, "START")
    if not success3 then
        safePrint("‚ùå Failed to start using bait")
        return false
    end
    
    task.wait(2.5)
    
    -- Step 5: End using tool
    safePrint("üéØ Completing bait use...")
    local success4, result4 = safeAPICall("API/ToolAPI/ServerUseTool", false, baitId, "END")
    if not success4 then
        safePrint("‚ùå Failed to end using bait")
        return false
    end
    
    task.wait(1)
    
    -- Step 6: Try to unfocus if pet exists
    if pug then
        safePrint("üîì Unfocusing pet...")
        local unfocusAPIs = {
            "API/AdoptAPI/UnfocusPet",
            "API/PetAPI/UnfocusPet",
            "API/EventAPI/UnfocusPet"
        }
        
        for _, apiPath in ipairs(unfocusAPIs) do
            safeAPICall(apiPath, false, pug)
        end
    end
    
    task.wait(1)
    
    -- Step 7: Progress taming - try multiple possible API paths
    safePrint("üìà Progressing taming...")
    
    local tamingAPIs = {
        "API/WinterEventAPI/ProgressTaming",
        "API/WinterEventAPI/TamePet", 
        "API/EventAPI/TameSnowballPug",
        "API/EventAPI/ProgressTaming",
        "API/MinigameAPI/SubmitTamingThrow",
        "API/ToolAPI/UseOnPet",
        "API/AdoptAPI/CompleteTaming",
        "API/PetAPI/CompleteTame"
    }
    
    local tamingSuccess = false
    for _, apiPath in ipairs(tamingAPIs) do
        local success5, result5 = safeAPICall(apiPath, true, false)
        if success5 then
            safePrint("‚úÖ Taming progressed via", apiPath)
            tamingSuccess = true
            break
        end
    end
    
    if not tamingSuccess then
        safePrint("‚ö†Ô∏è Could not progress taming with any API")
        safePrint("‚ö†Ô∏è Taming might still have worked - check inventory")
    else
        safePrint("üéâ Taming completed successfully!")
    end
    
    return true
end

-- To loop multiple times (since 10-20 needed):
local function runTamingSequence(times, delay)
    times = times or tamesNeeded
    delay = delay or delayBetweenTames
    
    safePrint("üîÑ Starting auto-taming sequence...")
    safePrint("üéØ Target:", times, "tames")
    safePrint("‚è±Ô∏è Delay between:", delay, "seconds")
    safePrint("===================================")
    
    local successfulTames = 0
    local failedTames = 0
    
    for i = 1, times do
        safePrint("")
        safePrint("üîÑ ATTEMPT", i, "/", times)
        safePrint("===================================")
        
        local success = autoTameWithBait()
        
        if success then
            successfulTames = successfulTames + 1
            safePrint("‚úÖ Attempt", i, "SUCCESS")
        else
            failedTames = failedTames + 1
            safePrint("‚ùå Attempt", i, "FAILED")
        end
        
        -- Check if we have bait left
        local _, baitCount = scanFoodInventory()
        if baitCount <= 0 then
            safePrint("‚ö†Ô∏è OUT OF BAIT! Stopping sequence.")
            break
        end
        
        -- Wait for next attempt (unless it's the last one)
        if i < times and baitCount > 0 then
            safePrint("‚è≥ Waiting", delay, "seconds before next attempt...")
            
            -- Countdown display
            for j = delay, 1, -1 do
                safePrint("   Next attempt in", j, "seconds...")
                task.wait(1)
            end
        end
    end
    
    safePrint("")
    safePrint("===================================")
    safePrint("üèÅ AUTO-TAMING SEQUENCE COMPLETE")
    safePrint("===================================")
    safePrint("‚úÖ Successful tames:", successfulTames)
    safePrint("‚ùå Failed tames:", failedTames)
    safePrint("üéØ Success rate:", string.format("%.1f%%", (successfulTames / times) * 100))
    safePrint("===================================")
    
    return successfulTames
end

-- Simple GUI
local function createSimpleGUI()
    -- Wait for PlayerGui
    if not player:FindFirstChild("PlayerGui") then
        player:WaitForChild("PlayerGui", 10)
    end
    
    if not player.PlayerGui then
        safePrint("Could not find PlayerGui")
        return
    end
    
    -- Remove existing GUI
    local existing = player.PlayerGui:FindFirstChild("WinterTamerGUI")
    if existing then
        existing:Destroy()
    end
    
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "WinterTamerGUI"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = player.PlayerGui
    
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 300, 0, 220)
    mainFrame.Position = UDim2.new(0, 20, 0, 20)
    mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui
    
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 8)
    UICorner.Parent = mainFrame
    
    -- Title
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 40)
    title.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
    title.BorderSizePixel = 0
    title.Text = "‚ùÑÔ∏è Snowball Pug Tamer ‚ùÑÔ∏è"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.TextSize = 16
    title.Font = Enum.Font.SourceSansBold
    title.Parent = mainFrame
    
    -- Bait count display
    local baitText = Instance.new("TextLabel")
    baitText.Size = UDim2.new(1, 0, 0, 30)
    baitText.Position = UDim2.new(0, 0, 0.2, 0)
    baitText.BackgroundTransparency = 1
    baitText.Text = "Yarn Beanie: 0"
    baitText.TextColor3 = Color3.fromRGB(200, 255, 200)
    baitText.TextSize = 14
    baitText.Font = Enum.Font.SourceSansBold
    baitText.Parent = mainFrame
    
    -- Status text
    local statusText = Instance.new("TextLabel")
    statusText.Size = UDim2.new(1, 0, 0, 20)
    statusText.Position = UDim2.new(0, 0, 0.35, 0)
    statusText.BackgroundTransparency = 1
    statusText.Text = "Status: Ready"
    statusText.TextColor3 = Color3.fromRGB(200, 200, 255)
    statusText.TextSize = 12
    statusText.Font = Enum.Font.SourceSans
    statusText.Parent = mainFrame
    
    -- Scan button
    local scanBtn = Instance.new("TextButton")
    scanBtn.Size = UDim2.new(0.9, 0, 0, 35)
    scanBtn.Position = UDim2.new(0.05, 0, 0.5, 0)
    scanBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
    scanBtn.BorderSizePixel = 0
    scanBtn.Text = "üîç SCAN INVENTORY"
    scanBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    scanBtn.TextSize = 14
    scanBtn.Font = Enum.Font.SourceSansBold
    scanBtn.Parent = mainFrame
    
    -- Single Tame button
    local tameBtn = Instance.new("TextButton")
    tameBtn.Size = UDim2.new(0.9, 0, 0, 35)
    tameBtn.Position = UDim2.new(0.05, 0, 0.7, 0)
    tameBtn.BackgroundColor3 = Color3.fromRGB(215, 80, 0)
    tameBtn.BorderSizePixel = 0
    tameBtn.Text = "üéØ SINGLE TAME"
    tameBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    tameBtn.TextSize = 14
    tameBtn.Font = Enum.Font.SourceSansBold
    tameBtn.Parent = mainFrame
    
    -- Auto Loop button
    local loopBtn = Instance.new("TextButton")
    loopBtn.Size = UDim2.new(0.9, 0, 0, 35)
    loopBtn.Position = UDim2.new(0.05, 0, 0.9, 0)
    loopBtn.BackgroundColor3 = Color3.fromRGB(120, 0, 200)
    loopBtn.BorderSizePixel = 0
    loopBtn.Text = "üîÑ AUTO-LOOP (20x)"
    loopBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    loopBtn.TextSize = 14
    loopBtn.Font = Enum.Font.SourceSansBold
    loopBtn.Parent = mainFrame
    
    -- Add corners
    for _, btn in pairs({scanBtn, tameBtn, loopBtn}) do
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 6)
        corner.Parent = btn
    end
    
    -- Update bait display function
    local function updateBaitDisplay()
        local _, baitCount = scanFoodInventory()
        baitText.Text = "üéØ Yarn Beanie: " .. baitCount
        return baitCount
    end
    
    -- Button functionality
    scanBtn.MouseButton1Click:Connect(function()
        statusText.Text = "Status: Scanning..."
        updateBaitDisplay()
        statusText.Text = "Status: Scan Complete"
    end)
    
    tameBtn.MouseButton1Click:Connect(function()
        statusText.Text = "Status: Taming..."
        tameBtn.Text = "TAMING..."
        tameBtn.BackgroundColor3 = Color3.fromRGB(150, 50, 0)
        
        local success = autoTameWithBait()
        
        if success then
            statusText.Text = "Status: Success!"
            tameBtn.Text = "‚úÖ SUCCESS!"
            task.wait(1)
            tameBtn.Text = "üéØ SINGLE TAME"
            tameBtn.BackgroundColor3 = Color3.fromRGB(215, 80, 0)
        else
            statusText.Text = "Status: Failed"
            tameBtn.Text = "‚ùå FAILED!"
            tameBtn.BackgroundColor3 = Color3.fromRGB(215, 0, 0)
            task.wait(1)
            tameBtn.Text = "üéØ SINGLE TAME"
            tameBtn.BackgroundColor3 = Color3.fromRGB(215, 80, 0)
        end
        
        updateBaitDisplay()
    end)
    
    local loopRunning = false
    loopBtn.MouseButton1Click:Connect(function()
        if loopRunning then
            loopRunning = false
            loopBtn.Text = "üîÑ AUTO-LOOP (20x)"
            loopBtn.BackgroundColor3 = Color3.fromRGB(120, 0, 200)
            statusText.Text = "Status: Loop Stopped"
        else
            local baitCount = updateBaitDisplay()
            if baitCount <= 0 then
                statusText.Text = "Status: No bait!"
                return
            end
            
            loopRunning = true
            loopBtn.Text = "‚è∏Ô∏è STOP LOOP"
            loopBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
            
            -- Run in coroutine to not freeze GUI
            coroutine.wrap(function()
                runTamingSequence(tamesNeeded, delayBetweenTames)
                loopRunning = false
                loopBtn.Text = "üîÑ AUTO-LOOP (20x)"
                loopBtn.BackgroundColor3 = Color3.fromRGB(120, 0, 200)
                updateBaitDisplay()
                statusText.Text = "Status: Loop Complete"
            end)()
        end
    end)
    
    -- Initial update
    updateBaitDisplay()
    
    safePrint("GUI created successfully!")
    return screenGui
end

-- Initialize
task.wait(3) -- Wait for game to load

safePrint("===================================")
safePrint("‚ùÑÔ∏è SNOWBALL PUG TAMER v3.0 ‚ùÑÔ∏è")
safePrint("===================================")
safePrint("Bait name:", baitName)
safePrint("Tames needed:", tamesNeeded)
safePrint("Delay between:", delayBetweenTames, "seconds")
safePrint("===================================")

-- Initial scan
task.wait(1)
scanFoodInventory()

-- Create GUI after delay
task.wait(2)
createSimpleGUI()

safePrint("===================================")
safePrint("‚úÖ System Ready!")
safePrint("Commands:")
safePrint("1. scanFoodInventory()")
safePrint("2. autoTameWithBait()")
safePrint("3. runTamingSequence(20, 10)")
safePrint("===================================")

-- Export functions to global for manual use
_G.scanFoodInventory = scanFoodInventory
_G.autoTameWithBait = autoTameWithBait
_G.runTamingSequence = runTamingSequence
_G.findSnowballPug = findSnowballPug

safePrint("üìù Functions exported to _G for manual use")
