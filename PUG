-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Player
local player = Players.LocalPlayer

-- Wait for player to load
if not player then
    repeat task.wait() until Players.LocalPlayer
    player = Players.LocalPlayer
end

-- Safe debug print
local function safePrint(...)
    local args = {...}
    local message = ""
    for i, v in ipairs(args) do
        message = message .. tostring(v) .. " "
    end
    print("[Food Scanner] " .. message)
end

-- Safe require function
local function safeRequire(path)
    local success, result = pcall(function()
        return require(path)
    end)
    if success then
        return result
    else
        safePrint("Warning: Could not require", path, "-", result)
        return nil
    end
end

-- Safe find API function
local function safeFindAPI(apiPath)
    local current = ReplicatedStorage
    local parts = string.split(apiPath, "/")
    
    for i, part in ipairs(parts) do
        if current:FindFirstChild(part) then
            current = current[part]
        else
            safePrint("API not found:", apiPath)
            return nil
        end
    end
    
    return current
end

-- Function to scan food inventory safely
local function scanFoodInventory()
    safePrint("=== SCANNING FOOD INVENTORY ===")
    
    local foods = {}
    local foundBaitId = nil
    local baitName = "winter_2025_yarn_beanie_bait"
    
    local clientData = safeRequire(ReplicatedStorage:FindFirstChild("ClientModules"))
    if not clientData then
        clientData = safeRequire(ReplicatedStorage:WaitForChild("ClientModules", 5))
    end
    
    if not clientData then
        safePrint("ERROR: Could not load ClientModules")
        return nil
    end
    
    -- Try different possible paths
    local playerData = nil
    local success, errorMsg = pcall(function()
        -- Try different data access patterns
        if clientData.get then
            playerData = clientData.get(player.Name)
        elseif clientData.GetData then
            playerData = clientData.GetData(player.Name)
        elseif clientData.get_data then
            playerData = clientData.get_data()[player.Name]
        elseif type(clientData) == "function" then
            playerData = clientData()[player.Name]
        end
    end)
    
    if not success then
        safePrint("ERROR: Could not get player data -", errorMsg)
        return nil
    end
    
    if playerData and playerData.inventory and playerData.inventory.food then
        for foodId, foodData in pairs(playerData.inventory.food) do
            if foodData and foodData.id then
                local foodInfo = {
                    id = foodId,
                    name = foodData.id,
                    amount = foodData.amount or 1
                }
                
                table.insert(foods, foodInfo)
                
                -- Check for winter bait
                if tostring(foodData.id):lower() == baitName:lower() then
                    foundBaitId = foodId
                    safePrint("FOUND Winter bait:", foodId, "- Amount:", foodInfo.amount)
                end
            end
        end
    else
        safePrint("No food inventory found or empty")
    end

    -- Print all foods
    safePrint("Food items found:", #foods)
    for i, food in ipairs(foods) do
        safePrint(string.format("%d. %s (ID: %s) - Amount: %d", 
            i, food.name, food.id:sub(1, 10) .. "...", food.amount))
    end
    
    safePrint("===================================")
    
    return foundBaitId
end

-- Safe API call function
local function safeAPICall(apiPath, isInvoke, ...)
    local api = safeFindAPI(apiPath)
    if not api then
        safePrint("API not available:", apiPath)
        return false, "API not found"
    end
    
    local args = {...}
    local success, result = pcall(function()
        if isInvoke then
            return api:InvokeServer(unpack(args))
        else
            return api:FireServer(unpack(args))
        end
    end)
    
    if not success then
        safePrint("API call failed:", apiPath, "-", result)
        return false, result
    end
    
    return true, result
end

-- Main function to auto-tame
local function autoTameWithBait()
    safePrint("Starting auto-tamer...")
    
    -- Step 1: Scan for bait
    local baitId = scanFoodInventory()
    
    if not baitId then
        safePrint("ERROR: Winter bait not found!")
        return false
    end
    
    safePrint("Using bait ID:", baitId)
    
    -- Step 2: Equip the bait
    safePrint("Equipping bait...")
    local success1 = safeAPICall("API/ToolAPI/Equip", true, baitId, {
        use_sound_delay = false,
        equip_as_last = false
    })
    
    if not success1 then
        safePrint("Failed to equip bait")
        return false
    end
    
    task.wait(0.5)
    
    -- Step 3: Try to find and focus on dog
    safePrint("Looking for dog...")
    
    -- Try to find dog in workspace
    local dog = workspace:FindFirstChild("Pets") and workspace.Pets:FindFirstChild("Dog")
    
    if dog then
        safePrint("Found dog, focusing...")
        local success2 = safeAPICall("API/AdoptAPI/FocusPet", false, dog)
        if not success2 then
            safePrint("Warning: Could not focus pet")
        end
    else
        safePrint("Warning: No dog found in workspace")
    end
    
    task.wait(1)
    
    -- Step 4: Start using tool
    safePrint("Using bait...")
    local success3 = safeAPICall("API/ToolAPI/ServerUseTool", false, baitId, "START")
    if not success3 then
        safePrint("Failed to start using bait")
        return false
    end
    
    task.wait(2)
    
    -- Step 5: End using tool
    safePrint("Ending bait use...")
    local success4 = safeAPICall("API/ToolAPI/ServerUseTool", false, baitId, "END")
    if not success4 then
        safePrint("Failed to end using bait")
        return false
    end
    
    task.wait(0.5)
    
    -- Step 6: Try to unfocus if dog exists
    if dog then
        safePrint("Unfocusing pet...")
        safeAPICall("API/AdoptAPI/UnfocusPet", false, dog)
    end
    
    task.wait(0.5)
    
    -- Step 7: Progress taming - try multiple possible API paths
    safePrint("Progressing taming...")
    
    local tamingAPIs = {
        "API/WinterEventAPI/ProgressTaming",
        "API/EventAPI/ProgressTaming",
        "API/ProgressTaming",
        "API/HalloweenEventAPI/ProgressTaming"  -- Try similar API
    }
    
    local tamingSuccess = false
    for _, apiPath in ipairs(tamingAPIs) do
        local success5 = safeAPICall(apiPath, true, false)
        if success5 then
            safePrint("Taming progressed via", apiPath)
            tamingSuccess = true
            break
        end
    end
    
    if not tamingSuccess then
        safePrint("Warning: Could not progress taming with any API")
    end
    
    safePrint("Taming sequence completed!")
    
    -- Rescan inventory
    task.wait(1)
    safePrint("Rescanning inventory...")
    scanFoodInventory()
    
    return true
end

-- Simple GUI
local function createSimpleGUI()
    -- Wait for PlayerGui
    if not player:FindFirstChild("PlayerGui") then
        player:WaitForChild("PlayerGui", 10)
    end
    
    if not player.PlayerGui then
        safePrint("Could not find PlayerGui")
        return
    end
    
    -- Remove existing GUI
    local existing = player.PlayerGui:FindFirstChild("SimpleFoodTamer")
    if existing then
        existing:Destroy()
    end
    
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "SimpleFoodTamer"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = player.PlayerGui
    
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 250, 0, 180)
    mainFrame.Position = UDim2.new(0, 20, 0, 20)
    mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui
    
    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0, 8)
    UICorner.Parent = mainFrame
    
    -- Title
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 40)
    title.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
    title.BorderSizePixel = 0
    title.Text = "Winter Tamer v2"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.TextSize = 16
    title.Font = Enum.Font.SourceSansBold
    title.Parent = mainFrame
    
    -- Status text
    local statusText = Instance.new("TextLabel")
    statusText.Size = UDim2.new(1, 0, 0, 30)
    statusText.Position = UDim2.new(0, 0, 0.25, 0)
    statusText.BackgroundTransparency = 1
    statusText.Text = "Status: Ready"
    statusText.TextColor3 = Color3.fromRGB(200, 200, 255)
    statusText.TextSize = 14
    statusText.Font = Enum.Font.SourceSans
    statusText.Parent = mainFrame
    
    -- Scan button
    local scanBtn = Instance.new("TextButton")
    scanBtn.Size = UDim2.new(0.9, 0, 0, 35)
    scanBtn.Position = UDim2.new(0.05, 0, 0.45, 0)
    scanBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
    scanBtn.BorderSizePixel = 0
    scanBtn.Text = "SCAN FOOD"
    scanBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    scanBtn.TextSize = 14
    scanBtn.Font = Enum.Font.SourceSansBold
    scanBtn.Parent = mainFrame
    
    -- Tame button
    local tameBtn = Instance.new("TextButton")
    tameBtn.Size = UDim2.new(0.9, 0, 0, 35)
    tameBtn.Position = UDim2.new(0.05, 0, 0.75, 0)
    tameBtn.BackgroundColor3 = Color3.fromRGB(215, 80, 0)
    tameBtn.BorderSizePixel = 0
    tameBtn.Text = "AUTO-TAME"
    tameBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    tameBtn.TextSize = 14
    tameBtn.Font = Enum.Font.SourceSansBold
    tameBtn.Parent = mainFrame
    
    -- Add corners
    for _, btn in pairs({scanBtn, tameBtn}) do
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 6)
        corner.Parent = btn
    end
    
    -- Button functionality
    scanBtn.MouseButton1Click:Connect(function()
        statusText.Text = "Status: Scanning..."
        scanFoodInventory()
        statusText.Text = "Status: Scan Complete"
    end)
    
    tameBtn.MouseButton1Click:Connect(function()
        statusText.Text = "Status: Taming..."
        tameBtn.Text = "TAMING..."
        tameBtn.BackgroundColor3 = Color3.fromRGB(150, 50, 0)
        
        local success = autoTameWithBait()
        
        if success then
            statusText.Text = "Status: Success!"
            tameBtn.Text = "SUCCESS!"
            task.wait(1)
            tameBtn.Text = "AUTO-TAME"
            tameBtn.BackgroundColor3 = Color3.fromRGB(215, 80, 0)
        else
            statusText.Text = "Status: Failed"
            tameBtn.Text = "FAILED!"
            tameBtn.BackgroundColor3 = Color3.fromRGB(215, 0, 0)
            task.wait(1)
            tameBtn.Text = "AUTO-TAME"
            tameBtn.BackgroundColor3 = Color3.fromRGB(215, 80, 0)
        end
    end)
    
    safePrint("GUI created successfully!")
    return screenGui
end

-- Initialize
task.wait(2) -- Wait for game to load

safePrint("===================================")
safePrint("FOOD SCANNER & AUTO-TAMER")
safePrint("Version: 2.1 (Safe Mode)")
safePrint("===================================")

-- Initial scan
task.wait(1)
scanFoodInventory()

-- Create GUI after delay
task.wait(2)
createSimpleGUI()

safePrint("===================================")
safePrint("System Ready!")
safePrint("Commands:")
safePrint("1. scanFoodInventory()")
safePrint("2. autoTameWithBait()")
safePrint("===================================")
