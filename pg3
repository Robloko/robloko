-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")

-- Local player
local localPlayer = Players.LocalPlayer
local playerGui = localPlayer:WaitForChild("PlayerGui")

-- Create ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "PetGiverUI"
screenGui.Parent = playerGui
screenGui.ResetOnSpawn = false

-- Main Frame (top center, even smaller and more compact, lower position)
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 240, 0, 85)
mainFrame.Position = UDim2.new(0.5, -120, 0, 20) -- Slightly lower from top
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BorderSizePixel = 0
mainFrame.BackgroundTransparency = 0.1
mainFrame.Parent = screenGui

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 6)
mainCorner.Parent = mainFrame

-- Title (smaller)
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 12)
title.Position = UDim2.new(0, 0, 0, 0)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Text = "üéÅ Pet Giver"
title.Font = Enum.Font.SourceSansBold
title.TextSize = 11
title.Parent = mainFrame

-- Give All Button (Row 1 Left)
local giveAllButton = Instance.new("TextButton")
giveAllButton.Size = UDim2.new(0, 115, 0, 16)
giveAllButton.Position = UDim2.new(0, 5, 0, 12)
giveAllButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
giveAllButton.TextColor3 = Color3.fromRGB(255, 255, 255)
giveAllButton.Text = "Give All [OFF]"
giveAllButton.Font = Enum.Font.SourceSansBold
giveAllButton.TextSize = 8
giveAllButton.Parent = mainFrame

local giveAllCorner = Instance.new("UICorner")
giveAllCorner.CornerRadius = UDim.new(0, 4)
giveAllCorner.Parent = giveAllButton

-- Give 4 to All Button (Row 1 Right)
local give4ToAllButton = Instance.new("TextButton")
give4ToAllButton.Size = UDim2.new(0, 115, 0, 16)
give4ToAllButton.Position = UDim2.new(0, 120, 0, 12)
give4ToAllButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
give4ToAllButton.TextColor3 = Color3.fromRGB(255, 255, 255)
give4ToAllButton.Text = "Give 4 to All [OFF]"
give4ToAllButton.Font = Enum.Font.SourceSansBold
give4ToAllButton.TextSize = 8
give4ToAllButton.Parent = mainFrame

local give4ToAllCorner = Instance.new("UICorner")
give4ToAllCorner.CornerRadius = UDim.new(0, 4)
give4ToAllCorner.Parent = give4ToAllButton

-- 1 Give Button (Row 2 Left)
local oneGiveButton = Instance.new("TextButton")
oneGiveButton.Size = UDim2.new(0, 115, 0, 16)
oneGiveButton.Position = UDim2.new(0, 5, 0, 30)
oneGiveButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
oneGiveButton.TextColor3 = Color3.fromRGB(255, 255, 255)
oneGiveButton.Text = "1 Give"
oneGiveButton.Font = Enum.Font.SourceSansBold
oneGiveButton.TextSize = 8
oneGiveButton.Parent = mainFrame

local oneGiveCorner = Instance.new("UICorner")
oneGiveCorner.CornerRadius = UDim.new(0, 4)
oneGiveCorner.Parent = oneGiveButton

-- Giveaway Button (Row 2 Right)
local giveawayButton = Instance.new("TextButton")
giveawayButton.Size = UDim2.new(0, 115, 0, 16)
giveawayButton.Position = UDim2.new(0, 120, 0, 30)
giveawayButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
giveawayButton.TextColor3 = Color3.fromRGB(255, 255, 255)
giveawayButton.Text = "Giveaway [OFF]"
giveawayButton.Font = Enum.Font.SourceSansBold
giveawayButton.TextSize = 8
giveawayButton.Parent = mainFrame

local giveawayCorner = Instance.new("UICorner")
giveawayCorner.CornerRadius = UDim.new(0, 4)
giveawayCorner.Parent = giveawayButton

-- Players Dropdown Frame (Bottom Left, smaller)
local playersDropdownFrame = Instance.new("Frame")
playersDropdownFrame.Size = UDim2.new(0, 115, 0, 25)
playersDropdownFrame.Position = UDim2.new(0, 5, 0, 48)
playersDropdownFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
playersDropdownFrame.BorderSizePixel = 0
playersDropdownFrame.BackgroundTransparency = 0.1
playersDropdownFrame.Parent = mainFrame

local playersCorner = Instance.new("UICorner")
playersCorner.CornerRadius = UDim.new(0, 4)
playersCorner.Parent = playersDropdownFrame

local playersTitle = Instance.new("TextLabel")
playersTitle.Size = UDim2.new(1, 0, 0, 10)
playersTitle.Position = UDim2.new(0, 0, 0, 0)
playersTitle.BackgroundTransparency = 1
playersTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
playersTitle.Text = "Player"
playersTitle.Font = Enum.Font.SourceSansBold
playersTitle.TextSize = 8
playersTitle.TextXAlignment = Enum.TextXAlignment.Left
playersTitle.Parent = playersDropdownFrame

local playersButton = Instance.new("TextButton")
playersButton.Size = UDim2.new(1, 0, 0, 15)
playersButton.Position = UDim2.new(0, 0, 0, 10)
playersButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
playersButton.TextColor3 = Color3.fromRGB(255, 255, 255)
playersButton.Text = "Choose"
playersButton.Font = Enum.Font.SourceSans
playersButton.TextSize = 8
playersButton.Parent = playersDropdownFrame

local playersButtonCorner = Instance.new("UICorner")
playersButtonCorner.CornerRadius = UDim.new(0, 4)
playersButtonCorner.Parent = playersButton

local playersListFrame = Instance.new("ScrollingFrame")
playersListFrame.Size = UDim2.new(1, 0, 0, 100)
playersListFrame.Position = UDim2.new(0, 0, 1, 0)
playersListFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
playersListFrame.BorderSizePixel = 0
playersListFrame.Visible = false
playersListFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
playersListFrame.ScrollBarThickness = 3
playersListFrame.Parent = playersDropdownFrame

local playersListCorner = Instance.new("UICorner")
playersListCorner.CornerRadius = UDim.new(0, 4)
playersListCorner.Parent = playersListFrame

-- Pets Dropdown Frame (Bottom Right, smaller)
local petsDropdownFrame = Instance.new("Frame")
petsDropdownFrame.Size = UDim2.new(0, 115, 0, 25)
petsDropdownFrame.Position = UDim2.new(0, 120, 0, 48)
petsDropdownFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
petsDropdownFrame.BorderSizePixel = 0
petsDropdownFrame.BackgroundTransparency = 0.1
petsDropdownFrame.Parent = mainFrame

local petsCorner = Instance.new("UICorner")
petsCorner.CornerRadius = UDim.new(0, 4)
petsCorner.Parent = petsDropdownFrame

local petsTitle = Instance.new("TextLabel")
petsTitle.Size = UDim2.new(1, 0, 0, 10)
petsTitle.Position = UDim2.new(0, 0, 0, 0)
petsTitle.BackgroundTransparency = 1
petsTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
petsTitle.Text = "Pet Type"
petsTitle.Font = Enum.Font.SourceSansBold
petsTitle.TextSize = 8
petsTitle.TextXAlignment = Enum.TextXAlignment.Left
petsTitle.Parent = petsDropdownFrame

local petsButton = Instance.new("TextButton")
petsButton.Size = UDim2.new(1, 0, 0, 15)
petsButton.Position = UDim2.new(0, 0, 0, 10)
petsButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
petsButton.TextColor3 = Color3.fromRGB(255, 255, 255)
petsButton.Text = "Choose"
petsButton.Font = Enum.Font.SourceSans
petsButton.TextSize = 8
petsButton.Parent = petsDropdownFrame

local petsButtonCorner = Instance.new("UICorner")
petsButtonCorner.CornerRadius = UDim.new(0, 4)
petsButtonCorner.Parent = petsButton

local petsListFrame = Instance.new("ScrollingFrame")
petsListFrame.Size = UDim2.new(1, 0, 0, 100)
petsListFrame.Position = UDim2.new(0, 0, 1, 0)
petsListFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
petsListFrame.BorderSizePixel = 0
petsListFrame.Visible = false
petsListFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
petsListFrame.ScrollBarThickness = 3
petsListFrame.Parent = petsDropdownFrame

local petsListCorner = Instance.new("UICorner")
petsListCorner.CornerRadius = UDim.new(0, 4)
petsListCorner.Parent = petsListFrame

-- Variables
local selectedPlayer = nil
local selectedPetType = nil
local petInventory = {}
local receivedPlayers = {}
local giveAllRunning = false
local give4Running = false
local giveawayRunning = false
local giveAllCoroutine = nil
local give4Coroutine = nil
local giveawayCoroutine = nil
local playerCycle = {}
local currentPlayerIndex = 1
local targetPets = {
    "basic_egg_2022_ant",
    "basic_egg_2022_mouse",
    "basic_egg_2022_camel",
    "basic_egg_2022_poodle",
    "basic_egg_2022_donkey",
    "basic_egg_2022_zebra",
    "basic_egg_2022_orangutan",
    "basic_egg_2022_parakeet",
    "basic_egg_2022_swordfish",
    "basic_egg_2022_robot",
    "basic_egg_2022_corgi"
}

-- Function to get all players except local
local function updatePlayersDropdown()
    local playersList = {}
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= localPlayer then
            table.insert(playersList, plr.Name)
        end
    end
    table.sort(playersList)

    -- Clear list
    for _, child in ipairs(playersListFrame:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end

    for i, playerName in ipairs(playersList) do
        local optionButton = Instance.new("TextButton")
        optionButton.Size = UDim2.new(1, 0, 0, 14)
        optionButton.Position = UDim2.new(0, 0, 0, (i-1)*14)
        optionButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        optionButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        optionButton.Text = playerName
        optionButton.Font = Enum.Font.SourceSans
        optionButton.TextSize = 8
        optionButton.Parent = playersListFrame

        optionButton.MouseButton1Click:Connect(function()
            playersButton.Text = playerName
            selectedPlayer = Players:FindFirstChild(playerName)
            playersListFrame.Visible = false
            print("Selected player: " .. playerName)
        end)
    end

    playersListFrame.CanvasSize = UDim2.new(0, 0, 0, #playersList * 14)
end

-- Function to get unique pet types from inventory
local function updatePetsDropdown()
    petInventory = {}
    local uniqueTypes = {}

    local success, clientData = pcall(require, ReplicatedStorage.ClientModules.Core.ClientData)
    if success then
        local success2, allData = pcall(clientData.get_data, clientData)
        if success2 and allData[localPlayer.Name] and allData[localPlayer.Name].inventory and allData[localPlayer.Name].inventory.pets then
            for uniqueId, petData in pairs(allData[localPlayer.Name].inventory.pets) do
                if petData.id then
                    local petType = petData.id
                    if not uniqueTypes[petType] then
                        uniqueTypes[petType] = {}
                    end
                    table.insert(uniqueTypes[petType], uniqueId)
                    petInventory[petType] = uniqueTypes[petType]
                end
            end
        end
    end

    local typesList = {}
    for petType, _ in pairs(uniqueTypes) do
        table.insert(typesList, petType)
    end
    table.sort(typesList)

    -- Clear list
    for _, child in ipairs(petsListFrame:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end

    for i, petType in ipairs(typesList) do
        local optionButton = Instance.new("TextButton")
        optionButton.Size = UDim2.new(1, 0, 0, 14)
        optionButton.Position = UDim2.new(0, 0, 0, (i-1)*14)
        optionButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
        optionButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        optionButton.Text = petType .. " (" .. #petInventory[petType] .. ")"
        optionButton.Font = Enum.Font.SourceSans
        optionButton.TextSize = 8
        optionButton.Parent = petsListFrame

        optionButton.MouseButton1Click:Connect(function()
            petsButton.Text = petType .. " (" .. #petInventory[petType] .. ")"
            selectedPetType = petType
            petsListFrame.Visible = false
            print("Selected pet type: " .. petType)
        end)
    end

    petsListFrame.CanvasSize = UDim2.new(0, 0, 0, #typesList * 14)
end

-- Toggle players dropdown
local playersToggle = false
playersButton.MouseButton1Click:Connect(function()
    playersToggle = not playersToggle
    playersListFrame.Visible = playersToggle
    if playersToggle then
        updatePlayersDropdown()
    end
end)

-- Toggle pets dropdown
local petsToggle = false
petsButton.MouseButton1Click:Connect(function()
    petsToggle = not petsToggle
    petsListFrame.Visible = petsToggle
    if petsToggle then
        updatePetsDropdown()
    end
end)

-- Function to give N pets to a player
local function giveNPetsToPlayer(targetPlayer, petType, numPets)
    if not petInventory[petType] or #petInventory[petType] < numPets then
        print("Not enough " .. petType .. " pets for " .. targetPlayer.Name)
        return false
    end

    local petUniqueIds = {}
    for i = 1, numPets do
        table.insert(petUniqueIds, table.remove(petInventory[petType], 1))
    end

    print("Giving " .. numPets .. " " .. petType .. " to " .. targetPlayer.Name)

    for i, uniqueId in ipairs(petUniqueIds) do
        local args = {
            targetPlayer,
            uniqueId
        }
        local success, result = pcall(function()
            return ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/GiveItem"):InvokeServer(unpack(args))
        end)
        if success then
            print("Gave pet " .. i .. "/" .. numPets .. " to " .. targetPlayer.Name .. ": " .. uniqueId)
            updatePetsDropdown() -- Sync after each give
        else
            print("Failed to give pet " .. i .. " to " .. targetPlayer.Name .. ": " .. tostring(result))
            -- Add back if failed
            for j = #petUniqueIds, i, -1 do
                table.insert(petInventory[petType], petUniqueIds[j])
            end
            return false
        end
        if i < numPets then
            task.wait(9)
        end
    end

    return true
end

-- Start continuous Give All
local function startGiveAll()
    while giveAllRunning do
        if selectedPlayer and selectedPetType and petInventory[selectedPetType] and #petInventory[selectedPetType] > 0 then
            giveNPetsToPlayer(selectedPlayer, selectedPetType, #petInventory[selectedPetType])
        end
        task.wait(10) -- Scan every 10s
    end
end

-- Give All Button Toggle
giveAllButton.MouseButton1Click:Connect(function()
    giveAllRunning = not giveAllRunning
    if giveAllRunning then
        giveAllButton.Text = "Give All [ON]"
        giveAllButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
        giveAllCoroutine = coroutine.wrap(startGiveAll)()
    else
        giveAllButton.Text = "Give All [OFF]"
        giveAllButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    end
end)

-- Start continuous Give 4 to All
local function startGive4ToAll()
    while give4Running do
        receivedPlayers = {} -- Reset per cycle
        local allPlayers = {}
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr ~= localPlayer then
                table.insert(allPlayers, plr)
            end
        end
        for _, targetPlayer in ipairs(allPlayers) do
            if selectedPetType and petInventory[selectedPetType] and #petInventory[selectedPetType] >= 4 then
                giveNPetsToPlayer(targetPlayer, selectedPetType, 4)
                receivedPlayers[targetPlayer.Name] = true
            end
            task.wait(2) -- Delay between players
        end
        task.wait(60) -- Wait 1 min before next cycle
    end
end

-- Give 4 to All Button Toggle
give4ToAllButton.MouseButton1Click:Connect(function()
    give4Running = not give4Running
    if give4Running then
        give4ToAllButton.Text = "Give 4 to All [ON]"
        give4ToAllButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
        give4Coroutine = coroutine.wrap(startGive4ToAll)()
    else
        give4ToAllButton.Text = "Give 4 to All [OFF]"
        give4ToAllButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    end
end)

-- 1 Give Button Click
oneGiveButton.MouseButton1Click:Connect(function()
    if not selectedPlayer or not selectedPetType or not petInventory[selectedPetType] or #petInventory[selectedPetType] == 0 then
        print("Please select a player and pet type with at least 1 pet!")
        return
    end
    oneGiveButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
    giveNPetsToPlayer(selectedPlayer, selectedPetType, 1)
    oneGiveButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
end)

-- Start continuous Giveaway
local function startGiveaway()
    -- Initialize player cycle
    playerCycle = {}
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= localPlayer then
            table.insert(playerCycle, plr)
        end
    end
    if #playerCycle == 0 then
        giveawayRunning = false
        return
    end
    currentPlayerIndex = 1
    while giveawayRunning do
        local gave = false
        for _, ptype in ipairs(targetPets) do
            if petInventory[ptype] and #petInventory[ptype] > 0 then
                local uid = table.remove(petInventory[ptype], 1)
                local target = playerCycle[currentPlayerIndex]
                local args = {target, uid}
                local success, result = pcall(function()
                    return ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/GiveItem"):InvokeServer(unpack(args))
                end)
                if success then
                    print("Giveaway: Gave " .. ptype .. " to " .. target.Name)
                    updatePetsDropdown() -- Sync
                    currentPlayerIndex = (currentPlayerIndex % #playerCycle) + 1
                    gave = true
                    break
                else
                    print("Giveaway failed: " .. tostring(result))
                    table.insert(petInventory[ptype], uid) -- Put back
                end
            end
        end
        if not gave then
            task.wait(5) -- Wait if no trash pets
        end
        task.wait(9) -- Delay between gives
    end
end

-- Giveaway Button Toggle
giveawayButton.MouseButton1Click:Connect(function()
    giveawayRunning = not giveawayRunning
    if giveawayRunning then
        giveawayButton.Text = "Giveaway [ON]"
        giveawayButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
        giveawayCoroutine = coroutine.wrap(startGiveaway)()
    else
        giveawayButton.Text = "Giveaway [OFF]"
        giveawayButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    end
end)

-- Initial updates
updatePlayersDropdown()
updatePetsDropdown()

-- Periodic refresh for pets (inventory changes) and players
spawn(function()
    while true do
        task.wait(30)
        updatePetsDropdown()
        updatePlayersDropdown()
        -- Refresh player cycle for giveaway if running
        if giveawayRunning then
            local tempCycle = {}
            for _, plr in ipairs(Players:GetPlayers()) do
                if plr ~= localPlayer then
                    table.insert(tempCycle, plr)
                end
            end
            playerCycle = tempCycle
            if #playerCycle > 0 then
                currentPlayerIndex = currentPlayerIndex % #playerCycle + 1
            end
        end
    end
end)

print("Ultra-Compact Pet Giver UI Loaded! Positioned lower at top center.")
