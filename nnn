-- Load Rayfield UI Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Create the main window
local Window = Rayfield:CreateWindow({
    Name = "Player Manager",
    LoadingTitle = "Loading Player Manager...",
    LoadingSubtitle = "by YourName",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "PlayerManager",
        FileName = "Config"
    },
    Discord = {
        Enabled = false,
        Invite = "noinvitelink",
        RememberJoins = true
    },
    KeySystem = false,
})

-- Variables
local selectedPlayer = "None"
local PlayerDropdown

-- Create the main tab
local MainTab = Window:CreateTab("Players", 4483362458)

-- Function to get player names (excluding yourself)
local function getPlayerNames()
    local names = {"None"}
    local localPlayerName = game.Players.LocalPlayer.Name
    
    for _, player in ipairs(game.Players:GetPlayers()) do
        if player.Name ~= localPlayerName then
            table.insert(names, player.Name)
        end
    end
    return names
end

-- Create the dropdown with initial options
PlayerDropdown = MainTab:CreateDropdown({
    Name = "Select Player",
    Options = getPlayerNames(), -- Initialize with current players
    CurrentOption = {"None"},
    MultipleOptions = false,
    Flag = "PlayerDropdown",
    Callback = function(Option)
        selectedPlayer = Option[1] -- Get first selected option
        print("Selected player:", selectedPlayer)
        
        Rayfield:Notify({
            Title = "Player Selected",
            Content = "Selected: " .. selectedPlayer,
            Duration = 2,
            Image = 4483362458
        })
    end,
})

-- Create sections
local PlayerSection = MainTab:CreateSection("Player List")

-- Refresh button (using correct Refresh() method)
MainTab:CreateButton({
    Name = "Refresh Player List",
    Callback = function()
        local playerNames = getPlayerNames()
        local playerCount = #playerNames - 1 -- Subtract 1 for "None" option
        
        -- CORRECT METHOD: Refresh the dropdown with new options
        PlayerDropdown:Refresh(playerNames)
        
        Rayfield:Notify({
            Title = "Refreshed",
            Content = "Found " .. playerCount .. " players",
            Duration = 3,
            Image = 4483362458
        })
        
        print("Refreshed player list. Options:", table.concat(playerNames, ", "))
    end,
})

-- Player actions section
local ActionsSection = MainTab:CreateSection("Player Actions")

-- Teleport to player
MainTab:CreateButton({
    Name = "Teleport to Player",
    Callback = function()
        if selectedPlayer and selectedPlayer ~= "None" then
            local target = game.Players:FindFirstChild(selectedPlayer)
            if target and target.Character then
                local hrp = target.Character:FindFirstChild("HumanoidRootPart")
                local localPlayer = game.Players.LocalPlayer
                if localPlayer.Character and hrp then
                    -- Teleport to player
                    localPlayer.Character:MoveTo(hrp.Position)
                    Rayfield:Notify({
                        Title = "Teleported",
                        Content = "Teleported to " .. selectedPlayer,
                        Duration = 3,
                        Image = 4483362458
                    })
                else
                    Rayfield:Notify({
                        Title = "Error",
                        Content = "Cannot teleport - character issue",
                        Duration = 3,
                        Image = 4483362458
                    })
                end
            else
                Rayfield:Notify({
                    Title = "Error",
                    Content = "Player or character not found",
                    Duration = 3,
                    Image = 4483362458
                })
            end
        else
            Rayfield:Notify({
                Title = "No Player Selected",
                Content = "Please select a player first",
                Duration = 3,
                Image = 4483362458
            })
        end
    end,
})

-- View player info
MainTab:CreateButton({
    Name = "Show Player Info",
    Callback = function()
        if selectedPlayer and selectedPlayer ~= "None" then
            local target = game.Players:FindFirstChild(selectedPlayer)
            if target then
                Rayfield:Notify({
                    Title = "Player Info: " .. selectedPlayer,
                    Content = string.format(
                        "UserID: %d\nAccount Age: %d days\nDisplay Name: %s",
                        target.UserId,
                        target.AccountAge,
                        target.DisplayName
                    ),
                    Duration = 5,
                    Image = 4483362458
                })
            else
                Rayfield:Notify({
                    Title = "Error",
                    Content = "Player not found!",
                    Duration = 3,
                    Image = 4483362458
                })
            end
        else
            Rayfield:Notify({
                Title = "No Player Selected",
                Content = "Please select a player first",
                Duration = 3,
                Image = 4483362458
            })
        end
    end,
})

-- Function to set a specific player in the dropdown
local function selectPlayerInDropdown(playerName)
    if playerName then
        -- Using the correct Set() method from documentation
        PlayerDropdown:Set({playerName})
    end
end

-- Auto-update player list when players join/leave
local function setupAutoUpdates()
    -- Update when player joins
    game.Players.PlayerAdded:Connect(function(player)
        task.wait(1) -- Brief delay to ensure player is fully loaded
        local playerNames = getPlayerNames()
        PlayerDropdown:Refresh(playerNames)
        
        Rayfield:Notify({
            Title = "Player Joined",
            Content = player.Name .. " joined the game",
            Duration = 2,
            Image = 4483362458
        })
    end)
    
    -- Update when player leaves
    game.Players.PlayerRemoved:Connect(function(player)
        task.wait(1) -- Brief delay
        local playerNames = getPlayerNames()
        PlayerDropdown:Refresh(playerNames)
        
        -- If the selected player left, reset to "None"
        if selectedPlayer == player.Name then
            PlayerDropdown:Set({"None"})
        end
        
        Rayfield:Notify({
            Title = "Player Left",
            Content = player.Name .. " left the game",
            Duration = 2,
            Image = 4483362458
        })
    end)
end

-- Initialize auto-updates
setupAutoUpdates()

-- Debug button to check current state
MainTab:CreateButton({
    Name = "Debug Info",
    Callback = function()
        print("=== DEBUG INFO ===")
        print("Selected Player:", selectedPlayer)
        print("Dropdown CurrentOption:", PlayerDropdown.CurrentOption and table.concat(PlayerDropdown.CurrentOption, ", ") or "nil")
        print("Players in game:")
        for _, player in ipairs(game.Players:GetPlayers()) do
            print("  - " .. player.Name)
        end
        print("==================")
    end,
})

-- Initial notification
Rayfield:Notify({
    Title = "Player Manager Loaded",
    Content = "Select a player from the dropdown\nUse Refresh if players are missing",
    Duration = 5,
    Image = 4483362458
})

print("Player Manager UI successfully loaded!")
print("Using correct Rayfield methods: Dropdown:Refresh() and Dropdown:Set()")
