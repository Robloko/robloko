-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualUser = game:GetService("VirtualUser")  -- Kept but no longer used for opening

-- Local player
local localPlayer = Players.LocalPlayer
local playerGui = localPlayer:WaitForChild("PlayerGui")

-- Create ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "GiftGiverUI"
screenGui.Parent = playerGui
screenGui.ResetOnSpawn = false

-- Main Frame (same as original, slightly cleaned)
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 300, 0, 190)
mainFrame.Position = UDim2.new(0.5, -150, 0, 20)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BackgroundTransparency = 0.1
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 12)

-- Title
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 30)
title.BackgroundTransparency = 1
title.Text = "üéÅ Gift Giver (Winter 2025)"
title.TextColor3 = Color3.new(1,1,1)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 24
title.Parent = mainFrame

-- Target Label
local targetLabel = Instance.new("TextLabel")
targetLabel.Size = UDim2.new(1, -20, 0, 28)
targetLabel.Position = UDim2.new(0, 10, 0, 35)
targetLabel.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
targetLabel.Text = "Target: Gerranafa"
targetLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
targetLabel.Font = Enum.Font.SourceSansBold
targetLabel.TextSize = 16
targetLabel.Parent = mainFrame
Instance.new("UICorner", targetLabel).CornerRadius = UDim.new(0, 8)

-- Give All Button
local giveAllButton = Instance.new("TextButton")
giveAllButton.Size = UDim2.new(1, -20, 0, 35)
giveAllButton.Position = UDim2.new(0, 10, 0, 70)
giveAllButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
giveAllButton.Text = "Give All winter_2025_angus_box"
giveAllButton.TextColor3 = Color3.new(1,1,1)
giveAllButton.Font = Enum.Font.SourceSansBold
giveAllButton.TextSize = 16
giveAllButton.Parent = mainFrame
Instance.new("UICorner", giveAllButton).CornerRadius = UDim.new(0, 8)

-- Open Gift Button
local openButton = Instance.new("TextButton")
openButton.Size = UDim2.new(1, -20, 0, 35)
openButton.Position = UDim2.new(0, 10, 0, 110)
openButton.BackgroundColor3 = Color3.fromRGB(0, 100, 255)
openButton.Text = "Open One Gift"
openButton.TextColor3 = Color3.new(1,1,1)
openButton.Font = Enum.Font.SourceSansBold
openButton.TextSize = 16
openButton.Parent = mainFrame
Instance.new("UICorner", openButton).CornerRadius = UDim.new(0, 8)

-- Status Label
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -20, 0, 35)
statusLabel.Position = UDim2.new(0, 10, 0, 150)
statusLabel.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
statusLabel.Text = "Ready"
statusLabel.TextColor3 = Color3.new(1,1,1)
statusLabel.Font = Enum.Font.SourceSansBold
statusLabel.TextSize = 14
statusLabel.Parent = mainFrame
Instance.new("UICorner", statusLabel).CornerRadius = UDim.new(0, 8)

-- Variables
local giftType = "winter_2025_angus_box"
local targetPlayerName = "Gerranafa"
local targetPlayer = nil
local giftInventory = {}
local totalGiftAmount = 0
local isGiving = false

-- Update inventory
local function updateGiftInventory()
    giftInventory = {}
    totalGiftAmount = 0
    local success, clientData = pcall(require, ReplicatedStorage.ClientModules.Core.ClientData)
    if success then
        local success2, allData = pcall(clientData.get_data, clientData)
        if success2 and allData[localPlayer.Name]?.inventory?.gifts then
            for uid, gift in pairs(allData[localPlayer.Name].inventory.gifts) do
                if gift.id == giftType then
                    table.insert(giftInventory, {uid = uid, amount = gift.amount or 1})
                    totalGiftAmount += (gift.amount or 1)
                end
            end
        end
    end
    statusLabel.Text = `Gifts: {totalGiftAmount} (Stacks: {#giftInventory})`
end

-- Find target
local function findTargetPlayer()
    targetPlayer = Players:FindFirstChild(targetPlayerName)
    if targetPlayer then
        targetLabel.Text = "Target: Gerranafa ‚úì"
        targetLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
        return true
    else
        targetLabel.Text = "Target: Gerranafa (Offline)"
        targetLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return false
    end
end

-- Give all gifts (unchanged logic, just cleaner)
local function giveAllGiftsToPlayer()
    if isGiving then return end
    if not findTargetPlayer() then
        statusLabel.Text = "ERROR: Target offline!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end
    updateGiftInventory()
    if #giftInventory == 0 then
        statusLabel.Text = "No gifts found!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end

    isGiving = true
    giveAllButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
    giveAllButton.Text = "Giving..."

    local successCount, failCount = 0, 0
    for i, stack in ipairs(giftInventory) do
        local success = pcall(function()
            ReplicatedStorage.API["TradeAPI/GiveItem"]:InvokeServer(targetPlayer, stack.uid)
        end)
        if success then
            successCount += 1
            statusLabel.Text = `Giving: {i}/{#giftInventory}`
            statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        else
            failCount += 1
        end
        if i < #giftInventory then task.wait(9) end
    end

    isGiving = false
    giveAllButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    giveAllButton.Text = "Give All winter_2025_angus_box"
    updateGiftInventory()

    if failCount == 0 then
        statusLabel.Text = `Success! Gave all {successCount} stacks`
        statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
    else
        statusLabel.Text = `Done: {successCount}‚úì {failCount}‚úó ({totalGiftAmount} left)`
        statusLabel.TextColor3 = Color3.fromRGB(255, 200, 0)
    end
end

-- NEW: Reliable gift opening (December 2025 working method)
local function openGift()
    statusLabel.Text = "Searching for gift..."
    statusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)

    local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
    local allData = clientData.get_data()
    local gifts = allData[localPlayer.Name]?.inventory?.gifts
    if not gifts then
        statusLabel.Text = "No inventory access"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end

    local uniqueId = nil
    for uid, gift in pairs(gifts) do
        if gift.id == giftType then
            uniqueId = uid
            break
        end
    end

    if not uniqueId then
        statusLabel.Text = `No {giftType} found`
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end

    statusLabel.Text = "Equipping gift..."
    ReplicatedStorage.API["ToolAPI/Equip"]:InvokeServer(uniqueId)
    task.wait(1.3)

    -- Click hotbar slot 13
    local toolApp = playerGui:WaitForChild("ToolApp", 10)
    local hotbar = toolApp?.Frame?.Hotbar
    if not hotbar then
        statusLabel.Text = "Hotbar not found!"
        return
    end

    local slots = hotbar:GetChildren()
    table.sort(slots, function(a,b)
        local na, nb = tonumber(a.Name), tonumber(b.Name)
        return na and nb and na < nb or a.Name < b.Name
    end)

    local slot13 = slots[13]
    if slot13 and slot13.Visible then
        firesignal(slot13.MouseButton1Down)
        task.wait(0.06)
        firesignal(slot13.MouseButton1Up)
        firesignal(slot13.MouseButton1Click)
        statusLabel.Text = "Clicked gift ‚Üí waiting for dialog..."
    else
        statusLabel.Text = "Slot 13 not ready!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end

    task.wait(1.3)

    -- Click the green "Open" button (3rd in Buttons)
    local confirmButton = playerGui:FindFirstChild("DialogApp")
        and playerGui.DialogApp:FindFirstChild("Dialog")
        and playerGui.DialogApp.Dialog:FindFirstChild("CheckboxDialog")
        and playerGui.DialogApp.Dialog.CheckboxDialog:FindFirstChild("Buttons")
        and playerGui.DialogApp.Dialog.CheckboxDialog.Buttons:GetChildren()[3]

    if confirmButton and confirmButton.Visible then
        firesignal(confirmButton.MouseButton1Down)
        task.wait(0.06)
        firesignal(confirmButton.MouseButton1Up)
        firesignal(confirmButton.MouseButton1Click)
        statusLabel.Text = "Gift opened successfully!"
        statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
        task.wait(2)
        updateGiftInventory()
    else
        statusLabel.Text = "Confirm button missing!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
    end
end

-- Button connections
giveAllButton.MouseButton1Click:Connect(giveAllGiftsToPlayer)
openButton.MouseButton1Click:Connect(openGift)

-- Initial + periodic update
findTargetPlayer()
updateGiftInventory()

spawn(function()
    while task.wait(5) do
        findTargetPlayer()
        updateGiftInventory()
    end
end)

print("Advanced Gift Giver UI Loaded! (Winter 2025 - Reliable Open Method)")
