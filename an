-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local VirtualUser = game:GetService("VirtualUser")
local Workspace = game:GetService("Workspace")

-- Local player
local localPlayer = Players.LocalPlayer
local playerGui = localPlayer:WaitForChild("PlayerGui")

-- Create ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "GiftGiverUI"
screenGui.Parent = playerGui
screenGui.ResetOnSpawn = false

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 300, 0, 220)
mainFrame.Position = UDim2.new(0.5, -150, 0, 20)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BorderSizePixel = 0
mainFrame.BackgroundTransparency = 0.1
mainFrame.Parent = screenGui

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 12)
mainCorner.Parent = mainFrame

-- Title
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 30)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Text = "üéÅ Gift Giver - Auto Open & Give"
title.Font = Enum.Font.SourceSansBold
title.TextSize = 22
title.Parent = mainFrame

-- Target Player Label
local targetLabel = Instance.new("TextLabel")
targetLabel.Size = UDim2.new(1, -20, 0, 28)
targetLabel.Position = UDim2.new(0, 10, 0, 40)
targetLabel.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
targetLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
targetLabel.Text = "Target: Gerranafa"
targetLabel.Font = Enum.Font.SourceSansBold
targetLabel.TextSize = 16
targetLabel.Parent = mainFrame

local targetCorner = Instance.new("UICorner")
targetCorner.CornerRadius = UDim.new(0, 8)
targetCorner.Parent = targetLabel

-- Give All Button
local giveAllButton = Instance.new("TextButton")
giveAllButton.Size = UDim2.new(1, -20, 0, 40)
giveAllButton.Position = UDim2.new(0, 10, 0, 78)
giveAllButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
giveAllButton.TextColor3 = Color3.fromRGB(255, 255, 255)
giveAllButton.Text = "Give All winter_2025_angus_box"
giveAllButton.Font = Enum.Font.SourceSansBold
giveAllButton.TextSize = 16
giveAllButton.Parent = mainFrame

local giveAllCorner = Instance.new("UICorner")
giveAllCorner.CornerRadius = UDim.new(0, 8)
giveAllCorner.Parent = giveAllButton

-- Open Gift Button
local openButton = Instance.new("TextButton")
openButton.Size = UDim2.new(1, -20, 0, 40)
openButton.Position = UDim2.new(0, 10, 0, 128)
openButton.BackgroundColor3 = Color3.fromRGB(0, 100, 255)
openButton.TextColor3 = Color3.fromRGB(255, 255, 255)
openButton.Text = "Open One Gift"
openButton.Font = Enum.Font.SourceSansBold
openButton.TextSize = 16
openButton.Parent = mainFrame

local openCorner = Instance.new("UICorner")
openCorner.CornerRadius = UDim.new(0, 8)
openCorner.Parent = openButton

-- Status Label
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -20, 0, 40)
statusLabel.Position = UDim2.new(0, 10, 0, 178)
statusLabel.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
statusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
statusLabel.Text = "Ready"
statusLabel.Font = Enum.Font.SourceSans
statusLabel.TextSize = 15
statusLabel.TextWrapped = true
statusLabel.Parent = mainFrame

local statusCorner = Instance.new("UICorner")
statusCorner.CornerRadius = UDim.new(0, 8)
statusCorner.Parent = statusLabel

-- Variables
local giftType = "winter_2025_angus_box"        -- Change this if needed
local targetPlayerName = "Gerranafa"            -- Change this if needed
local targetPlayer = nil
local giftInventory = {}
local totalGiftAmount = 0
local isGiving = false

-- Function to update gift inventory
local function updateGiftInventory()
    giftInventory = {}
    totalGiftAmount = 0
    local success, clientData = pcall(require, ReplicatedStorage.ClientModules.Core.ClientData)
    if success then
        local success2, allData = pcall(clientData.get_data, clientData)
        if success2 and allData[localPlayer.Name] and allData[localPlayer.Name].inventory and allData[localPlayer.Name].inventory.gifts then
            for uniqueId, giftData in pairs(allData[localPlayer.Name].inventory.gifts) do
                if giftData.id == giftType then
                    local amount = giftData.amount or 1
                    table.insert(giftInventory, {uid = uniqueId, amount = amount})
                    totalGiftAmount = totalGiftAmount + amount
                end
            end
        end
    end
    statusLabel.Text = "Gifts: " .. totalGiftAmount .. " (Stacks: " .. #giftInventory .. ")"
    return totalGiftAmount
end

-- Function to find target player
local function findTargetPlayer()
    targetPlayer = Players:FindFirstChild(targetPlayerName)
    if targetPlayer then
        targetLabel.Text = "Target: " .. targetPlayerName .. " ‚úì"
        targetLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
        return true
    else
        targetLabel.Text = "Target: " .. targetPlayerName .. " (Offline)"
        targetLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return false
    end
end

-- Function to give all gifts
local function giveAllGiftsToPlayer()
    if isGiving then return end
    if not findTargetPlayer() then
        statusLabel.Text = "ERROR: Target not online!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end
    updateGiftInventory()
    if #giftInventory == 0 then
        statusLabel.Text = "No " .. giftType .. " gifts found!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end

    isGiving = true
    giveAllButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
    giveAllButton.Text = "Giving... (Do not close)"

    local successCount = 0
    local failCount = 0

    for i, stack in ipairs(giftInventory) do
        local success, result = pcall(function()
            return ReplicatedStorage.API["TradeAPI/GiveItem"]:InvokeServer(targetPlayer, stack.uid)
        end)

        if success then
            successCount += 1
            statusLabel.Text = "Giving: " .. i .. "/" .. #giftInventory .. " ‚úì"
            statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        else
            failCount += 1
            statusLabel.Text = "Failed: " .. i .. "/" .. #giftInventory
            statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        end

        if i < #giftInventory then
            task.wait(9)  -- Anti-rate limit delay
        end
    end

    isGiving = false
    giveAllButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    giveAllButton.Text = "Give All " .. giftType

    updateGiftInventory()
    if failCount == 0 then
        statusLabel.Text = "Success! All " .. successCount .. " stacks given"
        statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
    else
        statusLabel.Text = "Done: " .. successCount .. "‚úì | " .. failCount .. "‚úó | " .. totalGiftAmount .. " left"
        statusLabel.TextColor3 = Color3.fromRGB(255, 200, 0)
    end
end

-- Improved openGift function with proper VirtualUser click simulation
local function openGift()
    local success, clientData = pcall(require, ReplicatedStorage.ClientModules.Core.ClientData)
    if not success then
        statusLabel.Text = "Error: Could not access client data"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end

    local success2, allData = pcall(clientData.get_data, clientData)
    if not success2 or not allData[localPlayer.Name] or not allData[localPlayer.Name].inventory or not allData[localPlayer.Name].inventory.gifts then
        statusLabel.Text = "Error: No inventory/gifts found"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end

    local gifts = allData[localPlayer.Name].inventory.gifts
    local giftFound = false

    for uniqueId, giftData in pairs(gifts) do
        if giftData.id == giftType then
            giftFound = true
            statusLabel.Text = "Opening " .. giftType .. "..."
            statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)

            -- Equip gift
            pcall(function()
                ReplicatedStorage.API["ToolAPI/Equip"]:InvokeServer(uniqueId)
            end)
            task.wait(1)

            -- Best practice: Full realistic click simulation
            VirtualUser:CaptureController()
            VirtualUser:Button1Down(Vector2.new(2, 0), workspace.CurrentCamera.CFrame)
            task.wait(0.1)  -- Short hold for natural feel
            VirtualUser:Button1Up(Vector2.new(2, 0), workspace.CurrentCamera.CFrame)

            task.wait(1)

            -- Server sequence
            ReplicatedStorage.API["ToolAPI/ServerUseTool"]:FireServer(uniqueId, "START")
            task.wait(1)
            ReplicatedStorage.API["ShopAPI/IndicateOpenGift"]:FireServer(uniqueId)
            task.wait(1)
            ReplicatedStorage.API["ToolAPI/ServerUseTool"]:FireServer(uniqueId, "END")

            statusLabel.Text = "Gift opened successfully!"
            statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
            break  -- Only open one per click
        end
    end

    if not giftFound then
        statusLabel.Text = "No " .. giftType .. " found to open"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
    end

    task.wait(0.5)
    updateGiftInventory()  -- Refresh count
end

-- Button connections
giveAllButton.MouseButton1Click:Connect(function()
    if not isGiving then
        spawn(giveAllGiftsToPlayer)  -- Run in separate thread to keep UI responsive
    end
end)

openButton.MouseButton1Click:Connect(openGift)

-- Initial setup
findTargetPlayer()
updateGiftInventory()

-- Background refresh every 5 seconds
spawn(function()
    while true do
        task.wait(5)
        findTargetPlayer()
        updateGiftInventory()
    end
end)

print("Advanced Gift Giver UI Loaded! (Dec 2025 - Improved Click Simulation)")
print("Target: " .. targetPlayerName .. " | Gift: " .. giftType)
