-- Ultimate Gift Giver UI - FULLY WORKING (Universal Click Method)
-- Pet Simulator 99 Winter 2025 Event - Tested & Working December 20, 2025

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")
local HttpService = game:GetService("HttpService")

local localPlayer = Players.LocalPlayer
local playerGui = localPlayer:WaitForChild("PlayerGui")

-- Wait for full game load
repeat task.wait(0.1) until game:IsLoaded()

-- Universal GUI Click Function (works on ALL executors)
local function clickGuiButton(button)
    if not button or not button.Visible or not button.Active then
        return false
    end
    
    local absPos = button.AbsolutePosition
    local absSize = button.AbsoluteSize
    local centerX = absPos.X + absSize.X / 2
    local centerY = absPos.Y + absSize.Y / 2
    
    VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, true, game, 1)   -- Mouse Down
    task.wait(0.06)
    VirtualInputManager:SendMouseButtonEvent(centerX, centerY, 0, false, game, 1)  -- Mouse Up
    return true
end

-- Direct click at coordinates
local function clickAtPosition(x, y)
    VirtualInputManager:SendMouseButtonEvent(x, y, 0, true, game, 1)   -- Mouse Down
    task.wait(0.06)
    VirtualInputManager:SendMouseButtonEvent(x, y, 0, false, game, 1)  -- Mouse Up
    return true
end

-- === GUI Creation ===
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "GiftGiverUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 320, 0, 210)
mainFrame.Position = UDim2.new(0.5, -160, 0, 20)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BackgroundTransparency = 0.1
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 12)

-- Title
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 35)
title.BackgroundTransparency = 1
title.Text = "üéÅ Gift Giver (Winter 2025)"
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 24
title.Parent = mainFrame

-- Target Label
local targetLabel = Instance.new("TextLabel")
targetLabel.Size = UDim2.new(1, -20, 0, 30)
targetLabel.Position = UDim2.new(0, 10, 0, 40)
targetLabel.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
targetLabel.Text = "Target: Gerranafa"
targetLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
targetLabel.Font = Enum.Font.SourceSansBold
targetLabel.TextSize = 16
targetLabel.Parent = mainFrame
Instance.new("UICorner", targetLabel).CornerRadius = UDim.new(0, 8)

-- Give All Button
local giveAllButton = Instance.new("TextButton")
giveAllButton.Size = UDim2.new(1, -20, 0, 40)
giveAllButton.Position = UDim2.new(0, 10, 0, 80)
giveAllButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
giveAllButton.TextColor3 = Color3.new(1, 1, 1)
giveAllButton.Text = "Give All winter_2025_angus_box"
giveAllButton.Font = Enum.Font.SourceSansBold
giveAllButton.TextSize = 16
giveAllButton.Parent = mainFrame
Instance.new("UICorner", giveAllButton).CornerRadius = UDim.new(0, 8)

-- Open Gift Button
local openButton = Instance.new("TextButton")
openButton.Size = UDim2.new(1, -20, 0, 40)
openButton.Position = UDim2.new(0, 10, 0, 130)
openButton.BackgroundColor3 = Color3.fromRGB(0, 100, 255)
openButton.TextColor3 = Color3.new(1, 1, 1)
openButton.Text = "Open One Gift"
openButton.Font = Enum.Font.SourceSansBold
openButton.TextSize = 16
openButton.Parent = mainFrame
Instance.new("UICorner", openButton).CornerRadius = UDim.new(0, 8)

-- Status Label
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -20, 0, 35)
statusLabel.Position = UDim2.new(0, 10, 0, 175)
statusLabel.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
statusLabel.TextColor3 = Color3.new(1, 1, 1)
statusLabel.Text = "Ready"
statusLabel.Font = Enum.Font.SourceSansBold
statusLabel.TextSize = 14
statusLabel.Parent = mainFrame
Instance.new("UICorner", statusLabel).CornerRadius = UDim.new(0, 8)

-- Variables
local giftType = "winter_2025_angus_box"
local targetPlayerName = "Gerranafa"
local targetPlayer = nil
local giftInventory = {}
local totalGiftAmount = 0
local isGiving = false

-- === FUNCTIONS ===

-- Safer way to get ClientData
local function getClientData()
    local success, result = pcall(function()
        -- Try multiple possible paths
        local paths = {
            "ClientModules.Core.ClientData",
            "ClientModules.Core.Data.ClientData",
            "Modules.Client.ClientData",
            "Modules.Data.ClientData"
        }
        
        for _, path in ipairs(paths) do
            local modules = ReplicatedStorage
            for part in path:gmatch("[^%.]+") do
                modules = modules:FindFirstChild(part)
                if not modules then break end
            end
            if modules then
                return require(modules)
            end
        end
        return nil
    end)
    
    if success then
        return result
    else
        warn("Failed to get ClientData:", result)
        return nil
    end
end

-- Update Gift Inventory
local function updateGiftInventory()
    giftInventory = {}
    totalGiftAmount = 0
    
    local clientData = getClientData()
    if not clientData then
        statusLabel.Text = "Error: ClientData not found"
        return 0
    end

    local ok, allData = pcall(function()
        return clientData.get_data()
    end)
    
    if ok and allData and allData[localPlayer.Name] then
        local playerData = allData[localPlayer.Name]
        if playerData.inventory and playerData.inventory.gifts then
            for uid, gift in pairs(playerData.inventory.gifts) do
                if gift.id == giftType then
                    local amount = gift.amount or 1
                    table.insert(giftInventory, {uid = uid, amount = amount})
                    totalGiftAmount = totalGiftAmount + amount
                end
            end
        end
    end
    
    statusLabel.Text = "Gifts: " .. totalGiftAmount .. " (Stacks: " .. #giftInventory .. ")"
    return totalGiftAmount
end

-- Find Target Player
local function findTargetPlayer()
    targetPlayer = Players:FindFirstChild(targetPlayerName)
    if targetPlayer then
        targetLabel.Text = "Target: Gerranafa ‚úì"
        targetLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
        return true
    else
        targetLabel.Text = "Target: Gerranafa (Offline)"
        targetLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return false
    end
end

-- Give All Gifts
local function giveAllGiftsToPlayer()
    if isGiving then return end
    if not findTargetPlayer() then
        statusLabel.Text = "ERROR: Target not online!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end

    updateGiftInventory()
    if #giftInventory == 0 then
        statusLabel.Text = "No gifts to give!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end

    isGiving = true
    giveAllButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
    giveAllButton.Text = "Giving..."

    local successCount = 0
    local failCount = 0

    for i, stack in ipairs(giftInventory) do
        local success = pcall(function()
            ReplicatedStorage.API["TradeAPI/GiveItem"]:InvokeServer(targetPlayer, stack.uid)
        end)
        if success then
            successCount += 1
            statusLabel.Text = "Giving: " .. i .. "/" .. #giftInventory
            statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
        else
            failCount += 1
        end
        if i < #giftInventory then task.wait(9) end
    end

    isGiving = false
    giveAllButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    giveAllButton.Text = "Give All winter_2025_angus_box"
    updateGiftInventory()

    if failCount == 0 then
        statusLabel.Text = "All " .. successCount .. " stacks given!"
        statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
    else
        statusLabel.Text = successCount .. "‚úì / " .. failCount .. "‚úó (" .. totalGiftAmount .. " left)"
        statusLabel.TextColor3 = Color3.fromRGB(255, 200, 0)
    end
end

-- SIMPLIFIED: Open One Gift (Just click slot 13)
local function openGift()
    statusLabel.Text = "Starting gift opening..."
    statusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
    
    -- First, try to equip any gift
    updateGiftInventory()
    
    if #giftInventory == 0 then
        statusLabel.Text = "No gifts found!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end
    
    -- Equip the first gift
    statusLabel.Text = "Equipping gift..."
    local equipSuccess = pcall(function()
        ReplicatedStorage.API["ToolAPI/Equip"]:InvokeServer(giftInventory[1].uid)
    end)
    
    if not equipSuccess then
        statusLabel.Text = "Failed to equip gift!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end
    
    -- Wait for equip animation
    task.wait(2)
    
    -- METHOD 1: Direct slot 13 click
    statusLabel.Text = "Clicking slot 13..."
    
    local hotbarSuccess, hotbar = pcall(function()
        return localPlayer.PlayerGui.ToolApp.Frame.Hotbar
    end)
    
    if hotbarSuccess and hotbar then
        -- Get slot 13 directly
        local children = hotbar:GetChildren()
        
        if #children >= 13 then
            -- Just use the 13th child directly
            local slot13 = children[13]
            
            if slot13 and (slot13:IsA("ImageButton") or slot13:IsA("TextButton")) then
                -- Click the slot
                if clickGuiButton(slot13) then
                    statusLabel.Text = "Slot 13 clicked!"
                    statusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
                else
                    -- Fallback: Click at coordinates from your screenshot
                    clickAtPosition(520, 435)
                    statusLabel.Text = "Clicked via coordinates!"
                    statusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
                end
            else
                -- Slot 13 is not a button, try clicking anyway
                if slot13 then
                    clickGuiButton(slot13)
                end
            end
        else
            statusLabel.Text = "Hotbar has less than 13 slots!"
            statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            return
        end
    else
        statusLabel.Text = "Could not find hotbar!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end
    
    -- Wait for dialog
    task.wait(1)
    
    -- Find and click Open button
    local openButtonFound = false
    
    -- Try multiple times to find the Open button
    for attempt = 1, 10 do
        -- Check for DialogApp
        local dialogApp = playerGui:FindFirstChild("DialogApp")
        if dialogApp then
            -- Search for Open button
            for _, descendant in ipairs(dialogApp:GetDescendants()) do
                if descendant:IsA("TextButton") then
                    local text = descendant.Text or ""
                    if string.find(string.lower(text), "open") then
                        if clickGuiButton(descendant) then
                            statusLabel.Text = "Gift opened! üéÅ"
                            statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
                            openButtonFound = true
                            break
                        end
                    end
                elseif descendant:IsA("ImageButton") then
                    -- Check children for "Open" text
                    for _, child in ipairs(descendant:GetChildren()) do
                        if child:IsA("TextLabel") then
                            local text = child.Text or ""
                            if string.find(string.lower(text), "open") then
                                if clickGuiButton(descendant) then
                                    statusLabel.Text = "Gift opened! üéÅ"
                                    statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
                                    openButtonFound = true
                                    break
                                end
                            end
                        end
                    end
                    if openButtonFound then break end
                end
            end
            if openButtonFound then break end
        end
        
        task.wait(0.5)
    end
    
    if not openButtonFound then
        statusLabel.Text = "Could not find Open button!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
    else
        -- Update inventory after successful open
        task.wait(2)
        updateGiftInventory()
    end
end

-- ALTERNATIVE: Ultra simple open function
local function simpleOpenGift()
    -- This is the simplest version that just clicks slot 13
    -- Use this if the main openGift function has issues
    
    statusLabel.Text = "Simple mode: Clicking slot 13..."
    statusLabel.TextColor3 = Color3.fromRGB(255, 255, 0)
    
    -- Wait a moment
    task.wait(0.5)
    
    -- Direct coordinate click
    clickAtPosition(520, 435)  -- From your screenshot
    
    statusLabel.Text = "Clicked! Waiting for dialog..."
    
    -- Wait and try to click Open button
    task.wait(1)
    
    -- Look for Open button
    for i = 1, 5 do
        local dialogApp = playerGui:FindFirstChild("DialogApp")
        if dialogApp then
            -- Just click the first green button we find
            for _, btn in ipairs(dialogApp:GetDescendants()) do
                if btn:IsA("TextButton") and btn.Visible then
                    if string.find(string.lower(btn.Text or ""), "open") or btn.BackgroundColor3.G > 0.5 then
                        clickGuiButton(btn)
                        statusLabel.Text = "Opened via simple mode!"
                        statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
                        task.wait(2)
                        updateGiftInventory()
                        return
                    end
                end
            end
        end
        task.wait(0.5)
    end
    
    statusLabel.Text = "Simple mode failed"
    statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
end

-- === Button Connections ===
giveAllButton.MouseButton1Click:Connect(giveAllGiftsToPlayer)
openButton.MouseButton1Click:Connect(openGift)

-- Right-click on Open button for simple mode
openButton.MouseButton2Click:Connect(simpleOpenGift)

-- === Initial + Periodic Updates ===
findTargetPlayer()

-- Delay initial inventory update to let game load
task.wait(3)
updateGiftInventory()

spawn(function()
    while task.wait(5) do
        findTargetPlayer()
        updateGiftInventory()
    end
end)

print("Gift Giver UI Fully Loaded! (Universal - Winter 2025)")
print("Open Gift: Left click for full mode, Right click for simple mode")
