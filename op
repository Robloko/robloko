-- ULTRA SIMPLE BOX OPENER - WITH COUNTER & AUTO MODE
-- This will definitely work

-- Wait for services to load
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- Wait for player
local player = Players.LocalPlayer
repeat task.wait(0.1) until player and player.Character

-- Simple print function
local function printMsg(msg)
    print("[BoxOpener] " .. msg)
end

printMsg("Script starting...")

-- Simple click function
local function clickAt(x, y)
    VirtualInputManager:SendMouseButtonEvent(x, y, 0, true, game, 1)
    task.wait(0.05)
    VirtualInputManager:SendMouseButtonEvent(x, y, 0, false, game, 1)
    return true
end

-- Create the UI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "BoxOpenerUI"
screenGui.ResetOnSpawn = false

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 180, 0, 110)
mainFrame.Position = UDim2.new(0, 10, 1, -120)
mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
mainFrame.BorderSizePixel = 0
mainFrame.BackgroundTransparency = 0.2

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 8)
corner.Parent = mainFrame

-- Title with counter
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 25)
title.BackgroundTransparency = 1
title.Text = "Box Opener: 0"
title.TextColor3 = Color3.new(1, 1, 1)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 16
title.Parent = mainFrame

-- Open One button
local openOneBtn = Instance.new("TextButton")
openOneBtn.Size = UDim2.new(0.9, 0, 0, 25)
openOneBtn.Position = UDim2.new(0.05, 0, 0.3, 0)
openOneBtn.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
openOneBtn.Text = "OPEN ONE"
openOneBtn.TextColor3 = Color3.new(1, 1, 1)
openOneBtn.Font = Enum.Font.SourceSansBold
openOneBtn.TextSize = 12
openOneBtn.Parent = mainFrame

local btnCorner1 = Instance.new("UICorner")
btnCorner1.CornerRadius = UDim.new(0, 6)
btnCorner1.Parent = openOneBtn

-- Open All button
local openAllBtn = Instance.new("TextButton")
openAllBtn.Size = UDim2.new(0.9, 0, 0, 25)
openAllBtn.Position = UDim2.new(0.05, 0, 0.55, 0)
openAllBtn.BackgroundColor3 = Color3.fromRGB(200, 100, 0)
openAllBtn.Text = "OPEN ALL [OFF]"
openAllBtn.TextColor3 = Color3.new(1, 1, 1)
openAllBtn.Font = Enum.Font.SourceSansBold
openAllBtn.TextSize = 12
openAllBtn.Parent = mainFrame

local btnCorner2 = Instance.new("UICorner")
btnCorner2.CornerRadius = UDim.new(0, 6)
btnCorner2.Parent = openAllBtn

-- Status label
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, 0, 0, 20)
statusLabel.Position = UDim2.new(0, 0, 0, 85)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Ready"
statusLabel.TextColor3 = Color3.fromRGB(200, 200, 100)
statusLabel.Font = Enum.Font.SourceSans
statusLabel.TextSize = 11
statusLabel.Parent = mainFrame

-- Put UI in place
mainFrame.Parent = screenGui
screenGui.Parent = player:WaitForChild("PlayerGui")

printMsg("UI created")

-- Variables
local isOpeningAll = false
local openingCoroutine = nil

-- Function to count boxes
local function countBoxes()
    local boxCount = 0
    
    local success, err = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local data = clientData.get_data()
        if data[player.Name] and data[player.Name].inventory and data[player.Name].inventory.gifts then
            for uid, gift in pairs(data[player.Name].inventory.gifts) do
                if gift.id == "winter_2025_angus_box" then
                    boxCount = boxCount + (gift.amount or 1)
                end
            end
        end
    end)
    
    if not success then
        printMsg("Count error: " .. tostring(err))
        return 0
    end
    
    return boxCount
end

-- Function to update counter
local function updateCounter()
    local boxCount = countBoxes()
    title.Text = "Boxes: " .. boxCount
    return boxCount
end

-- Function to find and get a box ID
local function getBoxId()
    local foundBox = false
    local boxId = nil
    
    local success, err = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local data = clientData.get_data()
        if data[player.Name] and data[player.Name].inventory and data[player.Name].inventory.gifts then
            for uid, gift in pairs(data[player.Name].inventory.gifts) do
                if gift.id == "winter_2025_angus_box" then
                    foundBox = true
                    boxId = uid
                    break
                end
            end
        end
    end)
    
    if not success then
        statusLabel.Text = "Error: " .. tostring(err)
        return nil
    end
    
    return boxId
end

-- Function to open one box
local function openOneBox()
    statusLabel.Text = "Finding box..."
    
    local boxId = getBoxId()
    
    if not boxId then
        statusLabel.Text = "No boxes found"
        updateCounter()
        return false
    end
    
    statusLabel.Text = "Equipping..."
    
    -- Equip the box
    local equipSuccess, equipErr = pcall(function()
        ReplicatedStorage.API["ToolAPI/Equip"]:InvokeServer(boxId)
    end)
    
    if not equipSuccess then
        statusLabel.Text = "Equip failed"
        return false
    end
    
    task.wait(1)
    
    -- Click first spot
    statusLabel.Text = "Clicking slot..."
    clickAt(520, 485)
    
    task.wait(1)
    
    -- Click second spot
    statusLabel.Text = "Opening..."
    clickAt(570, 333)
    
    task.wait(2)
    
    -- Check if successful
    local newCount = updateCounter()
    if newCount > 0 then
        statusLabel.Text = "Opened! " .. newCount .. " left"
    else
        statusLabel.Text = "All boxes opened!"
    end
    
    return true
end

-- Function to open all boxes
local function openAllBoxes()
    while isOpeningAll do
        local boxCount = updateCounter()
        
        if boxCount == 0 then
            isOpeningAll = false
            openAllBtn.Text = "OPEN ALL [OFF]"
            openAllBtn.BackgroundColor3 = Color3.fromRGB(200, 100, 0)
            statusLabel.Text = "All boxes opened!"
            printMsg("Finished opening all boxes")
            break
        end
        
        statusLabel.Text = "Opening... (" .. boxCount .. " left)"
        printMsg("Opening box (" .. boxCount .. " remaining)")
        
        local success = openOneBox()
        
        if not success then
            statusLabel.Text = "Failed, retrying..."
            task.wait(2)
        else
            task.wait(3) -- Wait between boxes
        end
        
        -- Update counter
        updateCounter()
    end
end

-- Start/stop opening all
local function toggleOpenAll()
    isOpeningAll = not isOpeningAll
    
    if isOpeningAll then
        openAllBtn.Text = "OPEN ALL [ON]"
        openAllBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
        statusLabel.Text = "Starting..."
        printMsg("Starting to open all boxes")
        
        -- Start opening coroutine
        openingCoroutine = coroutine.wrap(function()
            openAllBoxes()
        end)()
    else
        openAllBtn.Text = "OPEN ALL [OFF]"
        openAllBtn.BackgroundColor3 = Color3.fromRGB(200, 100, 0)
        statusLabel.Text = "Stopped"
        printMsg("Stopped opening boxes")
    end
end

-- Connect buttons
openOneBtn.MouseButton1Click:Connect(function()
    printMsg("Opening one box...")
    openOneBox()
end)

-- Right click to test coordinates
openOneBtn.MouseButton2Click:Connect(function()
    printMsg("Testing coordinates...")
    clickAt(520, 485)
    task.wait(0.5)
    clickAt(570, 333)
    printMsg("Test complete")
    statusLabel.Text = "Test done"
end)

openAllBtn.MouseButton1Click:Connect(function()
    toggleOpenAll()
end)

-- Auto-update counter
coroutine.wrap(function()
    while true do
        updateCounter()
        task.wait(5)
    end
end)()

-- Initial update
task.wait(2)
updateCounter()

printMsg("Script loaded successfully!")
printMsg("Left-click OPEN ONE to open single box")
printMsg("Left-click OPEN ALL to open all boxes automatically")
printMsg("Right-click OPEN ONE to test coordinates")
printMsg("Counter updates every 5 seconds")
