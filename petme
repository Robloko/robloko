local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local petUniqueID = "2_ca817f9348c34cf98be5b67057ca47d5"

-- Enhanced debugging function
local function debugPrint(message, level)
    level = level or 1
    local prefix = string.rep(">", level) .. " "
    print(prefix .. message)
end

-- Function to get player data with better debugging
local function getPlayerData()
    debugPrint("Attempting to get player data...", 1)
    local success, data = pcall(function()
        local clientModule = ReplicatedStorage:FindFirstChild("ClientModules")
        if not clientModule then
            debugPrint("ClientModules not found in ReplicatedStorage", 2)
            return nil
        end
        
        local coreModule = clientModule:FindFirstChild("Core")
        if not coreModule then
            debugPrint("Core not found in ClientModules", 2)
            return nil
        end
        
        local clientData = coreModule:FindFirstChild("ClientData")
        if not clientData then
            debugPrint("ClientData not found in Core", 2)
            return nil
        end
        
        local requiredModule = require(clientData)
        if not requiredModule.get_data then
            debugPrint("get_data function not found in ClientData", 2)
            return nil
        end
        
        local allData = requiredModule.get_data()
        return allData and allData[player.Name]
    end)
    
    if not success then
        debugPrint("FAILED to get player data: " .. tostring(data), 2)
        return nil
    end
    
    if not data then
        debugPrint("No data found for player: " .. player.Name, 2)
        return nil
    end
    
    debugPrint("Successfully retrieved player data", 2)
    return data
end

-- Function to find the pet model with detailed debugging
local function findPetModel(petUniqueID)
    debugPrint("Searching for pet model with ID: " .. petUniqueID, 1)
    
    local data = getPlayerData()
    if not data then
        debugPrint("No player data available", 2)
        return nil
    end
    
    if not data.inventory then
        debugPrint("No inventory data found", 2)
        return nil
    end
    
    if not data.inventory.pets then
        debugPrint("No pets found in inventory", 2)
        return nil
    end
    
    debugPrint("Scanning " .. tostring(#data.inventory.pets) .. " pets in inventory", 2)
    
    local petCount = 0
    for petID, petData in pairs(data.inventory.pets) do
        petCount = petCount + 1
        debugPrint("Checking pet " .. petCount .. ": ID=" .. tostring(petID) .. ", Unique=" .. tostring(petData.unique), 3)
        
        if petData.unique == petUniqueID then
            debugPrint("FOUND matching pet: " .. tostring(petData.id), 2)
            
            -- Check if Pets folder exists
            local petsFolder = Workspace:FindFirstChild("Pets")
            if not petsFolder then
                debugPrint("Pets folder not found in Workspace", 3)
                return nil
            end
            
            -- Look for the pet model
            local petModel = petsFolder:FindFirstChild(tostring(petData.id))
            if petModel then
                debugPrint("SUCCESS: Found pet model in workspace: " .. petModel.Name, 2)
                return petModel
            else
                debugPrint("Pet model not found in workspace: " .. tostring(petData.id), 3)
                debugPrint("Available pets in workspace:", 3)
                for _, child in pairs(petsFolder:GetChildren()) do
                    debugPrint("  - " .. child.Name, 4)
                end
            end
        end
    end
    
    debugPrint("No pet found with unique ID: " .. petUniqueID, 2)
    return nil
end

-- Function to check available remote events
local function checkRemoteEvents()
    debugPrint("Checking available remote events...", 1)
    
    local apiFolder = ReplicatedStorage:FindFirstChild("API")
    if not apiFolder then
        debugPrint("API folder not found in ReplicatedStorage", 2)
        return
    end
    
    debugPrint("Found API folder, listing contents:", 2)
    for _, child in pairs(apiFolder:GetChildren()) do
        debugPrint("  - " .. child.Name, 3)
    end
end

-- Function to focus on the pet
local function focusPet(petModel)
    if not petModel then
        debugPrint("No pet model provided to focusPet", 2)
        return false
    end

    debugPrint("Attempting to focus pet: " .. petModel.Name, 1)
    
    -- Check if the remote event exists
    local adoptAPI = ReplicatedStorage:FindFirstChild("API")
    if adoptAPI then
        local focusEvent = adoptAPI:FindFirstChild("AdoptAPI/FocusPet")
        if not focusEvent then
            debugPrint("Remote event 'AdoptAPI/FocusPet' not found", 2)
            checkRemoteEvents()
            return false
        end
    end

    local argsFocus = { petModel }
    local success, err = pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("AdoptAPI/FocusPet"):FireServer(unpack(argsFocus))
    end)

    if not success then
        debugPrint("FAILED to focus pet: " .. tostring(err), 2)
        return false
    end

    debugPrint("Successfully focused pet", 2)
    return true
end

-- Function to check if the pet is focused
local function isPetFocused(petModel)
    if not petModel then
        return false
    end

    local data = getPlayerData()
    if not data or not data.pet_interaction then
        debugPrint("No pet_interaction data found", 2)
        return false
    end

    local isFocused = data.pet_interaction.focused_pet == petModel
    debugPrint("Pet focused check: " .. tostring(isFocused), 2)
    return isFocused
end

-- Function to check the current progress of the "Pet Me" ailment
local function getPetMeProgress(petUniqueID)
    debugPrint("Checking 'Pet Me' progress for: " .. petUniqueID, 1)
    
    local data = getPlayerData()
    if not data then return nil end
    
    if not data.ailments_manager then
        debugPrint("No ailments_manager found", 2)
        return nil
    end
    
    if not data.ailments_manager.ailments then
        debugPrint("No ailments found", 2)
        return nil
    end
    
    debugPrint("Total ailments: " .. tostring(#data.ailments_manager.ailments), 2)
    
    for ailmentID, ailmentData in pairs(data.ailments_manager.ailments) do
        debugPrint("Ailment ID: " .. tostring(ailmentID), 3)
        if ailmentID == petUniqueID then
            if ailmentData.pet_me then
                local progress = ailmentData.pet_me.progress
                debugPrint("FOUND 'Pet Me' progress: " .. tostring(progress), 2)
                return progress
            else
                debugPrint("No 'Pet Me' data for this pet", 3)
            end
        end
    end
    
    debugPrint("No 'Pet Me' ailment found for pet", 2)
    return nil
end

-- Main function to test each step
local function testPetMeAilment(petUniqueID)
    debugPrint("=== STARTING PET ME AILMENT TEST ===", 0)
    debugPrint("Testing pet: " .. petUniqueID, 1)
    
    -- First, check what remote events are available
    checkRemoteEvents()
    
    -- Find the pet model in the workspace
    debugPrint("STEP 1: Finding pet model", 1)
    local petModel = findPetModel(petUniqueID)
    if not petModel then
        debugPrint("FAILED: Could not find pet model", 2)
        return
    end
    
    -- Focus on the pet
    debugPrint("STEP 2: Focusing pet", 1)
    local success = focusPet(petModel)
    if not success then
        debugPrint("FAILED: Could not focus pet", 2)
        return
    end
    
    -- Wait a bit for focus to apply
    wait(0.5)
    
    -- Check if the pet is focused
    debugPrint("STEP 3: Verifying focus", 1)
    if not isPetFocused(petModel) then
        debugPrint("FAILED: Pet is not focused", 2)
        return
    end
    
    debugPrint("SUCCESS: Pet is focused", 2)
    
    -- Check the current progress of the "Pet Me" ailment
    debugPrint("STEP 4: Checking initial progress", 1)
    local currentProgress = getPetMeProgress(petUniqueID)
    if currentProgress == nil then
        debugPrint("No 'Pet Me' ailment found or no progress data", 2)
        -- Continue anyway to test the progression
    else
        debugPrint("Initial progress: " .. tostring(currentProgress), 2)
    end
    
    debugPrint("TEST COMPLETED - Check output above for issues", 0)
end

-- Run the test
testPetMeAilment(petUniqueID)
