local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer

-- Function to focus on the pet
local function focusPet(petModel)
    local argsFocus = { petModel }
    local success, err = pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("AdoptAPI/FocusPet"):FireServer(unpack(argsFocus))
    end)

    if not success then
        warn("Failed to focus pet: " .. tostring(err))
        return false
    end

    print("Successfully focused pet")
    return true
end

-- Function to set up petting animations
local function setupPettingAnimations(petModel)
    -- Replicate active performances (e.g., petting)
    local argsReplicate = {
        petModel,
        {
            FocusPet = true
        }
    }
    local success, err = pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("PetAPI/ReplicateActivePerformances"):FireServer(unpack(argsReplicate))
    end)
    if not success then
        warn("Failed to replicate active performances: " .. tostring(err))
        return false
    end
    print("Successfully replicated active performances")

    -- Replicate performance modifiers (e.g., animations)
    local argsModifiers = {
        petModel,
        {
            local_anim_name = "DogSit",
            local_anim_speed = 1,
            dont_allow_sit_states = true,
            dont_allow_remote_interaction = true,
            anim_fade_time = 0.2
        }
    }
    local success, err = pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("PetAPI/ReplicatePerformanceModifiers"):FireServer(unpack(argsModifiers))
    end)
    if not success then
        warn("Failed to replicate performance modifiers: " .. tostring(err))
        return false
    end
    print("Successfully replicated performance modifiers")

    return true
end

-- Function to check if the pet is focused
local function isPetFocused(petModel)
    local success, data = pcall(function()
        return require(ReplicatedStorage.ClientModules.Core.ClientData).get_data()[player.Name]
    end)

    if not success or not data or not data.pet_interaction then
        warn("Failed to get pet interaction data")
        return false
    end

    return data.pet_interaction.focused_pet == petModel
end

-- Function to progress the "Pet Me" ailment
local function progressPetMeAilment(petUniqueID)
    local args = { petUniqueID }
    local success, err = pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("AilmentsAPI/ProgressPetMeAilment"):FireServer(unpack(args))
    end)

    if success then
        print("Successfully progressed 'Pet Me' ailment")
        return true
    else
        warn("Failed to progress 'Pet Me' ailment: " .. tostring(err))
        return false
    end
end

-- Function to check the current progress of the "Pet Me" ailment
local function getPetMeProgress(petUniqueID)
    local success, data = pcall(function()
        return require(ReplicatedStorage.ClientModules.Core.ClientData).get_data()[player.Name]
    end)

    if success and data and data.ailments_manager and data.ailments_manager.ailments then
        local petMeData = data.ailments_manager.ailments[petUniqueID] and data.ailments_manager.ailments[petUniqueID].pet_me
        if petMeData then
            return petMeData.progress
        end
    end
    return nil
end

-- Function to find the pet model in the workspace
local function findPetModel(petUniqueID)
    local success, data = pcall(function()
        return require(ReplicatedStorage.ClientModules.Core.ClientData).get_data()[player.Name]
    end)

    if not success or not data or not data.inventory or not data.inventory.pets then
        warn("Failed to get player data or pet inventory")
        return nil
    end

    for petID, petData in pairs(data.inventory.pets) do
        if petData.unique == petUniqueID then
            local petModel = Workspace:FindFirstChild("Pets") and Workspace.Pets:FindFirstChild(petData.id)
            if petModel then
                return petModel
            end
        end
    end

    warn("Failed to find pet model in workspace")
    return nil
end

-- Function to finish the "Pet Me" ailment
local function finishPetMeAilment(petUniqueID)
    print("Starting to finish 'Pet Me' ailment for Pet ID: " .. petUniqueID)

    -- Find the pet model in the workspace
    local petModel = findPetModel(petUniqueID)
    if not petModel then
        warn("Failed to find pet model")
        return
    end

    -- Focus on the pet
    local success = focusPet(petModel)
    if not success then
        warn("Failed to focus pet")
        return
    end

    -- Set up petting animations
    success = setupPettingAnimations(petModel)
    if not success then
        warn("Failed to setup petting animations")
        return
    end

    -- Progress the ailment until it's fully completed
    while true do
        -- Check if the pet is focused, refocus if necessary
        if not isPetFocused(petModel) then
            print("Pet lost focus, refocusing...")
            local success = focusPet(petModel)
            if not success then
                warn("Failed to refocus pet")
                break
            end
        end

        local currentProgress = getPetMeProgress(petUniqueID)
        if currentProgress == nil then
            warn("Failed to get current progress for 'Pet Me' ailment")
            break
        end

        print("Current progress: " .. currentProgress)

        -- Check if the ailment is already fully progressed
        if currentProgress >= 1 then
            print("'Pet Me' ailment is fully progressed!")
            break
        end

        -- Progress the ailment
        local success = progressPetMeAilment(petUniqueID)
        if not success then
            warn("Failed to progress 'Pet Me' ailment")
            break
        end

        wait(1) -- Wait a second before progressing again
    end
end

-- Example usage:
local petUniqueID = "2_ca817f9348c34cf98be5b67057ca47d5"  -- Use the provided pet ID

-- Start finishing the "Pet Me" ailment
finishPetMeAilment(petUniqueID)
