local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local petUniqueID = "2_ca817f9348c34cf98be5b67057ca47d5"  -- Use the provided pet ID

-- Function to get player data
local function getPlayerData()
    local success, data = pcall(function()
        return require(ReplicatedStorage.ClientModules.Core.ClientData).get_data()[player.Name]
    end)
    if not success or not data then
        warn("Failed to get player data")
        return nil
    end
    return data
end

-- Function to find the pet model in the workspace
local function findPetModel(petUniqueID)
    local data = getPlayerData()
    if not data or not data.inventory or not data.inventory.pets then
        warn("Failed to get player data or pet inventory")
        return nil
    end

    for petID, petData in pairs(data.inventory.pets) do
        if petData.unique == petUniqueID then
            local petModel = Workspace:FindFirstChild("Pets") and Workspace.Pets:FindFirstChild(petData.id)
            if petModel then
                print("Found pet model in workspace: " .. petData.id)
                return petModel
            else
                warn("Pet model not found in workspace: " .. petData.id)
            end
        end
    end

    warn("Failed to find pet model in workspace for Pet ID: " .. petUniqueID)
    return nil
end

-- Function to focus on the pet
local function focusPet(petModel)
    if not petModel then
        warn("No pet model provided to focusPet function")
        return false
    end

    local argsFocus = { petModel }
    print("Attempting to focus pet...")
    local success, err = pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("AdoptAPI/FocusPet"):FireServer(unpack(argsFocus))
    end)

    if not success then
        warn("Failed to focus pet: " .. tostring(err))
        return false
    end

    print("Successfully focused pet")
    return true
end

-- Function to check if the pet is focused
local function isPetFocused(petModel)
    if not petModel then
        warn("No pet model provided to isPetFocused function")
        return false
    end

    local data = getPlayerData()
    if not data or not data.pet_interaction then
        warn("Failed to get pet interaction data")
        return false
    end

    return data.pet_interaction.focused_pet == petModel
end

-- Function to check the current progress of the "Pet Me" ailment
local function getPetMeProgress(petUniqueID)
    if not petUniqueID then
        warn("No pet unique ID provided to getPetMeProgress function")
        return nil
    end

    local data = getPlayerData()
    if not data or not data.ailments_manager or not data.ailments_manager.ailments then
        warn("Failed to get ailments data")
        return nil
    end

    local petMeData = data.ailments_manager.ailments[petUniqueID] and data.ailments_manager.ailments[petUniqueID].pet_me
    if petMeData then
        print("Current 'Pet Me' ailment progress: " .. tostring(petMeData.progress))
        return petMeData.progress
    else
        warn("No 'Pet Me' ailment found for Pet ID: " .. petUniqueID)
        return nil
    end
end

-- Function to progress the "Pet Me" ailment while ensuring pet is focused
local function progressPetMeAilment(petUniqueID, petModel)
    if not petUniqueID or not petModel then
        warn("Missing petUniqueID or petModel in progressPetMeAilment function")
        return false
    end

    -- Double-check that the pet is still focused before progressing
    if not isPetFocused(petModel) then
        warn("Pet is not focused! Re-focusing before progressing ailment...")
        if not focusPet(petModel) then
            warn("Failed to re-focus pet for ailment progression")
            return false
        end
        -- Wait a moment for focus to apply
        wait(0.2)
        
        -- Check focus again
        if not isPetFocused(petModel) then
            warn("Pet still not focused after re-attempt")
            return false
        end
    end

    local args = { petUniqueID }
    print("Progressing 'Pet Me' ailment while pet is focused...")
    local success, err = pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("AilmentsAPI/ProgressPetMeAilment"):FireServer(unpack(args))
    end)

    if success then
        print("Successfully progressed 'Pet Me' ailment while pet was focused")
        return true
    else
        warn("Failed to progress 'Pet Me' ailment: " .. tostring(err))
        return false
    end
end

-- Wait for condition with timeout
local function waitForCondition(conditionFunc, timeout, checkInterval)
    timeout = timeout or 5
    checkInterval = checkInterval or 0.1
    local startTime = tick()
    
    while tick() - startTime < timeout do
        if conditionFunc() then
            return true
        end
        wait(checkInterval)
    end
    return false
end

-- Main function to test each step
local function testPetMeAilment(petUniqueID)
    print("Starting to test 'Pet Me' ailment for Pet ID: " .. petUniqueID)

    -- Find the pet model in the workspace
    local petModel = findPetModel(petUniqueID)
    if not petModel then
        warn("Failed to find pet model")
        return
    end

    -- Focus on the pet
    local success = focusPet(petModel)
    if not success then
        warn("Failed to focus pet")
        return
    end

    -- Wait for focus to be properly applied
    local focused = waitForCondition(function()
        return isPetFocused(petModel)
    end, 3)
    
    if not focused then
        warn("Pet is not focused after waiting")
        return
    end
    print("Pet is focused and ready for ailment progression")

    -- Check the current progress of the "Pet Me" ailment
    local currentProgress = getPetMeProgress(petUniqueID)
    if currentProgress == nil then
        warn("Failed to get current progress for 'Pet Me' ailment")
        return
    end

    -- Progress the ailment while ensuring pet remains focused
    success = progressPetMeAilment(petUniqueID, petModel)
    if not success then
        warn("Failed to progress 'Pet Me' ailment")
        return
    end

    -- Wait a moment for the progress to update
    wait(0.3)

    -- Check the progress again
    local updatedProgress = getPetMeProgress(petUniqueID)
    if updatedProgress then
        print("Updated progress: " .. tostring(updatedProgress))
        
        -- Check if progress actually increased
        if updatedProgress > currentProgress then
            print("SUCCESS: 'Pet Me' ailment progress increased from " .. tostring(currentProgress) .. " to " .. tostring(updatedProgress))
        else
            print("Progress did not increase. Current: " .. tostring(updatedProgress))
        end
    else
        warn("Failed to get updated progress after progression attempt")
    end
end

-- Run the test
testPetMeAilment(petUniqueID)
