-- üêæ Adopt Me! Pet Releaser Auto-Farmer (CORRECTED LOGIC)
-- ‚úÖ START releasing pets ONLY when confirmed at Nursery
-- ‚úÖ Proper nursery detection and timing

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer
local API = ReplicatedStorage:WaitForChild("API")
local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)

-- üè† NURSERY DETECTION SYSTEM
local function isInNursery()
    local character = player.Character
    if not character then return false end
    
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end
    
    -- Check if player is in Nursery area
    local position = hrp.Position
    local inNursery = (
        position.X > 8900 and position.X < 9100 and
        position.Y > 6920 and position.Y < 6950 and
        position.Z > 11900 and position.Z < 12000
    )
    
    -- Additional check: Look for Nursery objects
    local nursery = Workspace:FindFirstChild("Nursery")
    local inNurseryByName = nursery and true or false
    
    return inNursery or inNurseryByName
end

-- üè† TELEPORT TO NURSERY (if not already there)
local function ensureInNursery()
    if isInNursery() then
        print("‚úÖ Already in Nursery")
        return true
    end
    
    print("üöö Teleporting to Nursery...")
    local character = player.Character
    if character and character:FindFirstChild("HumanoidRootPart") then
        -- Nursery coordinates (adjust based on your game)
        character.HumanoidRootPart.CFrame = CFrame.new(8975, 6933, 11953)
        
        -- Wait for teleport to complete
        wait(3)
        
        if isInNursery() then
            print("‚úÖ Successfully teleported to Nursery")
            return true
        else
            print("‚ùå Failed to reach Nursery")
            return false
        end
    end
    return false
end

-- üîç Get ALL pets from inventory.pets
local function getAllPets()
    local playerData = clientData.get_data()[player.Name]
    local pets = {}
    if playerData.inventory and playerData.inventory.pets then
        for uniqueId, petData in pairs(playerData.inventory.pets) do
            petData.uniqueId = uniqueId
            petData.unique = petData.unique or uniqueId
            table.insert(pets, petData)
        end
    end
    return pets
end

-- üü¢ Neon 6+ years old
local function getNeonOldPets()
    local pets = getAllPets()
    local oldNeons = {}
    for _, pet in ipairs(pets) do
        local isNeon = pet.properties and pet.properties.neon
        local age = pet.properties and pet.properties.age or 0
        if isNeon and age >= 6 then
            table.insert(oldNeons, pet.uniqueId)
            print("‚úÖ Neon Old Found: " .. pet.id .. " (Age: " .. age .. ")")
        end
    end
    return oldNeons
end

-- üîç Target: 18x Basic Egg 2022 dupes
local targetNames = {
    "basic_egg_2022_orangutan",
    "basic_egg_2022_parakeet", 
    "basic_egg_2022_robot",
    "basic_egg_2022_corgi"
}

local function getTargetDupes()
    local pets = getAllPets()
    local dupes = {}
    local counts = {}
    
    for _, name in ipairs(targetNames) do
        counts[name] = 0
    end
    
    for _, pet in ipairs(pets) do
        for _, name in ipairs(targetNames) do
            if pet.id == name then
                table.insert(dupes, pet.uniqueId)
                counts[name] = counts[name] + 1
                if #dupes >= 18 then break end
            end
        end
        if #dupes >= 18 then break end
    end
    
    print("üìä Dupe Counts: " .. HttpService:JSONEncode(counts))
    return dupes
end

-- ü•ö Count Crystal Eggs
local function countCrystalEggs()
    local playerData = clientData.get_data()[player.Name]
    local count = 0
    if playerData.inventory then
        for _, item in pairs(playerData.inventory) do
            if item.id == "crystal_egg" or item.name == "Crystal Egg" then
                count += 1
            end
        end
    end
    print("ü•ö CRYSTAL EGGS OWNED: " .. count)
    return count
end

-- ‚ôªÔ∏è RELEASE: 18 pets via HousingAPI (ONLY IN NURSERY)
local function releasePets()
    -- CRITICAL: Verify we're in Nursery first
    if not isInNursery() then
        print("‚ùå NOT IN NURSERY - Cannot release pets!")
        return false
    end
    
    local neonOld = getNeonOldPets()
    local bulkDupes = getTargetDupes()
   
    if #bulkDupes < 18 then
        print("‚ùå INSUFFICIENT DUPES! Need 18 Basic 2022. Found: " .. #bulkDupes)
        return false
    end
   
    -- BOOST: Replace 1 dupe w/ Neon 6+ (if available)
    local petIds = bulkDupes
    if #neonOld > 0 then
        petIds[1] = neonOld[1]
        print("üöÄ BOOSTED: Added Neon 6+ yr pet!")
    end
   
    -- Release pets via HousingAPI
    local furnitureId = "nursery_releaser"
    local actionData = {
        action = "release",
        uniques = {}
    }
    
    for _, petId in ipairs(petIds) do
        actionData.uniques[petId] = true
    end
   
    local args = {
        furnitureId,
        "UseBlock",
        actionData,
        player.Character
    }
   
    local success, err = pcall(function()
        return API.HousingAPI.ActivateInteriorFurniture:InvokeServer(unpack(args))
    end)
   
    if success then
        print("üöÄ RELEASED 18 PETS! Timer started (7 min)...")
        return true
    else
        print("‚ùå RELEASE FAILED: " .. tostring(err))
        -- Fallback methods
        pcall(function() API.PetAPI.ReleasePets:FireServer(petIds) end)
        pcall(function() API.PetReleaserAPI.ReleaseBatch:FireServer(petIds) end)
        return false
    end
end

-- ‚úÖ CLAIM: After 7 min (MUST BE IN NURSERY)
local function claimRewards()
    -- CRITICAL: Verify we're still in Nursery
    if not isInNursery() then
        print("‚ùå LEFT NURSERY - Cannot claim rewards!")
        return false
    end
    
    local furnitureId = "nursery_releaser"
    local args = {
        furnitureId,
        "UseBlock", 
        { action = "claim" },
        player.Character
    }
    
    local success, err = pcall(function()
        API.HousingAPI.ActivateInteriorFurniture:InvokeServer(unpack(args))
    end)
    
    if success then
        print("‚úÖ REWARDS CLAIMED!")
        return true
    else
        print("‚ùå CLAIM FAILED: " .. tostring(err))
        return false
    end
end

-- üî• CORRECTED MAIN LOOP
local function farmLoop()
    print("\nüî• FARM CYCLE START")
    
    -- STEP 1: Count eggs before
    countCrystalEggs()
    
    -- STEP 2: Ensure we're in Nursery
    if not ensureInNursery() then
        print("‚ùå CANNOT REACH NURSERY - Skipping cycle")
        return
    end
    
    -- STEP 3: Release pets (ONLY if in Nursery)
    if releasePets() then
        print("‚è≥ Waiting 7 minutes for rewards...")
        
        -- STEP 4: Wait 7 minutes BUT check if we're still in Nursery periodically
        for i = 1, 420 do -- 420 seconds = 7 minutes
            wait(1)
            
            -- Safety check: If we left Nursery, abort
            if not isInNursery() then
                print("‚ùå LEFT NURSERY DURING WAIT - Rewards lost!")
                return
            end
            
            -- Progress indicator every minute
            if i % 60 == 0 then
                print("‚è∞ " .. math.floor(i/60) .. " minutes elapsed...")
            end
        end
        
        -- STEP 5: Claim rewards (verify still in Nursery)
        if isInNursery() then
            claimRewards()
            -- Count eggs after
            countCrystalEggs()
        else
            print("‚ùå LEFT NURSERY BEFORE CLAIM - Rewards lost!")
        end
    end
    
    print("üí§ Cycle complete, waiting 5 seconds...")
    wait(5)
end

-- üöÄ START SAFE FARMING
print("üêæ PET RELEASER FARMER LOADED! Goal: Crystal Eggs ü•ö")
print("üìç REQUIREMENT: Must be in Nursery to release pets")

-- Safe infinite loop with error handling
while true do
    local success, err = pcall(farmLoop)
    if not success then
        print("‚ùå CYCLE ERROR: " .. tostring(err))
        print("üîÑ Restarting in 10 seconds...")
        wait(10)
    end
end
