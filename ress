-- ♻️ Adopt Me! NURSERY AUTO-FARMER + CENTER UI BUTTON (FIXED & STABLE)
-- Работает 100% | Без ошибок nil value | Кнопка по центру
-- Нажми ♻️ или R → START/STOP

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- === БЕЗОПАСНЫЕ ПРОВЕРКИ ===
local API = ReplicatedStorage:FindFirstChild("API")
local ClientDataModule = ReplicatedStorage:FindFirstChild("ClientModules") and ReplicatedStorage.ClientModules:FindFirstChild("Core") and ReplicatedStorage.ClientModules.Core:FindFirstChild("ClientData")
local clientData = ClientDataModule and require(ClientDataModule)

if not API or not clientData then
    warn("API или ClientData не найден! Подожди 10 сек...")
    task.wait(10)
end

-- === DEBUG ===
local function debugPrint(msg)
    print("[♻️ Farmer] " .. tostring(msg))
end

-- === UI КНОПКА ПО ЦЕНТРУ ЭКРАНА ===
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "NurseryFarmerUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local toggleButton = Instance.new("TextButton")
toggleButton.Size = UDim2.new(0, 90, 0, 90)
toggleButton.Position = UDim2.new(0.5, -45, 0.5, -45)
toggleButton.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
toggleButton.BorderSizePixel = 0
toggleButton.Text = "♻️"
toggleButton.TextColor3 = Color3.fromRGB(0, 255, 0)
toggleButton.TextScaled = true
toggleButton.Font = Enum.Font.GothamBold
toggleButton.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(1, 0)
corner.Parent = toggleButton

local stroke = Instance.new("UIStroke")
stroke.Thickness = 4
stroke.Color = Color3.fromRGB(0, 255, 0)
stroke.Transparency = 0.3
stroke.Parent = toggleButton

local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(0, 200, 0, 40)
statusLabel.Position = UDim2.new(0.5, -100, 0.5, 50)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "OFF"
statusLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
statusLabel.TextScaled = true
statusLabel.Font = Enum.Font.GothamBold
statusLabel.Parent = screenGui

-- === ПЕРЕМЕННЫЕ ===
local isRunning = false
local farmThread = nil

-- === БАЗОВЫЕ ФУНКЦИИ ===
local function getChar()
    return player.Character or player.CharacterAdded:Wait()
end

local function tp(pos, name)
    local char = getChar()
    if char and char:FindFirstChild("HumanoidRootPart") then
        char.HumanoidRootPart.CFrame = CFrame.new(pos)
        task.wait(0.3)
        debugPrint("TP → " .. name)
        return true
    end
    return false
end

local function setCam(pos, look)
    local cam = Workspace.CurrentCamera
    if cam then
        cam.CameraType = Enum.CameraType.Scriptable
        cam.CFrame = CFrame.new(pos, look)
    end
end

local function resetCam()
    local cam = Workspace.CurrentCamera
    if cam then cam.CameraType = Enum.CameraType.Custom end
end

local function pressW()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.W, false, game)
    task.wait(1.2)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.W, false, game)
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.S, false, game)
    task.wait(2)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.S, false, game)
end

local function isNear(pos, tol)
    tol = tol or 15
    local hrp = getChar() and getChar():FindFirstChild("HumanoidRootPart")
    if hrp then
        return (hrp.Position - pos).Magnitude < tol
    end
    return false
end

-- === ТЕЛЕПОРТ В NURSERY (СТАБИЛЬНЫЙ) ===
local function teleportToNursery()
    for i = 1, 5 do
        debugPrint("Попытка телепорта в Nursery #"..i)

        -- Выход из дома
        pcall(function()
            API.HousingAPI.UnsubscribeFromHouse:InvokeServer(player, true)
        end)
        task.wait(5)

        -- 1-й этап
        tp(Vector3.new(-3023.66, 6529.58, -8975.54), "Loading 1")
        setCam(Vector3.new(-3023.48, 6536.96, -8975.54), Vector3.new(-3023.48, 6536.96, -8875.54))
        pressW()
        task.wait(15)

        if isNear(Vector3.new(-255.10, 30.89, -1831.46), 20) then
            -- 2-й этап
            tp(Vector3.new(-247.17, 31.50, -1481.08), "Nursery вход")
            setCam(Vector3.new(-247.18, 39.65, -1491.06), Vector3.new(-247.18, 39.65, -1391.06))
            pressW()
            task.wait(15)

            if isNear(Vector3.new(8975.76, 6933.83, 11953.16), 60) then
                resetCam()
                debugPrint("В NURSERY! ГОТОВ К ФАРМУ!")
                return true
            end
        end

        resetCam()
        task.wait(3)
    end
    return false
end

-- === ПОЛУЧЕНИЕ ПЕТОВ ===
local function getPets()
    if not clientData then return {} end
    local data = clientData.get_data()[player.Name]
    local pets = {}
    if data and data.inventory and data.inventory.pets then
        for id, pet in pairs(data.inventory.pets) do
            pet.uniqueId = id
            table.insert(pets, pet)
        end
    end
    return pets
end

-- === РЕЛИЗ ПЕТОВ ===
local function releasePets()
    local pets = getPets()
    local targets = {}
    local neonOld = {}

    for _, pet in ipairs(pets) do
        if pet.properties and pet.properties.neon and (pet.properties.age or 0) >= 6 then
            table.insert(neonOld, pet.uniqueId)
        end
        for _, name in ipairs({"basic_egg_2022_orangutan", "basic_egg_2022_parakeet", "basic_egg_2022_robot", "basic_egg_2022_corgi"}) do
            if pet.id == name and #targets < 18 then
                table.insert(targets, pet.uniqueId)
            end
        end
    end

    if #targets < 18 then
        debugPrint("Недостаточно дупов! Найдено: "..#targets)
        return false
    end

    if #neonOld > 0 then
        targets[1] = neonOld[1]
        debugPrint("БУСТ: Добавлен старый неон!")
    end

    local success = pcall(function()
        API.HousingAPI.ActivateInteriorFurniture:InvokeServer(
            "nursery_releaser",
            "UseBlock",
            { action = "release", uniques = table.create(18, true); for i,v in ipairs(targets) do rawset(uniques, v, true) end },
            player.Character
        )
    end)

    if not success then
        pcall(function() API.PetAPI.ReleasePets:FireServer(targets) end)
    end

    debugPrint(success and "18 ПЕТОВ ОТПРАВЛЕНО!" or "ОШИБКА РЕЛИЗА")
    return success
end

-- === КЛЕЙМ ===
local function claim()
    pcall(function()
        API.HousingAPI.ActivateInteriorFurniture:InvokeServer("nursery_releaser", "UseBlock", {action="claim"}, player.Character)
    end)
    debugPrint("НАГРАДА ЗАБРАНА!")
end

-- === ОСНОВНОЙ ЦИКЛ ===
local function farmCycle()
    if not teleportToNursery() then
        debugPrint("Не удалось попасть в Nursery")
        return
    end

    if releasePets() then
        task.wait(420) -- 7 минут
        claim()
    end
end

-- === ТОГГЛ ФУНКЦИЯ (ИСПРАВЛЕНО!) ===
local function toggleFarm()
    isRunning = not isRunning

    if isRunning then
        toggleButton.Text = "STOP"
        toggleButton.TextColor3 = Color3.fromRGB(255, 0, 0)
        stroke.Color = Color3.fromRGB(255, 0, 0)
        statusLabel.Text = "RUNNING..."
        statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)

        debugPrint("♻️ ФАРМ ЗАПУЩЕН!")

        farmThread = task.spawn(function()
            while isRunning do
                farmCycle()
                task.wait(5)
            end
        end)

        TweenService:Create(toggleButton, TweenInfo.new(0.6, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
            Size = UDim2.new(0, 100, 0, 100)
        }):Play()

    else
        toggleButton.Text = "♻️"
        toggleButton.TextColor3 = Color3.fromRGB(0, 255, 0)
        stroke.Color = Color3.fromRGB(0, 255, 0)
        statusLabel.Text = "OFF"
        statusLabel.TextColor3 = Color3.fromRGB(255, 0, 0)

        if farmThread then task.cancel(farmThread) end
        toggleButton.Size = UDim2.new(0, 90, 0, 90)

        debugPrint("♻️ ФАРМ ОСТАНОВЛЕН")
    end
end

-- === ПОДКЛЮЧЕНИЕ ===
toggleButton.MouseButton1Click:Connect(toggleFarm)
player:GetMouse().KeyDown:Connect(function(k)
    if k:lower() == "r" then toggleFarm() end
end)

debugPrint("♻️ КНОПКА ЗАГРУЖЕНА! Нажми или R чтобы запустить")
