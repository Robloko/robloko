-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local VirtualUser = game:GetService("VirtualUser")

-- Local player
local localPlayer = Players.LocalPlayer
local playerGui = localPlayer:WaitForChild("PlayerGui")

-- Configuration
local CONFIG = {
    TARGET_PLAYER = "Gerranafa",
    GIFT_TYPE = "winter_2025_angus_box",  -- Changed from your variable
    DELAY_BETWEEN_GIFTS = 9,  -- seconds
    DELAY_BETWEEN_ACTIONS = 1,  -- seconds for opening gifts
    UI_SIZE = UDim2.new(0, 320, 0, 200)  -- Slightly larger for better readability
}

-- Create ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "GiftGiverUI"
screenGui.Parent = playerGui
screenGui.ResetOnSpawn = false

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = CONFIG.UI_SIZE
mainFrame.Position = UDim2.new(0.5, -CONFIG.UI_SIZE.X.Offset/2, 0, 20)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
mainFrame.BorderSizePixel = 0
mainFrame.BackgroundTransparency = 0.05
mainFrame.Parent = screenGui

-- Make draggable
local dragging, dragInput, dragStart, startPos
mainFrame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

mainFrame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input == dragInput then
        local delta = input.Position - dragStart
        mainFrame.Position = startPos + UDim2.new(0, delta.X, 0, delta.Y)
    end
end)

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 12)
mainCorner.Parent = mainFrame

-- Title Bar
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 32)
titleBar.Position = UDim2.new(0, 0, 0, 0)
titleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
titleBar.BorderSizePixel = 0
titleBar.Parent = mainFrame

local titleBarCorner = Instance.new("UICorner")
titleBarCorner.CornerRadius = UDim.new(0, 12, 0, 0)
titleBarCorner.Parent = titleBar

-- Title
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -10, 1, 0)
title.Position = UDim2.new(0, 10, 0, 0)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Text = "ðŸŽ Gift Giver"
title.Font = Enum.Font.SourceSansBold
title.TextSize = 18
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = titleBar

-- Close Button
local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 24, 0, 24)
closeButton.Position = UDim2.new(1, -28, 0.5, -12)
closeButton.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.Text = "âœ•"
closeButton.Font = Enum.Font.SourceSansBold
closeButton.TextSize = 16
closeButton.Parent = titleBar
local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 6)
closeCorner.Parent = closeButton

closeButton.MouseButton1Click:Connect(function()
    screenGui:Destroy()
end)

-- Content Container
local content = Instance.new("Frame")
content.Size = UDim2.new(1, -10, 1, -42)
content.Position = UDim2.new(0, 5, 0, 37)
content.BackgroundTransparency = 1
content.Parent = mainFrame

-- Target Player Label
local targetLabel = Instance.new("TextLabel")
targetLabel.Size = UDim2.new(1, 0, 0, 28)
targetLabel.Position = UDim2.new(0, 0, 0, 0)
targetLabel.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
targetLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
targetLabel.Text = "Target: " .. CONFIG.TARGET_PLAYER
targetLabel.Font = Enum.Font.SourceSansSemibold
targetLabel.TextSize = 16
targetLabel.Parent = content
local targetCorner = Instance.new("UICorner")
targetCorner.CornerRadius = UDim.new(0, 8)
targetCorner.Parent = targetLabel

-- Give All Button
local giveAllButton = Instance.new("TextButton")
giveAllButton.Size = UDim2.new(1, 0, 0, 32)
giveAllButton.Position = UDim2.new(0, 0, 0, 32)
giveAllButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
giveAllButton.TextColor3 = Color3.fromRGB(255, 255, 255)
giveAllButton.Text = "Give All Gifts"
giveAllButton.Font = Enum.Font.SourceSansBold
giveAllButton.TextSize = 16
giveAllButton.Parent = content
local giveAllCorner = Instance.new("UICorner")
giveAllCorner.CornerRadius = UDim.new(0, 8)
giveAllCorner.Parent = giveAllButton

-- Open Button
local openButton = Instance.new("TextButton")
openButton.Size = UDim2.new(1, 0, 0, 32)
openButton.Position = UDim2.new(0, 0, 0, 68)
openButton.BackgroundColor3 = Color3.fromRGB(0, 100, 255)
openButton.TextColor3 = Color3.fromRGB(255, 255, 255)
openButton.Text = "Open One Gift"
openButton.Font = Enum.Font.SourceSansBold
openButton.TextSize = 16
openButton.Parent = content
local openCorner = Instance.new("UICorner")
openCorner.CornerRadius = UDim.new(0, 8)
openCorner.Parent = openButton

-- Status Label
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, 0, 0, 32)
statusLabel.Position = UDim2.new(0, 0, 0, 104)
statusLabel.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
statusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
statusLabel.Text = "Loading..."
statusLabel.Font = Enum.Font.SourceSansSemibold
statusLabel.TextSize = 14
statusLabel.TextWrapped = true
statusLabel.Parent = content
local statusCorner = Instance.new("UICorner")
statusCorner.CornerRadius = UDim.new(0, 8)
statusCorner.Parent = statusLabel

-- Variables
local giftInventory = {}
local totalGiftAmount = 0
local isGiving = false
local isOpening = false

-- Function to safely get client data
local function getClientData()
    local success, clientData = pcall(require, ReplicatedStorage:WaitForChild("ClientModules"):WaitForChild("Core"):WaitForChild("ClientData"))
    if not success then
        warn("Failed to require ClientData")
        return nil
    end
    
    local success2, allData = pcall(clientData.get_data, clientData)
    if not success2 then
        warn("Failed to get data from ClientData")
        return nil
    end
    
    return allData
end

-- Function to update gift inventory
local function updateGiftInventory()
    local allData = getClientData()
    if not allData or not allData[localPlayer.Name] then
        return 0
    end

    giftInventory = {}
    totalGiftAmount = 0
    
    local playerData = allData[localPlayer.Name]
    if playerData.inventory and playerData.inventory.gifts then
        for uniqueId, giftData in pairs(playerData.inventory.gifts) do
            if giftData.id == CONFIG.GIFT_TYPE then
                local amount = giftData.amount or 1
                table.insert(giftInventory, {
                    uid = uniqueId,
                    amount = amount,
                    data = giftData
                })
                totalGiftAmount = totalGiftAmount + amount
            end
        end
    end
    
    table.sort(giftInventory, function(a, b)
        return a.amount > b.amount  -- Sort by largest stacks first
    end)
    
    statusLabel.Text = string.format("Gifts: %d (Stacks: %d)", totalGiftAmount, #giftInventory)
    return totalGiftAmount
end

-- Function to find target player
local function findTargetPlayer()
    local targetPlayer = Players:FindFirstChild(CONFIG.TARGET_PLAYER)
    if targetPlayer then
        targetLabel.Text = string.format("Target: %s âœ“", CONFIG.TARGET_PLAYER)
        targetLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
        return targetPlayer
    else
        targetLabel.Text = string.format("Target: %s (Offline)", CONFIG.TARGET_PLAYER)
        targetLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return nil
    end
end

-- Function to give all gifts to target player
local function giveAllGiftsToPlayer()
    if isGiving then 
        statusLabel.Text = "Already giving gifts!"
        return 
    end

    local targetPlayer = findTargetPlayer()
    if not targetPlayer then
        statusLabel.Text = "ERROR: Target not found!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end

    updateGiftInventory()

    if #giftInventory == 0 then
        statusLabel.Text = "No gifts to give!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        return
    end

    isGiving = true
    giveAllButton.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
    giveAllButton.Text = "Giving..."

    print(string.format("Giving %d stacks of %s to %s", 
        #giftInventory, CONFIG.GIFT_TYPE, targetPlayer.Name))

    local successCount = 0
    local failCount = 0
    local totalGiven = 0

    for i, stack in ipairs(giftInventory) do
        if not findTargetPlayer() then
            statusLabel.Text = "Target disconnected!"
            statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            failCount = failCount + 1
            break
        end

        local args = {targetPlayer, stack.uid}
        local success, result = pcall(function()
            local api = ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/GiveItem")
            return api:InvokeServer(unpack(args))
        end)

        if success then
            successCount = successCount + 1
            totalGiven = totalGiven + stack.amount
            
            statusLabel.Text = string.format("Giving: %d/%d", i, #giftInventory)
            statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
            
            print(string.format("Gave stack %d/%d (Amount: %d)", 
                i, #giftInventory, stack.amount))
        else
            failCount = failCount + 1
            statusLabel.Text = string.format("Failed: %d/%d", i, #giftInventory)
            statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            
            warn("Failed to give stack " .. i .. ": " .. tostring(result))
        end

        if i < #giftInventory then
            for waitTime = CONFIG.DELAY_BETWEEN_GIFTS, 1, -1 do
                if not isGiving then break end
                statusLabel.Text = string.format("Waiting: %ds (%d/%d)", 
                    waitTime, i, #giftInventory)
                task.wait(1)
            end
        end
    end

    isGiving = false
    giveAllButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    giveAllButton.Text = "Give All Gifts"

    local remaining = updateGiftInventory()

    if failCount == 0 and successCount > 0 then
        statusLabel.Text = string.format("Success! Gave %d gifts", totalGiven)
        statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
    elseif successCount > 0 then
        statusLabel.Text = string.format("Partial: %dâœ“ %dâœ— (%d left)", 
            successCount, failCount, remaining)
        statusLabel.TextColor3 = Color3.fromRGB(255, 200, 0)
    else
        statusLabel.Text = "Failed to give any gifts"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
    end

    print(string.format("Transfer complete. Given: %d, Failed: %d, Remaining: %d", 
        totalGiven, failCount, remaining))
end

-- Function to open one gift
local function openOneGift()
    if isOpening then 
        statusLabel.Text = "Already opening a gift!"
        return 
    end

    isOpening = true
    openButton.BackgroundColor3 = Color3.fromRGB(170, 0, 170)
    openButton.Text = "Opening..."

    local allData = getClientData()
    if not allData or not allData[localPlayer.Name] then
        statusLabel.Text = "Error: Could not access client data"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        isOpening = false
        openButton.BackgroundColor3 = Color3.fromRGB(0, 100, 255)
        openButton.Text = "Open One Gift"
        return
    end

    local playerData = allData[localPlayer.Name]
    if not playerData.inventory or not playerData.inventory.gifts then
        statusLabel.Text = "Error: No inventory data"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        isOpening = false
        openButton.BackgroundColor3 = Color3.fromRGB(0, 100, 255)
        openButton.Text = "Open One Gift"
        return
    end

    local gifts = playerData.inventory.gifts
    local giftToOpen = nil

    -- Find the first gift of the target type
    for uniqueId, giftData in pairs(gifts) do
        if giftData.id == CONFIG.GIFT_TYPE then
            giftToOpen = {uid = uniqueId, data = giftData}
            break
        end
    end

    if not giftToOpen then
        statusLabel.Text = "No " .. CONFIG.GIFT_TYPE .. " found"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        isOpening = false
        openButton.BackgroundColor3 = Color3.fromRGB(0, 100, 255)
        openButton.Text = "Open One Gift"
        return
    end

    statusLabel.Text = "Equipping gift..."
    statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)

    -- Try to equip the gift
    local equipSuccess = pcall(function()
        ReplicatedStorage.API["ToolAPI/Equip"]:InvokeServer(giftToOpen.uid)
    end)
    
    if not equipSuccess then
        statusLabel.Text = "Failed to equip gift"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        isOpening = false
        openButton.BackgroundColor3 = Color3.fromRGB(0, 100, 255)
        openButton.Text = "Open One Gift"
        return
    end

    task.wait(CONFIG.DELAY_BETWEEN_ACTIONS)

    -- Simulate click
    VirtualUser:ClickButton1(Vector2.new(0.5, 0.5))
    task.wait(CONFIG.DELAY_BETWEEN_ACTIONS)

    -- Try to open the gift
    local openSuccess = false
    local openError = ""
    
    -- START opening
    local startSuccess = pcall(function()
        ReplicatedStorage.API["ToolAPI/ServerUseTool"]:FireServer(giftToOpen.uid, "START")
    end)
    
    if startSuccess then
        task.wait(CONFIG.DELAY_BETWEEN_ACTIONS)
        
        -- Indicate opening
        pcall(function()
            ReplicatedStorage.API["ShopAPI/IndicateOpenGift"]:FireServer(giftToOpen.uid)
        end)
        task.wait(CONFIG.DELAY_BETWEEN_ACTIONS)
        
        -- END opening
        local endSuccess = pcall(function()
            ReplicatedStorage.API["ToolAPI/ServerUseTool"]:FireServer(giftToOpen.uid, "END")
        end)
        
        openSuccess = endSuccess
    end

    isOpening = false
    openButton.BackgroundColor3 = Color3.fromRGB(0, 100, 255)
    openButton.Text = "Open One Gift"

    if openSuccess then
        statusLabel.Text = "Gift opened successfully!"
        statusLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
        task.wait(2)  -- Wait before updating inventory
        updateGiftInventory()
    else
        statusLabel.Text = "Failed to open gift"
        statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
    end
end

-- Button Clicks
giveAllButton.MouseButton1Click:Connect(function()
    task.spawn(giveAllGiftsToPlayer)
end)

openButton.MouseButton1Click:Connect(function()
    task.spawn(openOneGift)
end)

-- Cancel buttons
giveAllButton.MouseButton2Click:Connect(function()
    if isGiving then
        isGiving = false
        statusLabel.Text = "Cancelled!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 200, 0)
        giveAllButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
        giveAllButton.Text = "Give All Gifts"
    end
end)

openButton.MouseButton2Click:Connect(function()
    if isOpening then
        isOpening = false
        statusLabel.Text = "Cancelled!"
        statusLabel.TextColor3 = Color3.fromRGB(255, 200, 0)
        openButton.BackgroundColor3 = Color3.fromRGB(0, 100, 255)
        openButton.Text = "Open One Gift"
    end
end)

-- Initial updates
task.spawn(function()
    task.wait(1)  -- Wait for game to fully load
    findTargetPlayer()
    updateGiftInventory()
end)

-- Periodic refresh
local connection
connection = RunService.Heartbeat:Connect(function()
    -- Update every 5 seconds
    if os.time() % 5 < 0.1 then
        findTargetPlayer()
        updateGiftInventory()
    end
end)

-- Cleanup
screenGui.Destroying:Connect(function()
    if connection then
        connection:Disconnect()
    end
end)

print(string.format("Gift Giver UI Loaded! Targets %s gifts for %s.", 
    CONFIG.GIFT_TYPE, CONFIG.TARGET_PLAYER))
