-- UTILITIES
--------------------------------------------------------------
local player = game.Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")

local function log(msg) print("[Nursery Farmer] " .. tostring(msg)) end
local function getChar() return player.Character or player.CharacterAdded:Wait() end
local function safeTp(pos)
    return pcall(function()
        local hrp = getChar():FindFirstChild("HumanoidRootPart")
        if hrp then hrp.CFrame = CFrame.new(pos); task.wait(0.3) end
    end)
end
local function setCam(pos, look)
    pcall(function()
        local cam = Workspace.CurrentCamera
        if cam then cam.CameraType = Enum.CameraType.Scriptable; cam.CFrame = CFrame.new(pos, look) end
    end)
end
local function resetCam()
    pcall(function()
        local cam = Workspace.CurrentCamera
        if cam then cam.CameraType = Enum.CameraType.Custom end
    end)
end
local function pressW()
    pcall(function()
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.W, false, game)
        task.wait(0.1)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.W, false, game)
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.S, false, game)
        task.wait(0.1)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.S, false, game)
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.W, false, game)
        task.wait(0.1)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.W, false, game)
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.W, false, game)
        task.wait(0.1)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.W, false, game)
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.W, false, game)
        task.wait(1)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.W, false, game)
        VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.S, false, game)
        task.wait(1)
        VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.S, false, game)
    end)
end
local function isNear(pos, dist)
    dist = dist or 60
    local success, result = pcall(function()
        local hrp = getChar():FindFirstChild("HumanoidRootPart")
        return hrp and (hrp.Position - pos).Magnitude < dist
    end)
    return success and result or false
end
--------------------------------------------------------------
-- TELEPORT TO MAIN (formerly goToNursery)
--------------------------------------------------------------
local function gotoMain()
    for attempt = 1, 3 do
        log("Teleport attempt " .. attempt)
        game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("TeamAPI/Spawn"):InvokeServer()
        task.wait(9)
        -- Exit house using correct API
        pcall(function()
            local unsubscribeAPI = ReplicatedStorage.API:FindFirstChild("HousingAPI/UnsubscribeFromHouse")
            if unsubscribeAPI then
                if unsubscribeAPI:IsA("RemoteFunction") then
                    unsubscribeAPI:InvokeServer(player, true)
                elseif unsubscribeAPI:IsA("RemoteEvent") then
                    unsubscribeAPI:FireServer(player, true)
                end
            end
        end)
        task.wait(7)
        if safeTp(Vector3.new(-3025.614, 6529.577, -8968.435)) then
            setCam(Vector3.new(-3025.623, 6532.164, -8970.206), Vector3.new(0, 0, 1))
            pressW()
            task.wait(15)
            if isNear(Vector3.new(-255.10, 30.89, -1831.46), 50) then
                if safeTp(Vector3.new(-247.17, 31.50, -1481.08)) then
                    setCam(Vector3.new(-247.18, 39.65, -1491.06), Vector3.new(-247.18, 39.65, -1391.06))
                end
            end
        end
        resetCam()
        task.wait(2)
    end
    return false
end
--------------------------------------------------------------
-- EXIT HOME AND TP TO SPECIFIC LOCATION
--------------------------------------------------------------
local function exitHomeAndTpToSpecific()
    log("Exiting home and teleporting to specific location...")
    -- Spawn to ensure proper state before exiting
    log("Spawning player...")
    pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("TeamAPI/Spawn"):InvokeServer()
    end)
    task.wait(9)
    -- Exit house using correct API
    log("Unsubscribing from house...")
    pcall(function()
        local unsubscribeAPI = ReplicatedStorage.API:FindFirstChild("HousingAPI/UnsubscribeFromHouse")
        if unsubscribeAPI then
            if unsubscribeAPI:IsA("RemoteFunction") then
                unsubscribeAPI:InvokeServer(player, true)
            elseif unsubscribeAPI:IsA("RemoteEvent") then
                unsubscribeAPI:FireServer(player, true)
            end
        else
            log("⚠️ HousingAPI/UnsubscribeFromHouse not found!")
        end
    end)
    task.wait(7)
    local targetPos = Vector3.new(-247.17, 31.50, -1481.08)
    log("Attempting teleport to: " .. tostring(targetPos))
    local tpSuccess = safeTp(targetPos)
    if tpSuccess then
        log("✅ Teleported to specific location: " .. tostring(targetPos))
        -- Optional: Set camera if needed
        setCam(Vector3.new(-247.18, 39.65, -1491.06), Vector3.new(-247.18, 39.65, -1391.06))
        task.wait(1)
        resetCam()
        return true
    else
        log("❌ Failed to teleport to specific location. Check position or anti-cheat.")
        return false
    end
end
