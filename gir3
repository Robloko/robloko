-- Load Rayfield UI Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local localPlayer = Players.LocalPlayer

-- Remote event references
local adoptmeNet = game:GetService("ReplicatedStorage"):WaitForChild("adoptme_new_net")
local iceSkatingEvent = adoptmeNet:WaitForChild("adoptme_legacy_shared.ContentPacks.Winter2025.Game.IceSkating.IceSkatingNet:7")
local collectEvent = adoptmeNet:WaitForChild("adoptme_legacy_shared.ContentPacks.Winter2025.Game.IceSkating.IceSkatingNet:16")
local trainEvent = adoptmeNet:WaitForChild("adoptme_legacy_shared.ContentPacks.Winter2025.Game.Train.WinterTrainNet:7")
local spawnAPI = game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("TeamAPI/Spawn")

-- Gingerbread IDs
local gingerbreadIds = {
    "{60E33537-47D5-4212-958D-307C17501331}",
    "{28F6FD49-55C2-4E45-88F3-E62344AEE010}",
    "{96EB009D-84A2-464B-925E-41E269B5D7E4}",
    "{437F2FA1-230F-498F-9276-DE0EF87C3AE1}",
    "{1F5105D1-7F27-4C3F-88F8-DAB5AC6F80A7}",
    "{81E888FB-BEF4-4F79-AE22-C5F438EF0E4E}",
    "{9989159C-CF88-4D53-A30D-037A337969D3}",
    "{82062F93-CB93-48AF-9DEB-AB5385F67173}",
    "{4112DDAB-4A73-4C16-A75C-DD260D6D0155}",
    "{D07D63E3-184C-41E1-9664-4DD8E26237C6}",
    "{D1B20364-78F5-4CCC-A510-E40A8D625D16}",
    "{248879AA-6B47-4BCF-AFC0-161C2EBFF6AD}",
    "{F8FAEF3D-A8EC-4FC6-B6DA-9900D9F01089}",
    "{80612A9C-FDE0-4CEE-B5F8-8B7DE2E9DC39}",
    "{A6482191-3E6B-45E0-B1F6-5BE8600C0D46}",
    "{2BEB302F-EB22-4403-B2E7-F4239A306A9C}",
    "{65E06DD8-CCCB-4DFC-ADED-EC29B7890D53}",
    "{40475233-9A85-4BE4-B20F-4C7A2C04C67E}",
    "{CF994B67-FA40-453E-ADEA-859E4B2C48A3}",
    "{5E5EAA7A-C7C4-4AB0-AB22-DBFD967098BF}",
    "{850FA732-1759-41FD-8D11-A966F663DC54}",
    "{0217C4CB-EBE3-4EAD-BAA8-801D1DD0BD8F}",
    "{C61B5F35-B5E6-4DDE-B9CA-8C5CDE82D3F5}",
    "{F0F44CAC-FF90-4B94-A996-5094CECF1531}",
    "{487EE748-30B2-40A5-AEAC-2724E29C6C6D}",
    "{C8380520-D52C-46F1-A257-ADA9BC410E79}",
    "{51F28E59-3CEC-46F4-84C3-5D6FD3FBCCF1}",
    "{8B70133A-0EDA-439B-B41D-26B9EE5B824D}",
    "{4B0E202F-743E-46C3-A538-CAAABE3D6A76}",
    "{3C929F9E-9C60-4844-B6A6-C5AB16B89030}",
    "{1CA3C55C-E6FF-4632-B023-4AFABBD3175F}",
    "{E58BFD84-62BE-4A62-A2C8-5D088FB0E6BF}",
    "{FB967ED2-445C-4B78-8576-5D99AB7AA4B9}",
    "{FC8810F5-8C12-46AC-9260-12E9276199B2}",
    "{29580925-384D-4CF6-810A-5B2FBEBE14EF}",
    "{A6C07949-FE1D-4C8A-9234-782981398813}",
    "{82B7AF91-D7FD-48D5-BEA1-A7048595647E}",
    "{1B7E9043-B129-4341-BDB9-FA83CE503F5C}",
    "{25DA2E1D-7191-4B7F-AB26-5EFECB267307}",
    "{87A78497-E137-47E5-AE8A-5E4C0F30D90A}",
    "{F11CFC7D-3222-4856-AB81-532ADB118D34}",
    "{CC47FF49-48FD-444E-8F70-BFB36EB4E1DE}",
    "{2883E3B9-AEB4-4577-A1E6-D75BD7D00042}",
    "{9E8B22FE-410D-4005-8610-B5BEE9058A01}",
    "{69372C32-4F4E-4786-B973-36405115DC84}",
    "{5FD5BDBD-5847-4EFD-9DF1-0AB7B94A3548}",
    "{D194622B-F101-47D3-8974-7610FB3830AE}",
    "{8897445D-6138-4BD6-8DA1-1F02ECFE5898}",
    "{808A9B20-FA50-412A-9A5D-D728B1D355A9}",
    "{5C9A79E8-A97B-4DD9-8B8B-7DAD80B541E0}",
    "{1A218809-DBE4-4542-80B2-2B585D33CEC6}",
    "{14F3C7DB-D67E-4288-9D94-AB33653FD928}",
    "{85A9AEA7-5427-4144-AFC1-12DCE9D5ECB7}",
    "{63E116B6-1955-4B06-B28F-3113E0760583}",
    "{94D2643C-32DC-4D5F-9350-BA5BD54BCA23}",
    "{FD6318F0-8AIF-41CF-9B91-64EBBBCB3E98}",
    "{45912694-2CF8-4B46-9222-B4E052EC74FC}",
    "{A76214EC-C75E-4E91-B515-32CF008CA73F}",
    "{6DEDCEB2-62B4-4259-BDFF-A3FA56DF71A7}",
    "{71CB1A2A-6433-496F-A75D-79B57EA2020D}",
    "{2FAC02AF-1E80-4890-BC34-C5D8F22F12F2}",
    "{08D592C6-8F94-435E-98CD-D038E23CF236}",
    "{A33B95DC-4636-4FB9-81E1-098C819359A8}",
    "{30189A3D-F6CE-4B86-A19C-C71E64541796}",
    "{B0390D1A-AAFF-45F9-823E-9DBF1EE671DF}",
    "{439925AF-0A96-40F3-8707-D5A65AA605AF}",
    "{0836BB00-2107-49A6-8544-72FC3EECC742}",
    "{2EEF9B08-10D5-40A6-B563-94FF012868D9}",
    "{39592C2B-0CC3-4BDD-9E64-00846F06C629}",
    "{1F104AAC-B4CF-4B9E-8ACA-C72F3B7601D7}",
    "{1E4A9A9E-F945-4A6A-A777-EA765AC9892D}",
    "{FCE711AB-1097-47DF-AFD5-E3D8BA0B4BA5}",
    "{24236D55-6152-4783-B736-9CAA56F6F655}",
    "{1479F2D4-D712-4B53-8B24-546270239BE7}",
    "{058EE9BE-D9A9-4660-9729-60E2FF891783}",
    "{AFFECD3D-9FCD-4822-BDF8-1B7F589620DD}",
    "{154F7871-BCA0-4691-9210-AD6D76103119}",
    "{677BBA18-0BDA-4A19-92F9-8C8DF6A11E30}",
    "{505165ED-12ED-4FC3-8E0B-DE786471F388}",
    "{FE0C85D8-2E11-46BA-BE97-9EC67E96ABB8}",
    "{0DBD86AB-EDAD-4C5F-B64A-E879935418FD}",
    "{2FA1E614-9B22-495E-8543-A28A449662C0}",
    "{9A475EE6-2AA9-407F-96B8-AFD73C904E9C}",
    "{374FCE6C-D73A-4E68-AA7F-8954D47A913E}",
    "{0FBAF510-CE97-44B5-B5EE-43B31B642530}",
    "{832B63F3-FBA5-4380-99DB-78CFB9F87D6F}",
    "{8BEADFD7-FB96-4F3D-A2A3-32FC758A60CE}",
    "{0447C188-1620-4CE4-897D-E34CDBE3F30D}",
    "{93479D49-84B0-4410-B39D-D2553FFFFCF0}",
    "{D85AC2E0-131F-4316-B8CF-0CD0BFAC639D}",
    "{DD193776-16EC-4550-B696-19E19CE313D4}",
    "{4FE802B6-9D8D-4CAA-B07A-775154792D1A}",
    "{B097C8D5-6034-42F2-ABE1-4CEFE35E76FB}",
    "{569DD3EB-30D5-4CDD-85B6-5AA6C886D51C}",
    "{65EF0557-0D8E-4B74-AFD8-FC5DB243EDB8}",
    "{51E924AC-12DF-46F8-A77C-C2756C38AD3B}",
    "{E8AD7C9A-C60C-4DE2-A111-A3E8AD26B1D0}",
    "{B484E83E-396E-4ACA-828E-0E1121708E88}",
    "{5926D161-4B98-4901-8A66-6178F21B616C}",
    "{8743B7A9-257B-48DF-8DB0-0F4FD057A4B0}",
    "{600EB06A-F13D-411D-BEB3-E04E93ED4276}",
    "{6147E9F3-8FDA-45AF-AF7B-96245CA32096}",
    "{27AE43F6-30C5-477C-BD53-2511CD23C5CA}",
    "{4A3B540E-FC78-4095-AFDA-F560F263AD13}",
    "{084B9A25-9B24-461B-8FEB-1A071D2800FB}",
    "{449145AC-B3DC-4FDD-9C9F-5FFF5F2FA183}",
    "{177D7587-F672-49D5-85D1-090AA2AAAB29}",
    "{45E5C75E-DB43-4196-9B2A-6A3C044C6095}",
    "{7A2585D3-0477-40CD-B6FF-BD781A3B5777}",
    "{F6D9E4BE-9433-4563-A10A-9E3684407E20}",
    "{6C05E92C-38EB-4033-B610-4503E5262FDF}",
    "{50BC1E72-EE91-4332-B707-B24E1622A214}",
    "{C4194D7B-54B5-4B35-B262-1B700143DB56}",
    "{0F4D8710-8B26-4D9C-92EC-FFAB5CFEDA15}",
    "{48BB1D7E-0B33-4171-A423-A911FE9A4972}",
    "{081D2B7B-79A6-4330-93EC-C36DF19BBC93}",
    "{DEB255CE-6405-43A3-81AD-DCAA8A0A707C}",
    "{E8749084-B9C2-4C1C-8DCA-8DD601B57E99}",
    "{57CF0C2B-CB8F-430A-AE09-6A271E46447D}",
    "{A5D4CB92-D091-41DF-A0F5-968778175398}",
    "{537FCB8D-0868-463D-B2A1-A85E3F9507A3}",
    "{D5EBC9DB-8E7A-45AD-BF8F-F93703B61F20}",
    "{ED15A0DF-DEA5-4EE5-91D4-568CF3D13D20}",
    "{04A431CF-78AD-4200-9B3E-8DA02A6DA347}",
    "{53C81678-DDD1-410F-9476-0A1AFD17B22D}",
    "{F0B27251-FFE7-4A70-9077-80D73E10BD1E}",
    "{33430CD2-A47B-4987-ACEA-5EA4ABF9AAE0}",
    "{93F23433-BA8C-49CF-B1A8-D8FDA736623A}",
    "{381C38F4-4B07-4F2E-A12E-AF6328F96A54}",
    "{A2CBBB92-06FB-4CB3-A81F-6926203BD34E}",
    "{AB788250-8C62-45AF-BE63-6493F5363116}",
    "{D0A52723-FFA4-40E5-A6B7-16FC57BF9B9E}",
    "{DD2C92B9-881C-4128-B11D-A92E8873472E}",
    "{069AFA82-D910-45A2-AF24-7F33E0237182}",
    "{20619AAB-74D9-4F8D-AB89-62DB4130C6A9}",
    "{EB9C2171-5D89-43AB-BA09-2F6439BF805D}",
    "{B6709EA9-0B13-47F5-9022-524426FC2B20}",
    "{301B6795-D383-41BC-AB6C-6A4C4CAA8EDF}",
    "{E774C005-3B66-4736-8E35-421710DB25FB}",
    "{D356DB30-2CDC-48D8-AB28-F9E1C4C8E82D}",
    "{137708F4-430A-4C0D-A63C-B75A59C5EB2E}",
    "{F72AED52-624E-43BA-AF8E-7C3C311B93D7}",
    "{8F6C3881-F732-42C9-936A-5852D3A194B4}",
    "{F72BD7C6-B22D-4E5C-AA9C-C0FE8F034E43}",
    "{AE2F9B5B-589F-4A12-B4A5-0912FFE8C463}",
    "{3DE5F28B-8893-4BD0-B742-6096E9DDEDB6}",
    "{9B4F9569-4463-47AB-B753-0DBF64B56883}",
    "{21119F02-5EB6-4308-B15A-AE086F9605EC}",
    "{40D33237-E99B-4BA3-A0BE-7AEE3AD7B607}",
    "{5A651C27-4680-40DB-968C-71B89B56F3D0}",
    "{CBE7FE13-7C12-4469-8F0E-B32E7B224B20}",
    "{B6510D79-459E-40A7-88A1-06EECF7DFEDD}",
    "{11496169-8138-4EB2-9883-9F0453297D84}",
    "{6DAB765F-B559-4BB5-B70B-C868947D1C56}",
    "{316F5213-D48B-4F4B-8AFB-D18E44ACDDCB}",
    "{6F890B4D-2BB8-446F-A492-21C61EC7D36D}",
    "{5F3EECB5-14F4-4481-BA0D-86EED34D4597}",
    "{4F764D10-CC2B-447E-9876-DC9259316804}",
    "{54E9E593-8C0E-4120-9637-83B0BA891573}",
    "{FD974ABC-023F-4238-BB26-EA963179D61F}"
}

-- Get current gingerbread value
local function getCurrentGingerbread()
    local success, clientData = pcall(require, ReplicatedStorage.ClientModules.Core.ClientData)
    if not success then return 0 end

    local success2, allData = pcall(clientData.get_data, clientData)
    if not success2 or not allData[localPlayer.Name] then return 0 end

    local playerData = allData[localPlayer.Name]
    local gingerbread = 0

    if playerData.gingerbread_2025 then
        gingerbread = playerData.gingerbread_2025
    elseif playerData.inventory and playerData.inventory.currency then
        gingerbread = playerData.inventory.currency.gingerbread_2025 or 0
    else
        for key, value in pairs(playerData) do
            if type(key) == "string" and string.find(key:lower(), "gingerbread") then
                if key == "gingerbread_2025" then
                    gingerbread = value
                end
            end
        end
    end

    return gingerbread
end

-- Call gingerbread ID
local function callGingerbreadId(gingerbreadId)
    local args = { interior_name = "MainMap!Christmas", gingerbread_id = gingerbreadId }
    iceSkatingEvent:FireServer(args)
end

-- Collect gingerbreads
local function collectGingerbreads()
    collectEvent:FireServer()
    return true
end

-- Board train
local function boardTrain()
    local args = { carriage = workspace:WaitForChild("WinterTrainSeats"):WaitForChild("Seat") }
    trainEvent:FireServer(args)
end

-- Respawn player
local function respawnPlayer()
    spawnAPI:InvokeServer()
end

-- Get current minute
local function getCurrentMinute()
    return os.date("*t").min
end

-- Main cycle
local function runCycle()
    for _, gingerbreadId in ipairs(gingerbreadIds) do
        pcall(callGingerbreadId, gingerbreadId)
        task.wait(0.5)
    end

    local success, err = pcall(collectGingerbreads)
    if not success then
        warn("Collection error: " .. tostring(err))
        return false
    end
    return true
end

-- Create UI window
local Window = Rayfield:CreateWindow({
    Name = "COCOON",
    LoadingTitle = "Winter 2025 Gingerbread Farm",
    LoadingSubtitle = "Auto Farming Script",
    ConfigurationSaving = { Enabled = false },
    KeySystem = false,
})

-- Create tabs
local WinterTab = Window:CreateTab("Winter Events", 4483362458)
local BuyTab = Window:CreateTab("Buy", 6941542458)
local PetsTab = Window:CreateTab("Pets", 123456789)
local GiftsTab = Window:CreateTab("Gifts", 123456789)

-- Variables
local isRunning, isMailCollecting, isBucksExchange, isTrainRunning = false, false, false, false
local gingerbreadLabel
local petInventory, giftInventory = {}, {}
local selectedPlayerName, selectedPetType, selectedGiftType = nil, nil, nil

-- Update gingerbread label
local function updateGingerbreadLabel()
    local currentGingerbread = getCurrentGingerbread()
    if gingerbreadLabel then
        gingerbreadLabel:Set("üç™ Current Gingerbread: " .. currentGingerbread)
    end
end

-- ========================
-- WINTER EVENTS TAB
-- ========================
gingerbreadLabel = WinterTab:CreateLabel("üç™ Current Gingerbread: " .. getCurrentGingerbread())
WinterTab:CreateSection("")

-- Spawn House & Respawn Button
WinterTab:CreateButton({
    Name = "üè† Spawn House & Respawn",
    Callback = function()
        game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("HousingAPI/SpawnHouse"):FireServer(1)
        task.wait(2)
        game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("TeamAPI/Spawn"):InvokeServer()
        Rayfield:Notify({
            Title = "House Spawned",
            Content = "House spawned and player respawned successfully",
            Duration = 3,
            Image = 4483362458
        })
    end,
})

-- Auto Farm Gingerbread Toggle
WinterTab:CreateToggle({
    Name = "üç™ Auto Farm Gingerbread",
    CurrentValue = true,
    Flag = "FarmToggle",
    Callback = function(Value)
        isRunning = Value
        if Value then
            task.spawn(function()
                while isRunning do
                    if runCycle() then
                        task.wait(2)
                        updateGingerbreadLabel()
                        for i = 600, 1, -1 do
                            if not isRunning then break end
                            task.wait(1)
                        end
                    else
                        task.wait(30)
                    end
                end
            end)
        end
    end,
})

-- Auto Xmas Train Toggle
WinterTab:CreateToggle({
    Name = "üöÇ Auto Xmas Train",
    CurrentValue = false,
    Flag = "TrainToggle",
    Callback = function(Value)
        isTrainRunning = Value
        if Value then
            task.spawn(function()
                while isTrainRunning do
                    local currentMinute = getCurrentMinute()
                    local currentSecond = os.date("*t").sec
                    if (currentMinute == 6 or currentMinute == 16 or currentMinute == 26 or
                       currentMinute == 36 or currentMinute == 46 or currentMinute == 56) and currentSecond <= 10 then
                        pcall(boardTrain)
                        task.wait(120)
                        pcall(respawnPlayer)
                        task.wait(5)
                    else
                        local minutesUntilNextTrain = (currentMinute < 6 and 6 - currentMinute) or
                                                      (currentMinute < 16 and 16 - currentMinute) or
                                                      (currentMinute < 26 and 26 - currentMinute) or
                                                      (currentMinute < 36 and 36 - currentMinute) or
                                                      (currentMinute < 46 and 46 - currentMinute) or
                                                      (currentMinute < 56 and 56 - currentMinute) or
                                                      (60 - currentMinute + 6)
                        local waitSeconds = (minutesUntilNextTrain * 60) - currentSecond
                        if waitSeconds > 10 then
                            waitSeconds = waitSeconds - 5
                            for i = 1, math.floor(waitSeconds) do
                                if not isTrainRunning then break end
                                task.wait(1)
                            end
                        else
                            task.wait(1)
                        end
                    end
                end
            end)
            Rayfield:Notify({
                Title = "Auto Train Started",
                Content = "Train will board at 06,16,26,36,46,56 and exit at 08,18,28,38,48,58",
                Duration = 5,
                Image = 4483362458
            })
        end
    end,
})

-- Xmas Mail Collect Toggle
WinterTab:CreateToggle({
    Name = "üìÆ Xmas Mail Collect",
    CurrentValue = false,
    Flag = "MailToggle",
    Callback = function(Value)
        isMailCollecting = Value
        if Value then
            task.spawn(function()
                while isMailCollecting do
                    game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("HousingAPI/ClaimAllDeliveries"):FireServer()
                    for i = 600, 1, -1 do
                        if not isMailCollecting then break end
                        task.wait(1)
                    end
                end
            end)
        end
    end,
})

-- Auto Bucks Exchange Toggle
WinterTab:CreateToggle({
    Name = "üí∞ Auto Bucks Exchange",
    CurrentValue = false,
    Flag = "BucksToggle",
    Callback = function(Value)
        isBucksExchange = Value
        if Value then
            task.spawn(function()
                while isBucksExchange do
                    for i = 1, 3 do
                        if not isBucksExchange then break end
                        game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("WinterEventAPI/UseExchangeKiosk"):InvokeServer()
                        task.wait(0.5)
                    end
                    for i = 600, 1, -1 do
                        if not isBucksExchange then break end
                        task.wait(1)
                    end
                end
            end)
        end
    end,
})

-- ========================
-- BUY TAB
-- ========================
local isBuyingHumbug, isBuyingTurtleDove = false, false

-- Humbug Auto Buy Toggle
BuyTab:CreateToggle({
    Name = "ü¶î Auto Buy Humbug Pet",
    CurrentValue = false,
    Flag = "HumbugToggle",
    Callback = function(Value)
        isBuyingHumbug = Value
        if Value then
            task.spawn(function()
                while isBuyingHumbug do
                    game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("ShopAPI/BuyItem"):InvokeServer("pets", "winter_2025_humbug", { buy_count = 1 })
                    task.wait(60)
                end
            end)
        end
    end,
})

-- Turtle Dove Auto Buy Toggle
BuyTab:CreateToggle({
    Name = "üê¶ Auto Buy Turtle Dove Pet",
    CurrentValue = false,
    Flag = "TurtleDoveToggle",
    Callback = function(Value)
        isBuyingTurtleDove = Value
        if Value then
            task.spawn(function()
                while isBuyingTurtleDove do
                    game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("ShopAPI/BuyItem"):InvokeServer("pets", "winter_2025_turtle_doves", { buy_count = 1 })
                    task.wait(60)
                end
            end)
        end
    end,
})

-- ========================
-- PETS TAB
-- ========================
-- Get all players in server
local function getPlayersInServer()
    local players = {}
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= localPlayer then
            table.insert(players, player.Name)
        end
    end
    table.sort(players)
    return players
end

-- Get all available pets
local function getAvailablePets()
    local pets = {}
    petInventory = {} -- Reset pet inventory
    local success, clientData = pcall(require, ReplicatedStorage.ClientModules.Core.ClientData)
    if success then
        local success2, allData = pcall(clientData.get_data, clientData)
        if success2 and allData[localPlayer.Name] and allData[localPlayer.Name].inventory and allData[localPlayer.Name].inventory.pets then
            print("=== PET INVENTORY ===")
            for uniqueId, petData in pairs(allData[localPlayer.Name].inventory.pets) do
                print("Pet ID:", uniqueId, "Pet Data:", petData.id)
                if petData.id then
                    local petType = petData.id
                    if not pets[petType] then
                        pets[petType] = {}
                    end
                    table.insert(pets[petType], uniqueId)
                    petInventory[petType] = pets[petType]
                end
            end
            print("=== PET INVENTORY END ===")
        else
            print("Failed to get pet inventory data.")
        end
    else
        print("Failed to load ClientData.")
    end
    return pets
end

-- Refresh pet dropdown
local function refreshPetDropdown()
    local pets = getAvailablePets()
    local petOptions = {}
    for petType, petList in pairs(pets) do
        table.insert(petOptions, string.format("%s (%d)", petType, #petList))
    end
    table.sort(petOptions)
    print("Available pet options:", table.concat(petOptions, ", "))
    return petOptions
end

-- Create dropdowns
local playerOptions = getPlayersInServer()
local PlayerDropdown = PetsTab:CreateDropdown({
    Name = "üéØ Select Player",
    Options = playerOptions,
    CurrentOption = playerOptions[1] or nil,
    MultipleOptions = false,
    Flag = "PlayerDropdown",
    Callback = function(Option)
        if type(Option) == "table" then
            selectedPlayerName = Option.Name or Option[1] or tostring(Option)
        else
            selectedPlayerName = tostring(Option)
        end
        print("Selected player:", selectedPlayerName, type(selectedPlayerName))
    end,
})

local petOptions = refreshPetDropdown()
local PetDropdown = PetsTab:CreateDropdown({
    Name = "üêæ Select Pet Type",
    Options = petOptions,
    CurrentOption = petOptions[1] or nil,
    MultipleOptions = false,
    Flag = "PetDropdown",
    Callback = function(Option)
        local optionString = tostring(Option)
        local petType = optionString:match("^(.-)%s+%(%d+%)$")
        selectedPetType = petType or optionString
        print("Selected pet type:", selectedPetType)
        print("Available pets for this type:", petInventory[selectedPetType])
    end,
})

-- Give pet to player
local function givePet()
    if not selectedPlayerName or type(selectedPlayerName) ~= "string" or selectedPlayerName == "" then
        Rayfield:Notify({
            Title = "Error",
            Content = "Please select a valid player!",
            Duration = 3,
            Image = 4483362458
        })
        return
    end

    if not selectedPetType then
        Rayfield:Notify({
            Title = "Error",
            Content = "Please select a pet type!",
            Duration = 3,
            Image = 4483362458
        })
        return
    end

    -- Refresh pet inventory before giving
    getAvailablePets()
    print("Available pets for", selectedPetType, ":", petInventory[selectedPetType])

    if not petInventory[selectedPetType] or #petInventory[selectedPetType] == 0 then
        Rayfield:Notify({
            Title = "Error",
            Content = "No " .. selectedPetType .. " pets available!",
            Duration = 3,
            Image = 4483362458
        })
        return
    end

    local petUid = table.remove(petInventory[selectedPetType], 1)
    local targetPlayer
    for _, player in pairs(Players:GetPlayers()) do
        if type(player.Name) == "string" and player.Name:lower() == selectedPlayerName:lower() then
            targetPlayer = player
            break
        end
    end

    if not targetPlayer then
        Rayfield:Notify({
            Title = "Error",
            Content = "Selected player is offline or not found!",
            Duration = 3,
            Image = 4483362458
        })
        return
    end

    local args = {targetPlayer, petUid}
    local success, result = pcall(function()
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/GiveItem"):InvokeServer(unpack(args))
    end)

    if success then
        Rayfield:Notify({
            Title = "Success",
            Content = "Gave " .. selectedPetType .. " to " .. selectedPlayerName,
            Duration = 3,
            Image = 4483362458
        })
        PetDropdown:Refresh(refreshPetDropdown())
        if #petOptions > 0 then
            PetDropdown:Set(petOptions[1])
        end
        task.wait(9)
    else
        Rayfield:Notify({
            Title = "Error",
            Content = "Failed to give pet: " .. tostring(result),
            Duration = 3,
            Image = 4483362458
        })
        table.insert(petInventory[selectedPetType], petUid)
    end
end

-- Give Pet button
PetsTab:CreateButton({
    Name = "üéÅ Give Selected Pet",
    Callback = function()
        givePet()
    end,
})

-- Auto give toggle
local autoGivePets = false
PetsTab:CreateToggle({
    Name = "üöÄ Auto Give Selected Pet",
    CurrentValue = false,
    Flag = "AutoGiveToggle",
    Callback = function(Value)
        autoGivePets = Value
        if Value then
            task.spawn(function()
                while autoGivePets do
                    givePet()
                    task.wait(10)
                end
            end)
        end
    end,
})

-- ========================
-- GIFTS TAB
-- ========================
-- Get all available gifts
local function getAvailableGifts()
    local gifts = {}
    giftInventory = {} -- Reset gift inventory
    local success, clientData = pcall(require, ReplicatedStorage.ClientModules.Core.ClientData)
    if success then
        local success2, allData = pcall(clientData.get_data, clientData)
        if success2 and allData[localPlayer.Name] and allData[localPlayer.Name].inventory and allData[localPlayer.Name].inventory.gifts then
            print("=== GIFT INVENTORY ===")
            for giftId, giftData in pairs(allData[localPlayer.Name].inventory.gifts) do
                print("Gift ID:", giftId, "Gift Data:", giftData.id)
                if giftData.id then
                    local giftName = giftData.id
                    if not gifts[giftName] then
                        gifts[giftName] = {}
                    end
                    table.insert(gifts[giftName], giftId)
                    giftInventory[giftName] = gifts[giftName]
                end
            end
            print("=== GIFT INVENTORY END ===")
        else
            print("Failed to get gift inventory data.")
        end
    else
        print("Failed to load ClientData.")
    end
    return gifts
end

-- Refresh gift dropdown
local function refreshGiftDropdown()
    local gifts = getAvailableGifts()
    local giftOptions = {}
    for giftName, giftList in pairs(gifts) do
        table.insert(giftOptions, string.format("%s (%d)", giftName, #giftList))
    end
    table.sort(giftOptions)
    print("Available gift options:", table.concat(giftOptions, ", "))
    return giftOptions
end

-- Create dropdowns for gifts
local giftPlayerOptions = getPlayersInServer()
local GiftsPlayerDropdown = GiftsTab:CreateDropdown({
    Name = "üéØ Select Player",
    Options = giftPlayerOptions,
    CurrentOption = giftPlayerOptions[1] or nil,
    MultipleOptions = false,
    Flag = "GiftsPlayerDropdown",
    Callback = function(Option)
        if type(Option) == "table" then
            selectedPlayerName = Option.Name or Option[1] or tostring(Option)
        else
            selectedPlayerName = tostring(Option)
        end
        print("Selected player:", selectedPlayerName, type(selectedPlayerName))
    end,
})

local giftTypeOptions = refreshGiftDropdown()
local GiftDropdown = GiftsTab:CreateDropdown({
    Name = "üéÅ Select Gift Type",
    Options = giftTypeOptions,
    CurrentOption = giftTypeOptions[1] or nil,
    MultipleOptions = false,
    Flag = "GiftDropdown",
    Callback = function(Option)
        local optionString = tostring(Option)
        local giftType = optionString:match("^(.-)%s+%(%d+%)$")
        selectedGiftType = giftType or optionString
        print("Selected gift type:", selectedGiftType)
        print("Available gifts for this type:", giftInventory[selectedGiftType])
    end,
})

-- Give gift to player
local function giveGift()
    if not selectedPlayerName or type(selectedPlayerName) ~= "string" or selectedPlayerName == "" then
        Rayfield:Notify({
            Title = "Error",
            Content = "Please select a valid player!",
            Duration = 3,
            Image = 4483362458
        })
        return
    end

    if not selectedGiftType then
        Rayfield:Notify({
            Title = "Error",
            Content = "Please select a gift type!",
            Duration = 3,
            Image = 4483362458
        })
        return
    end

    -- Refresh gift inventory before giving
    getAvailableGifts()
    print("Available gifts for", selectedGiftType, ":", giftInventory[selectedGiftType])

    if not giftInventory[selectedGiftType] or #giftInventory[selectedGiftType] == 0 then
        Rayfield:Notify({
            Title = "Error",
            Content = "No " .. selectedGiftType .. " gifts available!",
            Duration = 3,
            Image = 4483362458
        })
        return
    end

    local giftUid = table.remove(giftInventory[selectedGiftType], 1)
    local targetPlayer
    for _, player in pairs(Players:GetPlayers()) do
        if type(player.Name) == "string" and player.Name:lower() == selectedPlayerName:lower() then
            targetPlayer = player
            break
        end
    end

    if not targetPlayer then
        Rayfield:Notify({
            Title = "Error",
            Content = "Selected player is offline or not found!",
            Duration = 3,
            Image = 4483362458
        })
        return
    end

    local args = {targetPlayer, giftUid}
    local success, result = pcall(function()
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/GiveItem"):InvokeServer(unpack(args))
    end)

    if success then
        Rayfield:Notify({
            Title = "Success",
            Content = "Gave " .. selectedGiftType .. " to " .. selectedPlayerName,
            Duration = 3,
            Image = 4483362458
        })
        GiftDropdown:Refresh(refreshGiftDropdown())
        if #giftTypeOptions > 0 then
            GiftDropdown:Set(giftTypeOptions[1])
        end
        task.wait(9)
    else
        Rayfield:Notify({
            Title = "Error",
            Content = "Failed to give gift: " .. tostring(result),
            Duration = 3,
            Image = 4483362458
        })
        table.insert(giftInventory[selectedGiftType], giftUid)
    end
end

-- Give Gift button
GiftsTab:CreateButton({
    Name = "üéÅ Give Selected Gift",
    Callback = function()
        giveGift()
    end,
})

-- Auto give toggle for gifts
local autoGiveGifts = false
GiftsTab:CreateToggle({
    Name = "üöÄ Auto Give Selected Gift",
    CurrentValue = false,
    Flag = "AutoGiveGiftsToggle",
    Callback = function(Value)
        autoGiveGifts = Value
        if Value then
            task.spawn(function()
                while autoGiveGifts do
                    giveGift()
                    task.wait(10)
                end
            end)
        end
    end,
})

-- ========================
-- INITIALIZATION
-- ========================
-- Auto-update gingerbread label
task.spawn(function()
    while true do
        updateGingerbreadLabel()
        task.wait(10)
    end
end)

-- Auto-refresh dropdowns
task.spawn(function()
    while true do
        task.wait(10)
        PlayerDropdown:Refresh(getPlayersInServer())
        GiftsPlayerDropdown:Refresh(getPlayersInServer())
        PetDropdown:Refresh(refreshPetDropdown())
        GiftDropdown:Refresh(refreshGiftDropdown())
    end
end)

-- Startup notification
task.wait(3)
Rayfield:Notify({
    Title = "COCOON Auto Farm Started",
    Content = "Gingerbread farming is now running automatically!",
    Duration = 5,
    Image = 4483362458
})

print("COCOON Gingerbread Farm Loaded! Auto Farm is ON.")
