-- Load Rayfield UI Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local localPlayer = Players.LocalPlayer

-- Get the remote event references
local adoptmeNet = game:GetService("ReplicatedStorage"):WaitForChild("adoptme_new_net")
local iceSkatingEvent = adoptmeNet:WaitForChild("adoptme_legacy_shared.ContentPacks.Winter2025.Game.IceSkating.IceSkatingNet:7")
local collectEvent = adoptmeNet:WaitForChild("adoptme_legacy_shared.ContentPacks.Winter2025.Game.IceSkating.IceSkatingNet:16")
local trainEvent = adoptmeNet:WaitForChild("adoptme_legacy_shared.ContentPacks.Winter2025.Game.Train.WinterTrainNet:7")
local spawnAPI = game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("TeamAPI/Spawn")

-- Store all gingerbread IDs (deduplicated)
local gingerbreadIds = {
    "{60E33537-47D5-4212-958D-307C17501331}",
    "{28F6FD49-55C2-4E45-88F3-E62344AEE010}",
    "{96EB009D-84A2-464B-925E-41E269B5D7E4}",
    "{437F2FA1-230F-498F-9276-DE0EF87C3AE1}",
    "{1F5105D1-7F27-4C3F-88F8-DAB5AC6F80A7}",
}

-- Function to get current gingerbread_2025 value
local function getCurrentGingerbread()
    local success, clientData = pcall(require, ReplicatedStorage.ClientModules.Core.ClientData)
    if not success then
        return 0
    end

    local success2, allData = pcall(clientData.get_data, clientData)
    if not success2 or not allData[localPlayer.Name] then
        return 0
    end

    local playerData = allData[localPlayer.Name]
    local gingerbread = 0

    if playerData.gingerbread_2025 then
        gingerbread = playerData.gingerbread_2025
    elseif playerData.inventory and playerData.inventory.currency then
        gingerbread = playerData.inventory.currency.gingerbread_2025 or 0
    else
        for key, value in pairs(playerData) do
            if type(key) == "string" and string.find(key:lower(), "gingerbread") then
                if key == "gingerbread_2025" then
                    gingerbread = value
                end
            end
        end
    end

    return gingerbread
end

-- Function to call a single gingerbread ID
local function callGingerbreadId(gingerbreadId)
    local args = {
        {
            interior_name = "MainMap!Christmas",
            gingerbread_id = gingerbreadId
        }
    }
    iceSkatingEvent:FireServer(unpack(args))
end

-- Function to collect rewards
local function collectGingerbreads()
    collectEvent:FireServer()
    return true
end

-- Function to board the train
local function boardTrain()
    local args = {
        {
            carriage = workspace:WaitForChild("WinterTrainSeats"):WaitForChild("Seat")
        }
    }
    trainEvent:FireServer(unpack(args))
end

-- Function to respawn player
local function respawnPlayer()
    spawnAPI:InvokeServer()
end

-- Function to get current minute
local function getCurrentMinute()
    return os.date("*t").min
end

-- Main function to run the cycle
local function runCycle()
    for i, gingerbreadId in ipairs(gingerbreadIds) do
        pcall(callGingerbreadId, gingerbreadId)
        task.wait(0.5)
    end

    local success, err = pcall(collectGingerbreads)
    if not success then
        warn("Collection error: " .. tostring(err))
        return false
    end
    return true
end

-- Create the window with COCOON title
local Window = Rayfield:CreateWindow({
    Name = "COCOON",
    LoadingTitle = "Winter 2025 Gingerbread Farm",
    LoadingSubtitle = "Auto Farming Script",
    ConfigurationSaving = {
        Enabled = false,
    },
    KeySystem = false,
})

-- Create tabs
local WinterTab = Window:CreateTab("Winter Events", 4483362458)
local BuyTab = Window:CreateTab("Buy", 6941542458)
local PetsTab = Window:CreateTab("Pets", 123456789)
local GiftsTab = Window:CreateTab("Gifts", 123456789)

-- Variables for controls
local isRunning = false
local isMailCollecting = false
local isBucksExchange = false
local isTrainRunning = false
local gingerbreadLabel
local petInventory = {}
local giftInventory = {}
local selectedPlayerName = nil
local selectedPetType = nil
local selectedGiftType = nil

-- Function to update gingerbread label
local function updateGingerbreadLabel()
    local currentGingerbread = getCurrentGingerbread()
    if gingerbreadLabel then
        gingerbreadLabel:Set("üç™ Current Gingerbread: " .. currentGingerbread)
    end
end

-- ========================
-- WINTER EVENTS TAB
-- ========================
gingerbreadLabel = WinterTab:CreateLabel("üç™ Current Gingerbread: " .. getCurrentGingerbread())
WinterTab:CreateSection("")

-- Spawn House & Respawn Button
WinterTab:CreateButton({
    Name = "üè† Spawn House & Respawn",
    Callback = function()
        local args = {1}
        game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("HousingAPI/SpawnHouse"):FireServer(unpack(args))
        task.wait(2)
        game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("TeamAPI/Spawn"):InvokeServer()
        Rayfield:Notify({
            Title = "House Spawned",
            Content = "House spawned and player respawned successfully",
            Duration = 3,
            Image = 4483362458
        })
    end,
})

-- Auto Farm Gingerbread Toggle
local GingerbreadToggle = WinterTab:CreateToggle({
    Name = "üç™ Auto Farm Gingerbread",
    CurrentValue = true,
    Flag = "FarmToggle",
    Callback = function(Value)
        isRunning = Value
        if Value then
            task.spawn(function()
                while isRunning do
                    if runCycle() then
                        task.wait(2)
                        updateGingerbreadLabel()
                        for i = 600, 1, -1 do
                            if not isRunning then break end
                            task.wait(1)
                        end
                    else
                        task.wait(30)
                    end
                end
            end)
        end
    end,
})

-- Auto Xmas Train Toggle
local TrainToggle = WinterTab:CreateToggle({
    Name = "üöÇ Auto Xmas Train",
    CurrentValue = false,
    Flag = "TrainToggle",
    Callback = function(Value)
        isTrainRunning = Value
        if Value then
            task.spawn(function()
                while isTrainRunning do
                    local currentMinute = getCurrentMinute()
                    local currentSecond = os.date("*t").sec
                    if (currentMinute == 6 or currentMinute == 16 or currentMinute == 26 or
                       currentMinute == 36 or currentMinute == 46 or currentMinute == 56) and currentSecond <= 10 then
                        pcall(boardTrain)
                        task.wait(120)
                        pcall(respawnPlayer)
                        task.wait(5)
                    else
                        local minutesUntilNextTrain
                        if currentMinute < 6 then
                            minutesUntilNextTrain = 6 - currentMinute
                        elseif currentMinute < 16 then
                            minutesUntilNextTrain = 16 - currentMinute
                        elseif currentMinute < 26 then
                            minutesUntilNextTrain = 26 - currentMinute
                        elseif currentMinute < 36 then
                            minutesUntilNextTrain = 36 - currentMinute
                        elseif currentMinute < 46 then
                            minutesUntilNextTrain = 46 - currentMinute
                        elseif currentMinute < 56 then
                            minutesUntilNextTrain = 56 - currentMinute
                        else
                            minutesUntilNextTrain = (60 - currentMinute) + 6
                        end
                        local waitSeconds = (minutesUntilNextTrain * 60) - currentSecond
                        if waitSeconds > 10 then
                            waitSeconds = waitSeconds - 5
                            for i = 1, math.floor(waitSeconds) do
                                if not isTrainRunning then break end
                                task.wait(1)
                            end
                        else
                            task.wait(1)
                        end
                    end
                end
            end)
            Rayfield:Notify({
                Title = "Auto Train Started",
                Content = "Train will board at 06,16,26,36,46,56 and exit at 08,18,28,38,48,58",
                Duration = 5,
                Image = 4483362458
            })
        end
    end,
})

-- Xmas Mail Collect Toggle
local MailToggle = WinterTab:CreateToggle({
    Name = "üìÆ Xmas Mail Collect",
    CurrentValue = false,
    Flag = "MailToggle",
    Callback = function(Value)
        isMailCollecting = Value
        if Value then
            task.spawn(function()
                while isMailCollecting do
                    game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("HousingAPI/ClaimAllDeliveries"):FireServer()
                    for i = 600, 1, -1 do
                        if not isMailCollecting then break end
                        task.wait(1)
                    end
                end
            end)
        end
    end,
})

-- Auto Bucks Exchange Toggle
local BucksToggle = WinterTab:CreateToggle({
    Name = "üí∞ Auto Bucks Exchange",
    CurrentValue = false,
    Flag = "BucksToggle",
    Callback = function(Value)
        isBucksExchange = Value
        if Value then
            task.spawn(function()
                while isBucksExchange do
                    for i = 1, 3 do
                        if not isBucksExchange then break end
                        game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("WinterEventAPI/UseExchangeKiosk"):InvokeServer()
                        task.wait(0.5)
                    end
                    for i = 600, 1, -1 do
                        if not isBucksExchange then break end
                        task.wait(1)
                    end
                end
            end)
        end
    end,
})

-- ========================
-- BUY TAB
-- ========================
local isBuyingHumbug = false
local isBuyingTurtleDove = false

-- Humbug Auto Buy Toggle
BuyTab:CreateToggle({
    Name = "ü¶î Auto Buy Humbug Pet",
    CurrentValue = false,
    Flag = "HumbugToggle",
    Callback = function(Value)
        isBuyingHumbug = Value
        if Value then
            task.spawn(function()
                while isBuyingHumbug do
                    local args = {
                        "pets",
                        "winter_2025_humbug",
                        { buy_count = 1 }
                    }
                    game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("ShopAPI/BuyItem"):InvokeServer(unpack(args))
                    task.wait(60)
                end
            end)
        end
    end,
})

-- Turtle Dove Auto Buy Toggle
BuyTab:CreateToggle({
    Name = "üê¶ Auto Buy Turtle Dove Pet",
    CurrentValue = false,
    Flag = "TurtleDoveToggle",
    Callback = function(Value)
        isBuyingTurtleDove = Value
        if Value then
            task.spawn(function()
                while isBuyingTurtleDove do
                    local args = {
                        "pets",
                        "winter_2025_turtle_doves",
                        { buy_count = 1 }
                    }
                    game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("ShopAPI/BuyItem"):InvokeServer(unpack(args))
                    task.wait(60)
                end
            end)
        end
    end,
})

-- ========================
-- PETS TAB (FIXED VERSION)
-- ========================
-- Function to get all players in server
local function getPlayersInServer()
    local players = {}
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= localPlayer then
            table.insert(players, player.Name)
        end
    end
    table.sort(players)
    return players
end

-- Function to get all available pets
local function getAvailablePets()
    local pets = {}
    local success, clientData = pcall(require, ReplicatedStorage.ClientModules.Core.ClientData)
    if success then
        local success2, allData = pcall(clientData.get_data, clientData)
        if success2 and allData[localPlayer.Name] and allData[localPlayer.Name].inventory and allData[localPlayer.Name].inventory.pets then
            for uniqueId, petData in pairs(allData[localPlayer.Name].inventory.pets) do
                if petData.id then
                    local petType = petData.id
                    if not pets[petType] then
                        pets[petType] = {}
                    end
                    table.insert(pets[petType], uniqueId)
                    petInventory[petType] = pets[petType]
                end
            end
        end
    end
    return pets
end

-- Function to refresh pet dropdown
local function refreshPetDropdown()
    local pets = getAvailablePets()
    local petOptions = {}

    for petType, petList in pairs(pets) do
        table.insert(petOptions, string.format("%s (%d)", petType, #petList))
    end

    table.sort(petOptions)
    print("Available pet options:", table.concat(petOptions, ", "))
    return petOptions
end

-- Create dropdowns
local playerOptions = getPlayersInServer()
local PlayerDropdown = PetsTab:CreateDropdown({
    Name = "üéØ Select Player",
    Options = playerOptions,
    CurrentOption = playerOptions[1] or nil,
    MultipleOptions = false,
    Flag = "PlayerDropdown",
    Callback = function(Option)
        -- Option is a table; extract the name
        if type(Option) == "table" and Option.Name then
            selectedPlayerName = Option.Name
        elseif type(Option) == "string" then
            selectedPlayerName = Option
        else
            selectedPlayerName = nil
        end
        print("Selected player:", selectedPlayerName)
    end,
})

local petOptions = refreshPetDropdown()
local PetDropdown = PetsTab:CreateDropdown({
    Name = "üêæ Select Pet Type",
    Options = petOptions,
    CurrentOption = petOptions[1] or nil,
    MultipleOptions = false,
    Flag = "PetDropdown",
    Callback = function(Option)
        local optionString = tostring(Option)
        local petType = optionString:match("^(.-)%s+%(%d+%)$")
        if petType then
            selectedPetType = petType
            print("Selected pet type:", selectedPetType)
        else
            selectedPetType = optionString
            print("Selected pet type (no count):", selectedPetType)
        end
    end,
})

-- Function to give pet to player (FIXED VERSION)
local function givePet()
    if not selectedPlayerName or type(selectedPlayerName) ~= "string" then
        Rayfield:Notify({
            Title = "Error",
            Content = "Please select a valid player!",
            Duration = 3,
            Image = 4483362458
        })
        return
    end

    -- Debug: Print selected player and online players
    print("Selected player name:", selectedPlayerName)
    print("Online players:")
    for _, player in pairs(Players:GetPlayers()) do
        print(player.Name)
    end

    -- Find the player (case-insensitive)
    local targetPlayer
    for _, player in pairs(Players:GetPlayers()) do
        if type(player.Name) == "string" and player.Name:lower() == selectedPlayerName:lower() then
            targetPlayer = player
            break
        end
    end

    if not targetPlayer then
        Rayfield:Notify({
            Title = "Error",
            Content = "Selected player is offline or not found!",
            Duration = 3,
            Image = 4483362458
        })
        return
    end

    if not selectedPetType then
        Rayfield:Notify({
            Title = "Error",
            Content = "Please select a pet type!",
            Duration = 3,
            Image = 4483362458
        })
        return
    end

    if not petInventory[selectedPetType] or #petInventory[selectedPetType] == 0 then
        Rayfield:Notify({
            Title = "Error",
            Content = "No " .. selectedPetType .. " pets available!",
            Duration = 3,
            Image = 4483362458
        })
        return
    end

    local petUid = table.remove(petInventory[selectedPetType], 1)

    local args = {targetPlayer, petUid}
    local success, result = pcall(function()
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/GiveItem"):InvokeServer(unpack(args))
    end)

    if success then
        Rayfield:Notify({
            Title = "Success",
            Content = "Gave " .. selectedPetType .. " to " .. selectedPlayerName,
            Duration = 3,
            Image = 4483362458
        })
        PetDropdown:Refresh(refreshPetDropdown())
        if #petOptions > 0 then
            PetDropdown:Set(petOptions[1])
        end
        task.wait(9)
    else
        Rayfield:Notify({
            Title = "Error",
            Content = "Failed to give pet: " .. tostring(result),
            Duration = 3,
            Image = 4483362458
        })
        table.insert(petInventory[selectedPetType], petUid)
    end
end

-- Add Give Pet button
PetsTab:CreateButton({
    Name = "üéÅ Give Selected Pet",
    Callback = function()
        givePet()
    end,
})

-- Auto give toggle
local autoGivePets = false
local AutoGiveToggle = PetsTab:CreateToggle({
    Name = "üöÄ Auto Give Selected Pet",
    CurrentValue = false,
    Flag = "AutoGiveToggle",
    Callback = function(Value)
        autoGivePets = Value
        if Value then
            task.spawn(function()
                while autoGivePets do
                    givePet()
                    task.wait(10)
                end
            end)
        end
    end,
})

-- ========================
-- GIFTS TAB (FIXED VERSION)
-- ========================
-- Function to get all available gifts
local function getAvailableGifts()
    local gifts = {}
    local success, clientData = pcall(require, ReplicatedStorage.ClientModules.Core.ClientData)
    if success then
        local success2, allData = pcall(clientData.get_data, clientData)
        if success2 and allData[localPlayer.Name] and allData[localPlayer.Name].inventory and allData[localPlayer.Name].inventory.gifts then
            for giftId, giftData in pairs(allData[localPlayer.Name].inventory.gifts) do
                if giftData.id then
                    local giftName = giftData.id
                    if not gifts[giftName] then
                        gifts[giftName] = {}
                    end
                    table.insert(gifts[giftName], giftId)
                    giftInventory[giftName] = gifts[giftName]
                end
            end
        end
    end
    return gifts
end

-- Function to refresh gift dropdown
local function refreshGiftDropdown()
    local gifts = getAvailableGifts()
    local giftOptions = {}

    for giftName, giftList in pairs(gifts) do
        table.insert(giftOptions, string.format("%s (%d)", giftName, #giftList))
    end

    table.sort(giftOptions)
    print("Available gift options:", table.concat(giftOptions, ", "))
    return giftOptions
end

-- Create dropdowns for gifts
local giftPlayerOptions = getPlayersInServer()
local GiftsPlayerDropdown = GiftsTab:CreateDropdown({
    Name = "üéØ Select Player",
    Options = giftPlayerOptions,
    CurrentOption = giftPlayerOptions[1] or nil,
    MultipleOptions = false,
    Flag = "GiftsPlayerDropdown",
    Callback = function(Option)
        -- Option is a table; extract the name
        if type(Option) == "table" and Option.Name then
            selectedPlayerName = Option.Name
        elseif type(Option) == "string" then
            selectedPlayerName = Option
        else
            selectedPlayerName = nil
        end
        print("Selected player:", selectedPlayerName)
    end,
})

local giftTypeOptions = refreshGiftDropdown()
local GiftDropdown = GiftsTab:CreateDropdown({
    Name = "üéÅ Select Gift Type",
    Options = giftTypeOptions,
    CurrentOption = giftTypeOptions[1] or nil,
    MultipleOptions = false,
    Flag = "GiftDropdown",
    Callback = function(Option)
        local optionString = tostring(Option)
        local giftType = optionString:match("^(.-)%s+%(%d+%)$")
        if giftType then
            selectedGiftType = giftType
            print("Selected gift type:", selectedGiftType)
        else
            selectedGiftType = optionString
            print("Selected gift type (no count):", selectedGiftType)
        end
    end,
})

-- Function to give gift to player (FIXED VERSION)
local function giveGift()
    if not selectedPlayerName or type(selectedPlayerName) ~= "string" then
        Rayfield:Notify({
            Title = "Error",
            Content = "Please select a valid player!",
            Duration = 3,
            Image = 4483362458
        })
        return
    end

    -- Debug: Print selected player and online players
    print("Selected player name:", selectedPlayerName)
    print("Online players:")
    for _, player in pairs(Players:GetPlayers()) do
        print(player.Name)
    end

    -- Find the player (case-insensitive)
    local targetPlayer
    for _, player in pairs(Players:GetPlayers()) do
        if type(player.Name) == "string" and player.Name:lower() == selectedPlayerName:lower() then
            targetPlayer = player
            break
        end
    end

    if not targetPlayer then
        Rayfield:Notify({
            Title = "Error",
            Content = "Selected player is offline or not found!",
            Duration = 3,
            Image = 4483362458
        })
        return
    end

    if not selectedGiftType then
        Rayfield:Notify({
            Title = "Error",
            Content = "Please select a gift type!",
            Duration = 3,
            Image = 4483362458
        })
        return
    end

    if not giftInventory[selectedGiftType] or #giftInventory[selectedGiftType] == 0 then
        Rayfield:Notify({
            Title = "Error",
            Content = "No " .. selectedGiftType .. " gifts available!",
            Duration = 3,
            Image = 4483362458
        })
        return
    end

    local giftUid = table.remove(giftInventory[selectedGiftType], 1)

    local args = {targetPlayer, giftUid}
    local success, result = pcall(function()
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/GiveItem"):InvokeServer(unpack(args))
    end)

    if success then
        Rayfield:Notify({
            Title = "Success",
            Content = "Gave " .. selectedGiftType .. " to " .. selectedPlayerName,
            Duration = 3,
            Image = 4483362458
        })
        GiftDropdown:Refresh(refreshGiftDropdown())
        if #giftTypeOptions > 0 then
            GiftDropdown:Set(giftTypeOptions[1])
        end
        task.wait(9)
    else
        Rayfield:Notify({
            Title = "Error",
            Content = "Failed to give gift: " .. tostring(result),
            Duration = 3,
            Image = 4483362458
        })
        table.insert(giftInventory[selectedGiftType], giftUid)
    end
end

-- Add Give Gift button
GiftsTab:CreateButton({
    Name = "üéÅ Give Selected Gift",
    Callback = function()
        giveGift()
    end,
})

-- Auto give toggle for gifts
local autoGiveGifts = false
local AutoGiveGiftsToggle = GiftsTab:CreateToggle({
    Name = "üöÄ Auto Give Selected Gift",
    CurrentValue = false,
    Flag = "AutoGiveGiftsToggle",
    Callback = function(Value)
        autoGiveGifts = Value
        if Value then
            task.spawn(function()
                while autoGiveGifts do
                    giveGift()
                    task.wait(10)
                end
            end)
        end
    end,
})

-- ========================
-- INITIALIZATION
-- ========================
-- Auto-update gingerbread label every 10 seconds
task.spawn(function()
    while true do
        updateGingerbreadLabel()
        task.wait(10)
    end
end)

-- Auto-refresh dropdowns every 10 seconds
task.spawn(function()
    while true do
        task.wait(10)
        PlayerDropdown:Refresh(getPlayersInServer())
        GiftsPlayerDropdown:Refresh(getPlayersInServer())
        PetDropdown:Refresh(refreshPetDropdown())
        GiftDropdown:Refresh(refreshGiftDropdown())
    end
end)

-- Delayed notification to confirm auto-start
task.wait(3)
Rayfield:Notify({
    Title = "COCOON Auto Farm Started",
    Content = "Gingerbread farming is now running automatically!",
    Duration = 5,
    Image = 4483362458
})

print("COCOON Gingerbread Farm Loaded! Auto Farm is ON.")
