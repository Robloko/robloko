-- [ FIXED CUSTOM TELEPORT SCRIPT ] --
-- Fixed: Won't do ANYTHING if at excluded position

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer

-- Positions to check
local EXCLUDED_POSITION = Vector3.new(-255.10, 30.89, -1831.46)
local EXCLUDED_TOLERANCE = 50  -- Increased tolerance to be safe

-- Debug print
local function debugPrint(msg)
    print("[FixedTP] " .. tostring(msg))
end

-- Get valid character
local function getValidCharacter()
    return player.Character or player.CharacterAdded:Wait()
end

-- Check if player is near a position
local function isNearPosition(targetPos, tolerance)
    tolerance = tolerance or 10
    local char = getValidCharacter()
    if not char or not char:FindFirstChild("HumanoidRootPart") then return false end
    local hrp = char.HumanoidRootPart
    local distance = (hrp.Position - targetPos).Magnitude
    return distance < tolerance
end

-- Check if player is at the excluded position (MASTER CHECK)
local function isAtExcludedPosition()
    return isNearPosition(EXCLUDED_POSITION, EXCLUDED_TOLERANCE)
end

-- Get current position
local function getCurrentPosition()
    local char = getValidCharacter()
    if char and char:FindFirstChild("HumanoidRootPart") then
        return char.HumanoidRootPart.Position
    end
    return nil
end

-- Safe exit house - ONLY if not at excluded position
local function safeExitHouse()
    if isAtExcludedPosition() then
        debugPrint("SKIP: Not exiting house - at excluded position")
        return false
    end
    
    local success, err = pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("HousingAPI/UnsubscribeFromHouse")
            :InvokeServer(player, true)
    end)
    if success then
        debugPrint("Exited house successfully")
        return true
    else
        debugPrint("Failed to exit house (or not in house): " .. tostring(err))
        return false
    end
end

-- Safe teleport - ONLY if not at excluded position
local function safeTeleportTo(pos, name)
    if isAtExcludedPosition() then
        debugPrint("SKIP: Not teleporting - at excluded position")
        return false
    end
    
    local char = getValidCharacter()
    if not char or not char:FindFirstChild("HumanoidRootPart") then
        debugPrint("No HumanoidRootPart for teleport")
        return false
    end
    char.HumanoidRootPart.CFrame = CFrame.new(pos)
    task.wait(0.5)
    debugPrint("Teleported to " .. name)
    return true
end

-- Safe camera set - ONLY if not at excluded position
local function safeSetCamera(pos, lookAt)
    if isAtExcludedPosition() then
        debugPrint("SKIP: Not setting camera - at excluded position")
        return
    end
    
    local camera = Workspace.CurrentCamera
    if camera then
        camera.CameraType = Enum.CameraType.Scriptable
        camera.CFrame = CFrame.new(pos, lookAt)
        debugPrint("Camera set")
    end
end

-- Safe key press - ONLY if not at excluded position
local function safeKeyPress(forwardTime, backwardTime)
    if isAtExcludedPosition() then
        debugPrint("SKIP: Not pressing keys - at excluded position")
        return
    end
    
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.W, false, game)
    task.wait(forwardTime or 1.2)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.W, false, game)
    
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.S, false, game)
    task.wait(backwardTime or 2)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.S, false, game)
    
    debugPrint("Simulated keys")
end

-- Reset camera
local function resetCamera()
    local camera = Workspace.CurrentCamera
    if camera then
        camera.CameraType = Enum.CameraType.Custom
        debugPrint("Camera reset")
    end
end

-- MAIN FUNCTION: Teleport only if NOT at excluded position
local function teleportOnlyIfAllowed()
    -- Get current position first
    local currentPos = getCurrentPosition()
    if not currentPos then
        debugPrint("Cannot get current position")
        return false
    end
    
    debugPrint("Current position: " .. tostring(currentPos))
    
    -- CRITICAL CHECK: If at excluded position, DO NOTHING
    if isAtExcludedPosition() then
        debugPrint("✓ ALREADY AT TARGET POSITION: " .. tostring(EXCLUDED_POSITION))
        debugPrint("✓ DOING NOTHING - Script will not teleport you away")
        debugPrint("✓ Script execution complete")
        return true
    end
    
    -- Only if NOT at excluded position, proceed with teleport
    debugPrint("Not at excluded position. Starting teleport...")
    
    -- Target coordinates from first screenshot
    local targetPos = Vector3.new(-12025.122, 9529.577, -11970.038)
    local cameraPos = Vector3.new(-12025.516, 9535.196, -11981.302)
    
    -- Simple teleport sequence
    safeExitHouse()
    task.wait(1)
    
    safeTeleportTo(targetPos, "Target Location")
    task.wait(1)
    
    safeSetCamera(cameraPos, cameraPos + Vector3.new(0, 0, 10))
    task.wait(1)
    
    safeKeyPress(0.5, 0.5)
    
    debugPrint("Teleport sequence complete")
    resetCamera()
    return true
end

-- SIMPLE VERSION: Just checks and does nothing if at position
local function smartTeleport()
    local currentPos = getCurrentPosition()
    if not currentPos then return end
    
    debugPrint("Position check:")
    debugPrint("Current: " .. tostring(currentPos))
    debugPrint("Excluded: " .. tostring(EXCLUDED_POSITION))
    
    local distance = (currentPos - EXCLUDED_POSITION).Magnitude
    debugPrint("Distance: " .. string.format("%.2f", distance))
    
    if distance <= EXCLUDED_TOLERANCE then
        debugPrint("==================================")
        debugPrint("AT SAFE POSITION - DOING NOTHING")
        debugPrint("Script will not move you")
        debugPrint("==================================")
    else
        debugPrint("Not at safe position. Teleporting...")
        -- Call your teleport function here
        -- teleportOnlyIfAllowed()
    end
end

-- RUN THE SCRIPT
debugPrint("Starting position check...")
smartTeleport()  -- This version just checks and tells you what it would do

-- If you want to actually teleport when not at excluded position, use:
-- teleportOnlyIfAllowed()
