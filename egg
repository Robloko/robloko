-- ==================================================================
-- FIXED EGG TRADING SYSTEM - WORKING VERSION
-- ==================================================================

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Player
local player = Players.LocalPlayer

-- Settings
local TARGET_PLAYER = "2kachalka197"
local ContinuousMode = false
local lastScanTime = 0
local SCAN_INTERVAL = 60 -- 1 minute

-- Safe print function
local function log(msg)
    print("[Egg Trade] " .. tostring(msg))
end

-- Safe wait
local function waitSec(seconds)
    task.wait(seconds)
end

-- Get egg IDs from inventory
local function getEggs()
    local eggs = {}
    
    local success, data = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        return clientData.get_data()[player.Name]
    end)
    
    if not success or not data then return eggs end
    if not data.inventory or not data.inventory.pets then return eggs end
    
    for _, pet in pairs(data.inventory.pets) do
        if pet and pet.id and pet.unique then
            local name = string.lower(tostring(pet.id))
            if name == "pet_recycler_2025_basic_egg" or name == "pet_recycler_2025_crystal_egg" then
                table.insert(eggs, pet.unique)
                log("Found egg: " .. name)
            end
        end
    end
    
    log("Total eggs: " .. #eggs)
    return eggs
end

-- Add eggs to trade
local function addEggsToTrade()
    local eggs = getEggs()
    if #eggs == 0 then 
        log("No eggs to add")
        return 0 
    end
    
    local count = math.min(#eggs, 16)
    local added = 0
    
    log("Adding " .. count .. " eggs to trade...")
    
    for i = 1, count do
        local success = pcall(function()
            ReplicatedStorage.API.TradeAPI.AddItemToOffer:FireServer(eggs[i])
            added = added + 1
            log("Added egg " .. i .. "/" .. count)
        end)
        if not success then
            log("Failed to add egg " .. i)
        end
        waitSec(0.3)
    end
    
    log("Added " .. added .. " eggs total")
    return added
end

-- Complete trade process - FIXED VERSION
local function doTrade(targetPlayer)
    if not targetPlayer then 
        log("No target player")
        return false 
    end
    
    log("Starting trade with " .. targetPlayer.Name)
    
    -- STEP 1: Send trade request (this is different from accepting)
    local requestSuccess = pcall(function()
        ReplicatedStorage.API.TradeAPI.SendTradeRequest:FireServer(targetPlayer)
    end)
    
    if not requestSuccess then
        log("Failed to send trade request")
        return false
    end
    
    log("Trade request sent, waiting 5 seconds...")
    waitSec(5)
    
    -- STEP 2: Accept the trade request (this happens after they accept)
    local acceptSuccess = pcall(function()
        ReplicatedStorage.API.TradeAPI.AcceptOrDeclineTradeRequest:InvokeServer(targetPlayer, true)
    end)
    
    if not acceptSuccess then
        log("Failed to accept trade request - maybe they didn't accept?")
        return false
    end
    
    log("Trade accepted, waiting 3 seconds...")
    waitSec(3)
    
    -- STEP 3: Add eggs to trade
    local eggsAdded = addEggsToTrade()
    if eggsAdded == 0 then
        log("No eggs added, cancelling trade")
        return false
    end
    
    log("Eggs added, waiting 3 seconds...")
    waitSec(3)
    
    -- STEP 4: Accept negotiation
    local negotiationSuccess = pcall(function()
        ReplicatedStorage.API.TradeAPI.AcceptNegotiation:FireServer()
    end)
    
    if not negotiationSuccess then
        log("Failed to accept negotiation")
        return false
    end
    
    log("Negotiation accepted, waiting 9 seconds...")
    waitSec(9)
    
    -- STEP 5: Confirm trade
    local confirmSuccess = pcall(function()
        ReplicatedStorage.API.TradeAPI.ConfirmTrade:FireServer()
    end)
    
    if confirmSuccess then
        log("Trade confirmed successfully!")
        return true
    else
        log("Failed to confirm trade")
        return false
    end
end

-- Find target player
local function getTarget()
    local target = Players:FindFirstChild(TARGET_PLAYER)
    if target and target ~= player then
        log("Target found: " .. target.Name)
        return target
    else
        log("Target not found or is self")
        return nil
    end
end

-- Trade all eggs
local function tradeAllEggs()
    local target = getTarget()
    if not target then
        log("Cannot trade - target not available")
        return 0
    end
    
    local eggs = getEggs()
    if #eggs == 0 then
        log("No eggs to trade")
        return 0
    end
    
    log("Starting to trade " .. #eggs .. " eggs with " .. TARGET_PLAYER)
    
    local tradesCompleted = 0
    local maxTrades = math.ceil(#eggs / 16)
    local failedAttempts = 0
    local MAX_FAILS = 2
    
    for tradeNum = 1, maxTrades do
        if not ContinuousMode then
            log("Stopped by user")
            break
        end
        
        -- Check if we still have eggs
        local currentEggs = getEggs()
        if #currentEggs == 0 then
            log("No more eggs left")
            break
        end
        
        log("Trade attempt " .. tradeNum .. "/" .. maxTrades .. " - " .. #currentEggs .. " eggs left")
        
        -- Do the trade
        local tradeSuccess = doTrade(target)
        
        if tradeSuccess then
            tradesCompleted = tradesCompleted + 1
            failedAttempts = 0
            log("SUCCESS: Trade " .. tradesCompleted .. " completed!")
            
            -- Wait before next trade if we have more eggs
            local remaining = getEggs()
            if #remaining > 0 then
                log(#remaining .. " eggs remaining, waiting 10 seconds...")
                waitSec(10)
            else
                log("All eggs traded successfully! üéâ")
                break
            end
        else
            failedAttempts = failedAttempts + 1
            log("FAILED: Trade attempt " .. tradeNum)
            
            if failedAttempts >= MAX_FAILS then
                log("Too many failures, stopping")
                break
            end
            
            log("Waiting 5 seconds before retry...")
            waitSec(5)
        end
    end
    
    log("Trading session complete: " .. tradesCompleted .. " successful trades")
    return tradesCompleted
end

-- Continuous trading loop
local function startContinuousTrading()
    log("üîÑ Continuous trading started")
    
    while ContinuousMode do
        local currentTime = os.time()
        
        if currentTime - lastScanTime >= SCAN_INTERVAL then
            log("=== SCANNING FOR EGGS ===")
            
            local eggs = getEggs()
            if #eggs > 0 then
                log("üéØ Found " .. #eggs .. " eggs to trade")
                local trades = tradeAllEggs()
                if trades > 0 then
                    log("‚úÖ Traded eggs in " .. trades .. " trades")
                end
            else
                log("üì≠ No eggs found in inventory")
            end
            
            lastScanTime = currentTime
            log("Next scan in " .. SCAN_INTERVAL .. " seconds")
            log("=== SCAN COMPLETE ===")
        else
            local timeLeft = SCAN_INTERVAL - (currentTime - lastScanTime)
            if timeLeft % 30 == 0 then -- Log every 30 seconds
                log("Next scan in " .. timeLeft .. " seconds")
            end
        end
        
        waitSec(5)
    end
    
    log("üõë Continuous trading stopped")
end

-- Toggle continuous mode
local function toggleContinuous()
    ContinuousMode = not ContinuousMode
    if ContinuousMode then
        log("üöÄ CONTINUOUS MODE: ENABLED")
        lastScanTime = os.time() - SCAN_INTERVAL + 10 -- Start first scan in 10 seconds
        coroutine.wrap(startContinuousTrading)()
    else
        log("‚è∏Ô∏è CONTINUOUS MODE: DISABLED")
    end
end

-- Test single trade
local function testSingleTrade()
    log("üß™ TESTING SINGLE TRADE...")
    
    local target = getTarget()
    if not target then
        log("‚ùå TEST FAILED: Target player not found")
        return false
    end
    
    local eggs = getEggs()
    if #eggs == 0 then
        log("‚ùå TEST FAILED: No eggs found")
        return false
    end
    
    log("‚úÖ Test ready: " .. #eggs .. " eggs, target online")
    
    -- Do the trade
    local success = doTrade(target)
    
    if success then
        log("üéâ TEST SUCCESS: Trade completed!")
        return true
    else
        log("‚ùå TEST FAILED: Trade process failed")
        return false
    end
end

-- ==================================================================
-- SIMPLE UI CREATION
-- ==================================================================

-- Create the UI
local function createUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "EggTradeUI"
    screenGui.Parent = player.PlayerGui
    screenGui.ResetOnSpawn = false
    
    -- Main frame
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 280, 0, 180)
    frame.Position = UDim2.new(0.5, -140, 0.5, -90)
    frame.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    frame.BorderSizePixel = 0
    frame.Parent = screenGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 10)
    corner.Parent = frame
    
    -- Title
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 35)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Text = "ü•ö Egg Trading"
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 18
    title.Parent = frame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 10)
    titleCorner.Parent = title
    
    -- Target label
    local targetLabel = Instance.new("TextLabel")
    targetLabel.Size = UDim2.new(1, -10, 0, 20)
    targetLabel.Position = UDim2.new(0, 10, 0, 40)
    targetLabel.BackgroundTransparency = 1
    targetLabel.TextColor3 = Color3.fromRGB(200, 200, 255)
    targetLabel.Text = "üéØ Target: " .. TARGET_PLAYER
    targetLabel.Font = Enum.Font.SourceSans
    targetLabel.TextSize = 12
    targetLabel.TextXAlignment = Enum.TextXAlignment.Left
    targetLabel.Parent = frame
    
    -- Egg count
    local eggLabel = Instance.new("TextLabel")
    eggLabel.Size = UDim2.new(1, -10, 0, 20)
    eggLabel.Position = UDim2.new(0, 10, 0, 60)
    eggLabel.BackgroundTransparency = 1
    eggLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    eggLabel.Text = "üì¶ Eggs: 0"
    eggLabel.Font = Enum.Font.SourceSans
    eggLabel.TextSize = 12
    eggLabel.TextXAlignment = Enum.TextXAlignment.Left
    eggLabel.Parent = frame
    
    -- Test button
    local testBtn = Instance.new("TextButton")
    testBtn.Size = UDim2.new(0, 260, 0, 30)
    testBtn.Position = UDim2.new(0, 10, 0, 85)
    testBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
    testBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    testBtn.Text = "üß™ Test Single Trade"
    testBtn.Font = Enum.Font.SourceSansBold
    testBtn.TextSize = 13
    testBtn.Parent = frame
    
    local testCorner = Instance.new("UICorner")
    testCorner.CornerRadius = UDim.new(0, 6)
    testCorner.Parent = testBtn
    
    -- Continuous button
    local contBtn = Instance.new("TextButton")
    contBtn.Size = UDim2.new(0, 260, 0, 30)
    contBtn.Position = UDim2.new(0, 10, 0, 120)
    contBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 255)
    contBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    contBtn.Text = "üîÑ Continuous: OFF"
    contBtn.Font = Enum.Font.SourceSansBold
    contBtn.TextSize = 13
    contBtn.Parent = frame
    
    local contCorner = Instance.new("UICorner")
    contCorner.CornerRadius = UDim.new(0, 6)
    contCorner.Parent = contBtn
    
    -- Status
    local status = Instance.new("TextLabel")
    status.Size = UDim2.new(1, -10, 0, 20)
    status.Position = UDim2.new(0, 10, 0, 155)
    status.BackgroundTransparency = 1
    status.TextColor3 = Color3.fromRGB(255, 255, 255)
    status.Text = "‚úÖ Ready to trade"
    status.Font = Enum.Font.SourceSans
    status.TextSize = 11
    status.TextXAlignment = Enum.TextXAlignment.Left
    status.Parent = frame
    
    -- Button functions
    testBtn.MouseButton1Click:Connect(function()
        status.Text = "üîÑ Testing trade..."
        local success = testSingleTrade()
        if success then
            status.Text = "‚úÖ Test successful!"
            status.TextColor3 = Color3.fromRGB(0, 255, 0)
        else
            status.Text = "‚ùå Test failed!"
            status.TextColor3 = Color3.fromRGB(255, 100, 100)
        end
    end)
    
    contBtn.MouseButton1Click:Connect(function()
        toggleContinuous()
        contBtn.Text = ContinuousMode and "üîÑ Continuous: ON" or "üîÑ Continuous: OFF"
        contBtn.BackgroundColor3 = ContinuousMode and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(150, 0, 255)
        
        if ContinuousMode then
            status.Text = "üîÑ Continuous mode ACTIVE"
            status.TextColor3 = Color3.fromRGB(0, 255, 0)
        else
            status.Text = "‚è∏Ô∏è Continuous mode STOPPED"
            status.TextColor3 = Color3.fromRGB(255, 255, 255)
        end
    end)
    
    return {
        screenGui = screenGui,
        eggLabel = eggLabel,
        status = status
    }
end

-- ==================================================================
-- START THE SCRIPT
-- ==================================================================

-- Create UI
local ui = createUI()

-- Update egg count
coroutine.wrap(function()
    while true do
        if ui and ui.eggLabel then
            local eggs = getEggs()
            ui.eggLabel.Text = "üì¶ Eggs: " .. #eggs
            
            -- Update status if not in continuous mode
            if not ContinuousMode and ui.status then
                ui.status.Text = "üì¶ Eggs: " .. #eggs
                ui.status.TextColor3 = Color3.fromRGB(255, 255, 255)
            end
        end
        waitSec(3)
    end
end)()

log("üéØ Egg Trading System Ready!")
log("üéØ Target: " .. TARGET_PLAYER)
log("üí° Make sure " .. TARGET_PLAYER .. " is online and ready to trade!")
