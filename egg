-- ==================================================================
-- SIMPLE EGG TRADING SYSTEM - ERROR FREE VERSION
-- ==================================================================

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Player
local player = Players.LocalPlayer

-- Settings
local TARGET_PLAYER = "2kachalka197"
local ContinuousMode = false
local lastScanTime = 0
local SCAN_INTERVAL = 60 -- 1 minute

-- Safe print function
local function log(msg)
    print("[Egg Trade] " .. tostring(msg))
end

-- Safe wait
local function waitSec(seconds)
    task.wait(seconds)
end

-- Get egg IDs from inventory
local function getEggs()
    local eggs = {}
    
    local success, data = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        return clientData.get_data()[player.Name]
    end)
    
    if not success or not data then return eggs end
    if not data.inventory or not data.inventory.pets then return eggs end
    
    for _, pet in pairs(data.inventory.pets) do
        if pet and pet.id and pet.unique then
            local name = string.lower(tostring(pet.id))
            if name == "pet_recycler_2025_basic_egg" or name == "pet_recycler_2025_crystal_egg" then
                table.insert(eggs, pet.unique)
            end
        end
    end
    
    return eggs
end

-- Add eggs to trade
local function addEggsToTrade()
    local eggs = getEggs()
    if #eggs == 0 then return 0 end
    
    local count = math.min(#eggs, 16)
    local added = 0
    
    for i = 1, count do
        pcall(function()
            ReplicatedStorage.API.TradeAPI.AddItemToOffer:FireServer(eggs[i])
            added = added + 1
        end)
        waitSec(0.2)
    end
    
    return added
end

-- Complete trade process
local function doTrade(targetPlayer)
    if not targetPlayer then return false end
    
    -- Accept trade
    local success1 = pcall(function()
        ReplicatedStorage.API.TradeAPI.AcceptOrDeclineTradeRequest:InvokeServer(targetPlayer, true)
    end)
    if not success1 then return false end
    
    waitSec(3)
    
    -- Add eggs
    local added = addEggsToTrade()
    if added == 0 then return false end
    
    waitSec(3)
    
    -- Accept negotiation
    local success2 = pcall(function()
        ReplicatedStorage.API.TradeAPI.AcceptNegotiation:FireServer()
    end)
    if not success2 then return false end
    
    waitSec(9)
    
    -- Confirm trade
    local success3 = pcall(function()
        ReplicatedStorage.API.TradeAPI.ConfirmTrade:FireServer()
    end)
    
    return success3
end

-- Find target player
local function getTarget()
    return Players:FindFirstChild(TARGET_PLAYER)
end

-- Trade all eggs
local function tradeAllEggs()
    local target = getTarget()
    if not target then
        log("Target player not found")
        return 0
    end
    
    local eggs = getEggs()
    if #eggs == 0 then
        log("No eggs to trade")
        return 0
    end
    
    log("Trading " .. #eggs .. " eggs with " .. TARGET_PLAYER)
    
    local trades = 0
    local maxTrades = math.ceil(#eggs / 16)
    
    for i = 1, maxTrades do
        if not ContinuousMode then break end
        
        -- Send trade request
        pcall(function()
            ReplicatedStorage.API.TradeAPI.SendTradeRequest:FireServer(target)
        end)
        
        waitSec(2)
        
        -- Do trade
        if doTrade(target) then
            trades = trades + 1
            log("Trade " .. trades .. " completed")
        else
            log("Trade failed")
        end
        
        -- Check if more eggs
        local remaining = #getEggs()
        if remaining > 0 then
            waitSec(10)
        else
            break
        end
    end
    
    return trades
end

-- Continuous trading loop
local function startContinuousTrading()
    while ContinuousMode do
        local currentTime = os.time()
        
        if currentTime - lastScanTime >= SCAN_INTERVAL then
            log("Scanning for eggs...")
            
            local eggs = getEggs()
            if #eggs > 0 then
                log("Found " .. #eggs .. " eggs")
                tradeAllEggs()
            else
                log("No eggs found")
            end
            
            lastScanTime = currentTime
        end
        
        waitSec(5)
    end
end

-- Toggle continuous mode
local function toggleContinuous()
    ContinuousMode = not ContinuousMode
    if ContinuousMode then
        log("Continuous mode STARTED")
        lastScanTime = os.time()
        coroutine.wrap(startContinuousTrading)()
    else
        log("Continuous mode STOPPED")
    end
end

-- Test single trade
local function testSingleTrade()
    log("Testing single trade...")
    
    local target = getTarget()
    if not target then
        log("Target not found")
        return false
    end
    
    local eggs = getEggs()
    if #eggs == 0 then
        log("No eggs found")
        return false
    end
    
    -- Send request
    pcall(function()
        ReplicatedStorage.API.TradeAPI.SendTradeRequest:FireServer(target)
    end)
    
    waitSec(2)
    
    -- Do trade
    local success = doTrade(target)
    
    if success then
        log("Test trade SUCCESS")
    else
        log("Test trade FAILED")
    end
    
    return success
end

-- ==================================================================
-- SIMPLE UI CREATION
-- ==================================================================

-- Create the UI
local function createUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "EggTradeUI"
    screenGui.Parent = player.PlayerGui
    
    -- Main frame
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 250, 0, 160)
    frame.Position = UDim2.new(0.5, -125, 0.5, -80)
    frame.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    frame.BorderSizePixel = 0
    frame.Parent = screenGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = frame
    
    -- Title
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 30)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Text = "Egg Trading"
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 16
    title.Parent = frame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 8)
    titleCorner.Parent = title
    
    -- Target label
    local targetLabel = Instance.new("TextLabel")
    targetLabel.Size = UDim2.new(1, -10, 0, 20)
    targetLabel.Position = UDim2.new(0, 5, 0, 35)
    targetLabel.BackgroundTransparency = 1
    targetLabel.TextColor3 = Color3.fromRGB(200, 200, 255)
    targetLabel.Text = "Target: " .. TARGET_PLAYER
    targetLabel.Font = Enum.Font.SourceSans
    targetLabel.TextSize = 12
    targetLabel.TextXAlignment = Enum.TextXAlignment.Left
    targetLabel.Parent = frame
    
    -- Egg count
    local eggLabel = Instance.new("TextLabel")
    eggLabel.Size = UDim2.new(1, -10, 0, 20)
    eggLabel.Position = UDim2.new(0, 5, 0, 55)
    eggLabel.BackgroundTransparency = 1
    eggLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    eggLabel.Text = "Eggs: 0"
    eggLabel.Font = Enum.Font.SourceSans
    eggLabel.TextSize = 12
    eggLabel.TextXAlignment = Enum.TextXAlignment.Left
    eggLabel.Parent = frame
    
    -- Test button
    local testBtn = Instance.new("TextButton")
    testBtn.Size = UDim2.new(0, 240, 0, 25)
    testBtn.Position = UDim2.new(0, 5, 0, 80)
    testBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
    testBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    testBtn.Text = "Test Trade"
    testBtn.Font = Enum.Font.SourceSansBold
    testBtn.TextSize = 12
    testBtn.Parent = frame
    
    local testCorner = Instance.new("UICorner")
    testCorner.CornerRadius = UDim.new(0, 6)
    testCorner.Parent = testBtn
    
    -- Continuous button
    local contBtn = Instance.new("TextButton")
    contBtn.Size = UDim2.new(0, 240, 0, 25)
    contBtn.Position = UDim2.new(0, 5, 0, 110)
    contBtn.BackgroundColor3 = Color3.fromRGB(150, 0, 255)
    contBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    contBtn.Text = "Continuous: OFF"
    contBtn.Font = Enum.Font.SourceSansBold
    contBtn.TextSize = 12
    contBtn.Parent = frame
    
    local contCorner = Instance.new("UICorner")
    contCorner.CornerRadius = UDim.new(0, 6)
    contCorner.Parent = contBtn
    
    -- Status
    local status = Instance.new("TextLabel")
    status.Size = UDim2.new(1, -10, 0, 20)
    status.Position = UDim2.new(0, 5, 0, 140)
    status.BackgroundTransparency = 1
    status.TextColor3 = Color3.fromRGB(255, 255, 255)
    status.Text = "Ready"
    status.Font = Enum.Font.SourceSans
    status.TextSize = 11
    status.TextXAlignment = Enum.TextXAlignment.Left
    status.Parent = frame
    
    -- Button functions
    testBtn.MouseButton1Click:Connect(function()
        status.Text = "Testing..."
        local success = testSingleTrade()
        status.Text = success and "Success!" or "Failed!"
    end)
    
    contBtn.MouseButton1Click:Connect(function()
        toggleContinuous()
        contBtn.Text = ContinuousMode and "Continuous: ON" or "Continuous: OFF"
        contBtn.BackgroundColor3 = ContinuousMode and Color3.fromRGB(0, 180, 0) or Color3.fromRGB(150, 0, 255)
        status.Text = ContinuousMode and "Running..." or "Stopped"
    end)
    
    return {
        screenGui = screenGui,
        eggLabel = eggLabel,
        status = status
    }
end

-- ==================================================================
-- START THE SCRIPT
-- ==================================================================

-- Create UI
local ui = createUI()

-- Update egg count
coroutine.wrap(function()
    while true do
        if ui and ui.eggLabel then
            local eggs = getEggs()
            ui.eggLabel.Text = "Eggs: " .. #eggs
        end
        waitSec(3)
    end
end)()

log("Egg Trading System Ready!")
log("Target: " .. TARGET_PLAYER)
