-- Egg Trading System - Compact Standalone Script
-- Place this in StarterPlayerScripts or StarterGui

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local DEBUG_MODE = true

-- Egg Trading variables
local EggTradingMode = false
local eggTradingCoroutine = nil

-- Debug function
local function debugPrint(message)
    if not DEBUG_MODE then return end
    local timestamp = os.date("[%H:%M:%S]")
    print(timestamp .. " " .. message)
end

-- Function to find specific eggs in inventory
local function findEggsInInventory()
    local targetEggs = {
        "pet_recycler_2025_basic_egg",
        "pet_recycler_2025_crystal_egg"
    }

    local foundEggs = {}

    local success, errorMsg = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local playerData = clientData.get_data()[player.Name]
        if playerData and playerData.inventory and playerData.inventory.pets then
            for petUniqueId, petData in pairs(playerData.inventory.pets) do
                if petData.id then
                    local eggName = string.lower(petData.id)
                    for _, targetEgg in ipairs(targetEggs) do
                        if eggName == targetEgg then
                            table.insert(foundEggs, {
                                unique_id = petUniqueId,
                                name = petData.id,
                                type = targetEgg
                            })
                            debugPrint("Found egg: " .. petData.id .. " (ID: " .. petUniqueId .. ")")
                            break
                        end
                    end
                end
            end
        end
    end)

    if not success then
        debugPrint("Error scanning inventory for eggs: " .. tostring(errorMsg))
    end

    debugPrint("Total eggs found: " .. #foundEggs)
    return foundEggs
end

-- Function to add all eggs to trade
local function addAllEggsToTrade()
    debugPrint("Adding all recycler eggs to trade...")
    local eggs = findEggsInInventory()
    if #eggs == 0 then
        debugPrint("No recycler eggs found to add to trade")
        return 0
    end

    local eggsAdded = 0
    local maxEggs = math.min(#eggs, 18) -- Trade limit

    for i = 1, maxEggs do
        local egg = eggs[i]
        local success, err = pcall(function()
            ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/AddItemToOffer"):FireServer(egg.unique_id)
        end)

        if success then
            eggsAdded = eggsAdded + 1
            debugPrint("Added egg " .. i .. "/" .. maxEggs .. " to trade: " .. egg.name)
        else
            debugPrint("Failed to add egg to trade: " .. tostring(err))
        end
        task.wait(0.2)
    end

    debugPrint("Finished adding " .. eggsAdded .. " eggs to trade")
    return eggsAdded
end

-- Function to complete egg trade with specific player
local function completeEggTradeWithPlayer(targetPlayerName)
    if not targetPlayerName or targetPlayerName == "2kachalka197" then
        debugPrint("No player name provided for egg trading")
        return false
    end

    local targetPlayer = Players:FindFirstChild(targetPlayerName)
    if not targetPlayer then
        debugPrint("Player not found: " .. targetPlayerName)
        return false
    end

    debugPrint("Starting egg trade with: " .. targetPlayerName)

    -- Send trade request
    local success1, err1 = pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/SendTradeRequest"):FireServer(targetPlayer)
    end)

    if not success1 then
        debugPrint("Failed to send trade request: " .. tostring(err1))
        return false
    end

    debugPrint("Trade request sent successfully")
    task.wait(2)

    -- Accept trade request
    local args = { targetPlayer, true }
    local success2, result2 = pcall(function()
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/AcceptOrDeclineTradeRequest"):InvokeServer(unpack(args))
    end)

    if not success2 then
        debugPrint("Failed to accept trade request: " .. tostring(result2))
        return false
    end

    debugPrint("Trade request accepted")
    task.wait(2)

    -- Add all eggs to trade
    local eggsAdded = addAllEggsToTrade()
    if eggsAdded == 0 then
        debugPrint("No eggs to trade, cancelling...")
        return false
    end

    task.wait(3)

    -- Accept negotiation
    local success3, result3 = pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/AcceptNegotiation"):FireServer()
    end)

    if not success3 then
        debugPrint("Failed to accept negotiation: " .. tostring(result3))
        return false
    end

    debugPrint("Negotiation accepted, waiting for confirmation...")
    task.wait(9)

    -- Confirm trade
    local success4, result4 = pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("TradeAPI/ConfirmTrade"):FireServer()
    end)

    if success4 then
        debugPrint("SUCCESS: Egg trade completed with " .. targetPlayerName .. " (" .. eggsAdded .. " eggs traded)")
        return true
    else
        debugPrint("Failed to confirm trade: " .. tostring(result4))
        return false
    end
end

-- Function to continuously trade eggs to fixed player "2kachalka197"
local function startContinuousEggTrading()
    while EggTradingMode do
        local targetPlayerName = "1kachalka" -- Default player name

        -- Check if eggs are available
        local eggs = findEggsInInventory()
        if #eggs == 0 then
            debugPrint("No eggs available for trading. Waiting 30 seconds...")
            task.wait(30)
            continue
        end

        debugPrint("Eggs detected, sending trade request to " .. targetPlayerName)

        -- Perform trade only if eggs are detected
        local success = completeEggTradeWithPlayer(targetPlayerName)
        if not success then
            debugPrint("Trade failed. Retrying in 15 seconds...")
            task.wait(15)
        else
            task.wait(math.random(8, 12)) -- Random delay to avoid detection
        end
    end
end

-- Function to toggle egg trading mode
local function toggleEggTradingMode()
    EggTradingMode = not EggTradingMode
    if EggTradingMode then
        debugPrint("Continuous Egg Trading: ENABLED (target: 2kachalka197)")
        eggTradingCoroutine = coroutine.wrap(startContinuousEggTrading)()
    else
        debugPrint("Continuous Egg Trading: DISABLED")
        eggTradingCoroutine = nil
    end
end

-- Create UI for Egg Trading
local function createEggTradingUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "EggTradingUI"
    screenGui.Parent = player:WaitForChild("PlayerGui")

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 160, 0, 30)
    frame.Position = UDim2.new(0, 10, 1, -40)
    frame.AnchorPoint = Vector2.new(0, 1)
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BorderSizePixel = 0
    frame.BackgroundTransparency = 0.1
    frame.Parent = screenGui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = frame

    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 20)
    title.Position = UDim2.new(0, 0, 0, 5)
    title.BackgroundTransparency = 1
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Text = "Egg Trading"
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 12
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = frame

    local addEggsButton = Instance.new("TextButton")
    addEggsButton.Size = UDim2.new(1, -10, 0, 20)
    addEggsButton.Position = UDim2.new(0, 5, 0, 5)
    addEggsButton.BackgroundColor3 = Color3.fromRGB(120, 0, 200)
    addEggsButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    addEggsButton.Text = "Add Eggs [OFF]"
    addEggsButton.Font = Enum.Font.SourceSansBold
    addEggsButton.TextSize = 12
    addEggsButton.Parent = frame

    local addEggsCorner = Instance.new("UICorner")
    addEggsCorner.CornerRadius = UDim.new(0, 4)
    addEggsCorner.Parent = addEggsButton

    addEggsButton.MouseButton1Click:Connect(function()
        toggleEggTradingMode()
        addEggsButton.Text = EggTradingMode and "Add Eggs [ON]" or "Add Eggs [OFF]"
        addEggsButton.BackgroundColor3 = EggTradingMode and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(120, 0, 200)
    end)

    return {
        frame = frame,
        addEggsButton = addEggsButton
    }
end

-- Initialize UI
local ui = createEggTradingUI()

debugPrint("Egg Trading System Loaded Successfully!")
debugPrint("Features: Continuous Egg Trading with 2kachalka197")
debugPrint("Note: Trade requests are only sent when eggs are detected.")
