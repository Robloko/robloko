-- Simple UI Roblox Script using Rayfield Library for Gingerbread Farm
-- Load Rayfield UI Library
local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- Create the main window
local Window = Rayfield:CreateWindow({
   Name = "Gingerbread Farm UI",
   LoadingTitle = "Gingerbread Farm",
   LoadingSubtitle = "Powered by xAI",
   ConfigurationSaving = {
      Enabled = true,
      FolderName = nil,
      FileName = "GingerbreadConfig"
   },
   Discord = {
      Enabled = false,
      Invite = "",
      RememberJoins = true
   },
   KeySystem = false,
   KeySettings = {
      Title = "Key",
      Subtitle = "Enter Key",
      Note = "No key required",
      FileName = "Key",
      SaveKey = true,
      GrabKeyFromSite = false,
      Key = {"12345"}
   }
})

-- Get player and character
local Player = game:GetService("Players").LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()

-- Wait for humanoid root part
local function getHumanoidRootPart()
    if Character and Character:FindFirstChild("HumanoidRootPart") then
        return Character.HumanoidRootPart
    end
    return nil
end

-- Settings table
local Settings = {
   StartFarming = false
}

-- Function to safely teleport and collect gingerbread
local function teleportAndCollect(index)
    pcall(function()
        -- Get fresh character reference
        Character = Player.Character
        if not Character then return false end
        
        local humanoidRootPart = getHumanoidRootPart()
        if not humanoidRootPart then return false end
        
        local interior = workspace.Interiors["MainMap!Christmas"]
        if not interior then return false end
        
        local children = interior:GetChildren()
        if index > #children then return false end
        
        local targetModel = children[index]
        if not targetModel then return false end
        
        local gingerbreadPart = targetModel:FindFirstChild("GingerbreadMan")
        if not gingerbreadPart then return false end
        
        -- Teleport to gingerbread with slight offset to avoid getting stuck
        local targetCFrame = gingerbreadPart.CFrame + Vector3.new(0, 3, 0)
        
        -- Check if character is stuck (not moving)
        local startPosition = humanoidRootPart.Position
        
        -- Teleport
        humanoidRootPart.CFrame = targetCFrame
        
        -- Very small wait for teleport
        task.wait(0.05)
        
        -- Check if we actually teleported
        local currentPosition = humanoidRootPart.Position
        local distanceMoved = (currentPosition - startPosition).Magnitude
        
        -- If we didn't move much, try different approach
        if distanceMoved < 2 then
            -- Try alternative teleport method
            Character:PivotTo(targetCFrame)
            task.wait(0.05)
        end
        
        -- Collect gingerbread
        game:GetService("ReplicatedStorage"):WaitForChild("adoptme_new_net"):WaitForChild("adoptme_legacy_shared.ContentPacks.Winter2025.Game.IceSkating.IceSkatingNet:16"):FireServer()
        
        return true
    end)
    return false
end

-- Function to check if player is stuck and fix it
local function checkAndFixStuck()
    pcall(function()
        if not Character then return end
        
        local humanoid = Character:FindFirstChild("Humanoid")
        if not humanoid then return end
        
        -- If humanoid is seated or platform standing, sit/stand to reset
        if humanoid.Sit or humanoid.PlatformStand then
            humanoid.Sit = false
            humanoid.PlatformStand = false
            task.wait(0.1)
        end
        
        -- Try to move slightly to unstick
        local humanoidRootPart = getHumanoidRootPart()
        if humanoidRootPart then
            humanoidRootPart.CFrame = humanoidRootPart.CFrame + Vector3.new(0, 0.1, 0)
        end
    end)
end

-- Main farming function
local function startGingerbreadFarm()
    while Settings.StartFarming do
        pcall(function()
            -- Get fresh character reference
            Character = Player.Character
            if not Character then 
                task.wait(0.5)
                return 
            end
            
            -- Check and fix if stuck every 10 teleports
            if math.random(1, 10) == 1 then
                checkAndFixStuck()
            end
            
            local interior = workspace.Interiors["MainMap!Christmas"]
            if not interior then 
                task.wait(1)
                return 
            end
            
            -- Loop through indices 32 to 188
            for index = 32, 188 do
                if not Settings.StartFarming then break end
                
                -- Skip if index doesn't exist
                if index > #interior:GetChildren() then 
                    task.wait(0.1)
                    continue 
                end
                
                local success = teleportAndCollect(index)
                
                -- Very short delay between teleports (0.1 seconds)
                task.wait(0.1)
                
                -- If failed to teleport, wait a bit longer and try to fix
                if not success then
                    task.wait(0.2)
                    checkAndFixStuck()
                end
            end
            
            -- Small delay before restarting loop
            if Settings.StartFarming then
                task.wait(0.1)
            end
        end)
        
        -- Error handling wait
        task.wait(0.1)
    end
end

-- Create tab
local MainTab = Window:CreateTab("Main Farming", nil)

-- Create section for farming toggle
MainTab:CreateSection("Gingerbread Farming")

-- Create the main toggle
local FarmToggle = MainTab:CreateToggle({
   Name = "Start Gingerbread Farm",
   CurrentValue = Settings.StartFarming,
   Flag = "GingerBreadFarmToggle",
   Callback = function(State)
      Settings.StartFarming = State
      if State then
          -- Start farming in a separate thread
          coroutine.wrap(startGingerbreadFarm)()
          Rayfield:Notify({
             Title = "Started",
             Content = "Gingerbread farming started!\nTeleporting every 0.1 seconds",
             Duration = 3,
             Image = nil
          })
      else
          Rayfield:Notify({
             Title = "Stopped",
             Content = "Gingerbread farming stopped.",
             Duration = 3,
             Image = nil
          })
      end
   end
})

-- Create button to fix stuck character
MainTab:CreateButton({
    Name = "Fix Stuck Character",
    Callback = function()
        checkAndFixStuck()
        Rayfield:Notify({
            Title = "Fixed",
            Content = "Attempted to fix stuck character",
            Duration = 2,
            Image = nil
        })
    end
})

-- Create label for instructions
MainTab:CreateLabel("Toggle to start auto-farming gingerbread.")
MainTab:CreateLabel("Farms indices 32-188 with 0.1s delay")
MainTab:CreateLabel("Use 'Fix Stuck Character' if teleporting gets stuck")

-- Character respawn handler
Player.CharacterAdded:Connect(function(newChar)
    Character = newChar
    task.wait(0.5) -- Wait for character to fully load
end)

-- Initial notification
task.wait(1)
Rayfield:Notify({
   Title = "UI Loaded",
   Content = "Gingerbread Farm UI is ready!\nDelay: 0.1s between teleports",
   Duration = 5,
   Image = nil
})
