local function farmCycle()
    log("Starting farm cycle...")

    -- Check if the player's data is accessible
    local playerData = clientData.get_data()[player.Name]
    if not playerData then
        log("‚ùå Player data not found!")
        return
    end

    -- Count crystal eggs
    local crystalEggs = countCrystalEggs()
    log("ü•ö Crystal Eggs Counted: " .. crystalEggs)

    -- Check if we should release
    local shouldRelease, releaseReason, allowedPets, neonPets
    local success, err = pcall(function()
        shouldRelease, releaseReason, allowedPets, neonPets = shouldReleaseNow()
    end)

    if not success then
        log("‚ùå Error in shouldReleaseNow: " .. tostring(err))
        return
    end

    if not shouldRelease then
        log("‚ùå Not enough resources. Waiting " .. COOLDOWNS.RESOURCE_CHECK .. " seconds...")
        for i = 1, COOLDOWNS.RESOURCE_CHECK do
            if not running then break end
            task.wait(1)
        end
        return
    end

    log("‚úÖ Release conditions met! Reason: " .. releaseReason .. " - Teleporting to Nursery...")

    -- Teleport to Nursery
    local teleportSuccess = goToNursery()
    if not teleportSuccess then
        log("‚ùå Failed to reach Nursery")
        return
    end

    -- Execute release logic
    local releaseSuccess
    if releaseReason == "points" then
        log("Executing points-only release...")
        releaseSuccess, err = pcall(executePointsOnlyRelease)
        if not releaseSuccess then
            log("‚ùå Error in executePointsOnlyRelease: " .. tostring(err))
            return
        end
    else
        log("Executing pet release...")
        releaseSuccess, err = pcall(function()
            return executePetRelease(allowedPets, neonPets)
        end)
        if not releaseSuccess then
            log("‚ùå Error in executePetRelease: " .. tostring(err))
            return
        end
    end

    -- Wait for cooldown
    log("‚è≥ Waiting " .. COOLDOWNS.REWARD_WAIT .. " seconds for rewards cooldown...")
    for i = 1, COOLDOWNS.REWARD_WAIT do
        if not running then break end
        if i % 60 == 0 then
            local minutesLeft = math.floor((COOLDOWNS.REWARD_WAIT - i) / 60)
            local secondsLeft = (COOLDOWNS.REWARD_WAIT - i) % 60
            log("   " .. minutesLeft .. "m " .. secondsLeft .. "s remaining...")
        end
        task.wait(1)
    end

    if not running then return end

    -- Claim reward
    log("üîπ Claiming Reward...")
    local claimSuccess, claimErr = pcall(function()
        local claimArgs = {
            "f-27",
            "UseBlock",
            {
                action = "claim"
            },
            player.Character
        }
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("HousingAPI/ActivateInteriorFurniture"):InvokeServer(unpack(claimArgs))
    end)

    if not claimSuccess then
        log("‚ùå Failed to claim reward: " .. tostring(claimErr))
        -- Try alternative claim method
        local altClaimSuccess, altClaimErr = pcall(function()
            return ReplicatedStorage:WaitForChild("API"):WaitForChild("HousingAPI/ActivateInteriorFurniture"):InvokeServer("f-27", "UseBlock", {action = "claim"}, player.Character)
        end)
        if not altClaimSuccess then
            log("‚ùå Alternative claim method also failed: " .. tostring(altClaimErr))
        else
            log("‚úÖ Alternative claim method succeeded!")
        end
    else
        log("üéâ Successfully claimed reward!")
    end

    -- Count crystal eggs after claiming
    countCrystalEggs()

    -- Wait before next cycle
    log("‚è≥ Waiting " .. COOLDOWNS.AFTER_CLAIM .. " seconds before next resource check...")
    for i = 1, COOLDOWNS.AFTER_CLAIM do
        if not running then break end
        task.wait(1)
    end
end
