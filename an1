-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local VirtualUser = game:GetService("VirtualUser")
local RunService = game:GetService("RunService")

-- Local player
local localPlayer = Players.LocalPlayer
local playerGui = localPlayer:WaitForChild("PlayerGui")

-- Create ScreenGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "MouseRecorderUI"
screenGui.Parent = playerGui
screenGui.ResetOnSpawn = false

-- Main Frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 320, 0, 200)
mainFrame.Position = UDim2.new(0.5, -160, 0, 20)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
mainFrame.BorderSizePixel = 0
mainFrame.BackgroundTransparency = 0.1
mainFrame.Parent = screenGui
local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 12)
mainCorner.Parent = mainFrame

-- Title
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 28)
title.Position = UDim2.new(0, 0, 0, 0)
title.BackgroundTransparency = 1
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Text = "üéÆ Mouse Recorder"
title.Font = Enum.Font.SourceSansBold
title.TextSize = 20
title.Parent = mainFrame

-- Status Display
local statusDisplay = Instance.new("Frame")
statusDisplay.Size = UDim2.new(1, -20, 0, 60)
statusDisplay.Position = UDim2.new(0, 10, 0, 35)
statusDisplay.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
statusDisplay.Parent = mainFrame
local statusCorner = Instance.new("UICorner")
statusCorner.CornerRadius = UDim.new(0, 8)
statusCorner.Parent = statusDisplay

-- Status Text
local statusText = Instance.new("TextLabel")
statusText.Size = UDim2.new(1, -10, 0.7, 0)
statusText.Position = UDim2.new(0, 5, 0, 5)
statusText.BackgroundTransparency = 1
statusText.TextColor3 = Color3.fromRGB(255, 255, 255)
statusText.Text = "Status: Ready"
statusText.Font = Enum.Font.SourceSansBold
statusText.TextSize = 16
statusText.TextXAlignment = Enum.TextXAlignment.Left
statusText.Parent = statusDisplay

-- Info Text
local infoText = Instance.new("TextLabel")
infoText.Size = UDim2.new(1, -10, 0.3, 0)
infoText.Position = UDim2.new(0, 5, 0.7, 0)
infoText.BackgroundTransparency = 1
infoText.TextColor3 = Color3.fromRGB(200, 200, 200)
infoText.Text = "Clicks: 0 | Position: (0, 0)"
infoText.Font = Enum.Font.SourceSans
infoText.TextSize = 14
infoText.TextXAlignment = Enum.TextXAlignment.Left
infoText.Parent = statusDisplay

-- Control Buttons Frame
local buttonsFrame = Instance.new("Frame")
buttonsFrame.Size = UDim2.new(1, -20, 0, 80)
buttonsFrame.Position = UDim2.new(0, 10, 0, 105)
buttonsFrame.BackgroundTransparency = 1
buttonsFrame.Parent = mainFrame

-- Create button template function
local function createControlButton(name, text, color, positionX)
    local button = Instance.new("TextButton")
    button.Name = name
    button.Size = UDim2.new(0, 70, 0, 36)
    button.Position = UDim2.new(positionX, 0, 0, 0)
    button.BackgroundColor3 = color
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.Text = text
    button.Font = Enum.Font.SourceSansBold
    button.TextSize = 14
    button.Parent = buttonsFrame
    
    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 6)
    buttonCorner.Parent = button
    
    return button
end

-- Create control buttons
local recordButton = createControlButton("Record", "‚è∫ REC", Color3.fromRGB(255, 50, 50), 0)
local playButton = createControlButton("Play", "‚ñ∂ PLAY", Color3.fromRGB(50, 200, 50), 0.25)
local stopButton = createControlButton("Stop", "‚èπ STOP", Color3.fromRGB(100, 100, 100), 0.5)
local pauseButton = createControlButton("Pause", "‚è∏ PAUSE", Color3.fromRGB(255, 180, 0), 0.75)

-- Mouse click functions
local mouse1press, mouse1release
if mousemoverel then
    mouse1press = mouse1press or (function()
        VirtualUser:ClickButton1(Vector2.new(0, 0))
    end)
    mouse1release = mouse1release or (function()
        -- Some exploits may have mouse1release, if not we'll just use a delay
    end)
end

-- Recorder Variables
local recordedClicks = {}
local isRecording = false
local isPlaying = false
local isPaused = false
local recordingStartTime = 0
local playStartTime = 0
local currentPlayIndex = 1

-- Function to get current mouse position
local function getMousePosition()
    if UserInputService.MouseEnabled then
        return UserInputService:GetMouseLocation()
    end
    return Vector2.new(0, 0)
end

-- Function to simulate click at position
local function clickAtPosition(position)
    if mouse1press and mouse1release then
        mouse1press()
        task.wait(0.05)
        mouse1release()
    else
        VirtualUser:ClickButton1(position)
    end
    return position
end

-- Function to update status display
local function updateStatus()
    local status = "Ready"
    local statusColor = Color3.fromRGB(100, 255, 100)
    
    if isRecording then
        status = "Recording..."
        statusColor = Color3.fromRGB(255, 100, 100)
    elseif isPlaying then
        if isPaused then
            status = "Paused"
            statusColor = Color3.fromRGB(255, 200, 0)
        else
            status = "Playing..."
            statusColor = Color3.fromRGB(100, 255, 100)
        end
    end
    
    statusText.Text = "Status: " .. status
    statusText.TextColor3 = statusColor
    
    local mousePos = getMousePosition()
    infoText.Text = string.format("Clicks: %d | Position: (%d, %d)", #recordedClicks, mousePos.X, mousePos.Y)
end

-- Function to start recording
local function startRecording()
    if isPlaying then return end
    
    recordedClicks = {}
    isRecording = true
    recordingStartTime = tick()
    
    -- Connect mouse click listener
    local mouseClickConnection
    mouseClickConnection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if not gameProcessed and input.UserInputType == Enum.UserInputType.MouseButton1 then
            local currentTime = tick() - recordingStartTime
            local position = getMousePosition()
            
            table.insert(recordedClicks, {
                time = currentTime,
                position = position,
                x = position.X,
                y = position.Y
            })
            
            print(string.format("Recorded click at %.2fs: (%d, %d)", currentTime, position.X, position.Y))
            updateStatus()
        end
    end)
    
    -- Disconnect when recording stops
    recordButton.MouseButton1Click:Connect(function()
        if isRecording then
            isRecording = false
            if mouseClickConnection then
                mouseClickConnection:Disconnect()
            end
            print("Recording stopped. Total clicks: " .. #recordedClicks)
            updateStatus()
        end
    end)
    
    print("Recording started...")
    updateStatus()
end

-- Function to play recorded clicks
local function playRecording()
    if isRecording or #recordedClicks == 0 then return end
    
    isPlaying = true
    isPaused = false
    currentPlayIndex = 1
    playStartTime = tick()
    
    local function playNextClick()
        if not isPlaying or isPaused then return end
        
        while currentPlayIndex <= #recordedClicks do
            local click = recordedClicks[currentPlayIndex]
            local currentTime = tick() - playStartTime
            
            -- Wait until it's time to play this click
            if currentTime >= click.time then
                -- Click at the recorded position
                local clickedPos = clickAtPosition(click.position)
                print(string.format("Playing click %d/%d at (%.2fs): (%d, %d)", 
                    currentPlayIndex, #recordedClicks, click.time, clickedPos.X, clickedPos.Y))
                
                currentPlayIndex += 1
                updateStatus()
                
                if currentPlayIndex > #recordedClicks then
                    -- Finished playing
                    isPlaying = false
                    print("Playback completed!")
                    updateStatus()
                    return
                end
            else
                -- Wait a bit and check again
                task.wait(0.01)
            end
        end
    end
    
    -- Start playing in a separate thread
    spawn(playNextClick)
    
    print("Playing " .. #recordedClicks .. " clicks...")
    updateStatus()
end

-- Function to stop playback/recording
local function stopPlayback()
    isRecording = false
    isPlaying = false
    isPaused = false
    currentPlayIndex = 1
    
    print("Stopped")
    updateStatus()
end

-- Function to pause/resume playback
local function togglePause()
    if not isPlaying then return end
    
    isPaused = not isPaused
    
    if isPaused then
        print("Playback paused")
    else
        print("Playback resumed")
    end
    
    updateStatus()
end

-- Button click handlers
recordButton.MouseButton1Click:Connect(function()
    if not isRecording then
        startRecording()
    else
        stopPlayback()
    end
end)

playButton.MouseButton1Click:Connect(function()
    if not isPlaying then
        playRecording()
    else
        stopPlayback()
    end
end)

stopButton.MouseButton1Click:Connect(function()
    stopPlayback()
end)

pauseButton.MouseButton1Click:Connect(function()
    togglePause()
end)

-- Update mouse position in real-time
spawn(function()
    while true do
        if not isRecording then
            updateStatus()
        end
        task.wait(0.1)
    end
end)

-- Initial status update
updateStatus()

print("Mouse Recorder UI Loaded!")
print("Controls:")
print("‚è∫ REC - Start/Stop recording mouse clicks")
print("‚ñ∂ PLAY - Play recorded clicks")
print("‚èπ STOP - Stop playback/recording")
print("‚è∏ PAUSE - Pause/Resume playback")

-- Function to export recorded clicks
local function exportClicks()
    local exportStr = "local recordedClicks = {\n"
    for i, click in ipairs(recordedClicks) do
        exportStr = exportStr .. string.format("    {time = %.3f, x = %d, y = %d},\n", click.time, click.x, click.y)
    end
    exportStr = exportStr .. "}\n"
    
    print("\n=== EXPORTED CLICKS ===")
    print(exportStr)
    print("=== END EXPORT ===")
    
    return exportStr
end

-- Optional: Add export button
local exportButton = Instance.new("TextButton")
exportButton.Name = "Export"
exportButton.Size = UDim2.new(0, 100, 0, 28)
exportButton.Position = UDim2.new(0.5, -50, 0, 190)
exportButton.BackgroundColor3 = Color3.fromRGB(80, 80, 180)
exportButton.TextColor3 = Color3.fromRGB(255, 255, 255)
exportButton.Text = "üìã Export"
exportButton.Font = Enum.Font.SourceSans
exportButton.TextSize = 14
exportButton.Parent = mainFrame

local exportCorner = Instance.new("UICorner")
exportCorner.CornerRadius = UDim.new(0, 6)
exportCorner.Parent = exportButton

exportButton.MouseButton1Click:Connect(function()
    if #recordedClicks > 0 then
        exportClicks()
        statusText.Text = "Exported to console!"
        task.wait(2)
        updateStatus()
    else
        statusText.Text = "No clicks to export!"
        task.wait(1)
        updateStatus()
    end
end)
