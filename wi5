-- Gingerbread Farm Script with Smooth Movement
-- Try multiple Rayfield sources
local Rayfield = nil
local success, err = pcall(function()
    Rayfield = loadstring(game:HttpGet('https://raw.githubusercontent.com/shlexware/Rayfield/main/source'))()
end)
if not success then
    success, err = pcall(function()
        Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
    end)
end
if not success then
    -- Fallback to simple UI if Rayfield fails
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Gingerbread Farm",
        Text = "Failed to load Rayfield. Creating simple UI...",
        Duration = 5
    })
    
    -- Create a simple command-based system
    local Settings = {
        StartFarming = false,
        WalkSpeed = 16,
        StartIndex = 32,
        EndIndex = 188
    }
    
    -- Simple print commands
    print("=== Gingerbread Farm Commands ===")
    print("Type in chat or execute:")
    print("!start - Start farming")
    print("!stop - Stop farming")
    print("!status - Check status")
    print("!speed [number] - Set walking speed")
    print("================================")
    
    -- Listen for chat commands
    game:GetService("Players").LocalPlayer.Chatted:Connect(function(msg)
        if msg:lower() == "!start" then
            Settings.StartFarming = true
            print("[Gingerbread Farm] Started farming!")
        elseif msg:lower() == "!stop" then
            Settings.StartFarming = false
            print("[Gingerbread Farm] Stopped farming!")
        elseif msg:lower() == "!status" then
            print(string.format("[Gingerbread Farm] Status: %s", Settings.StartFarming and "Running" or "Stopped"))
        elseif msg:lower():sub(1, 6) == "!speed" then
            local speed = tonumber(msg:sub(8))
            if speed then
                Settings.WalkSpeed = speed
                print(string.format("[Gingerbread Farm] Speed set to: %s", speed))
            end
        end
    end)
    
    -- Return early since we're using command system
    return
end

-- If we get here, Rayfield loaded successfully
local Player = game:GetService("Players").LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
local Humanoid = Character:WaitForChild("Humanoid")

-- Smooth pathfinding service
local PathfindingService = game:GetService("PathfindingService")

-- Create the window with proper settings
local Window = Rayfield:CreateWindow({
    Name = "üç™ Gingerbread Farm",
    LoadingTitle = "Loading Gingerbread Farm...",
    LoadingSubtitle = "Powered by xAI",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "GingerbreadFarmConfig",
        FileName = "Settings"
    },
    Discord = {
        Enabled = false,
        Invite = "noinvite",
        RememberJoins = true
    },
    KeySystem = false
})

-- Verify window was created
if not Window then
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Error",
        Text = "Failed to create window",
        Duration = 5
    })
    return
end

-- Create tabs
local MainTab = Window:CreateTab("Main", 4483362458)
local TeleportTab = Window:CreateTab("Movement", 4483362458)
local SettingsTab = Window:CreateTab("Settings", 4483362458)

-- Settings
local Settings = {
    Farming = false,
    WalkSpeed = 16,
    StartIndex = 32,
    EndIndex = 188,
    AntiAFK = true,
    Notifications = true,
    UsePathfinding = true,
    CollectionDelay = 0.5,
    PathfindingTimeout = 10
}

-- Cache gingerbread locations
local GingerbreadLocations = {}
local LastCollectedIndex = 0

-- Function to find gingerbread at specific index
local function findGingerbreadAtIndex(index)
    local interior = workspace:FindFirstChild("Interiors")
    if not interior then return nil end
    
    local christmas = interior:FindFirstChild("MainMap!Christmas")
    if not christmas then return nil end
    
    local children = christmas:GetChildren()
    if index > #children then return nil end
    
    local model = children[index]
    if not model then return nil end
    
    local gingerbread = model:FindFirstChild("GingerbreadMan") or 
                       model:FindFirstChild("Gingerbread") or
                       model:FindFirstChildWhichIsA("BasePart")
    
    return gingerbread
end

-- Function to walk smoothly to a target position
local function walkToPosition(targetPosition)
    if not Character or not HumanoidRootPart or not Humanoid then
        return false
    end
    
    -- Calculate distance
    local distance = (targetPosition - HumanoidRootPart.Position).Magnitude
    
    -- If very close, just teleport
    if distance < 5 then
        HumanoidRootPart.CFrame = CFrame.new(targetPosition + Vector3.new(0, 3, 0))
        return true
    end
    
    -- Create path using PathfindingService
    if Settings.UsePathfinding then
        local path = PathfindingService:CreatePath({
            AgentRadius = 2,
            AgentHeight = 5,
            AgentCanJump = true,
            WaypointSpacing = 4,
            Costs = {}
        })
        
        -- Compute path
        local success, errorMessage = pcall(function()
            path:ComputeAsync(HumanoidRootPart.Position, targetPosition)
        end)
        
        if not success or path.Status ~= Enum.PathStatus.Success then
            -- Fallback: direct movement if pathfinding fails
            Humanoid:MoveTo(targetPosition)
            local startTime = tick()
            while (HumanoidRootPart.Position - targetPosition).Magnitude > 10 and tick() - startTime < Settings.PathfindingTimeout do
                Humanoid:MoveTo(targetPosition)
                task.wait(0.1)
            end
        else
            -- Follow the computed path
            local waypoints = path:GetWaypoints()
            
            for _, waypoint in ipairs(waypoints) do
                if not Settings.Farming then break end
                
                if waypoint.Action == Enum.PathWaypointAction.Jump then
                    Humanoid.Jump = true
                end
                
                Humanoid:MoveTo(waypoint.Position)
                
                -- Wait until reached waypoint or timeout
                local startTime = tick()
                while (HumanoidRootPart.Position - waypoint.Position).Magnitude > 4 and tick() - startTime < Settings.PathfindingTimeout do
                    if not Settings.Farming then break end
                    task.wait(0.1)
                end
                
                if not Settings.Farming then break end
            end
        end
    else
        -- Simple direct movement
        Humanoid:MoveTo(targetPosition)
        local startTime = tick()
        while (HumanoidRootPart.Position - targetPosition).Magnitude > 5 and tick() - startTime < Settings.PathfindingTimeout do
            if not Settings.Farming then break end
            task.wait(0.1)
        end
    end
    
    return (HumanoidRootPart.Position - targetPosition).Magnitude < 10
end

-- Function to collect gingerbread at current position
local function collectGingerbread()
    local remote = game:GetService("ReplicatedStorage"):FindFirstChild("adoptme_new_net")
    if remote then
        local iceRemote = remote:FindFirstChild("adoptme_legacy_shared.ContentPacks.Winter2025.Game.IceSkating.IceSkatingNet:16")
        if iceRemote then
            iceRemote:FireServer()
            return true
        end
    end
    return false
end

-- Pre-cache all gingerbread positions
local function cacheGingerbreadPositions()
    GingerbreadLocations = {}
    
    local interior = workspace:FindFirstChild("Interiors")
    if not interior then return end
    
    local christmas = interior:FindFirstChild("MainMap!Christmas")
    if not christmas then return end
    
    for i = Settings.StartIndex, Settings.EndIndex do
        local gingerbread = findGingerbreadAtIndex(i)
        if gingerbread then
            GingerbreadLocations[i] = gingerbread.Position
        end
    end
    
    print(string.format("[Gingerbread Farm] Cached %d gingerbread locations", #GingerbreadLocations))
end

-- Main farming function with smooth movement
local function farmGingerbreadSmoothly()
    -- First teleport to start position
    local startGingerbread = findGingerbreadAtIndex(Settings.StartIndex)
    if startGingerbread then
        HumanoidRootPart.CFrame = CFrame.new(startGingerbread.Position + Vector3.new(0, 3, 0))
        task.wait(1)
        
        -- Collect first gingerbread
        collectGingerbread()
        LastCollectedIndex = Settings.StartIndex
        
        if Settings.Notifications then
            Rayfield:Notify({
                Title = "Started Collection",
                Content = "Starting at gingerbread #" .. Settings.StartIndex,
                Duration = 2,
                Image = 4483362458
            })
        end
    end
    
    -- Set walking speed
    Humanoid.WalkSpeed = Settings.WalkSpeed
    
    -- Start sequential collection
    for i = Settings.StartIndex + 1, Settings.EndIndex do
        if not Settings.Farming then break end
        
        -- Find next gingerbread
        local gingerbread = findGingerbreadAtIndex(i)
        if gingerbread then
            local targetPosition = gingerbread.Position
            
            -- Walk smoothly to the gingerbread
            if Settings.Notifications then
                Rayfield:Notify({
                    Title = "Moving to",
                    Content = "Gingerbread #" .. i,
                    Duration = 1.5,
                    Image = 4483362458
                })
            end
            
            local success = walkToPosition(targetPosition)
            
            if success then
                -- Collect gingerbread
                task.wait(Settings.CollectionDelay)
                local collected = collectGingerbread()
                
                if collected then
                    LastCollectedIndex = i
                    
                    if Settings.Notifications then
                        Rayfield:Notify({
                            Title = "Collected",
                            Content = "Gingerbread #" .. i,
                            Duration = 1,
                            Image = 4483362458
                        })
                    end
                end
            else
                -- If failed to reach, teleport as fallback
                if Settings.Notifications then
                    Rayfield:Notify({
                        Title = "Pathfinding Failed",
                        Content = "Teleporting to gingerbread #" .. i,
                        Duration = 2,
                        Image = 4483362458
                    })
                end
                
                HumanoidRootPart.CFrame = CFrame.new(targetPosition + Vector3.new(0, 3, 0))
                task.wait(Settings.CollectionDelay)
                collectGingerbread()
                LastCollectedIndex = i
            end
        end
        
        -- Small delay between movements
        task.wait(0.3)
    end
    
    -- Stop farming when loop completes
    if Settings.Farming then
        Settings.Farming = false
        if Settings.Notifications then
            Rayfield:Notify({
                Title = "Collection Complete",
                Content = "Collected all gingerbreads from " .. Settings.StartIndex .. " to " .. Settings.EndIndex,
                Duration = 5,
                Image = 4483362458
            })
        end
    end
end

-- Anti-AFK
if Settings.AntiAFK then
    local VirtualUser = game:GetService("VirtualUser")
    game:GetService("Players").LocalPlayer.Idled:Connect(function()
        VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
        task.wait(1)
        VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    end)
end

-- Main Tab
MainTab:CreateSection("Farming Controls")

local Toggle = MainTab:CreateToggle({
    Name = "Start Farming",
    CurrentValue = Settings.Farming,
    Flag = "FarmingToggle",
    Callback = function(Value)
        Settings.Farming = Value
        if Value then
            Rayfield:Notify({
                Title = "Started",
                Content = "Gingerbread farming started with smooth movement!",
                Duration = 3,
                Image = 4483362458
            })
            -- Reset walk speed
            if Humanoid then
                Humanoid.WalkSpeed = Settings.WalkSpeed
            end
            -- Cache positions and start farming
            cacheGingerbreadPositions()
            task.spawn(farmGingerbreadSmoothly)
        else
            Rayfield:Notify({
                Title = "Stopped",
                Content = "Gingerbread farming stopped.",
                Duration = 3,
                Image = 4483362458
            })
        end
    end
})

MainTab:CreateButton({
    Name = "Cache Gingerbread Positions",
    Callback = function()
        cacheGingerbreadPositions()
        Rayfield:Notify({
            Title = "Positions Cached",
            Content = string.format("Found %d gingerbread locations", #GingerbreadLocations),
            Duration = 3,
            Image = 4483362458
        })
    end
})

MainTab:CreateButton({
    Name = "Go to Start Position",
    Callback = function()
        local gingerbread = findGingerbreadAtIndex(Settings.StartIndex)
        if gingerbread then
            local success = walkToPosition(gingerbread.Position)
            if success then
                Rayfield:Notify({
                    Title = "Arrived",
                    Content = "Reached gingerbread #" .. Settings.StartIndex,
                    Duration = 3,
                    Image = 4483362458
                })
            end
        end
    end
})

-- Movement Tab
TeleportTab:CreateSection("Movement Settings")

TeleportTab:CreateSlider({
    Name = "Walking Speed",
    Range = {8, 50},
    Increment = 1,
    Suffix = "studs/sec",
    CurrentValue = Settings.WalkSpeed,
    Flag = "WalkSpeedSlider",
    Callback = function(Value)
        Settings.WalkSpeed = Value
        if Humanoid then
            Humanoid.WalkSpeed = Value
        end
    end
})

TeleportTab:CreateSlider({
    Name = "Collection Delay",
    Range = {0.1, 2},
    Increment = 0.1,
    Suffix = "seconds",
    CurrentValue = Settings.CollectionDelay,
    Flag = "CollectionDelaySlider",
    Callback = function(Value)
        Settings.CollectionDelay = Value
    end
})

TeleportTab:CreateToggle({
    Name = "Use Pathfinding",
    CurrentValue = Settings.UsePathfinding,
    Flag = "UsePathfinding",
    Callback = function(Value)
        Settings.UsePathfinding = Value
    end
})

TeleportTab:CreateInput({
    Name = "Start Index",
    PlaceholderText = "32",
    RemoveTextAfterFocusLost = false,
    CurrentValue = tostring(Settings.StartIndex),
    Flag = "StartIndex",
    Callback = function(Value)
        local num = tonumber(Value)
        if num and num > 0 then
            Settings.StartIndex = num
        end
    end
})

TeleportTab:CreateInput({
    Name = "End Index",
    PlaceholderText = "188",
    RemoveTextAfterFocusLost = false,
    CurrentValue = tostring(Settings.EndIndex),
    Flag = "EndIndex",
    Callback = function(Value)
        local num = tonumber(Value)
        if num and num > 0 then
            Settings.EndIndex = num
        end
    end
})

-- Settings Tab
SettingsTab:CreateSection("Preferences")

SettingsTab:CreateToggle({
    Name = "Anti-AFK",
    CurrentValue = Settings.AntiAFK,
    Flag = "AntiAFK",
    Callback = function(Value)
        Settings.AntiAFK = Value
    end
})

SettingsTab:CreateToggle({
    Name = "Notifications",
    CurrentValue = Settings.Notifications,
    Flag = "Notifications",
    Callback = function(Value)
        Settings.Notifications = Value
    end
})

SettingsTab:CreateButton({
    Name = "Reset Character Speed",
    Callback = function()
        if Humanoid then
            Humanoid.WalkSpeed = 16
            Settings.WalkSpeed = 16
            Rayfield:Notify({
                Title = "Speed Reset",
                Content = "Walk speed reset to 16",
                Duration = 3,
                Image = 4483362458
            })
        end
    end
})

-- Character handling
Player.CharacterAdded:Connect(function(newChar)
    Character = newChar
    HumanoidRootPart = newChar:WaitForChild("HumanoidRootPart")
    Humanoid = newChar:WaitForChild("Humanoid")
    
    -- Restore walk speed
    if Humanoid and Settings.WalkSpeed then
        Humanoid.WalkSpeed = Settings.WalkSpeed
    end
end)

-- Initial notification
Rayfield:Notify({
    Title = "Gingerbread Farm",
    Content = "UI loaded with smooth movement! üç™",
    Duration = 5,
    Image = 4483362458
})

print("[Gingerbread Farm] UI Loaded Successfully with Smooth Movement!")
