-- Gingerbread Farm Script with Natural Movement
-- Try multiple Rayfield sources
local Rayfield = nil
local success, err = pcall(function()
    Rayfield = loadstring(game:HttpGet('https://raw.githubusercontent.com/shlexware/Rayfield/main/source'))()
end)
if not success then
    success, err = pcall(function()
        Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
    end)
end
if not success then
    -- Fallback to simple UI if Rayfield fails
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Gingerbread Farm",
        Text = "Failed to load Rayfield. Creating simple UI...",
        Duration = 5
    })
    
    -- Create a simple command-based system
    local Settings = {
        StartFarming = false,
        MoveDelay = 2,
        StartIndex = 32,
        EndIndex = 188
    }
    
    -- Simple print commands
    print("=== Gingerbread Farm Commands ===")
    print("Type in chat or execute:")
    print("!start - Start farming")
    print("!stop - Stop farming")
    print("!status - Check status")
    print("!setdelay [number] - Set movement delay")
    print("================================")
    
    -- Listen for chat commands
    game:GetService("Players").LocalPlayer.Chatted:Connect(function(msg)
        if msg:lower() == "!start" then
            Settings.StartFarming = true
            print("[Gingerbread Farm] Started farming!")
        elseif msg:lower() == "!stop" then
            Settings.StartFarming = false
            print("[Gingerbread Farm] Stopped farming!")
        elseif msg:lower() == "!status" then
            print(string.format("[Gingerbread Farm] Status: %s", Settings.StartFarming and "Running" or "Stopped"))
        elseif msg:lower():sub(1, 9) == "!setdelay" then
            local delay = tonumber(msg:sub(11))
            if delay then
                Settings.MoveDelay = delay
                print(string.format("[Gingerbread Farm] Delay set to: %s seconds", delay))
            end
        end
    end)
    
    -- Return early since we're using command system
    return
end

-- If we get here, Rayfield loaded successfully
local Player = game:GetService("Players").LocalPlayer
local Character = Player.Character or Player.CharacterAdded:Wait()
local HumanoidRootPart = Character:WaitForChild("HumanoidRootPart")
local Humanoid = Character:WaitForChild("Humanoid")

-- Create the window with proper settings
local Window = Rayfield:CreateWindow({
    Name = "ðŸª Gingerbread Farm",
    LoadingTitle = "Loading Gingerbread Farm...",
    LoadingSubtitle = "Powered by xAI",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "GingerbreadFarmConfig",
        FileName = "Settings"
    },
    Discord = {
        Enabled = false,
        Invite = "noinvite",
        RememberJoins = true
    },
    KeySystem = false
})

-- Verify window was created
if not Window then
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Error",
        Text = "Failed to create window",
        Duration = 5
    })
    return
end

-- Create tabs
local MainTab = Window:CreateTab("Main", 4483362458)
local TeleportTab = Window:CreateTab("Teleport", 4483362458)
local SettingsTab = Window:CreateTab("Settings", 4483362458)

-- Settings
local Settings = {
    Farming = false,
    MoveDelay = 2,
    WalkSpeed = 16,
    StartIndex = 32,
    EndIndex = 188,
    AntiAFK = true,
    Notifications = true,
    NaturalMovement = true
}

-- Movement functions
local function moveToPosition(targetPosition)
    if not Settings.NaturalMovement then
        -- Instant teleport
        HumanoidRootPart.CFrame = CFrame.new(targetPosition)
        return
    end
    
    -- Natural movement
    local distance = (HumanoidRootPart.Position - targetPosition).Magnitude
    
    if distance > 50 then
        -- For long distances, teleport to save time
        HumanoidRootPart.CFrame = CFrame.new(targetPosition + Vector3.new(0, 3, 0))
    else
        -- Walk naturally to the target
        Humanoid:MoveTo(targetPosition)
        
        -- Wait until we reach the target or timeout after 5 seconds
        local startTime = tick()
        while (HumanoidRootPart.Position - targetPosition).Magnitude > 3 and tick() - startTime < 5 do
            if not Settings.Farming then break end
            Humanoid:MoveTo(targetPosition)
            task.wait(0.1)
        end
        
        -- If we didn't reach, teleport the rest of the way
        if (HumanoidRootPart.Position - targetPosition).Magnitude > 3 then
            HumanoidRootPart.CFrame = CFrame.new(targetPosition + Vector3.new(0, 3, 0))
        end
    end
end

local function findGingerbreadPositions()
    local positions = {}
    
    pcall(function()
        local interior = workspace:FindFirstChild("Interiors")
        if interior then
            local christmas = interior:FindFirstChild("MainMap!Christmas")
            if christmas then
                for i, model in pairs(christmas:GetChildren()) do
                    local gingerbread = model:FindFirstChild("GingerbreadMan") or 
                                      model:FindFirstChild("Gingerbread") or
                                      model:FindFirstChildWhichIsA("BasePart")
                    
                    if gingerbread then
                        positions[i] = gingerbread.Position
                    end
                end
            end
        end
    end)
    
    return positions
end

-- Farming function with sequential movement
local function farmGingerbread()
    Rayfield:Notify({
        Title = "Starting",
        Content = "Finding gingerbread positions...",
        Duration = 3,
        Image = 4483362458
    })
    
    -- First teleport to the starting gingerbread
    local positions = findGingerbreadPositions()
    
    if not positions[Settings.StartIndex] then
        Rayfield:Notify({
            Title = "Error",
            Content = "Could not find starting position!",
            Duration = 5,
            Image = 4483362458
        })
        return
    end
    
    -- Teleport to the starting position
    HumanoidRootPart.CFrame = CFrame.new(positions[Settings.StartIndex] + Vector3.new(0, 3, 0))
    
    if Settings.Notifications then
        Rayfield:Notify({
            Title = "Starting Position",
            Content = "Teleported to gingerbread #" .. Settings.StartIndex,
            Duration = 3,
            Image = 4483362458
        })
    end
    
    task.wait(2) -- Wait a moment before starting
    
    -- Start sequential farming
    for i = Settings.StartIndex, Settings.EndIndex do
        if not Settings.Farming then break end
        
        -- Collect current gingerbread
        pcall(function()
            local remote = game:GetService("ReplicatedStorage"):FindFirstChild("adoptme_new_net")
            if remote then
                local iceRemote = remote:FindFirstChild("adoptme_legacy_shared.ContentPacks.Winter2025.Game.IceSkating.IceSkatingNet:16")
                if iceRemote then
                    iceRemote:FireServer()
                end
            end
        end)
        
        if Settings.Notifications and i % 5 == 0 then
            Rayfield:Notify({
                Title = "Collected",
                Content = "Gingerbread #" .. i,
                Duration = 1,
                Image = 4483362458
            })
        end
        
        -- If this is not the last one, move to the next
        if i < Settings.EndIndex then
            local nextPos = positions[i + 1]
            if nextPos then
                moveToPosition(nextPos + Vector3.new(0, 3, 0))
                task.wait(0.5) -- Brief pause before collecting next
            end
        end
        
        task.wait(Settings.MoveDelay)
    end
    
    if Settings.Farming then
        Rayfield:Notify({
            Title = "Completed",
            Content = "Finished collecting gingerbreads!",
            Duration = 5,
            Image = 4483362458
        })
        Settings.Farming = false
    end
end

-- Anti-AFK
if Settings.AntiAFK then
    local VirtualUser = game:GetService("VirtualUser")
    game:GetService("Players").LocalPlayer.Idled:Connect(function()
        VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
        task.wait(1)
        VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    end)
end

-- Main Tab
MainTab:CreateSection("Farming Controls")

local Toggle = MainTab:CreateToggle({
    Name = "Start Farming",
    CurrentValue = Settings.Farming,
    Flag = "FarmingToggle",
    Callback = function(Value)
        Settings.Farming = Value
        if Value then
            Rayfield:Notify({
                Title = "Started",
                Content = "Gingerbread farming started! Moving sequentially from #" .. Settings.StartIndex .. " to #" .. Settings.EndIndex,
                Duration = 5,
                Image = 4483362458
            })
            task.spawn(farmGingerbread)
        else
            Rayfield:Notify({
                Title = "Stopped",
                Content = "Gingerbread farming stopped.",
                Duration = 3,
                Image = 4483362458
            })
        end
    end
})

MainTab:CreateButton({
    Name = "Move to Start Position",
    Callback = function()
        local positions = findGingerbreadPositions()
        if positions[Settings.StartIndex] then
            moveToPosition(positions[Settings.StartIndex] + Vector3.new(0, 3, 0))
            Rayfield:Notify({
                Title = "Teleported",
                Content = "Moved to starting position #" .. Settings.StartIndex,
                Duration = 3,
                Image = 4483362458
            })
        end
    end
})

MainTab:CreateButton({
    Name = "Find All Positions",
    Callback = function()
        local positions = findGingerbreadPositions()
        Rayfield:Notify({
            Title = "Found Positions",
            Content = "Found " .. #positions .. " gingerbread positions",
            Duration = 5,
            Image = 4483362458
        })
    end
})

-- Teleport Tab
TeleportTab:CreateSection("Movement Settings")

TeleportTab:CreateSlider({
    Name = "Movement Delay",
    Range = {0.5, 5},
    Increment = 0.1,
    Suffix = "seconds",
    CurrentValue = Settings.MoveDelay,
    Flag = "MoveDelaySlider",
    Callback = function(Value)
        Settings.MoveDelay = Value
    end
})

TeleportTab:CreateToggle({
    Name = "Natural Movement",
    CurrentValue = Settings.NaturalMovement,
    Flag = "NaturalMovement",
    Callback = function(Value)
        Settings.NaturalMovement = Value
    end
})

TeleportTab:CreateSection("Index Settings")

TeleportTab:CreateInput({
    Name = "Start Index",
    PlaceholderText = "32",
    RemoveTextAfterFocusLost = false,
    CurrentValue = tostring(Settings.StartIndex),
    Flag = "StartIndex",
    Callback = function(Value)
        local num = tonumber(Value)
        if num then
            Settings.StartIndex = num
        end
    end
})

TeleportTab:CreateInput({
    Name = "End Index",
    PlaceholderText = "188",
    RemoveTextAfterFocusLost = false,
    CurrentValue = tostring(Settings.EndIndex),
    Flag = "EndIndex",
    Callback = function(Value)
        local num = tonumber(Value)
        if num then
            Settings.EndIndex = num
        end
    end
})

-- Settings Tab
SettingsTab:CreateSection("Preferences")

SettingsTab:CreateToggle({
    Name = "Anti-AFK",
    CurrentValue = Settings.AntiAFK,
    Flag = "AntiAFK",
    Callback = function(Value)
        Settings.AntiAFK = Value
    end
})

SettingsTab:CreateToggle({
    Name = "Notifications",
    CurrentValue = Settings.Notifications,
    Flag = "Notifications",
    Callback = function(Value)
        Settings.Notifications = Value
    end
})

SettingsTab:CreateButton({
    Name = "Save Settings",
    Callback = function()
        Rayfield:Notify({
            Title = "Settings Saved",
            Content = "Your settings have been saved!",
            Duration = 3,
            Image = 4483362458
        })
    end
})

-- Character handling
Player.CharacterAdded:Connect(function(newChar)
    Character = newChar
    HumanoidRootPart = newChar:WaitForChild("HumanoidRootPart")
    Humanoid = newChar:WaitForChild("Humanoid")
end)

-- Initial notification
Rayfield:Notify({
    Title = "Gingerbread Farm",
    Content = "UI loaded successfully! ðŸª\nWill move sequentially from #32 to #188",
    Duration = 5,
    Image = 4483362458
})

print("[Gingerbread Farm] UI Loaded Successfully!")
