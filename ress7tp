local function safeWaitForChild(parent, childName, timeout)
    local child = parent:FindFirstChild(childName)
    if child then return child end
    local startTime = tick()
    repeat
        child = parent:FindFirstChild(childName)
        if child then return child end
        task.wait(0.1)
    until tick() - startTime > (timeout or 5)
    warn("safeWaitForChild: Timeout waiting for " .. childName .. " in " .. parent:GetFullName())
    return nil
end

local function isNear(position, radius)
    local char = getChar()
    if not char or not char:FindFirstChild("HumanoidRootPart") then
        warn("isNear: Character or HumanoidRootPart not found!")
        return false
    end
    local hrp = char.HumanoidRootPart
    return (hrp.Position - position).Magnitude <= radius
end

local function safeTp(position)
    if not position then
        warn("safeTp: Position is nil!")
        return false
    end
    -- Replace with your actual teleport logic
    local success, err = pcall(function()
        -- Example: game.Players.LocalPlayer.Character:SetPrimaryPartCFrame(CFrame.new(position))
        -- Use your game's teleport method here
    end)
    if not success then
        warn("safeTp failed:", err)
        return false
    end
    return true
end

local function goToNursery()
    local player = game.Players.LocalPlayer
    for attempt = 1, 3 do
        log("Teleport attempt " .. attempt .. "/3")

        -- === 1. EXIT HOUSE ===
        pcall(function()
            local api = safeWaitForChild(ReplicatedStorage, "API", 5)
            if api then
                -- Correct path: HousingAPI.UnsubscribeFromHouse
                local housingAPI = safeWaitForChild(api, "HousingAPI", 5)
                if housingAPI then
                    local unsubscribe = housingAPI:FindFirstChild("UnsubscribeFromHouse")
                    if unsubscribe then
                        if unsubscribe:IsA("RemoteFunction") then
                            unsubscribe:InvokeServer(player, true)
                        elseif unsubscribe:IsA("RemoteEvent") then
                            unsubscribe:FireServer(player, true)
                        end
                    else
                        warn("UnsubscribeFromHouse not found in HousingAPI!")
                    end
                end
            end
        end)
        task.wait(3 + math.random() * 2) -- Jitter: 3-5s

        -- === 2. TELEPORT TO MIDPOINT ===
        local MIDPOINT = Vector3.new(-3023.66, 6529.58, -8975.54)
        if safeTp(MIDPOINT) and isNear(MIDPOINT, 10) then
            setCam(
                MIDPOINT + Vector3.new(0, 7, 0),
                MIDPOINT + Vector3.new(0, 0, -100)
            )
            pressW()
            task.wait(10)
        else
            log("âš ï¸ TP1 failed, retrying...")
            task.wait(2)
            continue
        end

        -- === 3. CHECK IF NEAR ENTRANCE ===
        local ENTRANCE = Vector3.new(-255.10, 30.89, -1831.46)
        if not isNear(ENTRANCE, 50) then
            log("â° Entrance not reached, retrying...")
            task.wait(2)
            continue
        end

        -- === 4. TELEPORT TO DOORWAY ===
        local DOORWAY = Vector3.new(-247.17, 31.50, -1481.08)
        if safeTp(DOORWAY) and isNear(DOORWAY, 10) then
            setCam(
                DOORWAY + Vector3.new(0, 8, 0),
                DOORWAY + Vector3.new(0, 0, -100)
            )
            pressW()
            task.wait(10)
        else
            log("âš ï¸ TP2 failed, retrying...")
            task.wait(2)
            continue
        end

        -- === 5. VERIFY PET RECYCLER ROOM ===
        local RECYCLER = Vector3.new(8975.76, 6933.83, 11953.16)
        if isNear(RECYCLER, 100) then
            resetCam()
            log("ðŸŽ‰ In Nursery! Starting release process...")
            return true
        else
            log("âŒ Not in Nursery, retrying...")
            resetCam()
            task.wait(2)
        end
    end

    log("ðŸ’¥ Failed to reach Nursery after 3 attempts.")
    resetCam()
    return false
end
