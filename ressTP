local function executePetRelease(allowedPets, neonPets, megaNeonPets)
    log("ðŸ”¹ Starting PET release process...")

    -- Form the list of pet unique IDs for release
    local petIds = {}
    local usedNeons = 0
    local usedMegaNeons = 0

    -- Priority 1: Add mega neon pets (ANY type, any age)
    for i, megaNeon in ipairs(megaNeonPets) do
        if i <= 1 then
            table.insert(petIds, megaNeon.uniqueId)
            usedMegaNeons = usedMegaNeons + 1
            log("ðŸš€ Adding MEGA NEON: " .. (megaNeon.id or "Unknown"))
        end
    end

    -- Priority 2: Add neon pets (ANY type, up to 2, age 6+)
    for i, neon in ipairs(neonPets) do
        if i <= 2 and usedMegaNeons < 1 then
            table.insert(petIds, neon.uniqueId)
            usedNeons = usedNeons + 1
            log("ðŸš€ Adding Neon: " .. (neon.id or "Unknown") .. " (Age: " .. (neon.age or 0) .. ")")
        end
    end

    -- Priority 3: Add ONLY allowed pets (strict filter)
    local slotsRemaining = 18 - usedNeons - usedMegaNeons
    for i = 1, math.min(slotsRemaining, #allowedPets) do
        table.insert(petIds, allowedPets[i])
    end

    log("ðŸŽ¯ Release Strategy: " ..
        usedMegaNeons .. " mega neons + " ..
        usedNeons .. " neons (any type, age 6+) + " ..
        (#petIds - usedNeons - usedMegaNeons) ..
        " allowed pets = " ..
        #petIds .. " total pets")

    if #petIds < 1 then
        log("âŒ No pets selected for release")
        return false
    end

    -- Create uniques table for API
    local uniques = {}
    for _, petId in ipairs(petIds) do
        uniques[petId] = true
    end

    -- STEP 1: Visit Pet Releaser (Achievement)
    log("ðŸ”¹ Step 1: Visiting Pet Releaser...")
    local visitArgs = {"visit_the_pet_releaser"}
    local success, err = pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("AchievementsAPI/CompleteAchievement"):FireServer(unpack(visitArgs))
    end)
    if not success then
        log("âš ï¸ Failed to visit Pet Releaser: " .. tostring(err) .. " - Continuing...")
    else
        log("âœ… Visited Pet Releaser")
    end
    task.wait(1)

    -- STEP 2: Open Backpack (Achievement)
    log("ðŸ”¹ Step 2: Opening Backpack...")
    local openBackpackArgs = {"open_backpack"}
    success, err = pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("AchievementsAPI/CompleteAchievement"):FireServer(unpack(openBackpackArgs))
    end)
    if not success then
        log("âš ï¸ Failed to open backpack: " .. tostring(err) .. " - Continuing...")
    else
        log("âœ… Opened Backpack")
    end
    task.wait(1)

    -- STEP 3: Release Pets (MAIN ACTION)
    -- Try all slots from f-0 to f-99
    local releaseSuccess = false
    for slot = 0, 99 do
        local slotName = string.format("f-%d", slot)
        local releaseArgs = {
            slotName,
            "UseBlock",
            {
                action = "use",
                uniques = uniques
            },
            player.Character
        }
        success, err = pcall(function()
            return ReplicatedStorage:WaitForChild("API"):WaitForChild("HousingAPI/ActivateInteriorFurniture"):InvokeServer(unpack(releaseArgs))
        end)
        if success then
            log("âœ… Released pets in slot: " .. slotName)
            releaseSuccess = true
            break
        else
            log("âŒ Failed to release in slot " .. slotName .. ": " .. tostring(err))
        end
        task.wait(0.5) -- Small delay between attempts
    end

    if not releaseSuccess then
        log("âŒ All release attempts failed")
        return false
    end

    -- STEP 4: Collect Tickets
    log("ðŸŽŸï¸ Collecting tickets...")
    local ticketSuccess, ticketErr = pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("PetRecyclerAPI/TicketsCollected"):InvokeServer()
    end)
    if ticketSuccess then
        log("âœ… Tickets collected!")
    else
        log("âŒ Failed to collect tickets: " .. tostring(ticketErr))
    end

    return true
end
