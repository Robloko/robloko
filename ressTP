-- üîç ALLOWED PETS FOR RELEASE
local ALLOWED_PET_NAMES = {
    "basic_egg_2022_camel",
    "basic_egg_2022_poodle",
    "basic_egg_2022_donkey",
    "basic_egg_2022_zebra",
    "basic_egg_2022_orangutan",
    "basic_egg_2022_parakeet",
    "basic_egg_2022_swordfish",
    "basic_egg_2022_robot",
    "basic_egg_2022_corgi"
}

-- üîç FIND PET RECYCLER (WITH SLOT DETECTION)
local function findPetRecycler()
    print("[DEBUG] –ü–æ–∏—Å–∫ PetRecycler...")
    local Workspace = game:GetService("Workspace")
    local HouseInteriors = Workspace:FindFirstChild("HouseInteriors")

    if not HouseInteriors then
        warn("[ERROR] HouseInteriors –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return nil
    end

    -- –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ PetRecycler
    local function search(folder)
        for _, child in ipairs(folder:GetChildren()) do
            if child.Name == "PetRecycler" then
                print("[DEBUG] –ù–∞–π–¥–µ–Ω PetRecycler:", child:GetFullName())
                local slotName = child.Parent and child.Parent.Name or "Unknown"
                if slotName:match("^f%-%d+$") then
                    print("[DEBUG] –°–ª–æ—Ç:", slotName)
                    return child, slotName, child:GetFullName()
                else
                    warn("[WARNING] PetRecycler –Ω–∞–π–¥–µ–Ω, –Ω–æ —Å–ª–æ—Ç –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω!")
                end
            end
            if child:IsA("Folder") or child:IsA("Model") then
                local found, slot, path = search(child)
                if found then
                    return found, slot, path
                end
            end
        end
        return nil
    end

    -- –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ —Å HouseInteriors
    local petRecycler, slotName, fullPath = search(HouseInteriors)
    if not petRecycler then
        warn("[ERROR] PetRecycler –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    end
    return petRecycler, slotName, fullPath
end

-- üîç GET PLAYER PETS FROM INVENTORY (FILTERED BY ALLOWED_PET_NAMES)
local function getAllowedPlayerPets()
    print("[DEBUG] –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∏—Ç–æ–º—Ü–µ–≤ –∏–≥—Ä–æ–∫–∞...")
    local Players = game:GetService("Players")
    local player = Players.LocalPlayer
    local clientData
    local allowedPets = {}

    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º ClientData
    local core = game:GetService("ReplicatedStorage"):FindFirstChild("ClientModules")
    if not core then
        warn("[ERROR] ClientModules –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return allowedPets
    end

    core = core:FindFirstChild("Core")
    if not core then
        warn("[ERROR] Core –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ ClientModules!")
        return allowedPets
    end

    local clientDataModule = core:FindFirstChild("ClientData")
    if not clientDataModule then
        warn("[ERROR] ClientData –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Core!")
        return allowedPets
    end

    -- –ó–∞–≥—Ä—É–∂–∞–µ–º ClientData
    local success, err = pcall(function()
        clientData = require(clientDataModule)
    end)

    if not success then
        warn("[ERROR] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ClientData: " .. tostring(err))
        return allowedPets
    end

    -- –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞
    local playerData = clientData.get_data()[player.Name]
    if not playerData then
        warn("[ERROR] –î–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!")
        return allowedPets
    end

    if not playerData.inventory or not playerData.inventory.pets then
        warn("[ERROR] –£ –∏–≥—Ä–æ–∫–∞ –Ω–µ—Ç –ø–∏—Ç–æ–º—Ü–µ–≤!")
        return allowedPets
    end

    -- –§–∏–ª—å—Ç—Ä—É–µ–º –ø–∏—Ç–æ–º—Ü–µ–≤ –ø–æ ALLOWED_PET_NAMES
    for uniqueId, petData in pairs(playerData.inventory.pets) do
        if type(petData) == "table" then
            for _, allowedName in ipairs(ALLOWED_PET_NAMES) do
                if petData.id == allowedName then
                    petData.uniqueId = uniqueId
                    table.insert(allowedPets, petData)
                    print("[DEBUG] –ù–∞–π–¥–µ–Ω —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–π –ø–∏—Ç–æ–º–µ—Ü:", petData.id)
                    break
                end
            end
        end
    end

    print("[DEBUG] –ù–∞–π–¥–µ–Ω–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–∏—Ç–æ–º—Ü–µ–≤:", #allowedPets)
    return allowedPets
end

-- üé´ RELEASE PETS IN PET RECYCLER
local function releasePets(petRecycler, slotName, petsToRelease)
    if not petRecycler or not slotName then
        warn("[ERROR] PetRecycler –∏–ª–∏ —Å–ª–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return false
    end

    print("[DEBUG] –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ä–µ–ª–∏–∑—É –ø–∏—Ç–æ–º—Ü–µ–≤...")
    -- –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ uniqueId –ø–∏—Ç–æ–º—Ü–µ–≤ –¥–ª—è —Ä–µ–ª–∏–∑–∞
    local uniques = {}
    for _, pet in ipairs(petsToRelease) do
        uniques[pet.uniqueId] = true
        print("[DEBUG] –î–æ–±–∞–≤–ª—è–µ–º –ø–∏—Ç–æ–º—Ü–∞ –¥–ª—è —Ä–µ–ª–∏–∑–∞:", pet.uniqueId)
    end

    -- –ü—Ä–æ–≤–µ—Ä—è–µ–º API
    local API = game:GetService("ReplicatedStorage"):FindFirstChild("API")
    if not API then
        warn("[ERROR] API –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return false
    end

    local housingAPI = API:FindFirstChild("HousingAPI/ActivateInteriorFurniture")
    if not housingAPI then
        warn("[ERROR] HousingAPI/ActivateInteriorFurniture –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return false
    end

    -- –í—ã–∑—ã–≤–∞–µ–º —Ä–µ–ª–∏–∑ —á–µ—Ä–µ–∑ API
    local success, err = pcall(function()
        return housingAPI:InvokeServer(
            slotName,
            "UseBlock",
            {
                action = "use",
                uniques = uniques
            },
            game.Players.LocalPlayer.Character
        )
    end)

    if not success then
        warn("[ERROR] –û—à–∏–±–∫–∞ —Ä–µ–ª–∏–∑–∞ –ø–∏—Ç–æ–º—Ü–µ–≤: " .. tostring(err))
        return false
    end

    print("[DEBUG] –ü–∏—Ç–æ–º—Ü—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Ä–µ–ª–∏–∑!")
    return true
end

-- üéüÔ∏è COLLECT TICKETS AFTER RELEASE
local function collectTickets()
    print("[DEBUG] –°–±–æ—Ä –±–∏–ª–µ—Ç–æ–≤...")
    local API = game:GetService("ReplicatedStorage"):FindFirstChild("API")
    if not API then
        warn("[ERROR] API –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return false
    end

    local ticketsAPI = API:FindFirstChild("PetRecyclerAPI/TicketsCollected")
    if not ticketsAPI then
        warn("[ERROR] PetRecyclerAPI/TicketsCollected –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return false
    end

    local success, err = pcall(function()
        return ticketsAPI:InvokeServer()
    end)

    if not success then
        warn("[ERROR] –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ –±–∏–ª–µ—Ç–æ–≤: " .. tostring(err))
        return false
    end

    print("[DEBUG] –ë–∏–ª–µ—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã!")
    return true
end

-- üîÑ MAIN EXECUTION
print("[START] –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ PetRecycler...")
local petRecycler, slotName, fullPath = findPetRecycler()
if petRecycler then
    print("[SUCCESS] PetRecycler –Ω–∞–π–¥–µ–Ω!")
    print("–°–ª–æ—Ç:", slotName)
    print("–ü–æ–ª–Ω—ã–π –ø—É—Ç—å:", fullPath)

    -- –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–∏—Ç–æ–º—Ü–µ–≤ –∏–≥—Ä–æ–∫–∞
    local allowedPets = getAllowedPlayerPets()
    if #allowedPets > 0 then
        print("[SUCCESS] –ù–∞–π–¥–µ–Ω–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–∏—Ç–æ–º—Ü–µ–≤:", #allowedPets)

        -- –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–µ–ª–∏–∑
        local releaseSuccess = releasePets(petRecycler, slotName, allowedPets)
        if releaseSuccess then
            -- –°–æ–±–∏—Ä–∞–µ–º –±–∏–ª–µ—Ç—ã
            local collectSuccess = collectTickets()
            if collectSuccess then
                print("[SUCCESS] –ë–∏–ª–µ—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã!")
            else
                warn("[ERROR] –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –±–∏–ª–µ—Ç—ã!")
            end
        else
            warn("[ERROR] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Ç–æ–º—Ü–µ–≤ –Ω–∞ —Ä–µ–ª–∏–∑!")
        end
    else
        warn("[ERROR] –£ –∏–≥—Ä–æ–∫–∞ –Ω–µ—Ç —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–∏—Ç–æ–º—Ü–µ–≤ –¥–ª—è —Ä–µ–ª–∏–∑–∞!")
    end
else
    warn("[ERROR] PetRecycler –Ω–µ –Ω–∞–π–¥–µ–Ω!")
end
