-- üîç ALLOWED PETS FOR RELEASE
local ALLOWED_PET_NAMES = {
    "basic_egg_2022_camel",
    "basic_egg_2022_poodle",
    "basic_egg_2022_donkey",
    "basic_egg_2022_zebra",
    "basic_egg_2022_orangutan",
    "basic_egg_2022_parakeet",
    "basic_egg_2022_swordfish",
    "basic_egg_2022_robot",
    "basic_egg_2022_corgi"
}

-- üîç FIND PET RECYCLER (WITH SLOT DETECTION)
local function findPetRecycler()
    local Workspace = game:GetService("Workspace")
    local HouseInteriors = Workspace:FindFirstChild("HouseInteriors")

    if not HouseInteriors then
        warn("HouseInteriors –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return nil
    end

    -- –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫ PetRecycler
    local function search(folder)
        for _, child in ipairs(folder:GetChildren()) do
            if child.Name == "PetRecycler" then
                -- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É PetRecycler —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —Å–ª–æ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, f-0, f-1, ...)
                local slotName = child.Parent and child.Parent.Name or "Unknown"
                if slotName:match("^f%-%d+$") then
                    return child, slotName, child:GetFullName()
                end
            end
            if child:IsA("Folder") or child:IsA("Model") then
                local found, slot, path = search(child)
                if found then
                    return found, slot, path
                end
            end
        end
        return nil
    end

    -- –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ —Å HouseInteriors
    local petRecycler, slotName, fullPath = search(HouseInteriors)
    return petRecycler, slotName, fullPath
end

-- üîç GET PLAYER PETS FROM INVENTORY (FILTERED BY ALLOWED_PET_NAMES)
local function getAllowedPlayerPets()
    local Players = game:GetService("Players")
    local player = Players.LocalPlayer
    local clientData
    local allowedPets = {}

    -- –ü–æ–ª—É—á–∞–µ–º ClientData
    local success, err = pcall(function()
        local core = game:GetService("ReplicatedStorage"):WaitForChild("ClientModules"):WaitForChild("Core")
        clientData = require(core:WaitForChild("ClientData"))
    end)

    if not success then
        warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ClientData: " .. tostring(err))
        return allowedPets
    end

    -- –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä–æ–∫–∞
    local playerData = clientData.get_data()[player.Name]
    if not playerData or not playerData.inventory or not playerData.inventory.pets then
        warn("–£ –∏–≥—Ä–æ–∫–∞ –Ω–µ—Ç –ø–∏—Ç–æ–º—Ü–µ–≤!")
        return allowedPets
    end

    -- –§–∏–ª—å—Ç—Ä—É–µ–º –ø–∏—Ç–æ–º—Ü–µ–≤ –ø–æ ALLOWED_PET_NAMES
    for uniqueId, petData in pairs(playerData.inventory.pets) do
        if type(petData) == "table" then
            for _, allowedName in ipairs(ALLOWED_PET_NAMES) do
                if petData.id == allowedName then
                    petData.uniqueId = uniqueId
                    table.insert(allowedPets, petData)
                    break
                end
            end
        end
    end

    return allowedPets
end

-- üé´ RELEASE PETS IN PET RECYCLER
local function releasePets(petRecycler, slotName, petsToRelease)
    if not petRecycler or not slotName then
        warn("PetRecycler –∏–ª–∏ —Å–ª–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return false
    end

    -- –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ uniqueId –ø–∏—Ç–æ–º—Ü–µ–≤ –¥–ª—è —Ä–µ–ª–∏–∑–∞
    local uniques = {}
    for _, pet in ipairs(petsToRelease) do
        uniques[pet.uniqueId] = true
    end

    -- –í—ã–∑—ã–≤–∞–µ–º —Ä–µ–ª–∏–∑ —á–µ—Ä–µ–∑ API
    local success, err = pcall(function()
        return game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("HousingAPI/ActivateInteriorFurniture"):InvokeServer(
            slotName,
            "UseBlock",
            {
                action = "use",
                uniques = uniques
            },
            game.Players.LocalPlayer.Character
        )
    end)

    if not success then
        warn("–û—à–∏–±–∫–∞ —Ä–µ–ª–∏–∑–∞ –ø–∏—Ç–æ–º—Ü–µ–≤: " .. tostring(err))
        return false
    end

    return true
end

-- üéüÔ∏è COLLECT TICKETS AFTER RELEASE
local function collectTickets()
    local success, err = pcall(function()
        return game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("PetRecyclerAPI/TicketsCollected"):InvokeServer()
    end)

    if not success then
        warn("–û—à–∏–±–∫–∞ —Å–±–æ—Ä–∞ –±–∏–ª–µ—Ç–æ–≤: " .. tostring(err))
        return false
    end

    return true
end

-- üîÑ MAIN EXECUTION
local petRecycler, slotName, fullPath = findPetRecycler()
if petRecycler then
    print("PetRecycler –Ω–∞–π–¥–µ–Ω!")
    print("–°–ª–æ—Ç:", slotName)
    print("–ü–æ–ª–Ω—ã–π –ø—É—Ç—å:", fullPath)

    -- –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–∏—Ç–æ–º—Ü–µ–≤ –∏–≥—Ä–æ–∫–∞
    local allowedPets = getAllowedPlayerPets()
    print("–ù–∞–π–¥–µ–Ω–æ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–∏—Ç–æ–º—Ü–µ–≤:", #allowedPets)

    if #allowedPets > 0 then
        -- –í—ã–±–∏—Ä–∞–µ–º –≤—Å–µ—Ö —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–∏—Ç–æ–º—Ü–µ–≤ –¥–ª—è —Ä–µ–ª–∏–∑–∞
        local petsToRelease = allowedPets

        -- –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–µ–ª–∏–∑
        local releaseSuccess = releasePets(petRecycler, slotName, petsToRelease)
        if releaseSuccess then
            print("–ü–∏—Ç–æ–º—Ü—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Ä–µ–ª–∏–∑!")

            -- –°–æ–±–∏—Ä–∞–µ–º –±–∏–ª–µ—Ç—ã
            local collectSuccess = collectTickets()
            if collectSuccess then
                print("–ë–∏–ª–µ—Ç—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω—ã!")
            else
                warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –±–∏–ª–µ—Ç—ã!")
            end
        else
            warn("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Ç–æ–º—Ü–µ–≤ –Ω–∞ —Ä–µ–ª–∏–∑!")
        end
    else
        warn("–£ –∏–≥—Ä–æ–∫–∞ –Ω–µ—Ç —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö –ø–∏—Ç–æ–º—Ü–µ–≤ –¥–ª—è —Ä–µ–ª–∏–∑–∞!")
    end
else
    warn("PetRecycler –Ω–µ –Ω–∞–π–¥–µ–Ω!")
end
