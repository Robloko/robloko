-- Baby Farm Script
-- Place this as a LocalScript in StarterPlayerScripts or similar
-- This script monitors and handles baby ailments using simplified furniture detection

-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

-- Player
local player = Players.LocalPlayer

-- Debug settings
local DEBUG_MODE = true

-- Baby Farm variables
local BabyFarmMode = false
local babyFarmCoroutine = nil

-- Ailment to Furniture Mapping
local BABY_AILMENT_TASKS = {
    sleepy = "BasicBed",
    hungry = "teachers_apple", 
    thirsty = "water",
    dirty = "CheapPetBathtub",
    bored = "Piano",
    sick = "healing_apple"
}

-- Task cooldowns to prevent spam
local lastTaskTime = {}
local TASK_COOLDOWN = 30 -- seconds

-- Debug function
local function debugPrint(message)
    if not DEBUG_MODE then return end
    local hours = os.date("%H")
    local minutes = os.date("%M")
    local seconds = os.date("%S")
    local timestamp = string.format("[%s:%s:%s]", hours, minutes, seconds)
    print(timestamp .. " [BabyFarm] " .. message)
end

-- Function to safely get player data
local function getPlayerData()
    local clientModules = ReplicatedStorage:WaitForChild("ClientModules", 10)
    if not clientModules then return nil end
    local coreModule = clientModules:WaitForChild("Core", 5)
    if not coreModule then return nil end
    local clientDataModule = coreModule:WaitForChild("ClientData", 5)
    if not clientDataModule then return nil end
    
    local clientData
    local success, err = pcall(function()
        clientData = require(clientDataModule)
    end)
    if not success or not clientData then return nil end
    
    local playerData
    success, err = pcall(function()
        playerData = clientData.get_data()[player.Name]
    end)
    if not success or not playerData then return nil end
    
    return playerData
end

-- Enhanced helper to extract ailment key from potentially table-structured ailment
local function extractAilmentKey(ailment)
    if type(ailment) == "table" then
        -- Try common fields first
        local candidates = {"type", "name", "ailment", "id", "key", "kind"}
        for _, field in ipairs(candidates) do
            local val = ailment[field]
            if type(val) == "string" then
                local lowerVal = val:lower()
                if BABY_AILMENT_TASKS[lowerVal] then
                    debugPrint("Extracted ailment '" .. lowerVal .. "' from field '" .. field .. "'")
                    return lowerVal
                end
            end
        end
        -- If no direct match, search all string values for known ailments
        for k, v in pairs(ailment) do
            if type(v) == "string" then
                local lowerV = v:lower()
                if BABY_AILMENT_TASKS[lowerV] then
                    debugPrint("Found matching ailment string '" .. lowerV .. "' in table key '" .. tostring(k) .. "'")
                    return lowerV
                end
            elseif type(v) == "table" then
                -- Recurse into sub-tables if needed
                local subKey = extractAilmentKey(v)
                if subKey ~= "unknown" then
                    return subKey
                end
            end
        end
        -- If still unknown, debug the structure
        debugPrint("Unknown ailment table structure for debugging:")
        for k, v in pairs(ailment) do
            debugPrint(" Key: " .. tostring(k) .. " = " .. tostring(v) .. " (type: " .. type(v) .. ")")
        end
        return "unknown"
    else
        local str = tostring(ailment):lower()
        if BABY_AILMENT_TASKS[str] then
            return str
        end
        return str
    end
end

-- Function to print available baby ailments in compact form
local function printAvailableBabyAilmentsCompact()
    debugPrint("üîç BABY AILMENTS (COMPACT)")
    debugPrint("=========================")
    local playerData = getPlayerData()
    if not playerData or not playerData.ailments_manager or not playerData.ailments_manager.baby_ailments then
        debugPrint("No baby ailments found.")
        return
    end
    
    local babyAilments = playerData.ailments_manager.baby_ailments
    local count = 0
    local actionableCount = 0
    
    debugPrint(string.format("%-5s %-36s %-15s %-10s", "No.", "Pet Unique ID", "Ailment", "Actionable"))
    debugPrint(string.rep("-", 70))
    
    for petUniqueID, ailment in pairs(babyAilments) do
        local ailmentKey = extractAilmentKey(ailment)
        local isActionable = BABY_AILMENT_TASKS[ailmentKey] and ailmentKey ~= "unknown"
        if isActionable then actionableCount = actionableCount + 1 end
        count = count + 1
        local status = isActionable and "YES" or "NO"
        debugPrint(string.format("%-5d %-36s %-15s %-10s", count, petUniqueID:sub(1, 36), ailmentKey, status))
    end
    
    debugPrint(string.rep("-", 70))
    debugPrint(string.format("Total baby ailments: %d (Actionable: %d)", count, actionableCount))
end

-- Character validation
local function getValidCharacter()
    local currentChar = player.Character
    if currentChar and currentChar.Parent and currentChar:FindFirstChild("HumanoidRootPart") then
        return currentChar
    end
    debugPrint("Character not found or invalid, waiting for CharacterAdded...")
    local character = player.CharacterAdded:Wait()
    local startTime = os.time()
    while os.time() - startTime < 10 do
        if character and character.Parent and character:FindFirstChild("HumanoidRootPart") then
            debugPrint("Character loaded successfully")
            return character
        end
        task.wait(0.5)
    end
    debugPrint("Failed to load valid character after waiting")
    return nil
end

-- Ensure character is spawned and valid
local function ensureCharacterSpawned()
    local char = getValidCharacter()
    if not char then
        debugPrint("Respawning character...")
        pcall(function()
            ReplicatedStorage:WaitForChild("API"):WaitForChild("TeamAPI/Spawn"):InvokeServer()
        end)
        task.wait(5)
        char = getValidCharacter()
    end
    return char
end

-- Select Baby team
local function selectBabyTeam()
    debugPrint("Selecting Baby team...")
    local args = {
        "Babies",
        {
            dont_respawn = true,
            source_for_logging = "avatar_editor"
        }
    }
    local success, result = pcall(function()
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("TeamAPI/ChooseTeam"):InvokeServer(unpack(args))
    end)
    if success then
        debugPrint("Successfully selected Baby team")
        return true
    else
        debugPrint("Failed to select Baby team: " .. tostring(result))
        return false
    end
end

-- Check if player is at home
local function isPlayerAtHome()
    local hi = Workspace:FindFirstChild("HouseInteriors")
    if not hi then
        return false
    end
    local playerLower = string.lower(player.Name)
    for _, folder in ipairs(hi:GetChildren()) do
        local folderLower = string.lower(folder.Name)
        if string.find(folderLower, playerLower) then
            debugPrint("DEBUG: Found home folder matching player name: " .. folder.Name .. " (contains '" .. playerLower .. "')")
            return true
        end
    end
    debugPrint("DEBUG: No home folder found for player '" .. player.Name .. "' (" .. playerLower .. "). Available folders:")
    for _, folder in ipairs(hi:GetChildren()) do
        debugPrint("DEBUG: Available folder: '" .. folder.Name .. "'")
    end
    return false
end

-- ==================================================================
-- FIXED FURNITURE DETECTION & ACTIVATION (FOLLOWING PETFARM PATTERN)
-- ==================================================================

-- Extract furniture data (following PetFarm pattern)
local function extractFurnitureData(model, folderName)
    local activationParts = {"UseBlock", "Seat1"}
    local folderId = string.match(folderName, "f%-%d+") or folderName
    
    for _, partName in ipairs(activationParts) do
        local useBlocksFolder = model:FindFirstChild("UseBlocks")
        if useBlocksFolder then
            local part = useBlocksFolder:FindFirstChild(partName)
            if part and part:IsA("BasePart") then
                debugPrint("Using " .. partName .. " in UseBlocks folder")
                return {
                    folderId = folderId,
                    partName = partName,
                    position = part.Position,
                    cframe = part.CFrame,
                    model = model
                }
            end
        end
        
        local part = model:FindFirstChild(partName)
        if part and part:IsA("BasePart") then
            debugPrint("Using " .. partName .. " directly in model")
            return {
                folderId = folderId,
                partName = partName,
                position = part.Position,
                cframe = part.CFrame,
                model = model
            }
        end
    end
    
    -- Fallback: use any BasePart
    for _, part in ipairs(model:GetDescendants()) do
        if part:IsA("BasePart") then
            debugPrint("Using fallback part: " .. part.Name)
            return {
                folderId = folderId,
                partName = part.Name,
                position = part.Position,
                cframe = part.CFrame,
                model = model
            }
        end
    end
    
    return nil
end

-- Find furniture by name (following PetFarm pattern)
local function findFurnitureByName(name)
    debugPrint("Searching for furniture: " .. name)
    
    local hi = Workspace:FindFirstChild("HouseInteriors")
    if hi then
        for _, folder in ipairs(hi:GetChildren()) do
            if string.find(folder.Name, player.Name) or string.find(folder.Name, "f%-%d+") then
                local model = folder:FindFirstChild(name)
                if model and model:IsA("Model") then
                    debugPrint("Found " .. name .. " in " .. folder.Name)
                    return extractFurnitureData(model, folder.Name)
                end
            end
        end
    end
    
    -- Fallback: Direct search in workspace
    local model = Workspace:FindFirstChild(name, true)
    if model and model:IsA("Model") then
        debugPrint("Found " .. name .. " in workspace (fallback)")
        local folderId = model.Parent and string.match(model.Parent.Name, "f%-%d+") or "unknown"
        return extractFurnitureData(model, folderId)
    end
    
    debugPrint("Furniture not found: " .. name)
    return nil
end

-- Fixed furniture activation using PetFarm pattern
local function useFurnitureWithLocalPlayer(furnitureName)
    local char = ensureCharacterSpawned()
    if not char then
        debugPrint("Cannot use furniture: No valid character")
        return false
    end
    
    debugPrint("Using furniture for baby: " .. furnitureName .. " on localPlayer")
    
    local furnitureData = findFurnitureByName(furnitureName)
    if not furnitureData then
        debugPrint("Furniture not found: " .. furnitureName)
        return false
    end
    
    -- Call ExitSeatStates before use (like PetFarm)
    pcall(function()
        game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("AdoptAPI/ExitSeatStates"):FireServer()
    end)
    task.wait(1)
    
    -- **FIXED: Use the same API structure as PetFarm**
    local args = {
        player,  -- player object first
        furnitureData.folderId,  -- folder ID
        furnitureData.partName,  -- part name
        {
            cframe = furnitureData.cframe
        },
        char  -- character object last (like pet in PetFarm)
    }
    
    debugPrint("Activating " .. furnitureName .. " in folder " .. furnitureData.folderId .. " with part " .. furnitureData.partName)
    
    local success, result = pcall(function()
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("HousingAPI/ActivateFurniture"):InvokeServer(unpack(args))
    end)
    
    if success then
        debugPrint("Successfully activated: " .. furnitureName)
        
        -- Wait for character to start using furniture
        local startTime = os.time()
        local usingFurniture = false
        
        while os.time() - startTime < 10 do
            local humanoid = char:FindFirstChild("Humanoid")
            if humanoid and humanoid.Sit then
                usingFurniture = true
                debugPrint("Character is now using the furniture (sitting)")
                break
            end
            task.wait(1)
        end
        
        if usingFurniture then
            debugPrint("Waiting for ailment cure...")
            task.wait(20) -- Wait for ailment cure
        else
            debugPrint("Character did not start using furniture, but activation was successful")
            task.wait(10) -- Shorter wait if not using
        end
        
        -- Call ExitSeatStates after use
        pcall(function()
            game:GetService("ReplicatedStorage"):WaitForChild("API"):WaitForChild("AdoptAPI/ExitSeatStates"):FireServer()
        end)
        task.wait(2)
        return true
    else
        debugPrint("Failed to activate: " .. furnitureName .. " - " .. tostring(result))
        return false
    end
end

-- Check and buy missing furniture (simplified)
local function checkAndBuyMissingFurniture()
    debugPrint("Checking for missing furniture...")
    local missingFurniture = {}
    
    -- Check for Piano
    local pianoFound = findFurnitureByName("Piano")
    if not pianoFound then
        debugPrint("Piano not found, adding to buy list")
        table.insert(missingFurniture, {
            kind = "piano",
            properties = {
                cframe = CFrame.new(14, 0, -16.399999618530273, 1, 0, 0, 0, 1, 0, 0, 0, 1)
            }
        })
    else
        debugPrint("Piano found in house")
    end
    
    -- Check for BasicBed
    local basicBedFound = findFurnitureByName("BasicBed")
    if not basicBedFound then
        debugPrint("BasicBed not found, adding to buy list")
        table.insert(missingFurniture, {
            kind = "basic_bed",
            properties = {
                cframe = CFrame.new(10, 0, -10, 1, 0, 0, 0, 1, 0, 0, 0, 1)
            }
        })
    else
        debugPrint("BasicBed found in house")
    end
    
    -- Check for CheapPetBathtub
    local bathtubFound = findFurnitureByName("CheapPetBathtub")
    if not bathtubFound then
        debugPrint("CheapPetBathtub not found, adding to buy list")
        table.insert(missingFurniture, {
            kind = "cheap_pet_bathtub",
            properties = {
                cframe = CFrame.new(12, 0, -10, 1, 0, 0, 0, 1, 0, 0, 0, 1)
            }
        })
    else
        debugPrint("CheapPetBathtub found in house")
    end
    
    -- Buy missing furniture
    if #missingFurniture > 0 then
        debugPrint("Buying " .. #missingFurniture .. " missing furniture items...")
        local args = {missingFurniture}
        local success, result = pcall(function()
            return ReplicatedStorage:WaitForChild("API"):WaitForChild("HousingAPI/BuyFurnitures"):InvokeServer(unpack(args))
        end)
        if success then
            debugPrint("Successfully purchased missing furniture")
            task.wait(3)
        else
            debugPrint("Failed to buy furniture: " .. tostring(result))
        end
    else
        debugPrint("All furniture found, no purchases needed")
    end
end

-- ==================================================================
-- FOOD ITEM HANDLERS (UNCHANGED)
-- ==================================================================

-- [Keep all your existing food handlers exactly as they are]
-- buyTeachersApple, findTeachersApple, useTeachersApple, handleHungryAilment
-- buyWater, findWater, useWater, handleThirstyAilment  
-- buyHealingApple, findHealingApple, useHealingApple, handleSickAilment

-- ==================================================================
-- MAIN MONITORING LOOP
-- ==================================================================

-- Main monitoring loop for baby ailments
local function monitorAndHandleBabyAilments()
    debugPrint("Starting baby ailment monitoring...")
    local lastScanTime = 0
    local SCAN_INTERVAL = 10 -- seconds
    local currentTime = os.time()
    
    while BabyFarmMode do
        currentTime = os.time()
        local playerData = getPlayerData()
        
        if playerData and playerData.ailments_manager and playerData.ailments_manager.baby_ailments then
            local foundActionable = false
            
            for petUniqueID, ailmentType in pairs(playerData.ailments_manager.baby_ailments) do
                local ailmentKey = extractAilmentKey(ailmentType)
                local furnitureName = BABY_AILMENT_TASKS[ailmentKey]
                
                if furnitureName then
                    foundActionable = true
                    -- Check cooldown
                    if not lastTaskTime[ailmentKey] or (currentTime - lastTaskTime[ailmentKey]) >= TASK_COOLDOWN then
                        if ailmentKey == "hungry" then
                            debugPrint("Baby hungry ailment detected for pet: " .. petUniqueID .. " ‚Üí Using teachers_apple on localPlayer")
                            local success = handleHungryAilment()
                            if success then
                                lastTaskTime[ailmentKey] = currentTime
                            end
                        elseif ailmentKey == "thirsty" then
                            debugPrint("Baby thirsty ailment detected for pet: " .. petUniqueID .. " ‚Üí Using water on localPlayer")
                            local success = handleThirstyAilment()
                            if success then
                                lastTaskTime[ailmentKey] = currentTime
                            end
                        elseif ailmentKey == "sick" then
                            debugPrint("Baby sick ailment detected for pet: " .. petUniqueID .. " ‚Üí Using healing_apple on localPlayer")
                            local success = handleSickAilment()
                            if success then
                                lastTaskTime[ailmentKey] = currentTime
                            end
                        else
                            debugPrint("Baby " .. ailmentKey .. " ailment detected for pet: " .. petUniqueID .. " ‚Üí Using " .. furnitureName .. " on localPlayer")
                            local success = useFurnitureWithLocalPlayer(furnitureName)
                            if success then
                                lastTaskTime[ailmentKey] = currentTime
                            end
                        end
                        break -- Handle one at a time
                    else
                        debugPrint(ailmentKey .. " on cooldown (" .. (TASK_COOLDOWN - (currentTime - lastTaskTime[ailmentKey])) .. "s remaining)")
                    end
                end
            end
            
            if not foundActionable and currentTime - lastScanTime >= 60 then
                debugPrint("No actionable baby ailments detected")
                lastScanTime = currentTime
            end
        else
            if currentTime - lastScanTime >= 60 then
                debugPrint("No baby ailments data found")
                lastScanTime = currentTime
            end
        end
        
        task.wait(SCAN_INTERVAL)
    end
end

-- Toggle Baby Farm mode
local function toggleBabyFarmMode()
    BabyFarmMode = not BabyFarmMode
    if BabyFarmMode then
        debugPrint("Baby Farm: ENABLED")
        
        -- Step 1: Select Baby team first
        selectBabyTeam()
        task.wait(2)
        
        -- Step 2: Ensure character is spawned
        local char = ensureCharacterSpawned()
        if not char then
            debugPrint("Cannot start Baby Farm: No valid character")
            BabyFarmMode = false
            return
        end
        
        -- Step 3: Ensure player is at home
        if not isPlayerAtHome() then
            debugPrint("Player not at home, respawning...")
            pcall(function()
                ReplicatedStorage:WaitForChild("API"):WaitForChild("TeamAPI/Spawn"):InvokeServer()
            end)
            task.wait(15) -- Increased wait for home to load
            -- Re-check after spawn
            if not isPlayerAtHome() then
                debugPrint("Still not at home after spawn - forcing longer wait")
                task.wait(10)
            end
        end
        
        -- Step 4: Check and buy missing furniture
        checkAndBuyMissingFurniture()
        task.wait(3)
        
        -- Step 5: Start monitoring
        babyFarmCoroutine = coroutine.wrap(monitorAndHandleBabyAilments)()
    else
        debugPrint("Baby Farm: DISABLED")
        babyFarmCoroutine = nil
    end
end

-- ==================================================================
-- SIMPLE UI
-- ==================================================================

-- Simple UI for toggle
local function createSimpleUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "BabyFarmUI"
    screenGui.Parent = player:WaitForChild("PlayerGui")
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 120, 0, 40)
    frame.Position = UDim2.new(0, 10, 0, 250) -- Below main UI
    frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    frame.BorderSizePixel = 0
    frame.Parent = screenGui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = frame
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 20)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundTransparency = 1
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Text = "üë∂ Baby Farm"
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 12
    title.Parent = frame
    
    local toggleButton = Instance.new("TextButton")
    toggleButton.Size = UDim2.new(1, 0, 0, 20)
    toggleButton.Position = UDim2.new(0, 0, 1, 0)
    toggleButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    toggleButton.Text = "üöÄ START BABY FARM"
    toggleButton.Font = Enum.Font.SourceSansBold
    toggleButton.TextSize = 10
    toggleButton.Parent = frame
    
    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 4)
    buttonCorner.Parent = toggleButton
    
    toggleButton.MouseButton1Click:Connect(function()
        toggleBabyFarmMode()
        toggleButton.Text = BabyFarmMode and "üõë STOP BABY FARM" or "üöÄ START BABY FARM"
        toggleButton.BackgroundColor3 = BabyFarmMode and Color3.fromRGB(170, 0, 0) or Color3.fromRGB(0, 170, 0)
    end)
    
    -- Initial scan
    task.wait(2)
    printAvailableBabyAilmentsCompact()
end

-- Initialize
createSimpleUI()
debugPrint("Baby Farm Script Loaded! Toggle via UI button.")
debugPrint("Scans baby_ailments and uses furniture to cure (basic ailments only).")
debugPrint("All ailments now handled on localPlayer using HousingAPI/ActivateFurniture.")
debugPrint("UPDATED: Now selects Baby team first when enabled.")
debugPrint("UPDATED: Uses FIXED furniture detection following PetFarm pattern.")
debugPrint("UPDATED: Proper seat state management with ExitSeatStates calls.")
