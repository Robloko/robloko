-- Services
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

-- Player
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Declare variables FIRST
local tameButton = nil
local mainFrame = nil
local screenGui = nil
local ClientDataModule = nil

-- Wait for game to fully load
wait(1)

-- Load ClientData Module
local success, err = pcall(function()
    ClientDataModule = require(ReplicatedStorage:WaitForChild("ClientModules"):WaitForChild("Core"):WaitForChild("ClientData"))
end)
if not success then
    warn("Failed to load ClientData module: " .. tostring(err))
    return
end

print("ClientData module loaded successfully")

-- Function to find bait ID
local function findBaitId(baitName)
    local foundId = nil
    pcall(function()
        if not ClientDataModule then
            warn("ClientDataModule not loaded!")
            return
        end
        
        local clientData = ClientDataModule.get_data()
        if not clientData then
            warn("No client data found!")
            return
        end
        
        local playerData = clientData[player.Name]
        
        if playerData and playerData.inventory and playerData.inventory.food then
            for foodId, foodData in pairs(playerData.inventory.food) do
                if (foodData.name == baitName or foodData.id == baitName) and (foodData.amount or 1) > 0 then
                    foundId = foodId
                    print("Found bait in inventory: " .. foodId)
                    break
                end
            end
        end
    end)
    return foundId
end

-- Taming Function - DEFINED AFTER all dependencies are ready
local function tamePug()
    print("tamePug function started")
    
    -- Check if button exists
    if not tameButton or not tameButton:IsA("TextButton") then
        warn("Tame button not found!")
        return
    end
    
    -- Check if API paths exist
    if not ReplicatedStorage:FindFirstChild("API") then
        warn("API folder not found in ReplicatedStorage!")
        return
    end
    
    -- Find bait ID
    local baitId = findBaitId("winter_2025_yarn_beanie_bait")
    
    if not baitId then
        game.StarterGui:SetCore("SendNotification", {
            Title = "Tame Pug";
            Text = "No winter_2025_yarn_beanie_bait found!";
            Duration = 3;
        })
        return
    end
    
    print("Starting taming sequence with ID: " .. baitId)
    
    -- Disable button
    tameButton.AutoButtonColor = false
    tameButton.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    
    -- TAMING SEQUENCE - FIXED: Now has access to everything
    local success, errorMsg = pcall(function()
        print("Step 1: Sending END command")
        local args1 = {baitId, "END"}
        ReplicatedStorage.API.ToolAPI.ServerUseTool:FireServer(unpack(args1))
        wait(9)
        
        print("Step 2: Sending START command")
        local args2 = {baitId, "START"}
        ReplicatedStorage.API.ToolAPI.ServerUseTool:FireServer(unpack(args2))
        wait(2)
        
        print("Step 3: Equipping bait")
        local args3 = {baitId, {use_sound_delay = false, equip_as_last = false}}
        ReplicatedStorage.API.ToolAPI.Equip:InvokeServer(unpack(args3))
        wait(1)
        
        print("Step 4: Progress taming")
        local args4 = {false}
        ReplicatedStorage.API.WinterEventAPI.ProgressTaming:InvokeServer(unpack(args4))
        wait(1)
        
        print("Step 5: Equipping toy")
        local toyId = findBaitId("2_cad0eace6dca44908c1a74bb32fea4f2") or "2_cad0eace6dca44908c1a74bb32fea4f2"
        local args5 = {toyId, {use_sound_delay = false, equip_as_last = false}}
        ReplicatedStorage.API.ToolAPI.Equip:InvokeServer(unpack(args5))
        
        print("Taming sequence completed!")
    end)
    
    if not success then
        warn("Error in taming sequence: " .. tostring(errorMsg))
    end
    
    -- Re-enable button
    wait(1)
    tameButton.AutoButtonColor = true
    tameButton.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    
    game.StarterGui:SetCore("SendNotification", {
        Title = "Tame Pug";
        Text = "Taming sequence completed!";
        Duration = 3;
    })
    
    print("tamePug function finished")
end

-- Create UI
local function createUI()
    print("Creating UI...")
    
    screenGui = Instance.new("ScreenGui")
    screenGui.Name = "TamePugGui"
    screenGui.ResetOnSpawn = false
    
    -- Check if PlayerGui exists
    if not playerGui then
        warn("PlayerGui not found!")
        return false
    end
    
    screenGui.Parent = playerGui

    mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 150, 0, 50)
    mainFrame.Position = UDim2.new(0, 10, 0, 10)
    mainFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = mainFrame

    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(0, 170, 0)
    stroke.Thickness = 2
    stroke.Parent = mainFrame

    tameButton = Instance.new("TextButton")
    tameButton.Name = "TameButton"
    tameButton.Size = UDim2.new(1, 0, 1, 0)
    tameButton.Position = UDim2.new(0, 0, 0, 0)
    tameButton.BackgroundTransparency = 1
    tameButton.Text = "Tame Pug"
    tameButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    tameButton.TextScaled = true
    tameButton.Font = Enum.Font.GothamBold
    tameButton.Parent = mainFrame

    -- Hover effects
    local hoverTween = TweenService:Create(mainFrame, TweenInfo.new(0.2), {Size = UDim2.new(0, 160, 0, 55)})
    local normalTween = TweenService:Create(mainFrame, TweenInfo.new(0.2), {Size = UDim2.new(0, 150, 0, 50)})

    tameButton.MouseEnter:Connect(function()
        hoverTween:Play()
    end)

    tameButton.MouseLeave:Connect(function()
        normalTween:Play()
    end)

    -- Connect button click - THIS IS CRITICAL
    tameButton.MouseButton1Click:Connect(function()
        print("Button clicked, calling tamePug...")
        tamePug()
    end)

    -- Initial color check
    if findBaitId("winter_2025_yarn_beanie_bait") then
        mainFrame.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
    else
        mainFrame.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
    end

    print("UI created successfully")
    return true
end

-- Main execution flow
print("Starting Tame Pug script...")

-- Wait a bit for game to load
wait(2)

-- Create the UI
if createUI() then
    print("Tame Pug UI loaded! Button at top-left corner.")
    print("Make sure you have the bait in your inventory!")
else
    warn("Failed to create UI!")
end

print("Script initialization complete")
