-- ==================================================================
-- COMPACT POTION RELEASER & BOX OPENER SCRIPT (MODIFIED FOR NEON PETS)
-- ==================================================================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local player = Players.LocalPlayer

-- Potion Releaser variables
local PotionReleaserMode = false
local potionReleaserCoroutine = nil
local TARGET_PETS_FOR_POTIONS = {
    "winter_2025_maine_coon",
    "basic_egg_2022_zebra",
    "winter_2025_turtle_doves",
    "winter_2025_xmas_tree_sasquatch"
}

-- Box Opener variables
local BoxOpenerMode = false
local boxOpenerCoroutine = nil
local BOX_ID = "winter_2025_angus_box"

-- Debug print function
local function debugPrint(msg, prefix)
    prefix = prefix or "PotionRelease"
    print("[" .. prefix .. "] " .. msg)
end

-- ==================================================================
-- POTION RELEASER FUNCTIONS
-- ==================================================================

-- Function to find pet age potion in inventory
local function findPetAgePotion()
    local success, result = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local playerData = clientData.get_data()[player.Name]
        if playerData and playerData.inventory and playerData.inventory.food then
            for uniqueId, itemData in pairs(playerData.inventory.food) do
                if itemData.id == "pet_age_potion" then
                    return uniqueId
                end
            end
        end
    end)
    return success and result or nil
end

-- Function to safely unequip items
local function safelyUnequipFood(itemId)
    pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("ToolAPI/Unequip"):InvokeServer(itemId)
    end)
end

-- Function to equip a specific pet
local function equipPet(petUniqueID)
    if not petUniqueID then
        return false
    end
    local args = {
        petUniqueID,
        {
            use_sound_delay = true,
            equip_as_last = false
        }
    }
    local success = pcall(function()
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("ToolAPI/Equip"):InvokeServer(unpack(args))
    end)
    return success
end

-- Function to find pets that need potions (age < 6 and in target list, including neon pets)
local function findPetsNeedingPotions()
    local petsNeedingPotions = {}

    local success, errorMsg = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local playerData = clientData.get_data()[player.Name]
        if playerData and playerData.inventory and playerData.inventory.pets then
            for petUniqueId, petData in pairs(playerData.inventory.pets) do
                if petData.id and petData.properties then
                    local petName = string.lower(petData.id)
                    local petAge = petData.properties.age or 0
                    local isNeon = petData.properties.neon or false

                    -- Check if pet is in target list and under age 6 (including neon pets)
                    for _, targetPet in ipairs(TARGET_PETS_FOR_POTIONS) do
                        if petName == targetPet and petAge < 6 then
                            table.insert(petsNeedingPotions, {
                                unique_id = petUniqueId,
                                name = petData.id,
                                age = petAge,
                                target_age = 6
                            })
                            break
                        end
                    end
                end
            end
        end
    end)

    if not success then
        debugPrint("Error finding pets: " .. tostring(errorMsg), "PotionRelease")
    end

    -- Sort by age (youngest first)
    table.sort(petsNeedingPotions, function(a, b)
        return a.age < b.age
    end)

    return petsNeedingPotions
end

-- Function to use potion on a specific pet
local function usePotionOnPet(petUniqueID)
    if not petUniqueID then
        return false
    end

    -- Verify the pet still exists
    local petExists = false
    local currentPetAge = 0
    local petName = "Unknown"
    pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local playerData = clientData.get_data()[player.Name]
        if playerData and playerData.inventory and playerData.inventory.pets then
            for i, v in pairs(playerData.inventory.pets) do
                if v.unique == petUniqueID then
                    petExists = true
                    currentPetAge = v.properties.age or 0
                    petName = v.id or "Unknown"
                    break
                end
            end
        end
    end)

    if not petExists or currentPetAge >= 6 then
        return false
    end

    -- Equip the target pet before aging
    local equipSuccess = equipPet(petUniqueID)
    if not equipSuccess then
        debugPrint("Failed to equip pet: " .. petName, "PotionRelease")
        return false
    end
    debugPrint("Equipped pet: " .. petName, "PotionRelease")
    task.wait(1)

    local potionID = findPetAgePotion()
    if not potionID then
        return false
    end

    -- Equip potion
    local args1 = {
        potionID,
        {
            use_sound_delay = true,
            equip_as_last = false
        }
    }
    local equipSuccessPotion = pcall(function()
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("ToolAPI/Equip"):InvokeServer(unpack(args1))
    end)

    if not equipSuccessPotion then
        return false
    end

    task.wait(1)

    -- Start using potion
    local args2 = {
        potionID,
        "START"
    }
    local startSuccess = pcall(function()
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("ToolAPI/ServerUseTool"):FireServer(unpack(args2))
    end)

    if not startSuccess then
        safelyUnequipFood(potionID)
        return false
    end

    task.wait(1)

    -- Create pet object for consumption
    local args3 = {
        "__Enum_PetObjectCreatorType_2",
        {
            additional_consume_uniques = {},
            pet_unique = petUniqueID,
            unique_id = potionID
        }
    }
    local petObjectSuccess = pcall(function()
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("PetObjectAPI/CreatePetObject"):InvokeServer(unpack(args3))
    end)

    if not petObjectSuccess then
        safelyUnequipFood(potionID)
        return false
    end

    task.wait(9)
    safelyUnequipFood(potionID)

    debugPrint("Used potion on " .. petName .. " (Age: " .. currentPetAge .. ")", "PotionRelease")
    return true
end

-- Main potion releaser loop
local function startPotionReleaser()
    while PotionReleaserMode do
        local petsNeedingPotions = findPetsNeedingPotions()

        if #petsNeedingPotions == 0 then
            task.wait(30)
            continue
        end

        local potionID = findPetAgePotion()
        if not potionID then
            debugPrint("No potions available", "PotionRelease")
            task.wait(30)
            continue
        end

        debugPrint("Found " .. #petsNeedingPotions .. " pets needing potions", "PotionRelease")

        local potionsUsed = 0
        for _, petData in ipairs(petsNeedingPotions) do
            if not PotionReleaserMode then break end

            -- Check if pet still needs potion
            local currentAge = 0
            pcall(function()
                local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
                local playerData = clientData.get_data()[player.Name]
                if playerData and playerData.inventory and playerData.inventory.pets then
                    for i, v in pairs(playerData.inventory.pets) do
                        if v.unique == petData.unique_id then
                            currentAge = v.properties.age or 0
                            break
                        end
                    end
                end
            end)

            if currentAge >= 6 then
                continue
            end

            local success = usePotionOnPet(petData.unique_id)

            if success then
                potionsUsed = potionsUsed + 1
                task.wait(3)

                if not findPetAgePotion() then
                    debugPrint("Out of potions", "PotionRelease")
                    break
                end
            else
                task.wait(2)
            end
        end

        if potionsUsed > 0 then
            debugPrint("Cycle complete: " .. potionsUsed .. " potions used", "PotionRelease")
        end

        task.wait(10)
    end
end

-- Function to toggle potion releaser mode
local function togglePotionReleaserMode()
    PotionReleaserMode = not PotionReleaserMode
    if PotionReleaserMode then
        debugPrint("STARTED - Targeting pets until age 6 (including neon)", "PotionRelease")
        potionReleaserCoroutine = coroutine.wrap(startPotionReleaser)()
    else
        debugPrint("STOPPED", "PotionRelease")
        potionReleaserCoroutine = nil
    end
end

-- ==================================================================
-- BOX OPENER FUNCTIONS
-- ==================================================================

-- Simple click function for box opening
local function clickAt(x, y)
    VirtualInputManager:SendMouseButtonEvent(x, y, 0, true, game, 1)
    task.wait(0.05)
    VirtualInputManager:SendMouseButtonEvent(x, y, 0, false, game, 1)
    return true
end

-- Function to count boxes
local function countBoxes()
    local boxCount = 0
    
    local success, err = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local data = clientData.get_data()
        if data[player.Name] and data[player.Name].inventory and data[player.Name].inventory.gifts then
            for uid, gift in pairs(data[player.Name].inventory.gifts) do
                if gift.id == BOX_ID then
                    boxCount = boxCount + (gift.amount or 1)
                end
            end
        end
    end)
    
    if not success then
        debugPrint("Count error: " .. tostring(err), "BoxOpener")
        return 0
    end
    
    return boxCount
end

-- Function to find and get a box ID
local function getBoxId()
    local boxId = nil
    
    local success, err = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local data = clientData.get_data()
        if data[player.Name] and data[player.Name].inventory and data[player.Name].inventory.gifts then
            for uid, gift in pairs(data[player.Name].inventory.gifts) do
                if gift.id == BOX_ID then
                    boxId = uid
                    break
                end
            end
        end
    end)
    
    if not success then
        debugPrint("Error: " .. tostring(err), "BoxOpener")
        return nil
    end
    
    return boxId
end

-- Function to open one box
local function openOneBox()
    local boxId = getBoxId()
    
    if not boxId then
        return false
    end
    
    -- Equip the box
    local equipSuccess = pcall(function()
        ReplicatedStorage.API["ToolAPI/Equip"]:InvokeServer(boxId)
    end)
    
    if not equipSuccess then
        return false
    end
    
    task.wait(1)
    
    -- Click first spot
    clickAt(520, 485)
    
    task.wait(1)
    
    -- Click second spot
    clickAt(570, 333)
    
    task.wait(2)
    
    return true
end

-- Function to open all boxes
local function openAllBoxes()
    while BoxOpenerMode do
        local boxCount = countBoxes()
        
        if boxCount == 0 then
            BoxOpenerMode = false
            debugPrint("All boxes opened!", "BoxOpener")
            break
        end
        
        debugPrint("Opening box (" .. boxCount .. " remaining)", "BoxOpener")
        
        local success = openOneBox()
        
        if not success then
            task.wait(2)
        else
            task.wait(3) -- Wait between boxes
        end
    end
end

-- Function to toggle box opener mode
local function toggleBoxOpenerMode()
    BoxOpenerMode = not BoxOpenerMode
    if BoxOpenerMode then
        debugPrint("Starting to open all boxes", "BoxOpener")
        boxOpenerCoroutine = coroutine.wrap(function()
            openAllBoxes()
        end)()
    else
        debugPrint("Stopped opening boxes", "BoxOpener")
        boxOpenerCoroutine = nil
    end
end

-- ==================================================================
-- COMBINED UI CREATION
-- ==================================================================
local function createCombinedUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "PotionReleaseBoxOpenerUI"
    screenGui.Parent = player:WaitForChild("PlayerGui")

    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 200, 0, 140)
    mainFrame.Position = UDim2.new(0, 10, 1, -150)
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    mainFrame.BorderSizePixel = 0
    mainFrame.BackgroundTransparency = 0.1
    mainFrame.Parent = screenGui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = mainFrame

    -- Draggable functionality
    local dragging = false
    local dragStart = nil
    local startPos = nil

    local function updateInput(input)
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    mainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    mainFrame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            if dragging then
                updateInput(input)
            end
        end
    end)

    -- Title
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 25)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundTransparency = 1
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Text = "Potion Releaser & Box Opener"
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 14
    title.Parent = mainFrame

    -- Box counter
    local boxCounterLabel = Instance.new("TextLabel")
    boxCounterLabel.Size = UDim2.new(1, 0, 0, 20)
    boxCounterLabel.Position = UDim2.new(0, 5, 0, 25)
    boxCounterLabel.BackgroundTransparency = 1
    boxCounterLabel.TextColor3 = Color3.fromRGB(100, 200, 255)
    boxCounterLabel.Text = "Boxes: 0"
    boxCounterLabel.Font = Enum.Font.SourceSansBold
    boxCounterLabel.TextSize = 12
    boxCounterLabel.TextXAlignment = Enum.TextXAlignment.Left
    boxCounterLabel.Parent = mainFrame

    -- Potion status label
    local potionStatusLabel = Instance.new("TextLabel")
    potionStatusLabel.Size = UDim2.new(1, 0, 0, 15)
    potionStatusLabel.Position = UDim2.new(0, 5, 0, 45)
    potionStatusLabel.BackgroundTransparency = 1
    potionStatusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    potionStatusLabel.Text = "Ready"
    potionStatusLabel.Font = Enum.Font.SourceSans
    potionStatusLabel.TextSize = 10
    potionStatusLabel.TextXAlignment = Enum.TextXAlignment.Left
    potionStatusLabel.Parent = mainFrame

    -- Potion Release button
    local potionButton = Instance.new("TextButton")
    potionButton.Size = UDim2.new(0.9, 0, 0, 25)
    potionButton.Position = UDim2.new(0.05, 0, 0.5, 0)
    potionButton.BackgroundColor3 = Color3.fromRGB(200, 100, 0)
    potionButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    potionButton.Text = "PotionRelease [OFF]"
    potionButton.Font = Enum.Font.SourceSansBold
    potionButton.TextSize = 12
    potionButton.Parent = mainFrame

    local potionButtonCorner = Instance.new("UICorner")
    potionButtonCorner.CornerRadius = UDim.new(0, 4)
    potionButtonCorner.Parent = potionButton

    -- Open One Box button
    local openOneBoxButton = Instance.new("TextButton")
    openOneBoxButton.Size = UDim2.new(0.4, 0, 0, 25)
    openOneBoxButton.Position = UDim2.new(0.05, 0, 0.75, 0)
    openOneBoxButton.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
    openOneBoxButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    openOneBoxButton.Text = "OPEN ONE"
    openOneBoxButton.Font = Enum.Font.SourceSansBold
    openOneBoxButton.TextSize = 10
    openOneBoxButton.Parent = mainFrame

    local openOneCorner = Instance.new("UICorner")
    openOneCorner.CornerRadius = UDim.new(0, 4)
    openOneCorner.Parent = openOneBoxButton

    -- Open All Boxes button
    local openAllBoxesButton = Instance.new("TextButton")
    openAllBoxesButton.Size = UDim2.new(0.4, 0, 0, 25)
    openAllBoxesButton.Position = UDim2.new(0.55, 0, 0.75, 0)
    openAllBoxesButton.BackgroundColor3 = Color3.fromRGB(200, 100, 0)
    openAllBoxesButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    openAllBoxesButton.Text = "OPEN ALL [OFF]"
    openAllBoxesButton.Font = Enum.Font.SourceSansBold
    openAllBoxesButton.TextSize = 10
    openAllBoxesButton.Parent = mainFrame

    local openAllCorner = Instance.new("UICorner")
    openAllCorner.CornerRadius = UDim.new(0, 4)
    openAllCorner.Parent = openAllBoxesButton

    -- Update potion status function
    local function updatePotionStatus()
        local pets = findPetsNeedingPotions()
        local potions = findPetAgePotion() and "Yes" or "No"
        potionStatusLabel.Text = #pets .. " pets | Potions: " .. potions
    end

    -- Update box counter function
    local function updateBoxCounter()
        local boxCount = countBoxes()
        boxCounterLabel.Text = "Boxes: " .. boxCount
        return boxCount
    end

    -- Connect potion button click
    potionButton.MouseButton1Click:Connect(function()
        togglePotionReleaserMode()
        potionButton.Text = PotionReleaserMode and "PotionRelease [ON]" or "PotionRelease [OFF]"
        potionButton.BackgroundColor3 = PotionReleaserMode and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(200, 100, 0)
        updatePotionStatus()
    end)

    -- Connect open one box button
    openOneBoxButton.MouseButton1Click:Connect(function()
        debugPrint("Opening one box...", "BoxOpener")
        if openOneBox() then
            updateBoxCounter()
            debugPrint("Box opened successfully!", "BoxOpener")
        else
            debugPrint("Failed to open box", "BoxOpener")
        end
    end)

    -- Connect open all boxes button
    openAllBoxesButton.MouseButton1Click:Connect(function()
        toggleBoxOpenerMode()
        openAllBoxesButton.Text = BoxOpenerMode and "OPEN ALL [ON]" or "OPEN ALL [OFF]"
        openAllBoxesButton.BackgroundColor3 = BoxOpenerMode and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(200, 100, 0)
        updateBoxCounter()
    end)

    -- Auto-update status
    coroutine.wrap(function()
        while true do
            updatePotionStatus()
            updateBoxCounter()
            task.wait(5)
        end
    end)()

    return {
        mainFrame = mainFrame,
        potionStatusLabel = potionStatusLabel,
        boxCounterLabel = boxCounterLabel,
        potionButton = potionButton,
        openOneBoxButton = openOneBoxButton,
        openAllBoxesButton = openAllBoxesButton
    }
end

-- ==================================================================
-- INITIALIZATION
-- ==================================================================
-- Create the UI
local ui = createCombinedUI()
debugPrint("Compact Potion Releaser & Box Opener loaded successfully!", "System")
debugPrint("Target pets: winter_2025_maine_coon, basic_egg_2022_zebra, winter_2025_turtle_doves, winter_2025_xmas_tree_sasquatch (until age 6, including neon)", "System")
debugPrint("Box target: winter_2025_angus_box", "System")
