-- ==================================================================
-- COMPACT POTION RELEASER SCRIPT (MODIFIED FOR NEON PETS)
-- ==================================================================
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local VirtualInputManager = game:GetService("VirtualInputManager")
local player = Players.LocalPlayer

-- Potion Releaser variables
local PotionReleaserMode = false
local potionReleaserCoroutine = nil
local TARGET_PETS_FOR_POTIONS = {
    "winter_2025_maine_coon",
    "basic_egg_2022_zebra",
    "winter_2025_turtle_doves",
    "winter_2025_xmas_tree_sasquatch"
}

-- Box opening variables
local boxOpeningMode = false
local boxOpeningCoroutine = nil
local BOX_TYPE = "winter_2025_angus_box"

-- Debug print function
local function debugPrint(msg)
    print("[PotionRelease] " .. msg)
end

-- Function to find pet age potion in inventory
local function findPetAgePotion()
    local success, result = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local playerData = clientData.get_data()[player.Name]
        if playerData and playerData.inventory and playerData.inventory.food then
            for uniqueId, itemData in pairs(playerData.inventory.food) do
                if itemData.id == "pet_age_potion" then
                    return uniqueId
                end
            end
        end
    end)
    return success and result or nil
end

-- Function to find boxes in inventory
local function findBoxesInInventory()
    local boxes = {}
    local totalAmount = 0
    
    local success, errorMsg = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local playerData = clientData.get_data()[player.Name]
        if playerData and playerData.inventory and playerData.inventory.gifts then
            for uid, gift in pairs(playerData.inventory.gifts) do
                if gift.id == BOX_TYPE then
                    local amount = gift.amount or 1
                    table.insert(boxes, {uid = uid, amount = amount})
                    totalAmount = totalAmount + amount
                end
            end
        end
    end)
    
    if not success then
        debugPrint("Error finding boxes: " .. tostring(errorMsg))
    end
    
    return boxes, totalAmount
end

-- Function to safely unequip items
local function safelyUnequipFood(itemId)
    pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("ToolAPI/Unequip"):InvokeServer(itemId)
    end)
end

-- Function to equip a specific pet
local function equipPet(petUniqueID)
    if not petUniqueID then
        return false
    end
    local args = {
        petUniqueID,
        {
            use_sound_delay = true,
            equip_as_last = false
        }
    }
    local success = pcall(function()
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("ToolAPI/Equip"):InvokeServer(unpack(args))
    end)
    return success
end

-- Function to find pets that need potions (age < 6 and in target list, including neon pets)
local function findPetsNeedingPotions()
    local petsNeedingPotions = {}

    local success, errorMsg = pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local playerData = clientData.get_data()[player.Name]
        if playerData and playerData.inventory and playerData.inventory.pets do
            for petUniqueId, petData in pairs(playerData.inventory.pets) do
                if petData.id and petData.properties then
                    local petName = string.lower(petData.id)
                    local petAge = petData.properties.age or 0
                    local isNeon = petData.properties.neon or false

                    -- Check if pet is in target list and under age 6 (including neon pets)
                    for _, targetPet in ipairs(TARGET_PETS_FOR_POTIONS) do
                        if petName == targetPet and petAge < 6 then
                            table.insert(petsNeedingPotions, {
                                unique_id = petUniqueId,
                                name = petData.id,
                                age = petAge,
                                target_age = 6
                            })
                            break
                        end
                    end
                end
            end
        end
    end)

    if not success then
        debugPrint("Error finding pets: " .. tostring(errorMsg))
    end

    -- Sort by age (youngest first)
    table.sort(petsNeedingPotions, function(a, b)
        return a.age < b.age
    end)

    return petsNeedingPotions
end

-- Function to use potion on a specific pet
local function usePotionOnPet(petUniqueID)
    if not petUniqueID then
        return false
    end

    -- Verify the pet still exists
    local petExists = false
    local currentPetAge = 0
    local petName = "Unknown"
    pcall(function()
        local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
        local playerData = clientData.get_data()[player.Name]
        if playerData and playerData.inventory and playerData.inventory.pets then
            for i, v in pairs(playerData.inventory.pets) do
                if v.unique == petUniqueID then
                    petExists = true
                    currentPetAge = v.properties.age or 0
                    petName = v.id or "Unknown"
                    break
                end
            end
        end
    end)

    if not petExists or currentPetAge >= 6 then
        return false
    end

    -- Equip the target pet before aging
    local equipSuccess = equipPet(petUniqueID)
    if not equipSuccess then
        debugPrint("Failed to equip pet: " .. petName)
        return false
    end
    debugPrint("Equipped pet: " .. petName)
    task.wait(1)

    local potionID = findPetAgePotion()
    if not potionID then
        return false
    end

    -- Equip potion
    local args1 = {
        potionID,
        {
            use_sound_delay = true,
            equip_as_last = false
        }
    }
    local equipSuccessPotion = pcall(function()
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("ToolAPI/Equip"):InvokeServer(unpack(args1))
    end)

    if not equipSuccessPotion then
        return false
    end

    task.wait(1)

    -- Start using potion
    local args2 = {
        potionID,
        "START"
    }
    local startSuccess = pcall(function()
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("ToolAPI/ServerUseTool"):FireServer(unpack(args2))
    end)

    if not startSuccess then
        safelyUnequipFood(potionID)
        return false
    end

    task.wait(1)

    -- Create pet object for consumption
    local args3 = {
        "__Enum_PetObjectCreatorType_2",
        {
            additional_consume_uniques = {},
            pet_unique = petUniqueID,
            unique_id = potionID
        }
    }
    local petObjectSuccess = pcall(function()
        return ReplicatedStorage:WaitForChild("API"):WaitForChild("PetObjectAPI/CreatePetObject"):InvokeServer(unpack(args3))
    end)

    if not petObjectSuccess then
        safelyUnequipFood(potionID)
        return false
    end

    task.wait(9)
    safelyUnequipFood(potionID)

    debugPrint("Used potion on " .. petName .. " (Age: " .. currentPetAge .. ")")
    return true
end

-- Direct coordinate click function for box opening
local function clickAtPosition(x, y)
    VirtualInputManager:SendMouseButtonEvent(x, y, 0, true, game, 1)
    task.wait(0.06)
    VirtualInputManager:SendMouseButtonEvent(x, y, 0, false, game, 1)
    return true
end

-- Function to open a single box
local function openSingleBox()
    if boxOpeningMode then return end
    
    debugPrint("Starting box opening process...")
    
    -- Step 1: Find a box in inventory
    local boxes, totalAmount = findBoxesInInventory()
    
    if #boxes == 0 then
        debugPrint("ERROR: No boxes found!")
        return false
    end
    
    debugPrint("Found " .. totalAmount .. " boxes to open")
    
    -- Step 2: Equip the box
    local boxUID = boxes[1].uid
    
    local equipSuccess = pcall(function()
        ReplicatedStorage.API["ToolAPI/Equip"]:InvokeServer(boxUID)
    end)
    
    if not equipSuccess then
        debugPrint("ERROR: Failed to equip box!")
        return false
    end
    
    debugPrint("Box equipped! Waiting 1 second...")
    task.wait(1)  -- Wait 1 second after equipping
    
    -- Step 3: Click at first coordinates (slot 13)
    debugPrint("Clicking at 520,485...")
    clickAtPosition(520, 485)  -- First click
    
    debugPrint("First click done! Waiting 1 second...")
    task.wait(1)  -- Wait 1 second after first click
    
    -- Step 4: Click at second coordinates (Open button)
    debugPrint("Clicking at 570,333...")
    clickAtPosition(570, 333)  -- Second click (Open button)
    
    debugPrint("Both clicks completed!")
    task.wait(2)  -- Wait to see if box opened
    
    -- Verify if box was opened by checking inventory
    local oldCount = totalAmount
    local _, newTotalAmount = findBoxesInInventory()
    
    if newTotalAmount < oldCount then
        debugPrint("SUCCESS: Box opened! ðŸŽ")
        return true
    else
        debugPrint("Result: Unknown (check inventory)")
        return false
    end
end

-- Box opening loop function
local function startBoxOpeningLoop()
    while boxOpeningMode do
        local boxes, totalAmount = findBoxesInInventory()
        
        if #boxes == 0 then
            debugPrint("No boxes left to open")
            boxOpeningMode = false
            break
        end
        
        debugPrint("Opening box " .. (#boxes - #boxes + 1) .. "/" .. #boxes)
        
        local success = openSingleBox()
        
        if not success then
            debugPrint("Failed to open box, retrying in 5 seconds...")
            task.wait(5)
        else
            task.wait(3)  -- Wait between successful openings
        end
        
        -- Update box count
        boxes, totalAmount = findBoxesInInventory()
        debugPrint("Boxes remaining: " .. totalAmount)
    end
    
    debugPrint("Box opening stopped")
end

-- Main potion releaser loop
local function startPotionReleaser()
    while PotionReleaserMode do
        local petsNeedingPotions = findPetsNeedingPotions()

        if #petsNeedingPotions == 0 then
            task.wait(30)
            continue
        end

        local potionID = findPetAgePotion()
        if not potionID then
            debugPrint("No potions available")
            task.wait(30)
            continue
        end

        debugPrint("Found " .. #petsNeedingPotions .. " pets needing potions")

        local potionsUsed = 0
        for _, petData in ipairs(petsNeedingPotions) do
            if not PotionReleaserMode then break end

            -- Check if pet still needs potion
            local currentAge = 0
            pcall(function()
                local clientData = require(ReplicatedStorage.ClientModules.Core.ClientData)
                local playerData = clientData.get_data()[player.Name]
                if playerData and playerData.inventory and playerData.inventory.pets then
                    for i, v in pairs(playerData.inventory.pets) do
                        if v.unique == petData.unique_id then
                            currentAge = v.properties.age or 0
                            break
                        end
                    end
                end
            end)

            if currentAge >= 6 then
                continue
            end

            local success = usePotionOnPet(petData.unique_id)

            if success then
                potionsUsed = potionsUsed + 1
                task.wait(3)

                if not findPetAgePotion() then
                    debugPrint("Out of potions")
                    break
                end
            else
                task.wait(2)
            end
        end

        if potionsUsed > 0 then
            debugPrint("Cycle complete: " .. potionsUsed .. " potions used")
        end

        task.wait(10)
    end
end

-- Function to toggle potion releaser mode
local function togglePotionReleaserMode()
    PotionReleaserMode = not PotionReleaserMode
    if PotionReleaserMode then
        debugPrint("POTION RELEASER STARTED - Targeting pets until age 6 (including neon)")
        potionReleaserCoroutine = coroutine.wrap(startPotionReleaser)()
    else
        debugPrint("POTION RELEASER STOPPED")
        potionReleaserCoroutine = nil
    end
end

-- Function to toggle box opening mode
local function toggleBoxOpeningMode()
    boxOpeningMode = not boxOpeningMode
    if boxOpeningMode then
        debugPrint("BOX OPENING STARTED - Opening winter_2025_angus_box")
        boxOpeningCoroutine = coroutine.wrap(startBoxOpeningLoop)()
    else
        debugPrint("BOX OPENING STOPPED")
        boxOpeningCoroutine = nil
    end
end

-- ==================================================================
-- COMPACT UI CREATION
-- ==================================================================
local function createCompactPotionReleaserUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "PotionReleaseUI"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = player:WaitForChild("PlayerGui")

    local mainFrame = Instance.new("Frame")
    mainFrame.Size = UDim2.new(0, 180, 0, 110)
    mainFrame.Position = UDim2.new(0, 10, 1, -120)
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    mainFrame.BorderSizePixel = 0
    mainFrame.BackgroundTransparency = 0.1
    mainFrame.Parent = screenGui

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = mainFrame

    -- Draggable functionality
    local dragging = false
    local dragStart = nil
    local startPos = nil

    local function updateInput(input)
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    mainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    mainFrame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            if dragging then
                updateInput(input)
            end
        end
    end)

    -- Title
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 20)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.BackgroundTransparency = 1
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Text = "Auto Tools"
    title.Font = Enum.Font.SourceSansBold
    title.TextSize = 14
    title.Parent = mainFrame

    -- Status label
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Size = UDim2.new(1, 0, 0, 20)
    statusLabel.Position = UDim2.new(0, 5, 0, 20)
    statusLabel.BackgroundTransparency = 1
    statusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    statusLabel.Text = "Loading..."
    statusLabel.Font = Enum.Font.SourceSans
    statusLabel.TextSize = 10
    statusLabel.TextXAlignment = Enum.TextXAlignment.Left
    statusLabel.Parent = mainFrame

    -- Potion releaser toggle button
    local potionButton = Instance.new("TextButton")
    potionButton.Size = UDim2.new(0.45, -5, 0, 25)
    potionButton.Position = UDim2.new(0, 5, 0, 45)
    potionButton.BackgroundColor3 = Color3.fromRGB(200, 100, 0)
    potionButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    potionButton.Text = "Potion [OFF]"
    potionButton.Font = Enum.Font.SourceSansBold
    potionButton.TextSize = 10
    potionButton.Parent = mainFrame

    local potionCorner = Instance.new("UICorner")
    potionCorner.CornerRadius = UDim.new(0, 4)
    potionCorner.Parent = potionButton

    -- Box opener toggle button
    local boxButton = Instance.new("TextButton")
    boxButton.Size = UDim2.new(0.45, -5, 0, 25)
    boxButton.Position = UDim2.new(0.55, 0, 0, 45)
    boxButton.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
    boxButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    boxButton.Text = "Box [OFF]"
    boxButton.Font = Enum.Font.SourceSansBold
    boxButton.TextSize = 10
    boxButton.Parent = mainFrame

    local boxCorner = Instance.new("UICorner")
    boxCorner.CornerRadius = UDim.new(0, 4)
    boxCorner.Parent = boxButton

    -- Open single box button
    local singleBoxButton = Instance.new("TextButton")
    singleBoxButton.Size = UDim2.new(1, -10, 0, 25)
    singleBoxButton.Position = UDim2.new(0, 5, 0, 75)
    singleBoxButton.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
    singleBoxButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    singleBoxButton.Text = "Open One Box"
    singleBoxButton.Font = Enum.Font.SourceSansBold
    singleBoxButton.TextSize = 10
    singleBoxButton.Parent = mainFrame

    local singleBoxCorner = Instance.new("UICorner")
    singleBoxCorner.CornerRadius = UDim.new(0, 4)
    singleBoxCorner.Parent = singleBoxButton

    -- Update status function
    local function updateStatus()
        local pets = findPetsNeedingPotions()
        local potions = findPetAgePotion() and "Yes" or "No"
        local boxes, boxCount = findBoxesInInventory()
        statusLabel.Text = "P:" .. #pets .. " | Pot:" .. potions .. " | B:" .. boxCount
    end

    -- Connect potion button click
    potionButton.MouseButton1Click:Connect(function()
        togglePotionReleaserMode()
        potionButton.Text = PotionReleaserMode and "Potion [ON]" or "Potion [OFF]"
        potionButton.BackgroundColor3 = PotionReleaserMode and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(200, 100, 0)
        updateStatus()
    end)

    -- Connect box button click
    boxButton.MouseButton1Click:Connect(function()
        toggleBoxOpeningMode()
        boxButton.Text = boxOpeningMode and "Box [ON]" or "Box [OFF]"
        boxButton.BackgroundColor3 = boxOpeningMode and Color3.fromRGB(0, 200, 100) or Color3.fromRGB(0, 100, 200)
        updateStatus()
    end)

    -- Connect single box button click
    singleBoxButton.MouseButton1Click:Connect(function()
        if not boxOpeningMode then
            openSingleBox()
            task.wait(1)
            updateStatus()
        end
    end)

    -- Right-click for coordinate test
    singleBoxButton.MouseButton2Click:Connect(function()
        debugPrint("Testing coordinates...")
        clickAtPosition(520, 485)
        task.wait(1)
        clickAtPosition(570, 333)
        debugPrint("Coordinate test complete!")
    end)

    -- Auto-update status
    coroutine.wrap(function()
        while true do
            updateStatus()
            task.wait(5)
        end
    end)()

    return {
        mainFrame = mainFrame,
        statusLabel = statusLabel,
        potionButton = potionButton,
        boxButton = boxButton,
        singleBoxButton = singleBoxButton
    }
end

-- ==================================================================
-- INITIALIZATION
-- ==================================================================
-- Create the UI
local ui = createCompactPotionReleaserUI()
debugPrint("Compact Auto Tools loaded successfully!")
debugPrint("Potion Releaser: Targets pets until age 6 (including neon)")
debugPrint("Box Opener: Opens winter_2025_angus_box")
debugPrint("Instructions:")
debugPrint("- Left-click 'Open One Box': Open single box")
debugPrint("- Right-click 'Open One Box': Test coordinates")

-- Initial status update
task.wait(2)
local pets = findPetsNeedingPotions()
local boxes, boxCount = findBoxesInInventory()
debugPrint("Initial scan: " .. #pets .. " pets need potions, " .. boxCount .. " boxes available")
