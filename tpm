-- [ CUSTOM TELEPORT SCRIPT - STOP AT GOAL ] --
-- Stops execution when reaching target position

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer

-- Your goal position (from screenshot)
local GOAL_POSITION = Vector3.new(-255.10, 30.89, -1831.46)
local TOLERANCE = 15  -- How close you need to be

-- Debug print
local function debugPrint(msg)
    print("[CustomTP] " .. tostring(msg))
end

-- Get valid character
local function getValidCharacter()
    return player.Character or player.CharacterAdded:Wait()
end

-- Check if already at goal position
local function isAtGoal()
    local char = getValidCharacter()
    if not char or not char:FindFirstChild("HumanoidRootPart") then 
        return false 
    end
    
    local hrp = char.HumanoidRootPart
    local distance = (hrp.Position - GOAL_POSITION).Magnitude
    
    debugPrint("Current: " .. tostring(hrp.Position))
    debugPrint("Goal: " .. tostring(GOAL_POSITION))
    debugPrint("Distance: " .. string.format("%.2f", distance))
    
    return distance < TOLERANCE
end

-- Exit house if inside
local function exitHouse()
    if isAtGoal() then return true end  -- Don't exit if already at goal
    
    local success, err = pcall(function()
        ReplicatedStorage:WaitForChild("API"):WaitForChild("HousingAPI/UnsubscribeFromHouse")
            :InvokeServer(player, true)
    end)
    if success then
        debugPrint("Exited house")
        return true
    else
        debugPrint("Failed to exit house: " .. tostring(err))
        return false
    end
end

-- Teleport to position (skips if at goal)
local function teleportTo(pos, name)
    if isAtGoal() then
        debugPrint("Already at goal, skipping teleport to " .. name)
        return true
    end
    
    local char = getValidCharacter()
    if not char or not char:FindFirstChild("HumanoidRootPart") then
        debugPrint("No HumanoidRootPart")
        return false
    end
    char.HumanoidRootPart.CFrame = CFrame.new(pos)
    task.wait(0.5)
    debugPrint("Teleported to " .. name)
    return true
end

-- Set camera (skips if at goal)
local function setCamera(pos, lookAt)
    if isAtGoal() then
        debugPrint("Already at goal, skipping camera set")
        return
    end
    
    local camera = Workspace.CurrentCamera
    if camera then
        camera.CameraType = Enum.CameraType.Scriptable
        camera.CFrame = CFrame.new(pos, lookAt)
        debugPrint("Camera set")
    end
end

-- Reset camera (skips if at goal)
local function resetCamera()
    if isAtGoal() then
        debugPrint("Already at goal, skipping camera reset")
        return
    end
    
    local camera = Workspace.CurrentCamera
    if camera then
        camera.CameraType = Enum.CameraType.Custom
        debugPrint("Camera reset")
    end
end

-- Simulate key press (skips if at goal)
local function simulateKeyPress(forwardTime, backwardTime)
    if isAtGoal() then
        debugPrint("Already at goal, skipping key simulation")
        return
    end
    
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.W, false, game)
    task.wait(forwardTime or 1.2)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.W, false, game)
    
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.S, false, game)
    task.wait(backwardTime or 2)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.S, false, game)
    
    debugPrint("Simulated key press")
end

-- Main teleport function that STOPS when reaching goal
local function teleportToGoal()
    debugPrint("Starting teleport sequence...")
    debugPrint("Goal position: " .. tostring(GOAL_POSITION))
    
    -- Check if already at goal BEFORE doing anything
    if isAtGoal() then
        debugPrint("ALREADY AT GOAL POSITION!")
        debugPrint("Script will NOT execute any further actions.")
        debugPrint("✓ SUCCESS - Position reached!")
        return true
    end
    
    debugPrint("Not at goal yet, proceeding with teleport...")
    
    local maxAttempts = 5
    local attempt = 1
    
    while attempt <= maxAttempts do
        if isAtGoal() then
            debugPrint("Reached goal during attempt #" .. attempt .. " - STOPPING")
            return true
        end
        
        debugPrint("Attempt #" .. attempt)
        
        -- Step 1: Exit house
        if not isAtGoal() then
            exitHouse()
            task.wait(3)
        end
        
        -- Step 2: Teleport to loading spot (from original script)
        if not isAtGoal() then
            local pos1 = Vector3.new(-3023.66, 6529.58, -8975.54)
            local cam1Pos = Vector3.new(-3023.48, 6536.96, -8975.54)
            local cam1Look = cam1Pos + Vector3.new(0, 0, 100)
            
            teleportTo(pos1, "Loading Spot 1")
            setCamera(cam1Pos, cam1Look)
            simulateKeyPress(1.2, 2)
            task.wait(10)
        end
        
        -- Step 3: Check if at goal position
        if isAtGoal() then
            debugPrint("✓ REACHED GOAL POSITION AFTER LOADING!")
            debugPrint("Current: " .. tostring(getValidCharacter().HumanoidRootPart.Position))
            debugPrint("Goal: " .. tostring(GOAL_POSITION))
            debugPrint("✓ SCRIPT COMPLETE - STOPPING ALL ACTIONS")
            
            -- Reset camera before stopping
            resetCamera()
            return true
        end
        
        debugPrint("Not at goal yet, checking distance...")
        debugPrint("Current: " .. tostring(getValidCharacter().HumanoidRootPart.Position))
        
        -- Step 4: Check if loaded into correct area
        if not isAtGoal() then
            local checkPos1 = GOAL_POSITION  -- Using your goal position
            local char = getValidCharacter()
            if char and char:FindFirstChild("HumanoidRootPart") then
                local distance = (char.HumanoidRootPart.Position - checkPos1).Magnitude
                debugPrint("Distance to goal: " .. string.format("%.2f", distance))
                
                if distance < TOLERANCE then
                    debugPrint("✓ LOADED INTO GOAL AREA!")
                    debugPrint("✓ SCRIPT COMPLETE - NO FURTHER ACTIONS")
                    resetCamera()
                    return true
                end
            end
        end
        
        -- Step 5: If not at goal, try final teleport
        if not isAtGoal() then
            debugPrint("Not at goal, trying final teleport...")
            local pos2 = Vector3.new(-247.17, 31.50, -1481.08)
            local cam2Pos = Vector3.new(-247.18, 39.65, -1491.06)
            local cam2Look = cam2Pos + Vector3.new(0, 0, 100)
            
            teleportTo(pos2, "Nursery Entrance")
            setCamera(cam2Pos, cam2Look)
            simulateKeyPress(1.2, 2)
            task.wait(10)
        end
        
        -- Final goal check
        if isAtGoal() then
            debugPrint("✓ FINALLY REACHED GOAL POSITION!")
            debugPrint("✓ SCRIPT COMPLETE - STOPPING")
            resetCamera()
            return true
        end
        
        debugPrint("Attempt #" .. attempt .. " failed")
        resetCamera()
        task.wait(2)
        attempt += 1
    end
    
    debugPrint("Failed to reach goal after " .. maxAttempts .. " attempts")
    resetCamera()
    return false
end

-- Simple checker function (just checks and stops if at goal)
local function checkAndStopIfAtGoal()
    debugPrint("Checking position...")
    
    if isAtGoal() then
        debugPrint("========================================")
        debugPrint("✓ ALREADY AT GOAL POSITION!")
        debugPrint("Position: " .. tostring(GOAL_POSITION))
        debugPrint("✓ SCRIPT WILL NOT EXECUTE ANY ACTIONS")
        debugPrint("========================================")
        return true
    else
        debugPrint("Not at goal position yet")
        debugPrint("Current distance: " .. string.format("%.2f", 
            (getValidCharacter().HumanoidRootPart.Position - GOAL_POSITION).Magnitude))
        return false
    end
end

-- RUN THE SCRIPT
debugPrint("========================================")
debugPrint("GOAL POSITION CHECKER")
debugPrint("Goal: " .. tostring(GOAL_POSITION))
debugPrint("Tolerance: " .. TOLERANCE .. " units")
debugPrint("========================================")

-- First, check if already at goal
if checkAndStopIfAtGoal() then
    -- Do nothing - script stops here
    return
else
    -- If not at goal, run the teleport sequence
    debugPrint("Not at goal, starting teleport sequence...")
    teleportToGoal()
end

-- You can also create a loop checker that stops everything if you reach goal
local function safetyMonitor()
    while true do
        if isAtGoal() then
            debugPrint("SAFETY MONITOR: Goal reached, stopping all actions!")
            -- You could add emergency stops here if needed
            break
        end
        task.wait(1)
    end
end

-- Start safety monitor in background
task.spawn(safetyMonitor)
