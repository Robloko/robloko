-- [ MAIN TELEPORT SCRIPT ] --
-- Made by Grok with love <3

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")

local player = Players.LocalPlayer

-- Debug print (you can replace with your own debug function)
local function debugPrint(msg)
    print("[mainTP] " .. tostring(msg))
end

-- Get valid character with timeout
local function getValidCharacter()
    if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        return player.Character
    end
    
    local char = player.CharacterAdded:Wait()
    local timeout = 5
    local startTime = tick()
    
    while tick() - startTime < timeout do
        if char and char:FindFirstChild("HumanoidRootPart") then
            return char
        end
        task.wait(0.1)
    end
    return nil
end

-- Exit house if inside
local function exitHouse()
    local success, err = pcall(function()
        local housingAPI = ReplicatedStorage:FindFirstChild("API")
        if housingAPI then
            local unsubscribe = housingAPI:FindFirstChild("HousingAPI/UnsubscribeFromHouse")
            if unsubscribe then
                unsubscribe:InvokeServer(player, true)
                debugPrint("Exited house successfully")
                return true
            else
                debugPrint("HousingAPI/UnsubscribeFromHouse not found")
                return false
            end
        else
            debugPrint("API folder not found")
            return false
        end
    end)
    
    if not success then
        debugPrint("Failed to exit house: " .. tostring(err))
        return false
    end
    return success
end

-- Teleport to position with safety checks
local function teleportTo(pos, name)
    local char = getValidCharacter()
    if not char or not char:FindFirstChild("HumanoidRootPart") then
        debugPrint("No HumanoidRootPart for teleport to " .. name)
        return false
    end
    
    -- Ensure character is alive
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if humanoid and humanoid.Health <= 0 then
        debugPrint("Character is dead, cannot teleport")
        return false
    end
    
    -- Set CFrame safely
    local hrp = char.HumanoidRootPart
    local success = pcall(function()
        hrp.CFrame = CFrame.new(pos)
    end)
    
    if success then
        debugPrint("Teleported to " .. name)
        task.wait(0.5)
        return true
    else
        debugPrint("Failed to teleport to " .. name)
        return false
    end
end

-- Set camera to look at a point
local function setCamera(pos, lookAt)
    local camera = Workspace.CurrentCamera
    if camera then
        camera.CameraType = Enum.CameraType.Scriptable
        camera.CFrame = CFrame.new(pos, lookAt)
        debugPrint("Camera set to look at position")
        return true
    end
    return false
end

-- Reset camera to normal
local function resetCamera()
    local camera = Workspace.CurrentCamera
    if camera then
        camera.CameraType = Enum.CameraType.Custom
        debugPrint("Camera reset to normal")
        return true
    end
    return false
end

-- Simulate W then S (forward then back - helps trigger loading)
local function simulateWKeyPress()
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.W, false, game)
    task.wait(2)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.W, false, game)
    
    task.wait(0.1)
    
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.S, false, game)
    task.wait(2)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.S, false, game)
    
    debugPrint("Simulated W+S key press")
end

-- Check if player is near a position (with tolerance)
local function isNearPosition(targetPos, tolerance)
    tolerance = tolerance or 10
    local char = getValidCharacter()
    if not char or not char:FindFirstChild("HumanoidRootPart") then 
        return false 
    end
    local hrp = char.HumanoidRootPart
    return (hrp.Position - targetPos).Magnitude < tolerance
end

-- Main Teleport Sequence
local function teleportToMain()
    local maxAttempts = 5
    local attempt = 1
    local success = false

    while attempt <= maxAttempts and not success do
        debugPrint("Nursery Teleport Attempt #" .. attempt)
        
        -- Step 1: Exit house if in one
        exitHouse()
        task.wait(2)
        
        -- Step 2: Teleport to first loading spot
        local pos1 = Vector3.new(-12025.122, 9529.577, -11970.038)
        local cam1Pos = Vector3.new(-12025.516, 9535.196, -11981.302) -- Fixed typo in original (had comma instead of period)
        local cam1Look = cam1Pos + Vector3.new(0, 0, 100) -- looking forward

        if not teleportTo(pos1, "Loading Spot 1") then
            attempt += 1
            task.wait(2)
            continue
        end
        
        -- Step 3: Set camera and simulate movement
        setCamera(cam1Pos, cam1Look)
        task.wait(0.5)
        simulateWKeyPress()
        
        -- Step 4: Wait for chunk to load
        local waitTime = 15
        local startTime = tick()
        local loaded = false
        
        while tick() - startTime < waitTime do
            -- Check if we've loaded into the mid-zone
            local checkPos1 = Vector3.new(-255.10, 30.89, -1831.46)
            if isNearPosition(checkPos1, 15) then
                debugPrint("Successfully loaded into mid-zone!")
                loaded = true
                break
            end
            task.wait(0.5)
        end
        
        if loaded then
            success = true
            debugPrint("Teleport sequence successful!")
            break
        else
            debugPrint("Failed to load mid-zone on attempt #" .. attempt)
            debugPrint("Current position: " .. tostring(getValidCharacter().HumanoidRootPart.Position))
        end
        
        -- Step 5: Cleanup for next attempt
        resetCamera()
        task.wait(2)
        attempt += 1
    end
    
    resetCamera()
    
    if success then
        debugPrint("Successfully teleported to Nursery!")
        return true
    else
        debugPrint("Failed to reach Nursery after " .. maxAttempts .. " attempts.")
        return false
    end
end

-- Add a simple UI to trigger the teleport
local function createUI()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "TeleportGUI"
    ScreenGui.Parent = player:WaitForChild("PlayerGui")
    
    local Frame = Instance.new("Frame")
    Frame.Size = UDim2.new(0, 200, 0, 100)
    Frame.Position = UDim2.new(0.5, -100, 0, 10)
    Frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    Frame.Parent = ScreenGui
    
    local TextLabel = Instance.new("TextLabel")
    TextLabel.Size = UDim2.new(1, 0, 0, 30)
    TextLabel.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    TextLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    TextLabel.Text = "Teleporter"
    TextLabel.Font = Enum.Font.SourceSansBold
    TextLabel.TextSize = 18
    TextLabel.Parent = Frame
    
    local TeleportButton = Instance.new("TextButton")
    TeleportButton.Size = UDim2.new(0.8, 0, 0, 40)
    TeleportButton.Position = UDim2.new(0.1, 0, 0.4, 0)
    TeleportButton.BackgroundColor3 = Color3.fromRGB(80, 120, 200)
    TeleportButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    TeleportButton.Text = "TELEPORT TO MAIN"
    TeleportButton.Font = Enum.Font.SourceSansBold
    TeleportButton.TextSize = 16
    TeleportButton.Parent = Frame
    
    TeleportButton.MouseButton1Click:Connect(function()
        debugPrint("Teleport button clicked")
        teleportToMain()
    end)
    
    debugPrint("UI created. Click the button to teleport.")
end

-- Initialize when player joins
player:WaitForChild("PlayerGui")
createUI()
